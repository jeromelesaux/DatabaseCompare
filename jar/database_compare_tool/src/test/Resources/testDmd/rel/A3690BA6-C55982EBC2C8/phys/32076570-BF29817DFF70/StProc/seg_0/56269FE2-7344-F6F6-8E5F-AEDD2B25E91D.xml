<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.StoredProcedureOraclev10g" name="PROC_COMPOSANTE_SI" id="56269FE2-7344-F6F6-8E5F-AEDD2B25E91D" directorySegmentName="seg_0">
<sourceConnName>DEV57_AXIONEUSER_FACTU</sourceConnName>
<sourceObjSchema>AXIONEUSER_FACTU</sourceObjSchema>
<sourceObjName>PROC_COMPOSANTE_SI</sourceObjName>
<createdBy>R.WATH</createdBy>
<createdTime>2012-12-04 10:06:38 UTC</createdTime>
<generatorID>Généré par l&apos;utilisateur</generatorID>
<ownerDesignName>ST-SYS-SIB-BD_FCTPRO-000009-8 MCD-FACTUPRO V4.5.0</ownerDesignName>
<owner>4FCC3A6A-181E-A36A-613B-7868309493E2</owner>
<source>CREATE OR REPLACE PROCEDURE                    AXIONEUSER_FACTU.PROC_COMPOSANTE_SI (&lt;br/&gt;    DATE_MOIS     IN DATE,&lt;br/&gt;    LIGNE_SERVICE IN VARCHAR)&lt;br/&gt;AS&lt;br/&gt;  v_id_offre NUMBER;&lt;br/&gt;  v_tarif    NUMBER;&lt;br/&gt;  CURSOR c1&lt;br/&gt;  IS&lt;br/&gt;    SELECT nd,&lt;br/&gt;      nrainitial,&lt;br/&gt;      dsp,&lt;br/&gt;      typedegroupage,&lt;br/&gt;      SUBSTR(ligne,instr(ligne,&apos;;&apos;,1,27)+1, instr(ligne,&apos;;&apos;,1,28)-instr(ligne,&apos;;&apos;,1,27)-1) &quot;ABONNE&quot;,&lt;br/&gt;      (SELECT d.zone_densite&lt;br/&gt;      FROM S_SDSL_NRA n,&lt;br/&gt;        S_SDSL_DATE_OUVERTURE_NRA d&lt;br/&gt;      WHERE n.id_nra                                   = d.id_nra&lt;br/&gt;      AND d.id_fai                                     = &apos;161&apos;&lt;br/&gt;      AND d.id_technologie                             = &apos;1&apos;&lt;br/&gt;      AND trim(concat(n.code_insee, n.nom_nra_abrege)) = t.nrainitial&lt;br/&gt;      ) &quot;ZONE_DENSITE&quot;,&lt;br/&gt;    NVL(datecr, datear) &quot;DATE_REJET&quot;,&lt;br/&gt;    t.idcommande,&lt;br/&gt;    t.NBPAIRES,&lt;br/&gt;    substr(t.ligne,instr(t.ligne,&apos;;&apos;,1,28)+1, instr(t.ligne,&apos;;&apos;,1,29)-instr(t.ligne,&apos;;&apos;,1,28)-1) as ADRESSE,&lt;br/&gt;	substr(t.ligne,instr(t.ligne,&apos;;&apos;,1,29)+1, instr(t.ligne,&apos;;&apos;,1,30)-instr(t.ligne,&apos;;&apos;,1,29)-1) as RIVOLI,&lt;br/&gt;	substr(t.ligne,instr(t.ligne,&apos;;&apos;,1,37)+1, instr(t.ligne,&apos;;&apos;,1,38)-instr(t.ligne,&apos;;&apos;,1,37)-1) as CODE_INSEE,&lt;br/&gt;	substr(t.ligne,instr(t.ligne,&apos;;&apos;,1,38)+1, instr(t.ligne,&apos;;&apos;,1,39)-instr(t.ligne,&apos;;&apos;,1,38)-1) as CODE_POSTAL,&lt;br/&gt;	substr(t.ligne,instr(t.ligne,&apos;;&apos;,1,39)+1, instr(t.ligne,&apos;;&apos;,1,40)-instr(t.ligne,&apos;;&apos;,1,39)-1) as COMMUNE,&lt;br/&gt;	substr(t.ligne,instr(t.ligne,&apos;;&apos;,1,30)+1, instr(t.ligne,&apos;;&apos;,1,31)-instr(t.ligne,&apos;;&apos;,1,30)-1) as NUM_VOIE,&lt;br/&gt;	t.IDEXTERNESAV as VIA_GTR&lt;br/&gt;  FROM S_TEMP_FOP_FACTU_SDSL t&lt;br/&gt;  WHERE coderejet                          IS NOT NULL&lt;br/&gt;  AND TRUNC(NVL(t.datecr, t.datear),&apos;MONTH&apos;)=(add_months(to_date(DATE_MOIS),-1))&lt;br/&gt;  AND coderejet                                                            IN&lt;br/&gt;    (SELECT libelle_rejet FROM T_FDSL_CODE_REJET&lt;br/&gt;    );&lt;br/&gt;BEGIN&lt;br/&gt;  FOR r1 IN c1&lt;br/&gt;  LOOP&lt;br/&gt;    SELECT id_fdsl_offres,&lt;br/&gt;      tarif&lt;br/&gt;    INTO v_id_offre,&lt;br/&gt;      v_tarif&lt;br/&gt;    FROM T_FDSL_OFFRES o,&lt;br/&gt;      S_COM_DSP d&lt;br/&gt;    WHERE o.id_fdsl_dsp = d.id&lt;br/&gt;    AND ref_produit     = &apos;SDSL-COM-TORT&apos;&lt;br/&gt;    AND zone_densite    = r1.ZONE_DENSITE&lt;br/&gt;    AND o.id_fdsl_paire = 1 --r1.nbpaires&lt;br/&gt;    AND d.nom_dsp       = r1.dsp;&lt;br/&gt;    INSERT&lt;br/&gt;    INTO T_FDSL_FACTURATION&lt;br/&gt;      (&lt;br/&gt;        DATE_FACTURATION,&lt;br/&gt;        id_fdsl_offres,&lt;br/&gt;        TYPE_CHARGE,&lt;br/&gt;        IDENTITE,&lt;br/&gt;        ID_SERVICE2,&lt;br/&gt;        VIA,&lt;br/&gt;        TYPE_TECHNO,&lt;br/&gt;        TYPE_DEGROUPAGE,&lt;br/&gt;        DATE_MES,&lt;br/&gt;        DATE_RESIL,&lt;br/&gt;        NOM_DSP,&lt;br/&gt;        NRA,&lt;br/&gt;        PROFIL,&lt;br/&gt;        CODE_CHARGE,&lt;br/&gt;        MONTANT_HT,&lt;br/&gt;        ID_SERVICE,&lt;br/&gt;        ETAT_SERVICE,&lt;br/&gt;        NOM_FAI,&lt;br/&gt;        NBPAIRES,&lt;br/&gt;        id_commande_sfr,&lt;br/&gt;       ADRESSE,&lt;br/&gt;       RIVOLI,&lt;br/&gt;        CODE_INSEE,&lt;br/&gt;        CODE_POSTAL,&lt;br/&gt;        COMMUNE,&lt;br/&gt;        NUM_VOIE,&lt;br/&gt;        VIA_GTR&lt;br/&gt;      )&lt;br/&gt;      VALUES&lt;br/&gt;      (&lt;br/&gt;        DATE_MOIS,&lt;br/&gt;        v_id_offre,&lt;br/&gt;        &apos;USAGE&apos;,&lt;br/&gt;        r1.ABONNE,&lt;br/&gt;        r1.ND,&lt;br/&gt;        &apos;&apos;,&lt;br/&gt;        &apos;SDSL&apos;,&lt;br/&gt;        r1.typedegroupage,&lt;br/&gt;        r1.DATE_REJET,&lt;br/&gt;        &apos;&apos;,&lt;br/&gt;        r1.DSP,&lt;br/&gt;        r1.NRAINITIAL,&lt;br/&gt;        &apos;Commande à tort&apos;,&lt;br/&gt;        &apos;SDSL-COM-TORT&apos;,&lt;br/&gt;        v_tarif,&lt;br/&gt;        &apos;&apos;,&lt;br/&gt;        &apos;SI&apos;,&lt;br/&gt;        &apos;NEUF CEGETEL&apos;,&lt;br/&gt;        r1.NBPAIRES,&lt;br/&gt;        r1.idcommande,&lt;br/&gt;         r1.ADRESSE,&lt;br/&gt;		  r1.RIVOLI,&lt;br/&gt;		  r1.CODE_INSEE,&lt;br/&gt;		  r1.CODE_POSTAL,&lt;br/&gt;		  r1.COMMUNE,&lt;br/&gt;		  r1.NUM_VOIE,&lt;br/&gt;		  r1.VIA_GTR&lt;br/&gt;      );&lt;br/&gt;  END LOOP;&lt;br/&gt;  COMMIT;&lt;br/&gt;END PROC_COMPOSANTE_SI;</source>
<body>CREATE OR REPLACE PROCEDURE                    AXIONEUSER_FACTU.PROC_COMPOSANTE_SI (&lt;br/&gt;    DATE_MOIS     IN DATE,&lt;br/&gt;    LIGNE_SERVICE IN VARCHAR)&lt;br/&gt;AS&lt;br/&gt;  v_id_offre NUMBER;&lt;br/&gt;  v_tarif    NUMBER;&lt;br/&gt;  CURSOR c1&lt;br/&gt;  IS&lt;br/&gt;    SELECT nd,&lt;br/&gt;      nrainitial,&lt;br/&gt;      dsp,&lt;br/&gt;      typedegroupage,&lt;br/&gt;      SUBSTR(ligne,instr(ligne,&apos;;&apos;,1,27)+1, instr(ligne,&apos;;&apos;,1,28)-instr(ligne,&apos;;&apos;,1,27)-1) &quot;ABONNE&quot;,&lt;br/&gt;      (SELECT d.zone_densite&lt;br/&gt;      FROM S_SDSL_NRA n,&lt;br/&gt;        S_SDSL_DATE_OUVERTURE_NRA d&lt;br/&gt;      WHERE n.id_nra                                   = d.id_nra&lt;br/&gt;      AND d.id_fai                                     = &apos;161&apos;&lt;br/&gt;      AND d.id_technologie                             = &apos;1&apos;&lt;br/&gt;      AND trim(concat(n.code_insee, n.nom_nra_abrege)) = t.nrainitial&lt;br/&gt;      ) &quot;ZONE_DENSITE&quot;,&lt;br/&gt;    NVL(datecr, datear) &quot;DATE_REJET&quot;,&lt;br/&gt;    t.idcommande,&lt;br/&gt;    t.NBPAIRES,&lt;br/&gt;    substr(t.ligne,instr(t.ligne,&apos;;&apos;,1,28)+1, instr(t.ligne,&apos;;&apos;,1,29)-instr(t.ligne,&apos;;&apos;,1,28)-1) as ADRESSE,&lt;br/&gt;	substr(t.ligne,instr(t.ligne,&apos;;&apos;,1,29)+1, instr(t.ligne,&apos;;&apos;,1,30)-instr(t.ligne,&apos;;&apos;,1,29)-1) as RIVOLI,&lt;br/&gt;	substr(t.ligne,instr(t.ligne,&apos;;&apos;,1,37)+1, instr(t.ligne,&apos;;&apos;,1,38)-instr(t.ligne,&apos;;&apos;,1,37)-1) as CODE_INSEE,&lt;br/&gt;	substr(t.ligne,instr(t.ligne,&apos;;&apos;,1,38)+1, instr(t.ligne,&apos;;&apos;,1,39)-instr(t.ligne,&apos;;&apos;,1,38)-1) as CODE_POSTAL,&lt;br/&gt;	substr(t.ligne,instr(t.ligne,&apos;;&apos;,1,39)+1, instr(t.ligne,&apos;;&apos;,1,40)-instr(t.ligne,&apos;;&apos;,1,39)-1) as COMMUNE,&lt;br/&gt;	substr(t.ligne,instr(t.ligne,&apos;;&apos;,1,30)+1, instr(t.ligne,&apos;;&apos;,1,31)-instr(t.ligne,&apos;;&apos;,1,30)-1) as NUM_VOIE,&lt;br/&gt;	t.IDEXTERNESAV as VIA_GTR&lt;br/&gt;  FROM S_TEMP_FOP_FACTU_SDSL t&lt;br/&gt;  WHERE coderejet                          IS NOT NULL&lt;br/&gt;  AND TRUNC(NVL(t.datecr, t.datear),&apos;MONTH&apos;)=(add_months(to_date(DATE_MOIS),-1))&lt;br/&gt;  AND coderejet                                                            IN&lt;br/&gt;    (SELECT libelle_rejet FROM T_FDSL_CODE_REJET&lt;br/&gt;    );&lt;br/&gt;BEGIN&lt;br/&gt;  FOR r1 IN c1&lt;br/&gt;  LOOP&lt;br/&gt;    SELECT id_fdsl_offres,&lt;br/&gt;      tarif&lt;br/&gt;    INTO v_id_offre,&lt;br/&gt;      v_tarif&lt;br/&gt;    FROM T_FDSL_OFFRES o,&lt;br/&gt;      S_COM_DSP d&lt;br/&gt;    WHERE o.id_fdsl_dsp = d.id&lt;br/&gt;    AND ref_produit     = &apos;SDSL-COM-TORT&apos;&lt;br/&gt;    AND zone_densite    = r1.ZONE_DENSITE&lt;br/&gt;    AND o.id_fdsl_paire = 1 --r1.nbpaires&lt;br/&gt;    AND d.nom_dsp       = r1.dsp;&lt;br/&gt;    INSERT&lt;br/&gt;    INTO T_FDSL_FACTURATION&lt;br/&gt;      (&lt;br/&gt;        DATE_FACTURATION,&lt;br/&gt;        id_fdsl_offres,&lt;br/&gt;        TYPE_CHARGE,&lt;br/&gt;        IDENTITE,&lt;br/&gt;        ID_SERVICE2,&lt;br/&gt;        VIA,&lt;br/&gt;        TYPE_TECHNO,&lt;br/&gt;        TYPE_DEGROUPAGE,&lt;br/&gt;        DATE_MES,&lt;br/&gt;        DATE_RESIL,&lt;br/&gt;        NOM_DSP,&lt;br/&gt;        NRA,&lt;br/&gt;        PROFIL,&lt;br/&gt;        CODE_CHARGE,&lt;br/&gt;        MONTANT_HT,&lt;br/&gt;        ID_SERVICE,&lt;br/&gt;        ETAT_SERVICE,&lt;br/&gt;        NOM_FAI,&lt;br/&gt;        NBPAIRES,&lt;br/&gt;        id_commande_sfr,&lt;br/&gt;       ADRESSE,&lt;br/&gt;       RIVOLI,&lt;br/&gt;        CODE_INSEE,&lt;br/&gt;        CODE_POSTAL,&lt;br/&gt;        COMMUNE,&lt;br/&gt;        NUM_VOIE,&lt;br/&gt;        VIA_GTR&lt;br/&gt;      )&lt;br/&gt;      VALUES&lt;br/&gt;      (&lt;br/&gt;        DATE_MOIS,&lt;br/&gt;        v_id_offre,&lt;br/&gt;        &apos;USAGE&apos;,&lt;br/&gt;        r1.ABONNE,&lt;br/&gt;        r1.ND,&lt;br/&gt;        &apos;&apos;,&lt;br/&gt;        &apos;SDSL&apos;,&lt;br/&gt;        r1.typedegroupage,&lt;br/&gt;        r1.DATE_REJET,&lt;br/&gt;        &apos;&apos;,&lt;br/&gt;        r1.DSP,&lt;br/&gt;        r1.NRAINITIAL,&lt;br/&gt;        &apos;Commande à tort&apos;,&lt;br/&gt;        &apos;SDSL-COM-TORT&apos;,&lt;br/&gt;        v_tarif,&lt;br/&gt;        &apos;&apos;,&lt;br/&gt;        &apos;SI&apos;,&lt;br/&gt;        &apos;NEUF CEGETEL&apos;,&lt;br/&gt;        r1.NBPAIRES,&lt;br/&gt;        r1.idcommande,&lt;br/&gt;         r1.ADRESSE,&lt;br/&gt;		  r1.RIVOLI,&lt;br/&gt;		  r1.CODE_INSEE,&lt;br/&gt;		  r1.CODE_POSTAL,&lt;br/&gt;		  r1.COMMUNE,&lt;br/&gt;		  r1.NUM_VOIE,&lt;br/&gt;		  r1.VIA_GTR&lt;br/&gt;      );&lt;br/&gt;  END LOOP;&lt;br/&gt;  COMMIT;&lt;br/&gt;END PROC_COMPOSANTE_SI;</body>
</StoredProcedureOraclev10g>