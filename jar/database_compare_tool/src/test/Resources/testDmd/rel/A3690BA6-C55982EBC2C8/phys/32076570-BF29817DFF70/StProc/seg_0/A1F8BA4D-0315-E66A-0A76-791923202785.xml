<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.StoredProcedureOraclev10g" name="P_FDSL_DL_RECAP_FACTU_SF" id="A1F8BA4D-0315-E66A-0A76-791923202785" directorySegmentName="seg_0">
<sourceConnName>DEV57_AXIONEUSER_FACTU</sourceConnName>
<sourceObjSchema>AXIONEUSER_FACTU</sourceObjSchema>
<sourceObjName>P_FDSL_DL_RECAP_FACTU_SF</sourceObjName>
<createdBy>R.WATH</createdBy>
<createdTime>2012-12-04 10:06:38 UTC</createdTime>
<generatorID>Généré par l&apos;utilisateur</generatorID>
<ownerDesignName>ST-SYS-SIB-BD_FCTPRO-000009-8 MCD-FACTUPRO V4.5.0</ownerDesignName>
<owner>4FCC3A6A-181E-A36A-613B-7868309493E2</owner>
<source>CREATE OR REPLACE PROCEDURE                    AXIONEUSER_FACTU.P_FDSL_DL_RECAP_FACTU_SF (&lt;br/&gt;                                                       p_file_name in varchar2 default v(&apos;P32_FILENAME&apos;),&lt;br/&gt;                                                       p_format in varchar2 default v(&apos;P32_FORMAT&apos;),&lt;br/&gt;                                                       p_abs_path in varchar2 default v(&apos;P32_ABS_PATH&apos;),&lt;br/&gt;                                                       p_dsp in varchar2 default v(&apos;P32_DSP&apos;),&lt;br/&gt;                                                       p_fai in varchar2 default v(&apos;P32_FAI&apos;),&lt;br/&gt;                                                       p_techno in varchar2 default v(&apos;P32_TECHNO&apos;),&lt;br/&gt;                                                       p_terme_factu in varchar2 default v(&apos;P32_TERME_FACTU&apos;),&lt;br/&gt;                                                       p_mode_factu in varchar2 default v(&apos;P32_MODE_FACTU&apos;),&lt;br/&gt;                                                       p_bi_login in varchar2 default &apos;factu_sf&apos;,&lt;br/&gt;                                                       p_bi_pwd in varchar2 default &apos;factu_sf&apos;,&lt;br/&gt;                                                       p_bi_ip in varchar2 default v(&apos;BIPUB_SERVER&apos;),&lt;br/&gt;                                                       p_bi_port in varchar2 default v(&apos;BIPUB_PORT&apos;),&lt;br/&gt;                                                       p_bi_version in varchar2 default v(&apos;BIPUB_VERSION&apos;),&lt;br/&gt;                                                       p_ns in varchar2 default v(&apos;NS&apos;)&lt;br/&gt;                                                       ) AS&lt;br/&gt;/***************************************************************************************&lt;br/&gt;  *&lt;br/&gt;  *  AUTEUR       :  Yann Chauvel&lt;br/&gt;  *  DATE CREATION    :  30/06/2010&lt;br/&gt;  *  MAIL : yann.chauvel@axionesi.net&lt;br/&gt;  *&lt;br/&gt;  *  DESCRIPTION  :&lt;br/&gt;  *       { TELECHARGEMENT DES RAPPORTS BI PUBLISHER                 }&lt;br/&gt;  *       { Pour le récapitulatif factures SF                        }&lt;br/&gt;  *&lt;br/&gt;  *  PARAMETRES   :&lt;br/&gt;  *   ________________________________________________________________________&lt;br/&gt;  *  | No |  PARAMETRE  | DESCRIPTIF                   |   REGLE              |&lt;br/&gt;  *  |~~~~|~~~~~~~~~~~~~|~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|~~~~~~~~~~~~~~~~~~~~~~|&lt;br/&gt;  *  | 1  | p_file_name | nom du fichier               |                      |&lt;br/&gt;  *  | 1  | p_format    | format du fichier            | pdf, xls             |&lt;br/&gt;  *  | 2  | p_abs_path  | chemin d&apos;acces au rapport BI |                      |&lt;br/&gt;  *  | 3  | p_bi_login  | login du compte BI           |                      |&lt;br/&gt;  *  | 2  | p_bi_pwd    | mot de passe du compte BI    |                      |&lt;br/&gt;  *  | 2  | p_bi_ip     | IP du serveur BI             |                      |&lt;br/&gt;  *  | 2  | p_bi_port   | port du serveur BI           |                      |&lt;br/&gt;  *  | 2  | p_bi_version| version de BI Publisher      |                      |&lt;br/&gt;  *  | 2  | p_ns        | parametre xmlns              |                      |&lt;br/&gt;  *  |____|_____________|______________________________|______________________|&lt;br/&gt;  *&lt;br/&gt;  *&lt;br/&gt;  **************************************************************************************/&lt;br/&gt;&lt;br/&gt;    l_mime varchar2(48);&lt;br/&gt;    l_env clob;&lt;br/&gt;    l_base64 clob;&lt;br/&gt;    l_blob blob;&lt;br/&gt;    l_size number;&lt;br/&gt;    l_xml xmltype;&lt;br/&gt;    l_path varchar(255) default &apos;//multiRef&apos;;&lt;br/&gt;    l_url varchar2(4000);&lt;br/&gt;&lt;br/&gt;begin&lt;br/&gt;&lt;br/&gt;    -- prepartion de l&apos;appel du service web&lt;br/&gt;    -- enveloppe soap&lt;br/&gt;    l_env := &apos;&lt;soapenv:Envelope xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot;&lt;br/&gt;                xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot; xmlns:pub=&quot;http://xmlns.oracle.com/oxp/service/PublicReportService&quot; xmlns:soapenc=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;&gt;&lt;br/&gt;                &lt;soapenv:Header/&gt;&lt;br/&gt;                &lt;soapenv:Body&gt;&lt;br/&gt;                &lt;pub:runReport soapenv:encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;&gt;&lt;br/&gt;                &lt;reportRequest xsi:type=&quot;pub:ReportRequest&quot;&gt;&lt;br/&gt;                &lt;attributeFormat xsi:type=&quot;xsd:string&quot;&gt;&apos; || p_format || &apos;&lt;/attributeFormat&gt;&lt;br/&gt;                &lt;parameterNameValues&gt;&lt;br/&gt;                  &lt;item&gt;&lt;br/&gt;                     &lt;name&gt;DSP&lt;/name&gt;&lt;br/&gt;                     &lt;multiValuesAllowed&gt;false&lt;/multiValuesAllowed&gt;&lt;br/&gt;                     &lt;values&gt;&lt;br/&gt;                        &lt;item&gt;&apos; || p_dsp || &apos;&lt;/item&gt;&lt;br/&gt;                     &lt;/values&gt;&lt;br/&gt;                  &lt;/item&gt;&lt;br/&gt;                  &lt;item&gt;&lt;br/&gt;                     &lt;name&gt;FAI&lt;/name&gt;&lt;br/&gt;                     &lt;multiValuesAllowed&gt;false&lt;/multiValuesAllowed&gt;&lt;br/&gt;                     &lt;values&gt;&lt;br/&gt;                        &lt;item&gt;&apos; || p_fai || &apos;&lt;/item&gt;&lt;br/&gt;                     &lt;/values&gt;&lt;br/&gt;                  &lt;/item&gt;&lt;br/&gt;                  &lt;item&gt;&lt;br/&gt;                     &lt;name&gt;TECHNO&lt;/name&gt;&lt;br/&gt;                     &lt;multiValuesAllowed&gt;false&lt;/multiValuesAllowed&gt;&lt;br/&gt;                     &lt;values&gt;&lt;br/&gt;                        &lt;item&gt;&apos; || p_techno || &apos;&lt;/item&gt;&lt;br/&gt;                     &lt;/values&gt;&lt;br/&gt;                  &lt;/item&gt;&lt;br/&gt;                  &lt;item&gt;&lt;br/&gt;                     &lt;name&gt;TERME&lt;/name&gt;&lt;br/&gt;                     &lt;multiValuesAllowed&gt;false&lt;/multiValuesAllowed&gt;&lt;br/&gt;                     &lt;values&gt;&lt;br/&gt;                        &lt;item&gt;&apos; || p_terme_factu || &apos;&lt;/item&gt;&lt;br/&gt;                     &lt;/values&gt;&lt;br/&gt;                  &lt;/item&gt;&lt;br/&gt;                  &lt;item&gt;&lt;br/&gt;                     &lt;name&gt;MODES&lt;/name&gt;&lt;br/&gt;                     &lt;multiValuesAllowed&gt;false&lt;/multiValuesAllowed&gt;&lt;br/&gt;                     &lt;values&gt;&lt;br/&gt;                        &lt;item&gt;&apos; || p_mode_factu || &apos;&lt;/item&gt;&lt;br/&gt;                     &lt;/values&gt;&lt;br/&gt;                  &lt;/item&gt;&lt;br/&gt;                &lt;/parameterNameValues&gt;&lt;br/&gt;                &lt;reportAbsolutePath xsi:type=&quot;xsd:string&quot;&gt;&apos; || p_abs_path || &apos;&lt;/reportAbsolutePath&gt;&apos;;&lt;br/&gt;&lt;br/&gt;    if (p_bi_version = &apos;10.1.3.4.0&apos;) then&lt;br/&gt;        l_env := l_env||&apos;&lt;sizeOfDataChunkDownload&gt;-1&lt;/sizeOfDataChunkDownload&gt;&apos;;&lt;br/&gt;        l_path := &apos;//runReportReturn&apos;;&lt;br/&gt;    end if;&lt;br/&gt;&lt;br/&gt;    l_env := l_env||&apos;&lt;/reportRequest&gt;&lt;br/&gt;            &lt;userID xsi:type=&quot;xsd:string&quot;&gt;&apos; || p_bi_login || &apos;&lt;/userID&gt;&lt;br/&gt;            &lt;password xsi:type=&quot;xsd:string&quot;&gt;&apos; || p_bi_pwd ||&apos;&lt;/password&gt;&lt;br/&gt;            &lt;/pub:runReport&gt;&lt;br/&gt;            &lt;/soapenv:Body&gt;&lt;br/&gt;            &lt;/soapenv:Envelope&gt;&apos;;&lt;br/&gt;&lt;br/&gt;    --url du service web&lt;br/&gt;    l_url := &apos;https://&apos; || p_bi_ip;&lt;br/&gt;&lt;br/&gt;    if (p_bi_port is not null) then&lt;br/&gt;        l_url := l_url || &apos;:&apos; || p_bi_port;&lt;br/&gt;    end if;&lt;br/&gt;    l_url := l_url||&apos;/xmlpserver/services/PublicReportService&apos;;&lt;br/&gt;&lt;br/&gt;    --appel du service web&lt;br/&gt;    l_xml := flex_ws_api.make_request(p_url =&gt; l_url, p_envelope =&gt; l_env );&lt;br/&gt;&lt;br/&gt;    if l_xml.existsNode(&apos;//faultstring&apos;) = 1 then&lt;br/&gt;        raise_application_error(-20001,l_xml.extract(&apos;//faultstring/text()&apos;).getStringVal());&lt;br/&gt;    end if;&lt;br/&gt;&lt;br/&gt;    --preparation du telechargement&lt;br/&gt;    l_mime := flex_ws_api.parse_xml(l_xml,l_path||&apos;/reportContentType/text()&apos;,p_ns);&lt;br/&gt;    l_base64 := flex_ws_api.parse_xml_clob(l_xml,l_path||&apos;/reportBytes/text()&apos;,p_ns);&lt;br/&gt;    l_blob := flex_ws_api.clobbase642blob(l_base64);&lt;br/&gt;    l_size := dbms_lob.getlength(l_blob);&lt;br/&gt;&lt;br/&gt;    --telechargement du fichier&lt;br/&gt;    htp.init;&lt;br/&gt;    owa_util.mime_header( nvl(l_mime,&apos;application/octet&apos;), FALSE );&lt;br/&gt;    htp.p(&apos;Content-length: &apos;||l_size);&lt;br/&gt;    htp.p(&apos;Content-Disposition: attachment; filename=&quot;&apos;||replace(replace(p_file_name,chr(10),null),chr(13),null)||&apos;&quot;&apos;);&lt;br/&gt;    owa_util.http_header_close;&lt;br/&gt;    wpg_docload.download_file( l_blob );&lt;br/&gt;    apex_application.g_unrecoverable_error := true;&lt;br/&gt;end;</source>
<body>CREATE OR REPLACE PROCEDURE                    AXIONEUSER_FACTU.P_FDSL_DL_RECAP_FACTU_SF (&lt;br/&gt;                                                       p_file_name in varchar2 default v(&apos;P32_FILENAME&apos;),&lt;br/&gt;                                                       p_format in varchar2 default v(&apos;P32_FORMAT&apos;),&lt;br/&gt;                                                       p_abs_path in varchar2 default v(&apos;P32_ABS_PATH&apos;),&lt;br/&gt;                                                       p_dsp in varchar2 default v(&apos;P32_DSP&apos;),&lt;br/&gt;                                                       p_fai in varchar2 default v(&apos;P32_FAI&apos;),&lt;br/&gt;                                                       p_techno in varchar2 default v(&apos;P32_TECHNO&apos;),&lt;br/&gt;                                                       p_terme_factu in varchar2 default v(&apos;P32_TERME_FACTU&apos;),&lt;br/&gt;                                                       p_mode_factu in varchar2 default v(&apos;P32_MODE_FACTU&apos;),&lt;br/&gt;                                                       p_bi_login in varchar2 default &apos;factu_sf&apos;,&lt;br/&gt;                                                       p_bi_pwd in varchar2 default &apos;factu_sf&apos;,&lt;br/&gt;                                                       p_bi_ip in varchar2 default v(&apos;BIPUB_SERVER&apos;),&lt;br/&gt;                                                       p_bi_port in varchar2 default v(&apos;BIPUB_PORT&apos;),&lt;br/&gt;                                                       p_bi_version in varchar2 default v(&apos;BIPUB_VERSION&apos;),&lt;br/&gt;                                                       p_ns in varchar2 default v(&apos;NS&apos;)&lt;br/&gt;                                                       ) AS&lt;br/&gt;/***************************************************************************************&lt;br/&gt;  *&lt;br/&gt;  *  AUTEUR       :  Yann Chauvel&lt;br/&gt;  *  DATE CREATION    :  30/06/2010&lt;br/&gt;  *  MAIL : yann.chauvel@axionesi.net&lt;br/&gt;  *&lt;br/&gt;  *  DESCRIPTION  :&lt;br/&gt;  *       { TELECHARGEMENT DES RAPPORTS BI PUBLISHER                 }&lt;br/&gt;  *       { Pour le récapitulatif factures SF                        }&lt;br/&gt;  *&lt;br/&gt;  *  PARAMETRES   :&lt;br/&gt;  *   ________________________________________________________________________&lt;br/&gt;  *  | No |  PARAMETRE  | DESCRIPTIF                   |   REGLE              |&lt;br/&gt;  *  |~~~~|~~~~~~~~~~~~~|~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|~~~~~~~~~~~~~~~~~~~~~~|&lt;br/&gt;  *  | 1  | p_file_name | nom du fichier               |                      |&lt;br/&gt;  *  | 1  | p_format    | format du fichier            | pdf, xls             |&lt;br/&gt;  *  | 2  | p_abs_path  | chemin d&apos;acces au rapport BI |                      |&lt;br/&gt;  *  | 3  | p_bi_login  | login du compte BI           |                      |&lt;br/&gt;  *  | 2  | p_bi_pwd    | mot de passe du compte BI    |                      |&lt;br/&gt;  *  | 2  | p_bi_ip     | IP du serveur BI             |                      |&lt;br/&gt;  *  | 2  | p_bi_port   | port du serveur BI           |                      |&lt;br/&gt;  *  | 2  | p_bi_version| version de BI Publisher      |                      |&lt;br/&gt;  *  | 2  | p_ns        | parametre xmlns              |                      |&lt;br/&gt;  *  |____|_____________|______________________________|______________________|&lt;br/&gt;  *&lt;br/&gt;  *&lt;br/&gt;  **************************************************************************************/&lt;br/&gt;&lt;br/&gt;    l_mime varchar2(48);&lt;br/&gt;    l_env clob;&lt;br/&gt;    l_base64 clob;&lt;br/&gt;    l_blob blob;&lt;br/&gt;    l_size number;&lt;br/&gt;    l_xml xmltype;&lt;br/&gt;    l_path varchar(255) default &apos;//multiRef&apos;;&lt;br/&gt;    l_url varchar2(4000);&lt;br/&gt;&lt;br/&gt;begin&lt;br/&gt;&lt;br/&gt;    -- prepartion de l&apos;appel du service web&lt;br/&gt;    -- enveloppe soap&lt;br/&gt;    l_env := &apos;&lt;soapenv:Envelope xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot;&lt;br/&gt;                xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot; xmlns:pub=&quot;http://xmlns.oracle.com/oxp/service/PublicReportService&quot; xmlns:soapenc=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;&gt;&lt;br/&gt;                &lt;soapenv:Header/&gt;&lt;br/&gt;                &lt;soapenv:Body&gt;&lt;br/&gt;                &lt;pub:runReport soapenv:encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;&gt;&lt;br/&gt;                &lt;reportRequest xsi:type=&quot;pub:ReportRequest&quot;&gt;&lt;br/&gt;                &lt;attributeFormat xsi:type=&quot;xsd:string&quot;&gt;&apos; || p_format || &apos;&lt;/attributeFormat&gt;&lt;br/&gt;                &lt;parameterNameValues&gt;&lt;br/&gt;                  &lt;item&gt;&lt;br/&gt;                     &lt;name&gt;DSP&lt;/name&gt;&lt;br/&gt;                     &lt;multiValuesAllowed&gt;false&lt;/multiValuesAllowed&gt;&lt;br/&gt;                     &lt;values&gt;&lt;br/&gt;                        &lt;item&gt;&apos; || p_dsp || &apos;&lt;/item&gt;&lt;br/&gt;                     &lt;/values&gt;&lt;br/&gt;                  &lt;/item&gt;&lt;br/&gt;                  &lt;item&gt;&lt;br/&gt;                     &lt;name&gt;FAI&lt;/name&gt;&lt;br/&gt;                     &lt;multiValuesAllowed&gt;false&lt;/multiValuesAllowed&gt;&lt;br/&gt;                     &lt;values&gt;&lt;br/&gt;                        &lt;item&gt;&apos; || p_fai || &apos;&lt;/item&gt;&lt;br/&gt;                     &lt;/values&gt;&lt;br/&gt;                  &lt;/item&gt;&lt;br/&gt;                  &lt;item&gt;&lt;br/&gt;                     &lt;name&gt;TECHNO&lt;/name&gt;&lt;br/&gt;                     &lt;multiValuesAllowed&gt;false&lt;/multiValuesAllowed&gt;&lt;br/&gt;                     &lt;values&gt;&lt;br/&gt;                        &lt;item&gt;&apos; || p_techno || &apos;&lt;/item&gt;&lt;br/&gt;                     &lt;/values&gt;&lt;br/&gt;                  &lt;/item&gt;&lt;br/&gt;                  &lt;item&gt;&lt;br/&gt;                     &lt;name&gt;TERME&lt;/name&gt;&lt;br/&gt;                     &lt;multiValuesAllowed&gt;false&lt;/multiValuesAllowed&gt;&lt;br/&gt;                     &lt;values&gt;&lt;br/&gt;                        &lt;item&gt;&apos; || p_terme_factu || &apos;&lt;/item&gt;&lt;br/&gt;                     &lt;/values&gt;&lt;br/&gt;                  &lt;/item&gt;&lt;br/&gt;                  &lt;item&gt;&lt;br/&gt;                     &lt;name&gt;MODES&lt;/name&gt;&lt;br/&gt;                     &lt;multiValuesAllowed&gt;false&lt;/multiValuesAllowed&gt;&lt;br/&gt;                     &lt;values&gt;&lt;br/&gt;                        &lt;item&gt;&apos; || p_mode_factu || &apos;&lt;/item&gt;&lt;br/&gt;                     &lt;/values&gt;&lt;br/&gt;                  &lt;/item&gt;&lt;br/&gt;                &lt;/parameterNameValues&gt;&lt;br/&gt;                &lt;reportAbsolutePath xsi:type=&quot;xsd:string&quot;&gt;&apos; || p_abs_path || &apos;&lt;/reportAbsolutePath&gt;&apos;;&lt;br/&gt;&lt;br/&gt;    if (p_bi_version = &apos;10.1.3.4.0&apos;) then&lt;br/&gt;        l_env := l_env||&apos;&lt;sizeOfDataChunkDownload&gt;-1&lt;/sizeOfDataChunkDownload&gt;&apos;;&lt;br/&gt;        l_path := &apos;//runReportReturn&apos;;&lt;br/&gt;    end if;&lt;br/&gt;&lt;br/&gt;    l_env := l_env||&apos;&lt;/reportRequest&gt;&lt;br/&gt;            &lt;userID xsi:type=&quot;xsd:string&quot;&gt;&apos; || p_bi_login || &apos;&lt;/userID&gt;&lt;br/&gt;            &lt;password xsi:type=&quot;xsd:string&quot;&gt;&apos; || p_bi_pwd ||&apos;&lt;/password&gt;&lt;br/&gt;            &lt;/pub:runReport&gt;&lt;br/&gt;            &lt;/soapenv:Body&gt;&lt;br/&gt;            &lt;/soapenv:Envelope&gt;&apos;;&lt;br/&gt;&lt;br/&gt;    --url du service web&lt;br/&gt;    l_url := &apos;https://&apos; || p_bi_ip;&lt;br/&gt;&lt;br/&gt;    if (p_bi_port is not null) then&lt;br/&gt;        l_url := l_url || &apos;:&apos; || p_bi_port;&lt;br/&gt;    end if;&lt;br/&gt;    l_url := l_url||&apos;/xmlpserver/services/PublicReportService&apos;;&lt;br/&gt;&lt;br/&gt;    --appel du service web&lt;br/&gt;    l_xml := flex_ws_api.make_request(p_url =&gt; l_url, p_envelope =&gt; l_env );&lt;br/&gt;&lt;br/&gt;    if l_xml.existsNode(&apos;//faultstring&apos;) = 1 then&lt;br/&gt;        raise_application_error(-20001,l_xml.extract(&apos;//faultstring/text()&apos;).getStringVal());&lt;br/&gt;    end if;&lt;br/&gt;&lt;br/&gt;    --preparation du telechargement&lt;br/&gt;    l_mime := flex_ws_api.parse_xml(l_xml,l_path||&apos;/reportContentType/text()&apos;,p_ns);&lt;br/&gt;    l_base64 := flex_ws_api.parse_xml_clob(l_xml,l_path||&apos;/reportBytes/text()&apos;,p_ns);&lt;br/&gt;    l_blob := flex_ws_api.clobbase642blob(l_base64);&lt;br/&gt;    l_size := dbms_lob.getlength(l_blob);&lt;br/&gt;&lt;br/&gt;    --telechargement du fichier&lt;br/&gt;    htp.init;&lt;br/&gt;    owa_util.mime_header( nvl(l_mime,&apos;application/octet&apos;), FALSE );&lt;br/&gt;    htp.p(&apos;Content-length: &apos;||l_size);&lt;br/&gt;    htp.p(&apos;Content-Disposition: attachment; filename=&quot;&apos;||replace(replace(p_file_name,chr(10),null),chr(13),null)||&apos;&quot;&apos;);&lt;br/&gt;    owa_util.http_header_close;&lt;br/&gt;    wpg_docload.download_file( l_blob );&lt;br/&gt;    apex_application.g_unrecoverable_error := true;&lt;br/&gt;end;</body>
</StoredProcedureOraclev10g>