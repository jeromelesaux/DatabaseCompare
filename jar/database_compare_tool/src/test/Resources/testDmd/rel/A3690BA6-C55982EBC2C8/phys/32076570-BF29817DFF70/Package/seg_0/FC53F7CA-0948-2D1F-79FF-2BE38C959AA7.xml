<?xml version = '1.0' encoding = 'UTF-8'?>
<PackageOracle class="oracle.dbtools.crest.model.design.storage.oracle.PackageOracle" name="PCK_FACTU_PRO" id="FC53F7CA-0948-2D1F-79FF-2BE38C959AA7" directorySegmentName="seg_0">
<sourceConnName>DEV57_AXIONEUSER_FACTU</sourceConnName>
<sourceObjSchema>AXIONEUSER_FACTU</sourceObjSchema>
<sourceObjName>PCK_FACTU_PRO</sourceObjName>
<createdBy>R.WATH</createdBy>
<createdTime>2012-12-04 10:06:39 UTC</createdTime>
<generatorID>Généré par l&apos;utilisateur</generatorID>
<ownerDesignName>ST-SYS-SIB-BD_FCTPRO-000009-8 MCD-FACTUPRO V4.5.0</ownerDesignName>
<owner>4FCC3A6A-181E-A36A-613B-7868309493E2</owner>
<source>create or replace PACKAGE AXIONEUSER_FACTU.PCK_FACTU_PRO AS&lt;br/&gt;&lt;br/&gt;/***************************************************************************************&lt;br/&gt;  *&lt;br/&gt;  *  AUTEUR           :  Yann Chauvel&lt;br/&gt;  *  DATE CREATION    :  19/05/2010&lt;br/&gt;  *  MAIL : yann.chauvel@axionesi.net&lt;br/&gt;  *&lt;br/&gt;  *  DATE MODIFICATION   :  28/07/2011&lt;br/&gt;  *  MAIL : pascal.spinat.prestataire@axionesi.net&lt;br/&gt;  *&lt;br/&gt;  *  DESCRIPTION  :&lt;br/&gt;  *       { Package regroupant tous les outils nécessaire au calcul  }&lt;br/&gt;  *       { de la facturation PRO avec les données issues de SF      }&lt;br/&gt;  *&lt;br/&gt;  *  TABLES UTILISEES :&lt;br/&gt;  *   _________________________________________________________________&lt;br/&gt;  *  | TBL|  NOM TABLE                                     | LEC | ECR |&lt;br/&gt;  *  |~~~~|~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|~~~~~|~~~~~|&lt;br/&gt;  *  | 1  | T_FDSL_SERVICE_SF                              |  X  |  X  |&lt;br/&gt;  *  | 2  | T_FDSL_HISTO_SERVICE_SF                        |  X  |  X  |&lt;br/&gt;  *  | 3  | T_FDSL_DETAIL_FACTURE                          |  X  |  X  |&lt;br/&gt;  *  | 4  | T_FDSL_HISTO_DETAIL_FACTURE                    |  X  |  X  |&lt;br/&gt;  *  | 5  | T_FDSL_RECAP_FACTURE                           |  X  |  X  |&lt;br/&gt;  *  | 6  | T_FDSL_HISTO_RECAP_FACTURE                     |     |  X  |&lt;br/&gt;  *  | 7  | T_FDSL_COMPTA_FACTURE                          |  X  |  X  |&lt;br/&gt;  *  | 8  | T_FDSL_HISTO_COMPTA_FACTURE                    |  X  |  X  |&lt;br/&gt;  *  |____|________________________________________________|_____|_____|&lt;br/&gt;  *&lt;br/&gt;  *  PROCEDURES et FONCTIONS du PACKAGE :&lt;br/&gt;  *   __________________________________________________________________________________________________________&lt;br/&gt;  *  | No |  NOM PROCEDURE               |       DESCRIPTIF                                                     |&lt;br/&gt;  *  |~~~~|~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|&lt;br/&gt;  *  | 1  | F_AncienAbo                  | Récupération de l&apos;ancien abonnement et DE                            |&lt;br/&gt;  *  | 2  | F_InsertLigneDetailFactu     | Insert dans T_FDSL_DETAIL_FACTURE                                    |&lt;br/&gt;  *  | 3  | F_InsertLignesRecapFactu     | Insert dans T_FDSL_RECAP_FACTURE                                     |&lt;br/&gt;  *  | 4  | F_DeleteLignesRecapFactu     | Suppression dans T_FDSL_RECAP_FACTURE                                |&lt;br/&gt;  *  | 5  | F_FactuFASPFROIRU            | Calcul des FAS/PFRO/IRU                                              |&lt;br/&gt;  *  | 6  | F_FactuAbo                   | Calcul Abonnement et prorata de MES                                  |&lt;br/&gt;  *  | 7  | F_FactuAboProrata            | Calcul Abonnement et prorata MES et jours                            |&lt;br/&gt;  *  | 8  | F_FactuResil                 | Calcul Résiliation                                                   |&lt;br/&gt;  *  | 9  | F_FactuResilProrata          | Calcul Résiliation et prorata jours                                  |&lt;br/&gt;  *  | 10 | F_UpDown                     | Calcul Prorata Upgrade et Downgrade                                  |&lt;br/&gt;  *  | 11 | F_UpDownProrata              | Calcul Prorata jours Upgrade et Downgrade                            |&lt;br/&gt;  *  | 12 | P_InsertServiceSF            | Insertion dans T_FDSL_SERVICE_SF                                     |&lt;br/&gt;  *  | 13 | P_InsertComptaFactu          | Toute commande facturée + non facturée                               |&lt;br/&gt;  *  | 14 | P_InsertDetailFactu          | Algorithme principale pour détail facture                            |&lt;br/&gt;  *  | 15 | P_InsertRecapFactu           | Insertion dans la table de récap                                     |&lt;br/&gt;  *  | 16 | P_HistoServiceSF             | Historisation données sources Service SF                             |&lt;br/&gt;  *  | 17 | P_HistoComptaFactu           | Historisation compta facture                                         |&lt;br/&gt;  *  | 18 | P_HistoDetailFactu           | Historisation détail facture                                         |&lt;br/&gt;  *  | 19 | P_HistoRecapFactu            | Historisation recap facture                                          |&lt;br/&gt;  *  | 20 | P_ArchiServiceSF             | Archivage des données sources Service SF                             |&lt;br/&gt;  *  | 21 | P_ArchiComptafactu           | Archivage des données sources Compta Factu                           |&lt;br/&gt;  *  | 22 | P_ArchiDetailRecap           | Archivage des données du mois en parametre                           |&lt;br/&gt;  *  | 23 | P_UpdateDetailMail           | Ajout des destinaires mails ADV                                      |&lt;br/&gt;  *  | 24 | P_InsertFactureSF            | Lancement des calculs de facturation                                 |&lt;br/&gt;  *  | 25 | P_ArchiFactureSF             | Lancement de l&apos;archivage des données                                 |&lt;br/&gt;  *  | 26 | P_InitialiserDetailFactu     | Initialisation des valeurs pour insertion dans T_FDSL_DETAIL_FACTURE |&lt;br/&gt;  *  | 27 | P_InsertHistoComptaHisto     | Historisation de l&apos;histo service et facture dans l&apos;histo compta      |&lt;br/&gt;  *  |___ |______________________________|______________________________________________________________________|&lt;br/&gt;  *&lt;br/&gt;  * /////////////////////////////////////////////////////////////////////////////////////&lt;br/&gt;  *      CODE INDENTE AVEC 2 ESPACES&lt;br/&gt;  * /////////////////////////////////////////////////////////////////////////////////////&lt;br/&gt;  *&lt;br/&gt;  * NB : La procédure P_InsertFactureSF est le point de départ du package&lt;br/&gt;  *&lt;br/&gt;  * Note de L&apos;auteur : L&apos;algoritme de certaines fonctions/procédures n&apos;est pas optimisé&lt;br/&gt;  *                    par soucis de compréhension (enfin si on y arrive)&lt;br/&gt;  *&lt;br/&gt;  **************************************************************************************/&lt;br/&gt;&lt;br/&gt;-- HLE 03/04/2012 : prise en compte de la story 432&lt;br/&gt;-- le champ TARIF_FORFAIT n est plus alimenté dans SF pour TRANSIT IP&lt;br/&gt;-- alors mettre montant abo dans tarif forfait uniquement pour TRANSIT IP&lt;br/&gt;&lt;br/&gt;-- ADS 30/03/2012 : Prise en compte de la Story 436:&lt;br/&gt;-- Valorisation du champ &quot;DATE_FIN_ENGAGEMENT&quot; dans les tables:&lt;br/&gt;-- T_FDSL_SERVICE_SF&lt;br/&gt;-- T_SF_SERVICE&lt;br/&gt;-- T_FDSL_COMPTA_FACTURE&lt;br/&gt;-- T_FDSL_DETAIL_FACTURE&lt;br/&gt;-- T_FDSL_HISTO_DETAIL_FACTURE&lt;br/&gt;-- T_FDSL_HISTO_SERVICE_SF&lt;br/&gt;&lt;br/&gt;-- Le champ &quot;DUREE_ENGAGEMENT&quot; n&apos;etant plus alimente SalesForce, il est maintenant calcule&lt;br/&gt;-- dans le package, en soustrayant &quot;DATE_MES_EFFECTIVE&quot; a &quot;DATE_FIN_ENGAGEMENT&quot;&lt;br/&gt;&lt;br/&gt;-- ADS 05/04/2012 : Prise en compte de la Story 431:&lt;br/&gt;-- arrondi des montants a 2 decimales&lt;br/&gt;-- Modification de la formule de calcul de prorata (en modification, dans le cas d&apos;un remboursement et si date de modif &gt; date fin engagement,&lt;br/&gt;-- le jour de la modif doit être facturee a l&apos;ancien tarif ).&lt;br/&gt;&lt;br/&gt;-- ADS 11/04/2012 : Prise en compte de la Story 428&lt;br/&gt;-- Formule modifiee, on ne rajoute plus 1 jour supplementaire dans le calcul du nombre de jours de la date de &quot;DateFinEngagement&quot;&lt;br/&gt;&lt;br/&gt;-- ADS 25/05/2012 : Prise en compte de la Story 529&lt;br/&gt;-- Suppression des &quot;MONTANT&quot; = 0 pour les &quot;LIB_TYPE_PRESTA&quot; contenant &quot;LOCATION%&quot;&lt;br/&gt;&lt;br/&gt;-- ADS 12/10/2012 : Prise en compte de la Story (URL855)&lt;br/&gt;-- Modification de la table T_FDSL_SERVICE_SF pour y ajouter les champs PROFIL, CODE_POSTAL, ADRESSE LIGNE 1.&lt;br/&gt;-- Les noms des champs sont: PROFIL__C, CP__C, ADRESSE_1__C, ces champs sont propages dans toutes les tables intermediares&lt;br/&gt;&lt;br/&gt;--ALE 12/02/2013 : remontee du champ TYPE_VENTE__C&lt;br/&gt;&lt;br/&gt;FUNCTION F_AncienAbo(pLigne IN T_FDSL_SERVICE_SF%ROWTYPE, pAbo OUT NUMBER, pDE OUT NUMBER, pLoc OUT NUMBER,  pMsg OUT VARCHAR2) RETURN INTEGER;&lt;br/&gt;&lt;br/&gt;FUNCTION F_InsertLigneDetailFactu (pLigneDetailFactu IN T_FDSL_DETAIL_FACTURE%ROWTYPE) RETURN INTEGER;&lt;br/&gt;&lt;br/&gt;FUNCTION F_InsertLignesRecapFactu (pDSP IN T_FDSL_DETAIL_FACTURE.DSP%TYPE, pFAI IN T_FDSL_DETAIL_FACTURE.FAI%TYPE, pTechno IN T_FDSL_DETAIL_FACTURE.TECHNO%TYPE) RETURN INTEGER;&lt;br/&gt;&lt;br/&gt;FUNCTION F_DeleteLignesRecapFactu (pDSP IN T_FDSL_DETAIL_FACTURE.DSP%TYPE, pFAI IN T_FDSL_DETAIL_FACTURE.FAI%TYPE, pTechno IN T_FDSL_DETAIL_FACTURE.TECHNO%TYPE) RETURN INTEGER;&lt;br/&gt;&lt;br/&gt;FUNCTION F_FactuFASPFROIRU (pLigne IN T_FDSL_SERVICE_SF%ROWTYPE, pDateCalcFactu IN DATE, pMontantFAS OUT NUMBER, pMontantPFRO OUT NUMBER, pMontantIRU OUT NUMBER) RETURN INTEGER;&lt;br/&gt;&lt;br/&gt;FUNCTION F_FactuAbo (pLigne IN T_FDSL_SERVICE_SF%ROWTYPE, pDateCalcFactu IN DATE, pMontant OUT NUMBER, pMontantProrata OUT NUMBER, pLibelleProrata OUT VARCHAR2, pLibTypePrestaProrata OUT VARCHAR2, pLibPeriodeDebProrata OUT DATE, pLibPeriodeFinProrata OUT DATE, pFacteur IN NUMBER, pMoisInclus IN BOOLEAN) RETURN INTEGER;&lt;br/&gt;&lt;br/&gt;FUNCTION F_FactuAboProrata (pLigne IN T_FDSL_SERVICE_SF%ROWTYPE, pDateCalcFactu IN DATE, pTypePresta varchar2,  pMontant OUT NUMBER, pMontantProrata OUT NUMBER, pLibelleProrata OUT VARCHAR2, pLibTypePrestaProrata OUT VARCHAR2, pLibPeriodeDebProrata OUT DATE, pLibPeriodeFinProrata OUT DATE, pFacteur IN NUMBER, pMoisInclus IN BOOLEAN) RETURN INTEGER;&lt;br/&gt;&lt;br/&gt;FUNCTION F_FactuResil (pLigne IN T_FDSL_SERVICE_SF%ROWTYPE, pDateCalcFactu IN DATE, pMontant OUT NUMBER, pMontantFAS OUT NUMBER, pFacteur IN NUMBER, pMoisInclus IN BOOLEAN, pLibTypePresta OUT VARCHAR2, pLibPeriodeDeb OUT DATE, pLibPeriodeFin OUT DATE, pMsg OUT VARCHAR2) RETURN INTEGER;&lt;br/&gt;&lt;br/&gt;FUNCTION F_FactuResilProrata (pLigne IN T_FDSL_SERVICE_SF%ROWTYPE, pDateCalcFactu IN DATE, pMontant OUT NUMBER, pMontantLocation OUT NUMBER, pMontantFAS OUT NUMBER, pFacteur IN NUMBER, pMoisInclus IN BOOLEAN, pLibTypePresta OUT VARCHAR2, pLibPeriodeDeb OUT DATE, pLibPeriodeFin OUT DATE, pMsg OUT VARCHAR2) RETURN INTEGER;&lt;br/&gt;&lt;br/&gt;FUNCTION F_UpDown (pLigne IN T_FDSL_SERVICE_SF%ROWTYPE, pDateCalcFactu IN Date, pMontant OUT NUMBER, pMontantFAS OUT NUMBER, pFacteur IN NUMBER, pMoisInclus IN BOOLEAN, pLibPeriodeDeb OUT DATE, pLibPeriodeFin OUT DATE, pMsg OUT VARCHAR2) RETURN INTEGER;&lt;br/&gt;&lt;br/&gt;FUNCTION F_UpDownProrata (pLigne IN T_FDSL_SERVICE_SF%ROWTYPE, pDateCalcFactu IN Date, pTypePresta varchar2, pMontant OUT NUMBER, pMontantFAS OUT NUMBER, pFacteur IN NUMBER, pMoisInclus IN BOOLEAN, pLibPeriodeDeb OUT DATE, pLibPeriodeFin OUT DATE, pMsg OUT VARCHAR2,pTestMotifModif IN BOOLEAN) RETURN INTEGER;&lt;br/&gt;&lt;br/&gt;PROCEDURE P_InsertFactureSF (pDateCalcFactu IN DATE);&lt;br/&gt;&lt;br/&gt;PROCEDURE P_InsertServiceSF (pDateCalcFactu IN DATE);&lt;br/&gt;&lt;br/&gt;PROCEDURE P_InsertComptaFactu (pDateCalcFactu IN DATE);&lt;br/&gt;&lt;br/&gt;PROCEDURE P_InsertHistoComptaHisto (pDateCalcFactu IN DATE);&lt;br/&gt;&lt;br/&gt;PROCEDURE P_InsertDetailFactu (pDateCalcFactu IN DATE);&lt;br/&gt;&lt;br/&gt;PROCEDURE P_InsertRecapFactu;&lt;br/&gt;&lt;br/&gt;PROCEDURE P_HistoServiceSF(pMois IN NUMBER, pAnnee IN NUMBER);&lt;br/&gt;&lt;br/&gt;PROCEDURE P_HistoComptaFactu(pMois IN NUMBER, pAnnee IN NUMBER);&lt;br/&gt;&lt;br/&gt;&lt;br/&gt;PROCEDURE P_HistoDetailFactu(pMois IN NUMBER, pAnnee IN NUMBER);&lt;br/&gt;&lt;br/&gt;PROCEDURE P_HistoRecapFactu(pMois IN NUMBER, pAnnee IN NUMBER);&lt;br/&gt;&lt;br/&gt;PROCEDURE P_ArchiFactureSF(pMois IN NUMBER,pAnnee IN NUMBER);&lt;br/&gt;&lt;br/&gt;PROCEDURE P_ArchiServiceSF(pMois IN NUMBER,pAnnee IN NUMBER);&lt;br/&gt;&lt;br/&gt;PROCEDURE P_ArchiComptaFactu(pMois IN NUMBER,pAnnee IN NUMBER);&lt;br/&gt;&lt;br/&gt;PROCEDURE P_ArchiDetailRecap(pMois IN NUMBER,pAnnee IN NUMBER);&lt;br/&gt;&lt;br/&gt;PROCEDURE P_UpdateDetailMail;&lt;br/&gt;&lt;br/&gt;PROCEDURE P_UpdateMailDetailNewLigne( listIdService varchar2);&lt;br/&gt;&lt;br/&gt;procedure P_DeterminerMoisInclus(codeRetour IN OUT INTEGER&lt;br/&gt;   ,enr IN OUT T_FDSL_SERVICE_SF%ROWTYPE&lt;br/&gt;   ,pLigneDetailFactu IN OUT T_FDSL_DETAIL_FACTURE%ROWTYPE&lt;br/&gt;   ,vFacteur IN OUT NUMBER&lt;br/&gt;   ,vMois IN  NUMBER&lt;br/&gt;   ,vMoisInclus IN OUT BOOLEAN&lt;br/&gt;   ,vTraitementLigne IN OUT BOOLEAN&lt;br/&gt;   ) ;&lt;br/&gt;&lt;br/&gt;   procedure P_InitialiserDetailFactu(enr IN OUT T_FDSL_SERVICE_SF%ROWTYPE&lt;br/&gt;   ,pDateCalcFactu IN  Date&lt;br/&gt;   ,pLigneDetailFactu IN OUT T_FDSL_DETAIL_FACTURE%ROWTYPE&lt;br/&gt;   ,vAnnee IN  NUMBER&lt;br/&gt;   ,vMois IN  NUMBER&lt;br/&gt;   );&lt;br/&gt;&lt;br/&gt; PROCEDURE P_MAJ_MONTANT( P_ID_FDSL_DETAIL_FACTURE 	IN Number&lt;br/&gt;						, P_CONSOMMATION 			IN Number&lt;br/&gt;						, P_TARIF_FORFAIT 			IN Number&lt;br/&gt;						, P_SEUIL 					IN Number&lt;br/&gt;						, P_TARIF_DEPASS 			IN Number);&lt;br/&gt;&lt;br/&gt;   procedure P_FactureProrataTemporis(codeRetour IN OUT INTEGER&lt;br/&gt;   ,enr IN OUT T_FDSL_SERVICE_SF%ROWTYPE&lt;br/&gt;   ,pDateCalcFactu IN Date&lt;br/&gt;   ,pLigneDetailFactu IN OUT T_FDSL_DETAIL_FACTURE%ROWTYPE&lt;br/&gt;   ,vFacteur IN OUT NUMBER&lt;br/&gt;   ,vLibPeriodeDeb IN OUT T_FDSL_DETAIL_FACTURE.LIB_PERIODE_DEB%TYPE&lt;br/&gt;   ,vLibPeriodeDebProrata IN OUT T_FDSL_DETAIL_FACTURE.LIB_PERIODE_DEB%TYPE&lt;br/&gt;   ,vLibPeriodeFin IN OUT T_FDSL_DETAIL_FACTURE.LIB_PERIODE_FIN%TYPE&lt;br/&gt;   ,vLibPeriodeFinProrata IN OUT T_FDSL_DETAIL_FACTURE.LIB_PERIODE_FIN%TYPE&lt;br/&gt;   ,vLibTypePresta IN OUT T_FDSL_DETAIL_FACTURE.LIB_TYPE_PRESTA%TYPE&lt;br/&gt;   ,vLibTypePrestaProrata IN OUT T_FDSL_DETAIL_FACTURE.LIB_TYPE_PRESTA%TYPE&lt;br/&gt;   ,vLibelleProrata IN OUT T_FDSL_DETAIL_FACTURE.LIBELLE%TYPE&lt;br/&gt;   ,vMoisInclus IN OUT BOOLEAN&lt;br/&gt;   ,vMontant IN OUT T_FDSL_DETAIL_FACTURE.MONTANT%TYPE&lt;br/&gt;   ,vMontantFAS IN OUT T_FDSL_DETAIL_FACTURE.MONTANT%TYPE&lt;br/&gt;   ,vMontantProrata IN OUT T_FDSL_DETAIL_FACTURE.MONTANT%TYPE&lt;br/&gt;   ,vMsg IN OUT T_FDSL_DETAIL_FACTURE.DETAIL_ANALYSE%TYPE&lt;br/&gt;   ,vTestMotifModif IN OUT BOOLEAN&lt;br/&gt;&lt;br/&gt;   );&lt;br/&gt;END;</source>
<body class="oracle.dbtools.crest.model.design.storage.oracle.PackageBodyOracle" name="PCK_FACTU_PRO" id="FC53F7CA-0948-2D1F-79FF-2BE38C959AA7">
<sourceConnName>DEV57_AXIONEUSER_FACTU</sourceConnName>
<sourceObjSchema>AXIONEUSER_FACTU</sourceObjSchema>
<sourceObjName>PCK_FACTU_PRO</sourceObjName>
<createdBy>R.WATH</createdBy>
<createdTime>2012-12-04 10:06:40 UTC</createdTime>
<generatorID>Généré par l&apos;utilisateur</generatorID>
<owner>4FCC3A6A-181E-A36A-613B-7868309493E2</owner>
<source>CREATE OR REPLACE PACKAGE PCK_FACTU_PRO AS&lt;br/&gt;                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;/***************************************************************************************                                                                                                                                                                                                                                                                      &lt;br/&gt;  *                                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;  *  AUTEUR           :  Yann Chauvel                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;  *  DATE CREATION    :  19/05/2010                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;  *  MAIL : yann.chauvel@axionesi.net                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;  *                                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;  *  DATE MODIFICATION   :  28/07/2011                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;  *  MAIL : pascal.spinat.prestataire@axionesi.net                                                                                                                                                                                                                                                                                                            &lt;br/&gt;  *                                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;  *  DESCRIPTION  :                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;  *       { Package regroupant tous les outils nécessaire au calcul  }                                                                                                                                                                                                                                                                                        &lt;br/&gt;  *       { de la facturation PRO avec les données issues de SF      }                                                                                                                                                                                                                                                                                        &lt;br/&gt;  *                                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;  *  TABLES UTILISEES :                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;  *   _________________________________________________________________                                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | TBL|  NOM TABLE                                     | LEC | ECR |                                                                                                                                                                                                                                                                                      &lt;br/&gt;  *  |~~~~|~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|~~~~~|~~~~~|                                                                                                                                                                                                                                                                                      &lt;br/&gt;  *  | 1  | T_FDSL_SERVICE_SF                              |  X  |  X  |                                                                                                                                                                                                                                                                                      &lt;br/&gt;  *  | 2  | T_FDSL_HISTO_SERVICE_SF                        |  X  |  X  |                                                                                                                                                                                                                                                                                      &lt;br/&gt;  *  | 3  | T_FDSL_DETAIL_FACTURE                          |  X  |  X  |                                                                                                                                                                                                                                                                                      &lt;br/&gt;  *  | 4  | T_FDSL_HISTO_DETAIL_FACTURE                    |  X  |  X  |                                                                                                                                                                                                                                                                                      &lt;br/&gt;  *  | 5  | T_FDSL_RECAP_FACTURE                           |  X  |  X  |                                                                                                                                                                                                                                                                                      &lt;br/&gt;  *  | 6  | T_FDSL_HISTO_RECAP_FACTURE                     |     |  X  |                                                                                                                                                                                                                                                                                      &lt;br/&gt;  *  | 7  | T_FDSL_COMPTA_FACTURE                          |  X  |  X  |                                                                                                                                                                                                                                                                                      &lt;br/&gt;  *  | 8  | T_FDSL_HISTO_COMPTA_FACTURE                    |  X  |  X  |                                                                                                                                                                                                                                                                                      &lt;br/&gt;  *  |____|________________________________________________|_____|_____|                                                                                                                                                                                                                                                                                      &lt;br/&gt;  *                                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;  *  PROCEDURES et FONCTIONS du PACKAGE :                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;  *   __________________________________________________________________________________________________________                                                                                                                                                                                                                                                                        &lt;br/&gt;  *  | No |  NOM PROCEDURE               |       DESCRIPTIF                                                     |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  |~~~~|~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 1  | F_AncienAbo                  | Récupération de l&apos;ancien abonnement et DE                            |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 2  | F_InsertLigneDetailFactu     | Insert dans T_FDSL_DETAIL_FACTURE                                    |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 3  | F_InsertLignesRecapFactu     | Insert dans T_FDSL_RECAP_FACTURE                                     |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 4  | F_DeleteLignesRecapFactu     | Suppression dans T_FDSL_RECAP_FACTURE                                |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 5  | F_FactuFASPFROIRU            | Calcul des FAS/PFRO/IRU                                              |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 6  | F_FactuAbo                   | Calcul Abonnement et prorata de MES                                  |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 7  | F_FactuAboProrata            | Calcul Abonnement et prorata MES et jours                            |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 8  | F_FactuResil                 | Calcul Résiliation                                                   |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 9  | F_FactuResilProrata          | Calcul Résiliation et prorata jours                                  |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 10 | F_UpDown                     | Calcul Prorata Upgrade et Downgrade                                  |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 11 | F_UpDownProrata              | Calcul Prorata jours Upgrade et Downgrade                            |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 12 | P_InsertServiceSF            | Insertion dans T_FDSL_SERVICE_SF                                     |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 13 | P_InsertComptaFactu          | Toute commande facturée + non facturée                               |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 14 | P_InsertDetailFactu          | Algorithme principale pour détail facture                            |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 15 | P_InsertRecapFactu           | Insertion dans la table de récap                                     |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 16 | P_HistoServiceSF             | Historisation données sources Service SF                             |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 17 | P_HistoComptaFactu           | Historisation compta facture                                         |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 18 | P_HistoDetailFactu           | Historisation détail facture                                         |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 19 | P_HistoRecapFactu            | Historisation recap facture                                          |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 20 | P_ArchiServiceSF             | Archivage des données sources Service SF                             |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 21 | P_ArchiComptafactu           | Archivage des données sources Compta Factu                           |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 22 | P_ArchiDetailRecap           | Archivage des données du mois en parametre                           |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 23 | P_UpdateDetailMail           | Ajout des destinaires mails ADV                                      |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 24 | P_InsertFactureSF            | Lancement des calculs de facturation                                 |                                                                                                                                                                                                                                                                       &lt;br/&gt;  *  | 25 | P_ArchiFactureSF             | Lancement de l&apos;archivage des données                                 |&lt;br/&gt;  *  | 26 | P_InitialiserDetailFactu     | Initialisation des valeurs pour insertion dans T_FDSL_DETAIL_FACTURE |&lt;br/&gt;  *  | 27 | P_InsertHistoComptaHisto     | Historisation de l&apos;histo service et facture dans l&apos;histo compta      |&lt;br/&gt;  *  | 28 | F_CalculDateFinPeriod        | Calcul date de Fin de période de facturation                         |&lt;br/&gt;  *  |___ |______________________________|______________________________________________________________________|                                                                                                                                                                                                                                                                       &lt;br/&gt;  *                                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;  * /////////////////////////////////////////////////////////////////////////////////////                                                                                                                                                                                                                                                                     &lt;br/&gt;  *      CODE INDENTE AVEC 2 ESPACES                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  * /////////////////////////////////////////////////////////////////////////////////////                                                                                                                                                                                                                                                                     &lt;br/&gt;  *                                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;  * NB : La procédure P_InsertFactureSF est le point de départ du package                                                                                                                                                                                                                                                                                     &lt;br/&gt;  *                                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;  * Note de L&apos;auteur : L&apos;algoritme de certaines fonctions/procédures n&apos;est pas optimisé                                                                                                                                                                                                                                                                       &lt;br/&gt;  *                    par soucis de compréhension (enfin si on y arrive)                                                                                                                                                                                                                                                                                     &lt;br/&gt;  *                                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;  **************************************************************************************/                                                                                                                                                                                                                                                                     &lt;br/&gt;&lt;br/&gt;-- HLE 03/04/2012 : prise en compte de la story 432&lt;br/&gt;-- le champ TARIF_FORFAIT n est plus alimenté dans SF pour TRANSIT IP&lt;br/&gt;-- alors mettre montant abo dans tarif forfait uniquement pour TRANSIT IP &lt;br/&gt;&lt;br/&gt;-- ADS 30/03/2012 : Prise en compte de la Story 436:&lt;br/&gt;-- Valorisation du champ &quot;DATE_FIN_ENGAGEMENT&quot; dans les tables:&lt;br/&gt;-- T_FDSL_SERVICE_SF&lt;br/&gt;-- T_SF_SERVICE&lt;br/&gt;-- T_FDSL_COMPTA_FACTURE&lt;br/&gt;-- T_FDSL_DETAIL_FACTURE&lt;br/&gt;-- T_FDSL_HISTO_DETAIL_FACTURE&lt;br/&gt;-- T_FDSL_HISTO_SERVICE_SF&lt;br/&gt;&lt;br/&gt;-- Le champ &quot;DUREE_ENGAGEMENT&quot; n&apos;etant plus alimente SalesForce, il est maintenant calcule &lt;br/&gt;-- dans le package, en soustrayant &quot;DATE_MES_EFFECTIVE&quot; a &quot;DATE_FIN_ENGAGEMENT&quot;&lt;br/&gt;&lt;br/&gt;-- ADS 05/04/2012 : Prise en compte de la Story 431:&lt;br/&gt;-- arrondi des montants a 2 decimales&lt;br/&gt;-- Modification de la formule de calcul de prorata (en modification, dans le cas d&apos;un remboursement et si date de modif &gt; date fin engagement,&lt;br/&gt;-- le jour de la modif doit être facturee a l&apos;ancien tarif ).&lt;br/&gt;&lt;br/&gt;-- ADS 11/04/2012 : Prise en compte de la Story 428&lt;br/&gt;-- Formule modifiee, on ne rajoute plus 1 jour supplementaire dans le calcul du nombre de jours de la date de &quot;DateFinEngagement&quot;&lt;br/&gt;&lt;br/&gt;-- ADS 25/05/2012 : Prise en compte de la Story 529&lt;br/&gt;-- Suppression des &quot;MONTANT&quot; = 0 pour les &quot;LIB_TYPE_PRESTA&quot; contenant &quot;LOCATION%&quot;&lt;br/&gt;&lt;br/&gt;-- ADS 12/10/2012 : Prise en compte de la Story (URL855)&lt;br/&gt;-- Modification de la table T_FDSL_SERVICE_SF pour y ajouter les champs PROFIL, CODE_POSTAL, ADRESSE LIGNE 1.&lt;br/&gt;-- Les noms des champs sont: PROFIL__C, CP__C, ADRESSE_1__C, ces champs sont propages dans toutes les tables intermediares&lt;br/&gt;&lt;br/&gt;--ALE 12/02/2013 : remontee du champ TYPE_VENTE__C&lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;FUNCTION F_AncienAbo(pLigne IN T_FDSL_SERVICE_SF%ROWTYPE, pAbo OUT NUMBER, pDE OUT NUMBER, pLoc OUT NUMBER,  pMsg OUT VARCHAR2) RETURN INTEGER;                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;FUNCTION F_InsertLigneDetailFactu (pLigneDetailFactu IN T_FDSL_DETAIL_FACTURE%ROWTYPE) RETURN INTEGER;                                                                                                                                                                                                                                                        &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;FUNCTION F_InsertLignesRecapFactu (pDSP IN T_FDSL_DETAIL_FACTURE.DSP%TYPE, pFAI IN T_FDSL_DETAIL_FACTURE.FAI%TYPE, pTechno IN T_FDSL_DETAIL_FACTURE.TECHNO%TYPE) RETURN INTEGER;                                                                                                                                                                              &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;FUNCTION F_DeleteLignesRecapFactu (pDSP IN T_FDSL_DETAIL_FACTURE.DSP%TYPE, pFAI IN T_FDSL_DETAIL_FACTURE.FAI%TYPE, pTechno IN T_FDSL_DETAIL_FACTURE.TECHNO%TYPE) RETURN INTEGER;                                                                                                                                                                              &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;FUNCTION F_FactuFASPFROIRU (pLigne IN T_FDSL_SERVICE_SF%ROWTYPE, pDateCalcFactu IN DATE, pMontantFAS OUT NUMBER, pMontantPFRO OUT NUMBER, pMontantIRU OUT NUMBER) RETURN INTEGER;                                                                                                                                                                             &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;FUNCTION F_FactuAbo (pLigne IN T_FDSL_SERVICE_SF%ROWTYPE, pDateCalcFactu IN DATE, pMontant OUT NUMBER, pMontantProrata OUT NUMBER, pLibelleProrata OUT VARCHAR2, pLibTypePrestaProrata OUT VARCHAR2, pLibPeriodeDebProrata OUT DATE, pLibPeriodeFinProrata OUT DATE, pFacteur IN NUMBER, pMoisInclus IN BOOLEAN) RETURN INTEGER;                              &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;FUNCTION F_FactuAboProrata (pLigne IN T_FDSL_SERVICE_SF%ROWTYPE, pDateCalcFactu IN DATE, pTypePresta varchar2,  pMontant OUT NUMBER, pMontantProrata OUT NUMBER, pLibelleProrata OUT VARCHAR2, pLibTypePrestaProrata OUT VARCHAR2, pLibPeriodeDebProrata OUT DATE, pLibPeriodeFinProrata OUT DATE, pFacteur IN NUMBER, pMoisInclus IN BOOLEAN) RETURN INTEGER;&lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;FUNCTION F_FactuResil (pLigne IN T_FDSL_SERVICE_SF%ROWTYPE, pDateCalcFactu IN DATE, pMontant OUT NUMBER, pMontantFAS OUT NUMBER, pFacteur IN NUMBER, pMoisInclus IN BOOLEAN, pLibTypePresta OUT VARCHAR2, pLibPeriodeDeb OUT DATE, pLibPeriodeFin OUT DATE, pMsg OUT VARCHAR2) RETURN INTEGER;                                                                &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;FUNCTION F_FactuResilProrata (pLigne IN T_FDSL_SERVICE_SF%ROWTYPE, pDateCalcFactu IN DATE, pMontant OUT NUMBER, pMontantLocation OUT NUMBER, pMontantFAS OUT NUMBER, pFacteur IN NUMBER, pMoisInclus IN BOOLEAN, pLibTypePresta OUT VARCHAR2, pLibPeriodeDeb OUT DATE, pLibPeriodeFin OUT DATE, pMsg OUT VARCHAR2) RETURN INTEGER;                            &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;FUNCTION F_UpDown (pLigne IN T_FDSL_SERVICE_SF%ROWTYPE, pDateCalcFactu IN Date, pMontant OUT NUMBER, pMontantFAS OUT NUMBER, pFacteur IN NUMBER, pMoisInclus IN BOOLEAN, pLibPeriodeDeb OUT DATE, pLibPeriodeFin OUT DATE, pMsg OUT VARCHAR2) RETURN INTEGER;                                                                                                 &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;FUNCTION F_UpDownProrata (pLigne IN T_FDSL_SERVICE_SF%ROWTYPE, pDateCalcFactu IN Date, pTypePresta varchar2, pMontant OUT NUMBER, pMontantFAS OUT NUMBER, pFacteur IN NUMBER, pMoisInclus IN BOOLEAN, pLibPeriodeDeb OUT DATE, pLibPeriodeFin OUT DATE, pMsg OUT VARCHAR2,pTestMotifModif IN BOOLEAN) RETURN INTEGER;                                                                    &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;FUNCTION F_CalculDateFinPeriod (pDate IN DATE, pFacteur IN NUMBER) RETURN DATE;																																																																																				  PROCEDURE P_InsertFactureSF (pDateCalcFactu IN DATE);                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;PROCEDURE P_InsertServiceSF (pDateCalcFactu IN DATE);                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;PROCEDURE P_InsertComptaFactu (pDateCalcFactu IN DATE);                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;PROCEDURE P_InsertHistoComptaHisto (pDateCalcFactu IN DATE);                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;PROCEDURE P_InsertDetailFactu (pDateCalcFactu IN DATE);                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;PROCEDURE P_InsertRecapFactu;                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;PROCEDURE P_HistoServiceSF(pMois IN NUMBER, pAnnee IN NUMBER);                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;PROCEDURE P_HistoComptaFactu(pMois IN NUMBER, pAnnee IN NUMBER);                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;PROCEDURE P_HistoDetailFactu(pMois IN NUMBER, pAnnee IN NUMBER);                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;PROCEDURE P_HistoRecapFactu(pMois IN NUMBER, pAnnee IN NUMBER);                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;PROCEDURE P_ArchiFactureSF(pMois IN NUMBER,pAnnee IN NUMBER);                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;PROCEDURE P_ArchiServiceSF(pMois IN NUMBER,pAnnee IN NUMBER);                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;PROCEDURE P_ArchiComptaFactu(pMois IN NUMBER,pAnnee IN NUMBER);                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;PROCEDURE P_ArchiDetailRecap(pMois IN NUMBER,pAnnee IN NUMBER);                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;PROCEDURE P_UpdateDetailMail;                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;PROCEDURE P_UpdateMailDetailNewLigne( listIdService varchar2);                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;procedure P_DeterminerMoisInclus(codeRetour IN OUT INTEGER                                                                                                                                                                                                                                                                                                    &lt;br/&gt;   ,enr IN OUT T_FDSL_SERVICE_SF%ROWTYPE                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;   ,pLigneDetailFactu IN OUT T_FDSL_DETAIL_FACTURE%ROWTYPE                                                                                                                                                                                                                                                                                                    &lt;br/&gt;   ,vFacteur IN OUT NUMBER                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;   ,vMois IN  NUMBER                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;   ,vMoisInclus IN OUT BOOLEAN                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;   ,vTraitementLigne IN OUT BOOLEAN                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;   ) ;                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;   procedure P_InitialiserDetailFactu(enr IN OUT T_FDSL_SERVICE_SF%ROWTYPE                                                                                                                                                                                                                                                                                    &lt;br/&gt;   ,pDateCalcFactu IN  Date                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;   ,pLigneDetailFactu IN OUT T_FDSL_DETAIL_FACTURE%ROWTYPE                                                                                                                                                                                                                                                                                                    &lt;br/&gt;   ,vAnnee IN  NUMBER                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;   ,vMois IN  NUMBER                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;   );&lt;br/&gt;   &lt;br/&gt; PROCEDURE P_MAJ_MONTANT( P_ID_FDSL_DETAIL_FACTURE 	IN Number&lt;br/&gt;						, P_CONSOMMATION 			IN Number  &lt;br/&gt;						, P_TARIF_FORFAIT 			IN Number  &lt;br/&gt;						, P_SEUIL 					IN Number  &lt;br/&gt;						, P_TARIF_DEPASS 			IN Number);&lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;   procedure P_FactureProrataTemporis(codeRetour IN OUT INTEGER                                                                                                                                                                                                                                                                                               &lt;br/&gt;   ,enr IN OUT T_FDSL_SERVICE_SF%ROWTYPE                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;   ,pDateCalcFactu IN Date                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;   ,pLigneDetailFactu IN OUT T_FDSL_DETAIL_FACTURE%ROWTYPE                                                                                                                                                                                                                                                                                                    &lt;br/&gt;   ,vFacteur IN OUT NUMBER                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;   ,vLibPeriodeDeb IN OUT T_FDSL_DETAIL_FACTURE.LIB_PERIODE_DEB%TYPE                                                                                                                                                                                                                                                                                          &lt;br/&gt;   ,vLibPeriodeDebProrata IN OUT T_FDSL_DETAIL_FACTURE.LIB_PERIODE_DEB%TYPE                                                                                                                                                                                                                                                                                   &lt;br/&gt;   ,vLibPeriodeFin IN OUT T_FDSL_DETAIL_FACTURE.LIB_PERIODE_FIN%TYPE                                                                                                                                                                                                                                                                                          &lt;br/&gt;   ,vLibPeriodeFinProrata IN OUT T_FDSL_DETAIL_FACTURE.LIB_PERIODE_FIN%TYPE                                                                                                                                                                                                                                                                                   &lt;br/&gt;   ,vLibTypePresta IN OUT T_FDSL_DETAIL_FACTURE.LIB_TYPE_PRESTA%TYPE                                                                                                                                                                                                                                                                                          &lt;br/&gt;   ,vLibTypePrestaProrata IN OUT T_FDSL_DETAIL_FACTURE.LIB_TYPE_PRESTA%TYPE                                                                                                                                                                                                                                                                                   &lt;br/&gt;   ,vLibelleProrata IN OUT T_FDSL_DETAIL_FACTURE.LIBELLE%TYPE                                                                                                                                                                                                                                                                                                 &lt;br/&gt;   ,vMoisInclus IN OUT BOOLEAN                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;   ,vMontant IN OUT T_FDSL_DETAIL_FACTURE.MONTANT%TYPE                                                                                                                                                                                                                                                                                                        &lt;br/&gt;   ,vMontantFAS IN OUT T_FDSL_DETAIL_FACTURE.MONTANT%TYPE                                                                                                                                                                                                                                                                                                     &lt;br/&gt;   ,vMontantProrata IN OUT T_FDSL_DETAIL_FACTURE.MONTANT%TYPE                                                                                                                                                                                                                                                                                                 &lt;br/&gt;   ,vMsg IN OUT T_FDSL_DETAIL_FACTURE.DETAIL_ANALYSE%TYPE       &lt;br/&gt;   ,vTestMotifModif IN OUT BOOLEAN   &lt;br/&gt; &lt;br/&gt;   );                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;END;                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;&lt;br/&gt;/&lt;br/&gt;-------------------------------------------------- BODY --------------------------------------------------------------------------&lt;br/&gt;create or replace PACKAGE BODY AXIONEUSER_FACTU.PCK_FACTU_PRO AS                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;-- Récupération de l&apos;ancien abonnement                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;/* retourne codRet                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt; * 1 = non traité, on passe                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt; * 2 = erreur, on trace si besoin                                                                                                                                                                                                                                                                                                                              &lt;br/&gt; * 0 = ok, on est passé dedans                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt; */                                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;FUNCTION F_AncienAbo(pLigne IN T_FDSL_SERVICE_SF%ROWTYPE, pAbo OUT NUMBER, pDE OUT NUMBER, pLoc OUT NUMBER, pMsg OUT VARCHAR2) RETURN INTEGER IS                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;codRet INTEGER := 1;                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  -- Données obligatoire pour la recherche                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;  IF pLigne.ID_SERVICE__C IS NULL THEN                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;    codRet := 2;                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;    pMsg := pMsg||&apos;-ID_SERVICE non renseigné-&apos;;                                                                                                                                                                                                                                                                                                                &lt;br/&gt;  END IF;                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;  -- Impact dev Emilie B., TEST TRANSIT IP à changer ou enlever                                                                                                                                                                                                                                                                                                &lt;br/&gt;  /*IF pLigne.TECHNO__C = &apos;TRANSIT IP&apos; THEN                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    BEGIN                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;      SELECT TARIF_FORFAIT, DUREE_ENGAGEMENT                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;      INTO pAbo, pDE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      FROM                                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          T_FDSL_HISTO_DETAIL_FACTURE                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;      WHERE                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;          TYPE_FACTU=&apos;CONSO&apos;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;      AND ID_SERVICE = pLigne.ID_SERVICE__C                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;      AND DATE_CALC_FACTU = (                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                              SELECT MAX(DATE_CALC_FACTU)                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                              FROM                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                  T_FDSL_HISTO_DETAIL_FACTURE                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                              WHERE                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                  TYPE_FACTU=&apos;CONSO&apos;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                              AND ID_SERVICE = pLigne.ID_SERVICE__C                                                                                                                                                                                                                                                                                            &lt;br/&gt;                            )                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;      ;                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;      codRet := 0;                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;    EXCEPTION                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;      WHEN NO_DATA_FOUND THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;        pAbo := NULL;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;        pMsg := &apos;-Pas d&apos;&apos;ancien tarif forfait trouvé-&apos;;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;        codRet := 2;                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      WHEN TOO_MANY_ROWS THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;        pAbo := NULL;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;        pMsg := &apos;-Plusieurs Abonnements pour une même facture dans l&apos;&apos;historique : Voir avec le SI-&apos;;                                                                                                                                                                                                                                                          &lt;br/&gt;        codRet := 2;                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;        pAbo := NULL;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;        pMsg := &apos;-Problème : &apos;||SQLERRM||&apos;-&apos;;                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;        codRet := 2;                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;    END;                                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;      -- Impact dev Emilie B., TEST TRANSIT IP à changer ou enlever                                                                                                                                                                                                                                                                                            &lt;br/&gt;  ELSE*/                                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;   /* BEGIN                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;      SELECT MONTANT, DUREE_ENGAGEMENT                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;      INTO pAbo, pDE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      FROM                                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          T_FDSL_HISTO_DETAIL_FACTURE                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;      WHERE                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;          TYPE_FACTU=&apos;ABO&apos;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;      AND ID_SERVICE = pLigne.ID_SERVICE__C                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;      AND DATE_CALC_FACTU = (                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                              SELECT MAX(DATE_CALC_FACTU)                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                              FROM                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                  T_FDSL_HISTO_DETAIL_FACTURE                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                              WHERE                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                  TYPE_FACTU=&apos;ABO&apos;&lt;br/&gt;                              AND ID_SERVICE = pLigne.ID_SERVICE__C&lt;br/&gt;                            )&lt;br/&gt;      ;*/&lt;br/&gt;      BEGIN                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;            SELECT NVL(TO_NUMBER(ABONNEMENT_MENSUEL__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;),0) abo,&lt;br/&gt;             --NVL(TO_NUMBER(DUREE_D_ENGAGEMENT__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;),0) de,             &lt;br/&gt;             --TO_NUMBER( NVL( MONTHS_BETWEEN( TRUNC(DATE_FIN_ENGAGEMENT__C, &apos;MONTH&apos;), TRUNC(DATE_MES_EFFECTIVE__C, &apos;MONTH&apos;) ), 0), &apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;) de,&lt;br/&gt;             --STORY 436 (si DATE_FIN_ENGAGEMENT__C ou DATE_MES_EFFECTIVE__C null, alors on met DUREE_D_ENGAGEMENT__C )&lt;br/&gt;             TO_NUMBER( NVL( MONTHS_BETWEEN( TRUNC(DATE_FIN_ENGAGEMENT__C, &apos;MONTH&apos;), TRUNC(DATE_MES_EFFECTIVE__C, &apos;MONTH&apos;) ), DUREE_D_ENGAGEMENT__C), &apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;) de,&lt;br/&gt;             NVL(TO_NUMBER(LOCATION__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;),0) loc                                                                                                                                                                                                                                                                     &lt;br/&gt;      INTO pAbo, pDE, pLoc                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;      FROM                                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          t_fdsl_histo_service_sf                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;      WHERE                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;          motif_resiliation__c IS NULL                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;      AND id_service__c = pLigne.ID_SERVICE__C                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;      AND date_calc_factu = (                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                              SELECT MAX(DATE_CALC_FACTU)                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                              FROM                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                  t_fdsl_histo_service_sf                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                              WHERE                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                   motif_resiliation__c IS NULL                                                                                                                                                                                                                                                                                                &lt;br/&gt;                              AND id_service__c = pLigne.ID_SERVICE__C                                                                                                                                                                                                                                                                                         &lt;br/&gt;                            );&lt;br/&gt;                       &lt;br/&gt;      codRet := 0;                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;    EXCEPTION                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;      WHEN NO_DATA_FOUND THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;        pAbo := 0;                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;        pMsg := &apos;-Pas d&apos;&apos;ancien abonnement trouvé-&apos;;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;        codRet := 2;                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      WHEN TOO_MANY_ROWS THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;        pAbo := NULL;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;        pMsg := &apos;-Plusieurs Abonnements pour une même facture dans l&apos;&apos;historique : Voir avec le SI-&apos;;                                                                                                                                                                                                                                                          &lt;br/&gt;        codRet := 2;                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;        pAbo := NULL;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;        pMsg := &apos;-Problème : &apos;||SQLERRM||&apos;-&apos;;                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;        codRet := 2;                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;    END;                                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;-- Impact dev Emilie B., TEST TRANSIT IP à changer ou enlever                                                                                                                                                                                                                                                                                                  &lt;br/&gt; /* END IF;*/                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  -- Donnée obligatoire                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;  IF pDE IS NULL AND codRet &lt;&gt; 2 THEN                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;    codRet := 2;                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;    pMsg := pMsg||&apos;-Durée d&apos;&apos;engagement non renseignée-&apos;;                                                                                                                                                                                                                                                                                                      &lt;br/&gt;  END IF;                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  RETURN codRet;                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;END F_AncienAbo;                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;-- Insertion d&apos;une ligne dans T_FDSL_DETAIL_FACTURE                                                                                                                                                                                                                                                                                                            &lt;br/&gt;/* retourne codRet                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt; * 2 = erreur, on trace si besoin                                                                                                                                                                                                                                                                                                                              &lt;br/&gt; * 0 = ok, on est passé dedans                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt; */&lt;br/&gt;FUNCTION F_InsertLigneDetailFactu (pLigneDetailFactu IN T_FDSL_DETAIL_FACTURE%ROWTYPE) RETURN INTEGER IS                                                                                                                                                                                                                                                       &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;codRet INTEGER := 0;                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    INSERT INTO T_FDSL_DETAIL_FACTURE (                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                       ID_SERVICE         ,                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                       ABONNE             ,                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                       FAI                ,                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                       DSP                ,                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                       TECHNO             ,                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                       MOIS               ,                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                                       ANNEE              ,                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                       DATE_DEB_FACTU     ,                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                       DATE_SAISIE_MES    ,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                       DATE_MES_EFFECTIVE ,                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                                       DATE_SAISIE_MODIF  ,                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                       DATE_DE_MODIF      ,                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                       DATE_SAISIE_RESIL  ,                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                       DATE_RESIL         ,                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                       DATE_CALC_FACTU    ,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                       SDFC               ,                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                                       COMMANDE           ,                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                       REF_CLIENT         ,                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                       NOM_PROJET         ,                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                       PRODUITS_COMMANDES ,                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                                       VILLE              ,                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                       DUREE_ENGAGEMENT   ,                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                       FREQUENCE_FACTU    ,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                       NDI                ,                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                       VIA_DGT            ,                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                       VIA_GTR            ,                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                       TERME_FACTU        ,                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                       MODE_FACTU         ,                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                       LIBELLE            ,                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                       LIB_TYPE_PRESTA    ,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                       LIB_PERIODE_DEB    ,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                       LIB_PERIODE_FIN    ,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                       CONSOMMATION       ,                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                                       TARIF_FORFAIT      ,                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                       SEUIL              ,                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                       TARIF_DEPASSEMENT  ,                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                       MONTANT            ,                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                       COMMENTAIRE        ,                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                       ANALYSE            ,                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                       DETAIL_ANALYSE     ,                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                       STATUT             ,                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                       TYPE_FACTU         ,                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                       MOTIF_RESIL        ,                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                       MOTIF_MODIF        ,                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                       MAIL_DEST          ,                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                       MAIL_CC            ,                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                       ID_SALESFORCE      ,&lt;br/&gt;                                       DATE_FIN_ENGAGEMENT,&lt;br/&gt;                                       PROFIL             ,&lt;br/&gt;                                       ADRESSE_1          ,&lt;br/&gt;                                       CP                 ,&lt;br/&gt;									   TYPE_VENTE&lt;br/&gt;                                      )                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    VALUES (                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;            pLigneDetailFactu.ID_SERVICE         ,                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;            pLigneDetailFactu.ABONNE             ,                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            pLigneDetailFactu.FAI                ,                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;            pLigneDetailFactu.DSP                ,                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;            pLigneDetailFactu.TECHNO             ,                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            pLigneDetailFactu.MOIS               ,                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;            pLigneDetailFactu.ANNEE              ,                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;            pLigneDetailFactu.DATE_DEB_FACTU     ,                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;            pLigneDetailFactu.DATE_SAISIE_MES    ,                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;            pLigneDetailFactu.DATE_MES_EFFECTIVE ,                                                                                                                                                                                                                                                                                                              &lt;br/&gt;            pLigneDetailFactu.DATE_SAISIE_MODIF  ,                                                                                                                                                                                                                                                                                                               &lt;br/&gt;            pLigneDetailFactu.DATE_DE_MODIF      ,                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;            pLigneDetailFactu.DATE_SAISIE_RESIL  ,                                                                                                                                                                                                                                                                                                               &lt;br/&gt;            pLigneDetailFactu.DATE_RESIL         ,                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;            pLigneDetailFactu.DATE_CALC_FACTU    ,                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;            pLigneDetailFactu.SDFC               ,                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;            pLigneDetailFactu.COMMANDE           ,                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;            pLigneDetailFactu.REF_CLIENT         ,                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;            pLigneDetailFactu.NOM_PROJET         ,                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;            pLigneDetailFactu.PRODUITS_COMMANDES ,                                                                                                                                                                                                                                                                                                              &lt;br/&gt;            pLigneDetailFactu.VILLE              ,                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;            pLigneDetailFactu.DUREE_ENGAGEMENT   ,                                                                                                                                                                                                                                                                                                                &lt;br/&gt;            pLigneDetailFactu.FREQUENCE_FACTU    ,                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;            pLigneDetailFactu.NDI                ,                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;            pLigneDetailFactu.VIA_DGT            ,                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;            pLigneDetailFactu.VIA_GTR            ,                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;            pLigneDetailFactu.TERME_FACTU        ,                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;            pLigneDetailFactu.MODE_FACTU         ,                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;            pLigneDetailFactu.LIBELLE            ,                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;            pLigneDetailFactu.LIB_TYPE_PRESTA    ,                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;            pLigneDetailFactu.LIB_PERIODE_DEB    ,                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;            pLigneDetailFactu.LIB_PERIODE_FIN    ,                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;            pLigneDetailFactu.CONSOMMATION       ,                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;            pLigneDetailFactu.TARIF_FORFAIT      ,                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;            pLigneDetailFactu.SEUIL              ,                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;            pLigneDetailFactu.TARIF_DEPASSEMENT  ,                                                                                                                                                                                                                                                                                                               &lt;br/&gt;            pLigneDetailFactu.MONTANT            ,                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;            pLigneDetailFactu.COMMENTAIRE        ,                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;            pLigneDetailFactu.ANALYSE            ,                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;            pLigneDetailFactu.DETAIL_ANALYSE     ,                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;            pLigneDetailFactu.STATUT             ,                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            pLigneDetailFactu.TYPE_FACTU         ,                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;            pLigneDetailFactu.MOTIF_RESIL        ,                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;            pLigneDetailFactu.MOTIF_MODIF        ,                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;            pLigneDetailFactu.MAIL_DEST          ,                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;            pLigneDetailFactu.MAIL_CC            ,                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;            pLigneDetailFactu.ID_SALESFORCE      ,&lt;br/&gt;            pLigneDetailFactu.DATE_FIN_ENGAGEMENT,&lt;br/&gt;            pLigneDetailFactu.PROFIL             ,&lt;br/&gt;            pLigneDetailFactu.ADRESSE_1          ,&lt;br/&gt;            pLigneDetailFactu.CP				 ,&lt;br/&gt;			pLigneDetailFactu.TYPE_VENTE&lt;br/&gt;           )                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;    ;                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      codRet:=2;                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  RETURN codRet;                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;END F_InsertLigneDetailFactu;                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;-- Insertion des lignes dans la table récapitulative                                                                                                                                                                                                                                                                                                           &lt;br/&gt;/* retourne codRet                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt; * 2 = erreur, on trace si besoin                                                                                                                                                                                                                                                                                                                              &lt;br/&gt; * 0 = ok, on est passé dedans                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt; */                                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;FUNCTION F_InsertLignesRecapFactu (pDSP IN T_FDSL_DETAIL_FACTURE.DSP%TYPE, pFAI IN T_FDSL_DETAIL_FACTURE.FAI%TYPE, pTechno IN T_FDSL_DETAIL_FACTURE.TECHNO%TYPE) RETURN INTEGER IS                                                                                                                                                                             &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;vErr INTEGER :=0;                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    INSERT INTO T_FDSL_RECAP_FACTURE (                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                      FAI,                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                                      DSP,                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                                      TECHNO,                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                      MOIS,                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                      ANNEE,                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                                      LIBELLE,                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                      TYPE_FACTU,                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                      DATE_CALC_FACTU,                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                      MODE_FACTU,                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                      TERME_FACTU,                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                      FREQUENCE_FACTU,                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                      STATUT,                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                      MONTANT                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                     )                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;    SELECT                                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          FAI,                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;          DSP,                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;          TECHNO,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          MOIS,                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;          ANNEE,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          LIBELLE,                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          TYPE_FACTU,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          DATE_CALC_FACTU,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          MODE_FACTU,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          TERME_FACTU,                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;          FREQUENCE_FACTU,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          STATUT,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          SUM(MONTANT) MONTANT                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;    FROM T_FDSL_DETAIL_FACTURE                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;    WHERE                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;         FAI = pFAI                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;     AND DSP = pDSP                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;     AND TECHNO = pTechno                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;    GROUP BY                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;            FAI,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;            DSP,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;            TECHNO,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;            MOIS,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;            ANNEE,                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;            LIBELLE,                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;            TYPE_FACTU,                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;            DATE_CALC_FACTU,                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;            MODE_FACTU,                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;            TERME_FACTU,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;            FREQUENCE_FACTU,                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;            STATUT                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;    ;                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      vErr:=2;                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  IF vErr = 0 THEN                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;    COMMIT;                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;  ELSE                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;    ROLLBACK;                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;  END IF;                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  RETURN vErr;                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;END F_InsertLignesRecapFactu;                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;-- Suppression de lignes de la table récapitulative                                                                                                                                                                                                                                                                                                            &lt;br/&gt;/* retourne codRet                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt; * 2 = erreur, on trace si besoin                                                                                                                                                                                                                                                                                                                              &lt;br/&gt; * 0 = ok, on est passé dedans                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt; */                                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;FUNCTION F_DeleteLignesRecapFactu (pDSP IN T_FDSL_DETAIL_FACTURE.DSP%TYPE, pFAI IN T_FDSL_DETAIL_FACTURE.FAI%TYPE, pTechno IN T_FDSL_DETAIL_FACTURE.TECHNO%TYPE) RETURN INTEGER IS                                                                                                                                                                             &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;vErr INTEGER :=0;                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    DELETE T_FDSL_RECAP_FACTURE                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;    WHERE                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;         FAI = pFAI                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;     AND DSP = pDSP                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;     AND TECHNO = pTechno                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;    ;                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      vErr:=2;                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  IF vErr = 0 THEN                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;    COMMIT;                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;  ELSE                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;    ROLLBACK;                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;  END IF;                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  RETURN vErr;                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;END F_DeleteLignesRecapFactu;                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;-- Calcul des nouvelles mise en service                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;/* retourne codRet                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt; * 1 = non traité, on passe                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt; * 2 = erreur, on trace si besoin -- pas le cas pour le moment pour cette fonction                                                                                                                                                                                                                                                                             &lt;br/&gt; * 0 = ok, on est passé dedans                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt; */                                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;FUNCTION F_FactuFASPFROIRU (pLigne IN T_FDSL_SERVICE_SF%ROWTYPE, pDateCalcFactu IN DATE, pMontantFAS OUT NUMBER, pMontantPFRO OUT NUMBER, pMontantIRU OUT NUMBER) RETURN INTEGER IS                                                                                                                                                                            &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;codRet INTEGER :=1;&lt;br/&gt;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  -- Initialisation à null, permettra de distinguer avec la valeur 0 qui peut être insérée selon les types de frais                                                                                                                                                                                                                                                      &lt;br/&gt;  pMontantFAS:= TO_NUMBER(NULL);                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  pMontantPFRO:= TO_NUMBER(NULL);                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;  pMontantIRU:= TO_NUMBER(NULL);&lt;br/&gt;&lt;br/&gt; --Facturation au titre de la création&lt;br/&gt;	IF (pLigne.MOTIF_MODIF__C IS NULL AND pLigne.MOTIF_RESILIATION__C IS NULL) Then&lt;br/&gt;	  &lt;br/&gt;	 --Si Date arrivée MES est sur M-1 et date début antérieure ou égale à M-1, M étant le mois de lancement de la facture, on facture&lt;br/&gt;	  IF (TRUNC(pLigne.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) AND&lt;br/&gt;		  TRUNC(pLigne.DATE_DEBUT_FACTU__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;)) THEN&lt;br/&gt;			  pMontantFAS := ROUND(TO_NUMBER(pLigne.FAS__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;),2);&lt;br/&gt;			  pMontantPFRO :=  ROUND(TO_NUMBER(pLigne.PFRO__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;),2);&lt;br/&gt;			  pMontantIRU :=  ROUND(TO_NUMBER(pLigne.IRU__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;),2);&lt;br/&gt;			  codRet:=0;&lt;br/&gt;			  RETURN codRet;&lt;br/&gt;			  &lt;br/&gt;	 --Si Date arrivée MES est antérieure  à M-1 et Date de début factu est sur le mois M-1, on facture.&lt;br/&gt;	 &lt;br/&gt;	  ELSIF (TRUNC(pLigne.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;) &lt; TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) AND&lt;br/&gt;		  TRUNC(pLigne.DATE_DEBUT_FACTU__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;)) THEN&lt;br/&gt;			pMontantFAS := ROUND(TO_NUMBER(pLigne.FAS__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;),2);&lt;br/&gt;			pMontantPFRO :=  ROUND(TO_NUMBER(pLigne.PFRO__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;),2);&lt;br/&gt;			pMontantIRU :=  ROUND(TO_NUMBER(pLigne.IRU__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;),2);&lt;br/&gt;			codRet:=0;&lt;br/&gt;			RETURN codRet;&lt;br/&gt;	--sinon on ne facture pas		&lt;br/&gt;	  ELSE&lt;br/&gt;			codRet:=1;&lt;br/&gt;			RETURN codRet;&lt;br/&gt;	  END IF;&lt;br/&gt;	END IF;&lt;br/&gt;	codRet:=1;&lt;br/&gt;	RETURN codRet;    	&lt;br/&gt;	&lt;br/&gt;	                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;END F_FactuFASPFROIRU;                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;-- Calcul des abonnements sans prorata temporis                                                                                                                                                                                                                                                                                                                &lt;br/&gt;/* retourne codRet                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt; * 1 = non traité, on passe                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt; * 2 = erreur, on trace si besoin -- pas le cas pour le moment pour cette fonction                                                                                                                                                                                                                                                                             &lt;br/&gt; * 0 = ok, on est passé dedans                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt; */                                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;FUNCTION F_FactuAbo (pLigne IN T_FDSL_SERVICE_SF%ROWTYPE, pDateCalcFactu IN DATE, pMontant OUT NUMBER, pMontantProrata OUT NUMBER, pLibelleProrata OUT VARCHAR2, pLibTypePrestaProrata OUT VARCHAR2, pLibPeriodeDebProrata OUT DATE, pLibPeriodeFinProrata OUT DATE, pFacteur IN NUMBER, pMoisInclus IN BOOLEAN) RETURN INTEGER IS                             &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;codRet INTEGER :=1;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;vAbo T_FDSL_DETAIL_FACTURE.MONTANT%TYPE;                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;vNbMoisMESDebFactuXtriel NUMBER(5);                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;vTerme T_FDSL_DETAIL_FACTURE.TERME_FACTU%TYPE;                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;vDateMESEffec DATE;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  -- Initialisation des variables                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;  vTerme := UPPER(TRANSLATE(pLigne.TERME_FACTU__C,&apos;éà&apos;,&apos;ea&apos;));                                                                                                                                                                                                                                                                                                 &lt;br/&gt;  vDateMESEffec :=TRUNC(NVL(pLigne.DATE_DEBUT_FACTU__C,pLigne.DATE_MES_EFFECTIVE__C));                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  pMontant:=TO_NUMBER(NULL);                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;  pMontantProrata:=TO_NUMBER(NULL);                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  pLibPeriodeDebProrata :=TRUNC(NVL(pLigne.DATE_DEBUT_FACTU__C,pLigne.DATE_MES_EFFECTIVE__C));                                                                                                                                                                                                                                                                 &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt; /* IF pLigne.TECHNO__C = &apos;TRANSIT IP&apos; THEN                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    vAbo:=TO_NUMBER(pLigne.TARIF_FORFAIT__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;);                                                                                                                                                                                                                                                                      &lt;br/&gt;  ELSE*/                                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;    vAbo:=TO_NUMBER(pLigne.ABONNEMENT_MENSUEL__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;);                                                                                                                                                                                                                                                                 &lt;br/&gt; /* END IF;*/                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  IF UPPER(pLigne.STATUT__C) = &apos;ACTIF&apos; THEN                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;    IF TRUNC(vDateMESEffec,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                                       &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;      -- MENSUELLE                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;      IF pFacteur = 1 THEN                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;        -- A Echoir                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;        IF vTerme = &apos;A ECHOIR&apos; THEN                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          -- Initialisation de l&apos;abonnement si à Echoir -&gt; toujours le mois en cours à facturer                                                                                                                                                                                                                                                                &lt;br/&gt;          pMontant := vAbo;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;          codRet:=0;                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;        END IF;                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;        -- mois de MES effective &lt;= n-1 et mois de saisie MES = n-1                                                                                                                                                                                                                                                                                            &lt;br/&gt;        IF TRUNC(pLigne.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                     &lt;br/&gt;          -- pMontantProrata = nb mois entre date de MES effective et date de saisie MES * ABO&lt;br/&gt;          pMontantProrata := MONTHS_BETWEEN(TRUNC(pLigne.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;))*vAbo;&lt;br/&gt;          pLibTypePrestaProrata := &apos;Prorata&apos;;                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;          IF vTerme = &apos;A ECHOIR&apos; THEN                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            pLibPeriodeFinProrata :=LAST_DAY(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;));                                                                                                                                                                                                                                                                    &lt;br/&gt;            pLibelleProrata:=pLibTypePrestaProrata||&apos; de &apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(pLigne.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)))||&apos; mois entre le &apos;||TO_CHAR(pLibPeriodeDebProrata,&apos;DD/MM/YYYY&apos;)||&apos; et le &apos;||TO_CHAR(pLibPeriodeFinProrata,&apos;DD/MM/YYYY&apos;);                                                                         &lt;br/&gt;          END IF;                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          IF vTerme = &apos;ECHU&apos; THEN                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;            pLibPeriodeFinProrata := LAST_DAY(TRUNC(vDateMESEffec,&apos;MONTH&apos;));                                                                                                                                                                                                                                                                                   &lt;br/&gt;            pLibelleProrata:=pLibTypePrestaProrata||&apos; de &apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(pLigne.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)))||&apos; mois entre le &apos;||TO_CHAR(pLibPeriodeDebProrata,&apos;DD/MM/YYYY&apos;)||&apos; et le &apos;||TO_CHAR(pLibPeriodeFinProrata,&apos;DD/MM/YYYY&apos;);                                                                         &lt;br/&gt;          END IF;                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          codRet:=0;                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;        END IF;                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- Date de MES effective &lt;= n-1 et date de saisie de MES &lt;= n-2                                                                                                                                                                                                                                                                                        &lt;br/&gt;        IF TRUNC(pLigne.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-2),&apos;MONTH&apos;) THEN&lt;br/&gt;          pMontant := vAbo;&lt;br/&gt;          pMontantProrata:=TO_NUMBER(NULL);                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;          codRet:=0;                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;        END IF;                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;      -- TRIMESTRI, SEMESTRI, ANNU -&gt; ELLE                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;      ELSE                                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;        IF vTerme = &apos;A ECHOIR&apos; THEN                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          -- Date de saisie MES inférieure ou égalle à date de calcul de facturation -2 : Abonnement normal                                                                                                                                                                                                                                                    &lt;br/&gt;          IF TRUNC(pLigne.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-2),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                  &lt;br/&gt;            -- Sommes nous à la facturation d&apos;une période ?                                                                                                                                                                                                                                                                                                    &lt;br/&gt;            IF pMoisInclus THEN                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;              pMontant := pFacteur*vAbo;                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;              codRet:=0;                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          -- Détection mise en service à n-1                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;          ELSIF TRUNC(pLigne.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                &lt;br/&gt;            -- Sommes nous à la facturation d&apos;une période ?                                                                                                                                                                                                                                                                                                    &lt;br/&gt;            IF pMoisInclus THEN                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;              pMontant := pFacteur*vAbo;                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;              pLibPeriodeFinProrata :=LAST_DAY(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;));                                                                                                                                                                                                                                                                  &lt;br/&gt;              pLibelleProrata:=pLibTypePrestaProrata||&apos; de &apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(pLigne.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)))||&apos; mois entre le &apos;||TO_CHAR(pLibPeriodeDebProrata,&apos;DD/MM/YYYY&apos;)||&apos; et le &apos;||TO_CHAR(pLibPeriodeFinProrata,&apos;DD/MM/YYYY&apos;);                                                                       &lt;br/&gt;              pMontantProrata := MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(pLibPeriodeDebProrata,&apos;MONTH&apos;))*vAbo;                                                                                                                                                                                                                       &lt;br/&gt;              codRet:=0;                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;            -- Mois de facturation hors période                                                                                                                                                                                                                                                                                                                &lt;br/&gt;            ELSE                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;              -- si la date de MES effective est inférieure à la période de fréquence                                                                                                                                                                                                                                                                          &lt;br/&gt;              IF (TRUNC(vDateMESEffec,&apos;MONTH&apos;) &lt; TRUNC(pDateCalcFactu,&apos;Q&apos;) AND pFacteur = 3)                                                                                                                                                                                                                                                                   &lt;br/&gt;                -- Pour le semestre on compare le numéro de trimestre en prenant soin de lier les trimestres 1 et 2 -&gt; 1, et 3 et 4 -&gt; 3.                                                                                                                                                                                                                      &lt;br/&gt;                OR (TRANSLATE(TO_CHAR(vDateMESEffec,&apos;Q&apos;),&apos;24&apos;,&apos;13&apos;) &lt;&gt; TRANSLATE(TO_CHAR(pDateCalcFactu,&apos;Q&apos;),&apos;24&apos;,&apos;13&apos;) AND pFacteur = 6)                                                                                                                                                                                                                      &lt;br/&gt;                OR (TRUNC(vDateMESEffec,&apos;MONTH&apos;) &lt; TRUNC(pDateCalcFactu,&apos;YEAR&apos;) AND pFacteur = 12) THEN                                                                                                                                                                                                                                                        &lt;br/&gt;                pMontant := pFacteur*vAbo;                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                CASE pFacteur                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                  WHEN 3 THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                    -- Début du trimestre en cours -1jour = fin du trimestre précédent                                                                                                                                                                                                                                                                         &lt;br/&gt;                    pLibPeriodeFinProrata :=(TRUNC(pDateCalcFactu,&apos;Q&apos;)-1);                                                                                                                                                                                                                                                                                     &lt;br/&gt;                  WHEN 6 THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                    -- Début du semestre en cours  -1jour = fin du semestre précédent                                                                                                                                                                                                                                                                          &lt;br/&gt;                    IF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;1&apos;,&apos;3&apos;) THEN                                                                                                                                                                                                                                                                                           &lt;br/&gt;                      pLibPeriodeFinProrata :=(TRUNC(pDateCalcFactu,&apos;Q&apos;)-1);                                                                                                                                                                                                                                                                                   &lt;br/&gt;                    ELSIF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;2&apos;,&apos;4&apos;) THEN                                                                                                                                                                                                                                                                                        &lt;br/&gt;                     -- alors il faut enlever 3 mois (-3) pour passer au trimestre précédent et tomber dans le bon début de semestre                                                                                                                                                                                                                           &lt;br/&gt;                      pLibPeriodeFinProrata :=(TRUNC(ADD_MONTHS(pDateCalcFactu,-3),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                                    &lt;br/&gt;                    END IF;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                  WHEN 12 THEN                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                    pLibPeriodeFinProrata :=(TRUNC(pDateCalcFactu,&apos;YEAR&apos;)-1);                                                                                                                                                                                                                                                                                  &lt;br/&gt;                END CASE;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                pLibelleProrata:=pLibTypePrestaProrata||&apos; du &apos;||TO_CHAR(pLibPeriodeDebProrata,&apos;DD/MM/YYYY&apos;)||&apos; au &apos;||TO_CHAR(pLibPeriodeFinProrata,&apos;DD/MM/YYYY&apos;);                                                                                                                                                                                              &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;               -- Nombre de mois entre date MES et date de prochain trim/sem/anneé stre                                                                                                                                                                                                                                                                        &lt;br/&gt;                vNbMoisMESDebFactuXtriel :=MONTHS_BETWEEN(pLibPeriodeFinProrata,(LAST_DAY(TRUNC(pLibPeriodeDebProrata,&apos;MONTH&apos;))));                                                                                                                                                                                                                             &lt;br/&gt;                pMontantProrata := vNbMoisMESDebFactuXtriel*vAbo;                                                                                                                                                                                                                                                                                              &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                --pLibPeriodeFinProrata :=LAST_DAY(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;));                                                                                                                                                                                                                                                              &lt;br/&gt;                --pLibelleProrata:=pLibTypePrestaProrata||&apos; de &apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(pLigne.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)))||&apos; mois entre le &apos;||TO_CHAR(pLibPeriodeDebProrata,&apos;DD/MM/YYYY&apos;)||&apos; et le &apos;||TO_CHAR(pLibPeriodeFinProrata,&apos;DD/MM/YYYY&apos;);                                                                   &lt;br/&gt;                --pMontantProrata := MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(pLibPeriodeDebProrata,&apos;MONTH&apos;))*vAbo;                                                                                                                                                                                                                   &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              ELSE                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                CASE pFacteur                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                  WHEN 3 THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                    -- Début du trimestre prochain -1jour = fin du trimestre actuel                                                                                                                                                                                                                                                                            &lt;br/&gt;                    pLibPeriodeFinProrata :=(TRUNC(ADD_MONTHS(pDateCalcFactu,+3),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                                      &lt;br/&gt;                  WHEN 6 THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                    -- Début du semestre prochain -1jour = fin du semestre actuel                                                                                                                                                                                                                                                                              &lt;br/&gt;                    IF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;1&apos;,&apos;3&apos;) THEN                                                                                                                                                                                                                                                                                           &lt;br/&gt;                      pLibPeriodeFinProrata :=(TRUNC(ADD_MONTHS(pDateCalcFactu,+6),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                                    &lt;br/&gt;                    ELSIF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;2&apos;,&apos;4&apos;) THEN                                                                                                                                                                                                                                                                                        &lt;br/&gt;                      pLibPeriodeFinProrata :=(TRUNC(ADD_MONTHS(pDateCalcFactu,+3),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                                    &lt;br/&gt;                    END IF;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                  WHEN 12 THEN                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                    pLibPeriodeFinProrata :=(ADD_MONTHS(TRUNC(pDateCalcFactu,&apos;YEAR&apos;),+12)-1);                                                                                                                                                                                                                                                                  &lt;br/&gt;                END CASE;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                pLibelleProrata:=pLibTypePrestaProrata||&apos; de &apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(pLigne.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)))||&apos; mois entre le &apos;||TO_CHAR(pLibPeriodeDebProrata,&apos;DD/MM/YYYY&apos;)||&apos; et le &apos;||TO_CHAR(pLibPeriodeFinProrata,&apos;DD/MM/YYYY&apos;);                                                                     &lt;br/&gt;                pMontantProrata := MONTHS_BETWEEN(TRUNC(pLibPeriodeFinProrata,&apos;MONTH&apos;),TRUNC(pLibPeriodeDebProrata,&apos;MONTH&apos;))*vAbo;                                                                                                                                                                                                                             &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          END IF; -- Fin Date saisie MES                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;        END IF; -- Fin A echoir                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;        -- Echu                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;        IF vTerme = &apos;ECHU&apos; THEN                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;          -- Date de saisie MES inférieure ou égalle à date de calcul de facturation -2 : Abonnement normal                                                                                                                                                                                                                                                    &lt;br/&gt;          IF TRUNC(pLigne.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-2),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                  &lt;br/&gt;            -- Abonnement normal car mise en service antérieur à la fréquence précédente                                                                                                                                                                                                                                                                       &lt;br/&gt;            IF TRUNC(pLigne.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;) &lt; TRUNC(ADD_MONTHS(pDateCalcFactu,(-1*pFacteur)),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                      &lt;br/&gt;              IF pMoisInclus THEN                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                pMontant := pFacteur*vAbo;                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            -- Reste des mois à facturer suite mise en service détectée dans la fréquence précédente.                                                                                                                                                                                                                                                          &lt;br/&gt;            ELSE                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;              IF pMoisInclus THEN                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                pMontant := MONTHS_BETWEEN(TRUNC(pDateCalcFactu,&apos;MONTH&apos;),ADD_MONTHS(TRUNC(vDateMESEffec,&apos;MONTH&apos;),+1))*vAbo;                                                                                                                                                                                                                                    &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          ELSIF TRUNC(pLigne.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                &lt;br/&gt;            -- Sommes nous à la facturation d&apos;une période ?                                                                                                                                                                                                                                                                                                    &lt;br/&gt;            IF pMoisInclus THEN                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;              pLibPeriodeFinProrata :=LAST_DAY(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;));                                                                                                                                                                                                                                                                  &lt;br/&gt;              pLibelleProrata:=pLibTypePrestaProrata||&apos; de &apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(pLigne.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)))||&apos; mois entre le &apos;||TO_CHAR(pLibPeriodeDebProrata,&apos;DD/MM/YYYY&apos;)||&apos; et le &apos;||TO_CHAR(pLibPeriodeFinProrata,&apos;DD/MM/YYYY&apos;);                                                                       &lt;br/&gt;              pMontantProrata := MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(pLibPeriodeDebProrata,&apos;MONTH&apos;))*vAbo;                                                                                                                                                                                                                       &lt;br/&gt;              codRet:=0;                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;            -- Mois de facturation hors période                                                                                                                                                                                                                                                                                                                &lt;br/&gt;            ELSE                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;              pLibPeriodeFinProrata :=LAST_DAY(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;));                                                                                                                                                                                                                                                                  &lt;br/&gt;              pLibelleProrata:=pLibTypePrestaProrata||&apos; de &apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(pLigne.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)))||&apos; mois entre le &apos;||TO_CHAR(pLibPeriodeDebProrata,&apos;DD/MM/YYYY&apos;)||&apos; et le &apos;||TO_CHAR(pLibPeriodeFinProrata,&apos;DD/MM/YYYY&apos;);                                                                       &lt;br/&gt;              pMontantProrata := MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(pLibPeriodeDebProrata,&apos;MONTH&apos;))*vAbo;                                                                                                                                                                                                                       &lt;br/&gt;              codRet:=0;                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          END IF; -- Date saisie MES                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;        END IF; -- Fin Echu                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;      END IF; -- Fin pFacteur = 1                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;    END IF; -- vDateMESEffec &lt;= n-1                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;  END IF; -- Fin ACTIF                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;  &lt;br/&gt;  --Story 431 (arrondi a 2)&lt;br/&gt;  pMontant       := ROUND(pMontant, 2);&lt;br/&gt;  pMontantProrata:= ROUND(pMontantProrata, 2);&lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  RETURN codRet;                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;END F_FactuAbo;                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;  &lt;br/&gt;-- Calcule la date de fin d&apos;une période en fonction de la date passée en paramètre et de la période                                                                                                                                                                                                                                                                                                                &lt;br/&gt;/* &lt;br/&gt;input : pDate&lt;br/&gt;        pfacteur (1,3,6,12)   &lt;br/&gt;output : vDateRetour&lt;br/&gt;*/  &lt;br/&gt;FUNCTION F_CalculDateFinPeriod (pDate IN DATE, pFacteur IN NUMBER) RETURN DATE IS&lt;br/&gt;vDateRetour DATE;&lt;br/&gt;BEGIN&lt;br/&gt;	CASE pFacteur &lt;br/&gt;		WHEN 1 THEN&lt;br/&gt;			vDateRetour :=	LAST_DAY(TRUNC(pDate,&apos;MONTH&apos;));&lt;br/&gt;		WHEN 3 THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;		-- Début du trimestre prochain (+3) -1jour = fin du trimestre actuel                                                                                                                                                                                                                                                                       &lt;br/&gt;			vDateRetour := (TRUNC(ADD_MONTHS(pDate,+3),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                                      &lt;br/&gt;		WHEN 6 THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;		-- Début du semestre prochain (+6) -1jour = fin du semestre actuel                                                                                                                                                                                                                                                                         &lt;br/&gt;			IF TO_CHAR(pDate,&apos;Q&apos;) IN (&apos;1&apos;,&apos;3&apos;) THEN                                                                                                                                                                                                                                                                                           &lt;br/&gt;				vDateRetour := (TRUNC(ADD_MONTHS(pDate,+6),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                                    &lt;br/&gt;			ELSIF TO_CHAR(pDate,&apos;Q&apos;) IN (&apos;2&apos;,&apos;4&apos;) THEN                                                                                                                                                                                                                                                                                        &lt;br/&gt;		-- alors il faut enlever 3 mois (-3) pour passer au trimestre précédent et tomber dans le bon début de semestre                                                                                                                                                                                                                            &lt;br/&gt;				vDateRetour := (TRUNC(ADD_MONTHS(ADD_MONTHS(pDate,+6),-3),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                     &lt;br/&gt;			END IF;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;		WHEN 12 THEN                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;			vDateRetour := (ADD_MONTHS(TRUNC(pDate,&apos;YEAR&apos;),+12)-1);                                                                                                                                                                                                                                                                  &lt;br/&gt;	END CASE;      &lt;br/&gt;	RETURN vDateRetour;&lt;br/&gt;END F_CalculDateFinPeriod;&lt;br/&gt;&lt;br/&gt;										  &lt;br/&gt;-- Calcul des abonnements avec prorata temporis                                                                                                                                                                                                                                                                                                                &lt;br/&gt;/* retourne codRet                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt; * 1 = non traité, on passe                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt; * 2 = erreur, on trace si besoin -- pas le cas pour le moment pour cette fonction                                                                                                                                                                                                                                                                             &lt;br/&gt; * 0 = ok, on est passé dedans                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt; */                                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;FUNCTION F_FactuAboProrata (pLigne IN T_FDSL_SERVICE_SF%ROWTYPE, pDateCalcFactu IN DATE, pTypePresta varchar2, pMontant OUT NUMBER, pMontantProrata OUT NUMBER, pLibelleProrata OUT VARCHAR2, pLibTypePrestaProrata OUT VARCHAR2, pLibPeriodeDebProrata OUT DATE, pLibPeriodeFinProrata OUT DATE, pFacteur IN NUMBER, pMoisInclus IN BOOLEAN) RETURN INTEGER IS&lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;codRet INTEGER := 1;                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;vNbJMoisMES NUMBER(5);                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;vNbJMESFinMois NUMBER(5);                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;vNbMoisMESDebFactuXtriel NUMBER(5);                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;vAbo T_FDSL_DETAIL_FACTURE.MONTANT%TYPE;                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;vTerme T_FDSL_DETAIL_FACTURE.TERME_FACTU%TYPE;                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;vDateMESEffec DATE;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  -- Initialisation des variables                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;  vTerme := UPPER(TRANSLATE(pLigne.TERME_FACTU__C,&apos;éà&apos;,&apos;ea&apos;));                                                                                                                                                                                                                                                                                                 &lt;br/&gt;  vDateMESEffec :=TRUNC(NVL(pLigne.DATE_DEBUT_FACTU__C,pLigne.DATE_MES_EFFECTIVE__C));                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  pMontant:=TO_NUMBER(NULL);                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;  pMontantProrata:=TO_NUMBER(NULL);                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  pLibPeriodeDebProrata := TRUNC(NVL(pLigne.DATE_DEBUT_FACTU__C,pLigne.DATE_MES_EFFECTIVE__C));                                                                                                                                                                                                                                                                &lt;br/&gt;  if pTypePresta =&apos;ABO&apos; then                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;  pLibTypePrestaProrata := &apos;Prorata&apos;;                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  vAbo:=TO_NUMBER(pLigne.ABONNEMENT_MENSUEL__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;);                                                                                                                                                                                                                                                                   &lt;br/&gt;  else                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;  if pTypePresta =&apos;LOC&apos; then                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;  pLibTypePrestaProrata := &apos;Location Prorata&apos;;                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;  vAbo:=TO_NUMBER(pLigne.LOCATION__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;);                                                                                                                                                                                                                                                                             &lt;br/&gt;  end if;                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;  end if;                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;  vNbJMoisMES:=(LAST_DAY(TRUNC(vDateMESEffec,&apos;MONTH&apos;))-TRUNC(vDateMESEffec,&apos;MONTH&apos;)+1);                                                                                                                                                                                                                                                                        &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  IF UPPER(pLigne.STATUT__C) = &apos;ACTIF&apos; THEN                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;    IF TRUNC(vDateMESEffec,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                                       &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;      -- MENSUELLE                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;      IF pFacteur = 1 THEN                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- Initialisation de l&apos;abonnement si à Echoir -&gt; toujours le mois en cours à facturer                                                                                                                                                                                                                                                                  &lt;br/&gt;        IF vTerme = &apos;A ECHOIR&apos; THEN                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          pMontant := vAbo;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;        END IF;                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- mois MES effective = mois calcul facturation - 1 et mois saisie MES (MEF) = mois calcul facturation - 1                                                                                                                                                                                                                                             &lt;br/&gt;        IF TRUNC(vDateMESEffec,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) AND TRUNC(pLigne.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                     &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          -- pMontantProrata = (dernier jour du mois de la MES - date de MES)*(ABO/nbjour du mois de MES);                                                                                                                                                                                                                                                     &lt;br/&gt;          pLibPeriodeFinProrata := LAST_DAY(TRUNC(vDateMESEffec,&apos;MONTH&apos;));                                                                                                                                                                                                                                                                                     &lt;br/&gt;          pLibelleProrata:=pLibTypePrestaProrata||&apos; du &apos;||TO_CHAR(pLibPeriodeDebProrata,&apos;DD/MM/YYYY&apos;)||&apos; au &apos;||TO_CHAR(pLibPeriodeFinProrata,&apos;DD/MM/YYYY&apos;);                                                                                                                                                                                                    &lt;br/&gt;          pMontantProrata := (pLibPeriodeFinProrata-pLibPeriodeDebProrata)*(vAbo/vNbJMoisMES);                                                                                                                                                                                                                                                                 &lt;br/&gt;          codRet:=0;                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;        END IF;                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- mois MES effective &lt; mois calcul facturation - 1 et mois saisie MES (MEF) = mois calcul facturation - 1                                                                                                                                                                                                                                             &lt;br/&gt;        IF TRUNC(vDateMESEffec,&apos;MONTH&apos;) &lt; TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) AND TRUNC(pLigne.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                     &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          -- pMontantProrata = (dernier jour du mois de la MES - date de MES)*(ABO/nbjour du mois de MES)+ 1 Mois d&apos;abo;                                                                                                                                                                                                                                       &lt;br/&gt;          pLibPeriodeFinProrata := LAST_DAY(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;));                                                                                                                                                                                                                                                                     &lt;br/&gt;          pLibelleProrata:=pLibTypePrestaProrata||&apos; du &apos;||TO_CHAR(pLibPeriodeDebProrata,&apos;DD/MM/YYYY&apos;)||&apos; au &apos;||TO_CHAR(pLibPeriodeFinProrata,&apos;DD/MM/YYYY&apos;);                                                                                                                                                                                                    &lt;br/&gt;          pMontantProrata := ((LAST_DAY(TRUNC(pLibPeriodeDebProrata,&apos;MONTH&apos;))-pLibPeriodeDebProrata)*(vAbo/vNbJMoisMES))+MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(pLibPeriodeDebProrata,&apos;MONTH&apos;))*vAbo;                                                                                                                               &lt;br/&gt;          codRet:=0;                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;        END IF;                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- Date de saisie de MES antérieure à 2 mois -&gt; Dans ce cas il y a toujours un abonnement, à terme Echu ou à Echoir                                                                                                                                                                                                                                    &lt;br/&gt;        IF TRUNC(PLIGNE.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(PDATECALCFACTU,-2),&apos;MONTH&apos;) THEN   &lt;br/&gt;           pMontant := vAbo;       &lt;br/&gt;          -- pMontantProrata := TO_NUMBER(NULL); &lt;br/&gt;			   --story 1348&lt;br/&gt;			IF TRUNC(pLigne.DATE_DEBUT_FACTU__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN&lt;br/&gt;				pLibPeriodeFinProrata := LAST_DAY(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;));&lt;br/&gt;				pLibelleProrata:=pLibTypePrestaProrata||&apos; du &apos;||TO_CHAR(pLibPeriodeDebProrata,&apos;DD/MM/YYYY&apos;)||&apos; au &apos;||TO_CHAR(pLibPeriodeFinProrata,&apos;DD/MM/YYYY&apos;);&lt;br/&gt;				PMONTANTPRORATA := ((LAST_DAY(TRUNC(PLIBPERIODEDEBPRORATA,&apos;MONTH&apos;))-PLIBPERIODEDEBPRORATA)*(VABO/VNBJMOISMES))+MONTHS_BETWEEN(TRUNC(ADD_MONTHS(PDATECALCFACTU,-1),&apos;MONTH&apos;),TRUNC(PLIBPERIODEDEBPRORATA,&apos;MONTH&apos;))*VABO;&lt;br/&gt;				 --story 1348 : si c&apos; est a echoir calcul de l&apos; abo du mois suivant. si c&apos; est echu il n&apos; y aura que le prorata&lt;br/&gt;				  IF vTerme = &apos;ECHU&apos; THEN&lt;br/&gt;					pMontant := TO_NUMBER(NULL); &lt;br/&gt;				  END IF;&lt;br/&gt;    	END IF;&lt;br/&gt;          codRet:=0;                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;        END IF;                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;      -- TRIMESTRI, SEMESTRI, ANNU -&gt; ELLE                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;      ELSE                                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;        IF vTerme = &apos;A ECHOIR&apos; THEN                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          -- Date de saisie MES inférieure ou égale à date de calcul de facturation -2 : Abonnement normal                                                                                                                                                                                                                                                    &lt;br/&gt;            IF TRUNC(pLigne.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-2),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                  &lt;br/&gt;		         -- Sommes nous à la facturation d&apos;une période ?                                                                                                                                                                                                                                                                                                    &lt;br/&gt;				IF pMoisInclus THEN  -- oui                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;					PMONTANT := PFACTEUR*VABO;  &lt;br/&gt;						--story 1348&lt;br/&gt;						--  calcul du prorata que si Mois date debut_factu = Mois de Date de calcul - 1&lt;br/&gt;					IF  TRUNC(pLigne.DATE_DEBUT_FACTU__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN&lt;br/&gt;						pLibPeriodeFinProrata :=LAST_DAY(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;));                                                                                                                                                                                                                                                                  &lt;br/&gt;						pLibelleProrata:=pLibTypePrestaProrata||&apos; du &apos;||TO_CHAR(pLibPeriodeDebProrata,&apos;DD/MM/YYYY&apos;)||&apos; au &apos;||TO_CHAR(pLibPeriodeFinProrata,&apos;DD/MM/YYYY&apos;);  &lt;br/&gt;						-- jour de debut factu non inclus dans calcul du prorata&lt;br/&gt;						pMontantProrata := (MONTHS_BETWEEN(TRUNC(pDateCalcFactu,&apos;MONTH&apos;),TRUNC(pLibPeriodeDebProrata,&apos;MONTH&apos;))*vAbo)-((pLibPeriodeDebProrata-TRUNC(pLibPeriodeDebProrata,&apos;MONTH&apos;)+1)*(vAbo/vNbJMoisMES));                                                                                                                                                  &lt;br/&gt;					END IF;	&lt;br/&gt;					codRet:=0;  &lt;br/&gt;				ELSE  -- Pas le mois de facturation d&apos;une période &lt;br/&gt;				      -- Pas d&apos;ABO&lt;br/&gt;					  --  calcul du prorata que si Mois date debut_factu = Mois de Date de calcul - 1&lt;br/&gt;  					IF TRUNC(pLigne.DATE_DEBUT_FACTU__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN&lt;br/&gt;						pLibPeriodeFinProrata := F_CalculDateFinPeriod (pDateCalcFactu, pFacteur);&lt;br/&gt;						pLibelleProrata:=pLibTypePrestaProrata||&apos; du &apos;||TO_CHAR(pLibPeriodeDebProrata,&apos;DD/MM/YYYY&apos;)||&apos; au &apos;||TO_CHAR(pLibPeriodeFinProrata,&apos;DD/MM/YYYY&apos;);                                                                                                                                                                                              &lt;br/&gt;					-- Nombre de mois entre date de MES effective et date de fin de période moins les jours du début de mois de MES effective à la date effective.                                                                                                                                                                                                 &lt;br/&gt;						pMontantProrata := (MONTHS_BETWEEN(pLibPeriodeFinProrata+1,TRUNC(pLibPeriodeDebProrata,&apos;MONTH&apos;))*vAbo)-((pLibPeriodeDebProrata-TRUNC(pLibPeriodeDebProrata,&apos;MONTH&apos;)+1)*(vAbo/vNbJMoisMES));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;					END IF;&lt;br/&gt;					codRet:=0;  &lt;br/&gt;				END IF;&lt;br/&gt;          -- Détection saisie MES à n-1 de date de calcul de facturation                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;          ELSIF TRUNC(pLigne.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                &lt;br/&gt;            -- Sommes nous à la facturation d&apos;une période ?                                                                                                                                                                                                                                                                                                    &lt;br/&gt;            IF PMOISINCLUS THEN                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;              pMontant := pFacteur*vAbo;                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;              pLibPeriodeFinProrata :=LAST_DAY(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;));                                                                                                                                                                                                                                                                  &lt;br/&gt;              pLibelleProrata:=pLibTypePrestaProrata||&apos; du &apos;||TO_CHAR(pLibPeriodeDebProrata,&apos;DD/MM/YYYY&apos;)||&apos; au &apos;||TO_CHAR(pLibPeriodeFinProrata,&apos;DD/MM/YYYY&apos;);                                                                                                                                                                                                &lt;br/&gt;              -- Nombre de mois entre date de MES effective et date de facturation moins les jours du début de mois de MES effective à la date effective.                                                                                                                                                                                                      &lt;br/&gt;              pMontantProrata := (MONTHS_BETWEEN(TRUNC(pDateCalcFactu,&apos;MONTH&apos;),TRUNC(pLibPeriodeDebProrata,&apos;MONTH&apos;))*vAbo)-((pLibPeriodeDebProrata-TRUNC(pLibPeriodeDebProrata,&apos;MONTH&apos;))*(vAbo/vNbJMoisMES));                                                                                                                                                  &lt;br/&gt;              codRet:=0;                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;            -- Mois de facturation hors période                                                                                                                                                                                                                                                                                                                &lt;br/&gt;            ELSE                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;              -- si la date de MES effective est inférieure à la période de fréquence                                                                                                                                                                                                                                                                          &lt;br/&gt;              IF (TRUNC(vDateMESEffec,&apos;MONTH&apos;) &lt; TRUNC(pDateCalcFactu,&apos;Q&apos;) AND pFacteur = 3)                                                                                                                                                                                                                                                                   &lt;br/&gt;                -- Pour le semestre on compare le numéro de trimestre en prenant soin de lier les trimestres 1 et 2 -&gt; 1, et 3 et 4 -&gt; 3.                                                                                                                                                                                                                      &lt;br/&gt;                OR (TRANSLATE(TO_CHAR(vDateMESEffec,&apos;Q&apos;),&apos;24&apos;,&apos;13&apos;) &lt;&gt; TRANSLATE(TO_CHAR(pDateCalcFactu,&apos;Q&apos;),&apos;24&apos;,&apos;13&apos;) AND pFacteur = 6)                                                                                                                                                                                                                      &lt;br/&gt;                OR (TRUNC(vDateMESEffec,&apos;MONTH&apos;) &lt; TRUNC(pDateCalcFactu,&apos;YEAR&apos;) AND pFacteur = 12) THEN                                                                                                                                                                                                                                                        &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                pMontant := pFacteur*vAbo;                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                CASE pFacteur                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                  WHEN 3 THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                    -- Début du trimestre en cours -1jour = fin du trimestre précédent                                                                                                                                                                                                                                                                         &lt;br/&gt;                    pLibPeriodeFinProrata :=(TRUNC(pDateCalcFactu,&apos;Q&apos;)-1);                                                                                                                                                                                                                                                                                     &lt;br/&gt;                  WHEN 6 THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                    -- Début du semestre en cours  -1jour = fin du semestre précédent                                                                                                                                                                                                                                                                          &lt;br/&gt;                    IF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;1&apos;,&apos;3&apos;) THEN                                                                                                                                                                                                                                                                                           &lt;br/&gt;                      pLibPeriodeFinProrata :=(TRUNC(pDateCalcFactu,&apos;Q&apos;)-1);                                                                                                                                                                                                                                                                                   &lt;br/&gt;                    ELSIF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;2&apos;,&apos;4&apos;) THEN                                                                                                                                                                                                                                                                                        &lt;br/&gt;                     -- alors il faut enlever 3 mois (-3) pour passer au trimestre précédent et tomber dans le bon début de semestre                                                                                                                                                                                                                           &lt;br/&gt;                      pLibPeriodeFinProrata :=(TRUNC(ADD_MONTHS(pDateCalcFactu,-3),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                                    &lt;br/&gt;                    END IF;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                  WHEN 12 THEN                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                    pLibPeriodeFinProrata :=(TRUNC(pDateCalcFactu,&apos;YEAR&apos;)-1);                                                                                                                                                                                                                                                                                  &lt;br/&gt;                END CASE;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                --pLibPeriodeFinProrata :=LAST_DAY(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;));                                                                                                                                                                                                                                                              &lt;br/&gt;                pLibelleProrata:=pLibTypePrestaProrata||&apos; du &apos;||TO_CHAR(pLibPeriodeDebProrata,&apos;DD/MM/YYYY&apos;)||&apos; au &apos;||TO_CHAR(pLibPeriodeFinProrata,&apos;DD/MM/YYYY&apos;);                                                                                                                                                                                              &lt;br/&gt;                -- Nombre de mois entre date de MES effective et date de facturation moins les jours du début de mois de MES effective à la date effective.                                                                                                                                                                                                    &lt;br/&gt;                --pMontantProrata := (MONTHS_BETWEEN(TRUNC(pDateCalcFactu,&apos;MONTH&apos;),TRUNC(pLibPeriodeDebProrata,&apos;MONTH&apos;))*vAbo)-((pLibPeriodeDebProrata-TRUNC(pLibPeriodeDebProrata,&apos;MONTH&apos;)+1)*(vAbo/vNbJMoisMES));                                                                                                                                            &lt;br/&gt;               -- Nombre de mois entre date MES et date de prochaine facturation au trimestre/semestre/année * abo + nbre de jours entre date MES et fin du mois de date MES                                                                                                                                                                                   &lt;br/&gt;               vNbJMESFinMois :=LAST_DAY(TRUNC(pLibPeriodeDebProrata,&apos;MONTH&apos;))-pLibPeriodeDebProrata;                                                                                                                                                                                                                                                          &lt;br/&gt;               vNbMoisMESDebFactuXtriel :=MONTHS_BETWEEN(pLibPeriodeFinProrata,(LAST_DAY(TRUNC(pLibPeriodeDebProrata,&apos;MONTH&apos;))));                                                                                                                                                                                                                              &lt;br/&gt;               pMontantProrata := vNbMoisMESDebFactuXtriel*vAbo;                                                                                                                                                                                                                                                                                               &lt;br/&gt;               pMontantProrata := pMontantProrata + ((vNbJMESFinMois)*(vAbo/vNbJMoisMES));                                                                                                                                                                                                                                                                     &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              ELSE    &lt;br/&gt;				pLibPeriodeFinProrata := F_CalculDateFinPeriod (pDateCalcFactu, pFacteur);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                pLibelleProrata:=pLibTypePrestaProrata||&apos; du &apos;||TO_CHAR(pLibPeriodeDebProrata,&apos;DD/MM/YYYY&apos;)||&apos; au &apos;||TO_CHAR(pLibPeriodeFinProrata,&apos;DD/MM/YYYY&apos;);                                                                                                                                                                                              &lt;br/&gt;                -- Nombre de mois entre date de MES effective et date de fin de période moins les jours du début de mois de MES effective à la date effective.                                                                                                                                                                                                 &lt;br/&gt;                pMontantProrata := (MONTHS_BETWEEN(pLibPeriodeFinProrata+1,TRUNC(pLibPeriodeDebProrata,&apos;MONTH&apos;))*vAbo)-((pLibPeriodeDebProrata-TRUNC(pLibPeriodeDebProrata,&apos;MONTH&apos;)+1)*(vAbo/vNbJMoisMES));                                                                                                                                                    &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          END IF; -- Fin Date saisie MES                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;        END IF; -- Fin A echoir                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;        -- Echu                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;        IF vTerme = &apos;ECHU&apos; THEN                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;         -- Date de saisie MES inférieure ou égalle à date de calcul de facturation -2 : Abonnement normal                                                                                                                                                                                                                                                     &lt;br/&gt;          IF TRUNC(pLigne.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-2),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                  &lt;br/&gt;            -- Abonnement normal car mise en service antérieur à la fréquence précédente                                                                                                                                                                                                                                                                       &lt;br/&gt;            IF TRUNC(pLigne.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;) &lt; TRUNC(ADD_MONTHS(pDateCalcFactu,(-1*pFacteur)),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                      &lt;br/&gt;              IF pMoisInclus THEN                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                pMontant := pFacteur*vAbo;                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            -- Reste des mois à facturer suite mise en service détectée dans la fréquence précédente.                                                                                                                                                                                                                                                          &lt;br/&gt;            ELSE                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;              IF pMoisInclus THEN                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                pMontant := MONTHS_BETWEEN(TRUNC(pDateCalcFactu,&apos;MONTH&apos;),ADD_MONTHS(TRUNC(vDateMESEffec,&apos;MONTH&apos;),+1))*vAbo;                                                                                                                                                                                                                                    &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          ELSIF TRUNC(pLigne.DATE_MISE_EN_FACTU__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                &lt;br/&gt;            -- Sommes nous à la facturation d&apos;une période ?                                                                                                                                                                                                                                                                                                    &lt;br/&gt;            IF pMoisInclus THEN                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;              pLibPeriodeFinProrata :=LAST_DAY(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;));                                                                                                                                                                                                                                                                  &lt;br/&gt;              pLibelleProrata:=pLibTypePrestaProrata||&apos; du &apos;||TO_CHAR(pLibPeriodeDebProrata,&apos;DD/MM/YYYY&apos;)||&apos; au &apos;||TO_CHAR(pLibPeriodeFinProrata,&apos;DD/MM/YYYY&apos;);                                                                                                                                                                                                &lt;br/&gt;              -- Nombre de mois entre date de MES effective et date de facturation moins les jours du début de mois de MES effective à la date effective.                                                                                                                                                                                                      &lt;br/&gt;              pMontantProrata := (MONTHS_BETWEEN(TRUNC(pLibPeriodeDebProrata,&apos;MONTH&apos;),TRUNC(pDateCalcFactu,&apos;MONTH&apos;))*vAbo)-((pLibPeriodeDebProrata-TRUNC(pLibPeriodeDebProrata,&apos;MONTH&apos;)+1)*(vAbo/vNbJMoisMES));                                                                                                                                                &lt;br/&gt;              codRet:=0;                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;            -- Mois de facturation hors période                                                                                                                                                                                                                                                                                                                &lt;br/&gt;            ELSE                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;              pLibPeriodeFinProrata :=LAST_DAY(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;));                                                                                                                                                                                                                                                                  &lt;br/&gt;              pLibelleProrata:=pLibTypePrestaProrata||&apos; du &apos;||TO_CHAR(pLibPeriodeDebProrata,&apos;DD/MM/YYYY&apos;)||&apos; au &apos;||TO_CHAR(pLibPeriodeFinProrata,&apos;DD/MM/YYYY&apos;);                                                                                                                                                                                                &lt;br/&gt;              -- Nombre de mois entre date de MES effective et date de facturation moins les jours du début de mois de MES effective à la date effective.                                                                                                                                                                                                      &lt;br/&gt;              pMontantProrata := (MONTHS_BETWEEN(TRUNC(pLibPeriodeDebProrata,&apos;MONTH&apos;),TRUNC(pDateCalcFactu,&apos;MONTH&apos;))*vAbo)-((pLibPeriodeDebProrata-TRUNC(pLibPeriodeDebProrata,&apos;MONTH&apos;)+1)*(vAbo/vNbJMoisMES));                                                                                                                                                &lt;br/&gt;              codRet:=0;                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          END IF; -- Date saisie MES                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;        END IF; -- Fin Echu                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;      END IF; -- Fin pFacteur = 1                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;    END IF; -- vDateMESEffec &lt;= n-1                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;  END IF; -- Fin ACTIF                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;  &lt;br/&gt;  --Story 431 (arrondi a 2)&lt;br/&gt;  pMontant       := ROUND(pMontant, 2);&lt;br/&gt;  pMontantProrata:= ROUND(pMontantProrata, 2);                           &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  RETURN codRet;                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;END F_FactuAboProrata;                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;-- Calcul des résiliations sans prorata temporis                                                                                                                                                                                                                                                                                                               &lt;br/&gt;/* retourne codRet                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt; * 1 = non traité, on passe                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt; * 2 = erreur, on trace si besoin                                                                                                                                                                                                                                                                                                                              &lt;br/&gt; * 0 = ok, on est passé dedans                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt; */                                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;FUNCTION F_FactuResil (pLigne IN T_FDSL_SERVICE_SF%ROWTYPE, pDateCalcFactu IN DATE, pMontant OUT NUMBER, pMontantFAS OUT NUMBER, pFacteur IN NUMBER, pMoisInclus BOOLEAN, pLibTypePresta OUT VARCHAR2, pLibPeriodeDeb OUT DATE, pLibPeriodeFin OUT DATE, pMsg OUT VARCHAR2) RETURN INTEGER IS                                                                  &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;codRet INTEGER :=1;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;vAbo T_FDSL_DETAIL_FACTURE.MONTANT%TYPE;                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;vLoc T_FDSL_DETAIL_FACTURE.MONTANT%TYPE;                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;vTerme T_FDSL_DETAIL_FACTURE.TERME_FACTU%TYPE;                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;vDateMESEffec DATE;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;vDE T_FDSL_DETAIL_FACTURE.DUREE_ENGAGEMENT%TYPE;                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;vDateDebPeriodeEncours DATE;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;vDateDebPeriodeSuivante DATE;                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;vDateDebPeriodePrecedente DATE;                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  -- Initialisation des variables                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;  vTerme := UPPER(TRANSLATE(pLigne.TERME_FACTU__C,&apos;éà&apos;,&apos;ea&apos;));                                                                                                                                                                                                                                                                                                 &lt;br/&gt;  vDateMESEffec :=TRUNC(NVL(pLigne.DATE_DEBUT_FACTU__C,pLigne.DATE_MES_EFFECTIVE__C));                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  pMsg := NULL;                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;  pMontant:=TO_NUMBER(NULL);                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;  pMontantFAS:=TO_NUMBER(NULL);                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;  pLibTypePresta:=NULL;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;  pLibPeriodeDeb:=NULL;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;  pLibPeriodeFin:=NULL;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  -- Statut différent actif et mois de date mise en résil = n-1                                                                                                                                                                                                                                                                                                &lt;br/&gt;  IF UPPER(pLigne.STATUT__C) &lt;&gt; &apos;ACTIF&apos; AND TRUNC(pLigne.DATE_MISE_EN_RESIL__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                    &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;    -- Cas perte d&apos;accès                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;    IF UPPER(pLigne.MOTIF_RESILIATION__C) LIKE &apos;%PERTE%&apos; THEN                                                                                                                                                                                                                                                                                                  &lt;br/&gt;      pMontant:=0;                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;      pLibTypePresta:=&apos;Résiliation non facturée&apos;;                                                                                                                                                                                                                                                                                                              &lt;br/&gt;      codRet:=0;                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;      -- Faire apparaitre la ligne dans le détail de facture                                                                                                                                                                                                                                                                                                   &lt;br/&gt;    ELSE                                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;      -- On récupère le montant de l&apos;abonnement antérieur                                                                                                                                                                                                                                                                                                      &lt;br/&gt;      codRet := F_AncienAbo(pLigne,vAbo,vDE,vLoc,pMsg);                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;      -- On ne traite que si le code retour est égale à 0, sinon on retourne le code et l&apos;erreur sera traitée par la procédure mère avec insertion du msg dans le detail analyse de la ligne.                                                                                                                                                                  &lt;br/&gt;      IF codRet = 0 THEN                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;        -- On récupère le FAS de résiliation dans tous les cas.                                                                                                                                                                                                                                                                                                &lt;br/&gt;        pMontantFAS := TO_NUMBER(pLigne.FAS__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;);                                                                                                                                                                                                                                                                   &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- On note le montant de l&apos;abonnement et la durée d&apos;engagement à titre informatif                                                                                                                                                                                                                                                                      &lt;br/&gt;        pMsg:=&apos;## Abonnement de : &apos;||TO_CHAR(vAbo)||&apos;, Durée d&apos;&apos;engagement de :&apos;||TO_CHAR(vDE);                                                                                                                                                                                                                                                                &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- MENSUELLE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;        IF pFacteur = 1 THEN                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          -- Terme A echoir                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;          IF vTerme = &apos;A ECHOIR&apos; THEN                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            -- Si date de résiliation inférieure ou égalle à n-1                                                                                                                                                                                                                                                                                               &lt;br/&gt;            IF TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                        &lt;br/&gt;              -- nb mois entre date de MES effective et date de résil &lt; durée d&apos;engagement, cad durée d&apos;engagement non terminée                                                                                                                                                                                                                                &lt;br/&gt;              IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN                                                                                                                                                                                                                                                   &lt;br/&gt;                -- pMontant = mois de durée d&apos;engagement moins la différence de mois entre la date de MES effective et date de résil moins 1mois (car un mois déjà payé)* ABO                                                                                                                                                                                  &lt;br/&gt;                pMontant:=((vDE-MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)))-1)*vAbo;                                                                                                                                                                                                                                     &lt;br/&gt;                pLibTypePresta:=&apos;Résiliations : Montants restant dus&apos;;                                                                                                                                                                                                                                                                                         &lt;br/&gt;                pLibPeriodeDeb:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                pLibPeriodeFin:=ADD_MONTHS(vDateMESEffec,+vDE);                                                                                                                                                                                                                                                                                                &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              -- Engagement terminé                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;              ELSIF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN                                                                                                                                                                                                                                               &lt;br/&gt;                -- on rembourse le nombre de mois trop perçu (le résultat de la soustraction sera négatif)                                                                                                                                                                                                                                                     &lt;br/&gt;                pMontant:=TO_NUMBER(MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;)))*vAbo;                                                                                                                                                                                                                    &lt;br/&gt;                pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;)));                                                                                                                                                                                                  &lt;br/&gt;                pLibTypePresta:=&apos;Régularisation suite à résiliation&apos;;                                                                                                                                                                                                                                                                                          &lt;br/&gt;                pLibPeriodeDeb:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                pLibPeriodeFin:=pDateCalcFactu-1;                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                codRet :=0;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          -- Terme échu                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;          ELSIF vTerme = &apos;ECHU&apos; THEN                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;            -- Date de résil = n - 1                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;            IF TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                         &lt;br/&gt;              -- nb mois entre date de MES effective et date de résil &lt; durée d&apos;engagement, cad durée d&apos;engagement non terminée                                                                                                                                                                                                                                &lt;br/&gt;              IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN                                                                                                                                                                                                                                                   &lt;br/&gt;                -- pMontant = mois de durée d&apos;engagement moins la différence de mois entre la date de MES effective et la date de facturation moins 1 * ABO                                                                                                                                                                                                    &lt;br/&gt;                pMontant:=(vDE-MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)))*vAbo;                                                                                                                                                                                                                                &lt;br/&gt;                pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)));                                                                                                                                                                                                     &lt;br/&gt;                pLibTypePresta:=&apos;Résiliations : Montants restant dus&apos;;                                                                                                                                                                                                                                                                                         &lt;br/&gt;                pLibPeriodeDeb:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                pLibPeriodeFin:=ADD_MONTHS(vDateMESEffec,+vDE);                                                                                                                                                                                                                                                                                                &lt;br/&gt;                codRet :=0;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;              -- Engagement terminé                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;              ELSIF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN                                                                                                                                                                                                                                               &lt;br/&gt;                pMontant:=TO_NUMBER(MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;)))*vAbo;                                                                                                                                                                                                                    &lt;br/&gt;                pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;)));                                                                                                                                                                                                  &lt;br/&gt;                pLibTypePresta:=&apos;Résiliations : Montants restant dus&apos;;                                                                                                                                                                                                                                                                                         &lt;br/&gt;                pLibPeriodeDeb:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                pLibPeriodeFin:=pDateCalcFactu-1;                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                codRet :=0;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            -- Date résil &lt; n - 1                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;            ELSIF TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;) &lt; TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                      &lt;br/&gt;              -- nb mois entre date de MES effective et date de résil &lt; durée d&apos;engagement, cad durée d&apos;engagement non terminée                                                                                                                                                                                                                                &lt;br/&gt;              IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN                                                                                                                                                                                                                                                   &lt;br/&gt;                -- pMontant = mois de durée d&apos;engagement moins la différence de mois entre la date de MES effective et la date de facturation moins 1 * ABO                                                                                                                                                                                                    &lt;br/&gt;                pMontant:=(vDE-MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)))*vAbo;                                                                                                                                                                                                                                &lt;br/&gt;                pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)));                                                                                                                                                                                                     &lt;br/&gt;                pLibTypePresta:=&apos;Résiliations : Montants restant dus&apos;;                                                                                                                                                                                                                                                                                         &lt;br/&gt;                pLibPeriodeDeb:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                pLibPeriodeFin:=ADD_MONTHS(vDateMESEffec,+vDE);                                                                                                                                                                                                                                                                                                &lt;br/&gt;                codRet :=0;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;              -- Engagement terminé                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;              ELSIF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN                                                                                                                                                                                                                                               &lt;br/&gt;                -- on rembourse le nombre de mois trop perçu jusqu&apos;à n-2 uniquement (le résultat de la soustraction sera négatif)                                                                                                                                                                                                                              &lt;br/&gt;                pMontant:=TO_NUMBER(MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(ADD_MONTHS(pDateCalcFactu,-2),&apos;MONTH&apos;)))*vAbo;                                                                                                                                                                                                                    &lt;br/&gt;                pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(ADD_MONTHS(pDateCalcFactu,-2),&apos;MONTH&apos;)));                                                                                                                                                                                                  &lt;br/&gt;                pLibTypePresta:=&apos;Régularisation suite à résiliation&apos;;                                                                                                                                                                                                                                                                                          &lt;br/&gt;                pLibPeriodeDeb:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                pLibPeriodeFin:=pDateCalcFactu-1;                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                codRet :=0;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF; -- fin tests sur n-1                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;          END IF; -- fin terme                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- TRIMESTRI, SEMESTRI, ANNU -&gt; ELLE                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;        ELSE                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;          CASE pFacteur                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;            WHEN 3 THEN                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              vDateDebPeriodeEncours :=TRUNC(pDateCalcFactu,&apos;Q&apos;);                                                                                                                                                                                                                                                                                              &lt;br/&gt;              vDateDebPeriodeSuivante :=(TRUNC(ADD_MONTHS(pDateCalcFactu,+3),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                                          &lt;br/&gt;              vDateDebPeriodePrecedente :=TRUNC(ADD_MONTHS(pDateCalcFactu,-3),&apos;Q&apos;);                                                                                                                                                                                                                                                                            &lt;br/&gt;            WHEN 6 THEN                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              IF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;1&apos;,&apos;3&apos;) THEN                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                vDateDebPeriodeEncours :=TRUNC(pDateCalcFactu,&apos;Q&apos;);                                                                                                                                                                                                                                                                                            &lt;br/&gt;                vDateDebPeriodeSuivante :=TRUNC(ADD_MONTHS(pDateCalcFactu,+6),&apos;Q&apos;);                                                                                                                                                                                                                                                                            &lt;br/&gt;                vDateDebPeriodePrecedente :=TRUNC(ADD_MONTHS(pDateCalcFactu,-6),&apos;Q&apos;);                                                                                                                                                                                                                                                                          &lt;br/&gt;              ELSIF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;2&apos;,&apos;4&apos;) THEN                                                                                                                                                                                                                                                                                              &lt;br/&gt;                vDateDebPeriodeEncours :=TRUNC(ADD_MONTHS(pDateCalcFactu,-3),&apos;Q&apos;);                                                                                                                                                                                                                                                                             &lt;br/&gt;                vDateDebPeriodeSuivante :=TRUNC(ADD_MONTHS(pDateCalcFactu,+3),&apos;Q&apos;);                                                                                                                                                                                                                                                                            &lt;br/&gt;                vDateDebPeriodePrecedente :=TRUNC(ADD_MONTHS(pDateCalcFactu,-9),&apos;Q&apos;);                                                                                                                                                                                                                                                                          &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            WHEN 12 THEN                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;              vDateDebPeriodeEncours :=TRUNC(pDateCalcFactu,&apos;YEAR&apos;);                                                                                                                                                                                                                                                                                           &lt;br/&gt;              vDateDebPeriodeSuivante :=ADD_MONTHS(TRUNC(pDateCalcFactu,&apos;YEAR&apos;),+12);                                                                                                                                                                                                                                                                          &lt;br/&gt;              vDateDebPeriodePrecedente :=ADD_MONTHS(TRUNC(pDateCalcFactu,&apos;YEAR&apos;),-12);                                                                                                                                                                                                                                                                        &lt;br/&gt;          END CASE;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          IF vTerme = &apos;A ECHOIR&apos; THEN                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            IF TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                        &lt;br/&gt;              IF pMoisInclus THEN                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                -- nb mois entre date de MES effective et date de résil &lt; durée d&apos;engagement, cad durée d&apos;engagement non terminée                                                                                                                                                                                                                              &lt;br/&gt;                IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN                                                                                                                                                                                                                                                 &lt;br/&gt;                  pMontant:=(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;)))*vAbo;                                                                                                                                                                                                                                             &lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;)));                                                                                                                                                                                                                  &lt;br/&gt;                  pLibTypePresta:=&apos;Résiliations : Montants restant dus&apos;;                                                                                                                                                                                                                                                                                       &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                  pLibPeriodeFin:=ADD_MONTHS(vDateMESEffec,+vDE);                                                                                                                                                                                                                                                                                              &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                -- Engagement terminé                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                ELSIF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN                                                                                                                                                                                                                                             &lt;br/&gt;                  -- remboursement                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                  pMontant:=MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),vDateDebPeriodeEncours)*vAbo;                                                                                                                                                                                                                                                   &lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),vDateDebPeriodeEncours));                                                                                                                                                                                                                      &lt;br/&gt;                  pLibTypePresta:=&apos;Régularisation suite à résiliation&apos;;                                                                                                                                                                                                                                                                                        &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                  pLibPeriodeFin:=vDateDebPeriodeEncours-1;                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              -- Mois de facturation hors période                                                                                                                                                                                                                                                                                                              &lt;br/&gt;              ELSE                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                -- nb mois entre date de MES effective et date de résil &lt; durée d&apos;engagement, cad durée d&apos;engagement non terminée                                                                                                                                                                                                                              &lt;br/&gt;                IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN                                                                                                                                                                                                                                                 &lt;br/&gt;                  pMontant:=(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;)))*vAbo;                                                                                                                                                                                                                                             &lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;)));                                                                                                                                                                                                                  &lt;br/&gt;                  pLibTypePresta:=&apos;Résiliations : Montants restant dus&apos;;                                                                                                                                                                                                                                                                                       &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                  pLibPeriodeFin:=ADD_MONTHS(vDateMESEffec,+vDE);                                                                                                                                                                                                                                                                                              &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                -- Engagement terminé                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                ELSIF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN                                                                                                                                                                                                                                             &lt;br/&gt;                  -- remboursement                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                  -- Mois entre date résil et début période suivante                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  pMontant:=MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),vDateDebPeriodeSuivante)*vAbo;                                                                                                                                                                                                                                                  &lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),vDateDebPeriodeSuivante));                                                                                                                                                                                                                     &lt;br/&gt;                  pLibTypePresta:=&apos;Régularisation suite à résiliation&apos;;                                                                                                                                                                                                                                                                                        &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                  pLibPeriodeFin:=vDateDebPeriodeSuivante-1;                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          END IF; -- Fin A echoir                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          -- Echu                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          IF vTerme = &apos;ECHU&apos; THEN                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;            IF TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                        &lt;br/&gt;              IF pMoisInclus THEN                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                -- nb mois entre date de MES effective et date de résil &lt; durée d&apos;engagement, cad durée d&apos;engagement non terminée                                                                                                                                                                                                                              &lt;br/&gt;                IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN                                                                                                                                                                                                                                                 &lt;br/&gt;                  pMontant:=(vDE-MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(vDateMESEffec,&apos;MONTH&apos;)))*vAbo;                                                                                                                                                                                                                                                 &lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(vDateMESEffec,&apos;MONTH&apos;)));                                                                                                                                                                                                                      &lt;br/&gt;                  pLibTypePresta:=&apos;Résiliations : Montants restant dus&apos;;                                                                                                                                                                                                                                                                                       &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                  pLibPeriodeFin:=ADD_MONTHS(vDateMESEffec,+vDE);                                                                                                                                                                                                                                                                                              &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                -- Engagement terminé                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                ELSIF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN                                                                                                                                                                                                                                             &lt;br/&gt;                  pMontant:=MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))*vAbo;                                                                                                                                                                                                                                                &lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;)));                                                                                                                                                                                                                   &lt;br/&gt;                  pLibTypePresta:=&apos;Résiliations : Montants restant dus&apos;;                                                                                                                                                                                                                                                                                       &lt;br/&gt;                  pLibPeriodeDeb:=vDateDebPeriodePrecedente;                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                  pLibPeriodeFin:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              -- Mois de facturation hors période                                                                                                                                                                                                                                                                                                              &lt;br/&gt;              ELSE                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                -- nb mois entre date de MES effective et date de résil &lt; durée d&apos;engagement, cad durée d&apos;engagement non terminée                                                                                                                                                                                                                              &lt;br/&gt;                IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN                                                                                                                                                                                                                                                 &lt;br/&gt;                  pMontant:=(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;)))*vAbo;                                                                                                                                                                                                                                             &lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;)));                                                                                                                                                                                                                  &lt;br/&gt;                  pLibTypePresta:=&apos;Résiliations : Montants restant dus&apos;;                                                                                                                                                                                                                                                                                       &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                  pLibPeriodeFin:=ADD_MONTHS(vDateMESEffec,+vDE);                                                                                                                                                                                                                                                                                              &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                -- Engagement terminé                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                ELSIF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN                                                                                                                                                                                                                                             &lt;br/&gt;                  -- si la date de MES effective est inférieure à la période de fréquence                                                                                                                                                                                                                                                                      &lt;br/&gt;                  IF (TRUNC(pLigne.DATE_RESIL__C,&apos;Q&apos;) = TRUNC(pDateCalcFactu,&apos;Q&apos;) AND pFacteur = 3)                                                                                                                                                                                                                                                            &lt;br/&gt;                    -- Pour le semestre on compare le numéro de trimestre en prenant soin de lier les trimestres 1 et 2 -&gt; 1, et 3 et 4 -&gt; 3.                                                                                                                                                                                                                  &lt;br/&gt;                    OR (TRANSLATE(TO_CHAR(pLigne.DATE_RESIL__C,&apos;Q&apos;),&apos;24&apos;,&apos;13&apos;) = TRANSLATE(TO_CHAR(pDateCalcFactu,&apos;Q&apos;),&apos;24&apos;,&apos;13&apos;) AND pFacteur = 6)                                                                                                                                                                                                            &lt;br/&gt;                    OR (TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;) = TRUNC(pDateCalcFactu,&apos;YEAR&apos;) AND pFacteur = 12) THEN                                                                                                                                                                                                                                             &lt;br/&gt;                    pMontant:=MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))*vAbo;                                                                                                                                                                                                                                              &lt;br/&gt;                    pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;)));                                                                                                                                                                                                                &lt;br/&gt;                    pLibTypePresta:=&apos;Résiliations : Montants restant dus&apos;;                                                                                                                                                                                                                                                                                     &lt;br/&gt;                    pLibPeriodeDeb:=vDateDebPeriodePrecedente;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                    pLibPeriodeFin:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                    codRet:=0;                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  ELSIF (TRUNC(pLigne.DATE_RESIL__C,&apos;Q&apos;) &lt; TRUNC(pDateCalcFactu,&apos;Q&apos;) AND pFacteur = 3)                                                                                                                                                                                                                                                         &lt;br/&gt;                    -- Pour le semestre on compare le numéro de trimestre en prenant soin de lier les trimestres 1 et 2 -&gt; 1, et 3 et 4 -&gt; 3.                                                                                                                                                                                                                  &lt;br/&gt;                    OR (TRANSLATE(TO_CHAR(pLigne.DATE_RESIL__C,&apos;Q&apos;),&apos;24&apos;,&apos;13&apos;) &lt;&gt; TRANSLATE(TO_CHAR(pDateCalcFactu,&apos;Q&apos;),&apos;24&apos;,&apos;13&apos;) AND pFacteur = 6)                                                                                                                                                                                                           &lt;br/&gt;                    OR (TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;) &lt; TRUNC(pDateCalcFactu,&apos;YEAR&apos;) AND pFacteur = 12) THEN                                                                                                                                                                                                                                             &lt;br/&gt;                      -- remboursement                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                      pMontant:=MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),vDateDebPeriodeEncours)*vAbo;                                                                                                                                                                                                                                               &lt;br/&gt;                      pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),vDateDebPeriodeEncours));                                                                                                                                                                                                                  &lt;br/&gt;                      pLibTypePresta:=&apos;Régularisation suite à résiliation&apos;;                                                                                                                                                                                                                                                                                    &lt;br/&gt;                      pLibPeriodeDeb:=vDateDebPeriodeEncours;                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                      pLibPeriodeFin:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                      codRet:=0;                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                  END IF;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          END IF; -- Fin Echu                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;        END IF; -- Fin pFacteur = 1                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;        pMsg := pMsg||&apos; ##&apos;;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;      END IF; -- fin codRet = 0                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;    END IF; -- fin motif resil                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;  END IF; -- fin statut et date n-1                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;  &lt;br/&gt;  --Story 431 (arrondi a 2)&lt;br/&gt;  pMontant   := ROUND(pMontant   , 2);&lt;br/&gt;  pMontantFAS:= ROUND(pMontantFAS, 2);&lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  RETURN codRet;                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;END F_FactuResil;                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;-- Calcul des frais de résiliation avec prorata temporis                                                                                                                                                                                                                                                                                                       &lt;br/&gt;/* retourne codRet                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt; * 1 = non traité, on passe                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt; * 2 = erreur, on trace si besoin                                                                                                                                                                                                                                                                                                                              &lt;br/&gt; * 0 = ok, on est passé dedans                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt; */                                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;FUNCTION F_FactuResilProrata (pLigne IN T_FDSL_SERVICE_SF%ROWTYPE, pDateCalcFactu IN DATE, pMontant OUT NUMBER, pMontantLocation OUT NUMBER, pMontantFAS OUT NUMBER, pFacteur IN NUMBER, pMoisInclus IN BOOLEAN, pLibTypePresta OUT VARCHAR2, pLibPeriodeDeb OUT DATE, pLibPeriodeFin OUT DATE, pMsg OUT VARCHAR2) RETURN INTEGER IS                           &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;codRet INTEGER :=1;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;vNbJMoisRes NUMBER(5);                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;vNbJMoisEng NUMBER(5);                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;vAbo T_FDSL_DETAIL_FACTURE.MONTANT%TYPE;                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;vLoc T_FDSL_DETAIL_FACTURE.MONTANT%TYPE;                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;vTerme T_FDSL_DETAIL_FACTURE.TERME_FACTU%TYPE;                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;vDateMESEffec DATE;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;vDE T_FDSL_DETAIL_FACTURE.DUREE_ENGAGEMENT%TYPE;                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;vDateDebPeriodeEncours DATE;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;vDateDebPeriodeSuivante DATE;                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;vDateDebPeriodePrecedente DATE;                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;vDateFinEngagement DATE;                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  -- Initialisation des variables                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;  vTerme := UPPER(TRANSLATE(pLigne.TERME_FACTU__C,&apos;éà&apos;,&apos;ea&apos;));                                                                                                                                                                                                                                                                                                 &lt;br/&gt;  vDateMESEffec :=TRUNC(NVL(pLigne.DATE_DEBUT_FACTU__C,pLigne.DATE_MES_EFFECTIVE__C));                                                                                                                                                                                                                                                                         &lt;br/&gt;  --vDE:= NVL( TO_NUMBER( pLigne.DUREE_D_ENGAGEMENT__C, &apos;999999D99&apos;, &apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;), 0);  &lt;br/&gt;  --vDE:= TO_NUMBER( NVL( MONTHS_BETWEEN( TRUNC(pLigne.DATE_FIN_ENGAGEMENT__C, &apos;MONTH&apos;), TRUNC(pLigne.DATE_MES_EFFECTIVE__C, &apos;MONTH&apos;) ), 0), &apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;);&lt;br/&gt;  --STORY 436&lt;br/&gt;  vDE:= TO_NUMBER( NVL( MONTHS_BETWEEN( TRUNC(pLigne.DATE_FIN_ENGAGEMENT__C, &apos;MONTH&apos;), TRUNC(pLigne.DATE_MES_EFFECTIVE__C, &apos;MONTH&apos;) ), pLigne.DUREE_D_ENGAGEMENT__C), &apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;);&lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  pMsg := NULL;                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;  pMontant:=TO_NUMBER(NULL);                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;  pMontantFAS:=TO_NUMBER(NULL);                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;  pMontantLocation:=TO_NUMBER(NULL);                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;  vNbJMoisRes:=(LAST_DAY(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))-TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;)+1);                                                                                                                                                                                                                                                          &lt;br/&gt;  pLibTypePresta:=NULL;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;  pLibPeriodeDeb:=NULL;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;  pLibPeriodeFin:=NULL;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  -- Statut différent actif et mois de date mise en résil = n-1                                                                                                                                                                                                                                                                                                &lt;br/&gt;  IF UPPER(pLigne.STATUT__C) &lt;&gt; &apos;ACTIF&apos; AND TRUNC(pLigne.DATE_MISE_EN_RESIL__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                    &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;    -- Cas perte d&apos;accès -- cas spécial si ADSL Ext, on facture                                                                                                                                                                                                                                                                                                &lt;br/&gt;    IF UPPER(pLigne.MOTIF_RESILIATION__C) LIKE &apos;%PERTE%&apos; AND UPPER(pLigne.TECHNO__C) &lt;&gt; &apos;ADSL EXT&apos; THEN                                                                                                                                                                                                                                                        &lt;br/&gt;      pMontant:=0;                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;      pMontantLocation:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;      pLibTypePresta:=&apos;Résiliation non facturée&apos;;                                                                                                                                                                                                                                                                                                              &lt;br/&gt;      codRet:=0;                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;      -- Faire apparaitre la ligne dans le détail de facture                                                                                                                                                                                                                                                                                                   &lt;br/&gt;    ELSE                                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;      -- On récupère le montant de l&apos;abonnement antérieur                                                                                                                                                                                                                                                                                                      &lt;br/&gt;      codRet := F_AncienAbo(pLigne,vAbo,vDE,vLoc,pMsg);                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;      -- On ne traite que si le code retour est égale à 0, sinon on retourne le code et l&apos;erreur sera traitée par la procédure mère avec insertion du msg dans le detail analyse de la ligne.                                                                                                                                                                  &lt;br/&gt;      IF codRet = 0 THEN                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- Calcul Fin Engagement                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        vDateFinEngagement := ADD_MONTHS(vDateMESEffec,+vDE);                                                                                                                                                                                                                                                                                                  &lt;br/&gt;        vNbJMoisEng:=(LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement,&apos;MONTH&apos;)+1);                                                                                                                                                                                                                                                        &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- On récupère le FAS de résiliation dans tous les cas.--                                                                                                                                                                                                                                                                                              &lt;br/&gt;        pMontantFAS := TO_NUMBER(pLigne.FAS__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;);                                                                                                                                                                                                                                                                   &lt;br/&gt;      if (pLigne.Location__C is nULL ) then                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;         pMontantLocation:=NULL;                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          -- On note le montant de l&apos;abonnement, la location et la durée d&apos;engagement à titre informatif                                                                                                                                                                                                                                                       &lt;br/&gt;        pMsg:=&apos;## Abonnement de : &apos;||TO_CHAR(vAbo)||&apos;,  Durée d&apos;&apos;engagement de :&apos;||TO_CHAR(vDE);                                                                                                                                                                                                                                                               &lt;br/&gt;      else                                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;       -- On note le montant de l&apos;abonnement, la location et la durée d&apos;engagement à titre informatif                                                                                                                                                                                                                                                          &lt;br/&gt;        pMsg:=&apos;## Abonnement de : &apos;||TO_CHAR(vAbo)||&apos;, Location de :&apos;||TO_CHAR(vLoc)||&apos;,  Durée d&apos;&apos;engagement de :&apos;||TO_CHAR(vDE);                                                                                                                                                                                                                             &lt;br/&gt;    end if;                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- MENSUELLE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;        IF pFacteur = 1 THEN                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          -- Terme A echoir                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;          IF vTerme = &apos;A ECHOIR&apos; THEN                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            -- Si date de résiliation inférieure ou égalle à n-1                                                                                                                                                                                                                                                                                               &lt;br/&gt;            IF TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                        &lt;br/&gt;              -- nb mois entre date de MES effective et date de résil &lt; durée d&apos;engagement, cad durée d&apos;engagement non terminée                                                                                                                                                                                                                                &lt;br/&gt;              IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN                                                                                                                                                                                                                                                   &lt;br/&gt;                -- pMontant = (Mois d&apos;engagement moins différence entre mois MES et mois de facturation -1) *ABO - Nb de jours entre fin de mois d&apos;engagement et date de fin d&apos;engagement                                                                                                                                                                      &lt;br/&gt;                -- pas à partir de la date de résil car déjà facturée (à échoir)                                                                                                                                                                                                                                                                               &lt;br/&gt;                pMontant:=(vDE-MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)))*vAbo-(((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))+1)*(vAbo/vNbJMoisEng));                                                                                                                               &lt;br/&gt;                pMontantLocation:=(vDE-MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)))*vLoc-(((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))+1)*(vLoc/vNbJMoisEng));                                                                                                                       &lt;br/&gt;                pMsg := pMsg||&apos; Nombre de mois :+&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)))||&apos;, Nombre de jours :-&apos;||TO_CHAR((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))+1);                                                                                                 &lt;br/&gt;                pLibTypePresta:=&apos;Résiliations : Montants restant dus&apos;;                                                                                                                                                                                                                                                                                         &lt;br/&gt;                pLibPeriodeDeb:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                pLibPeriodeFin:=vDateFinEngagement;                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              -- Engagement terminé                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;              ELSIF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN                                                                                                                                                                                                                                               &lt;br/&gt;                -- On rembourse car déjà payé : nb de jour entre fin de mois de résil et date résil*ABO plus mois déjà payé entre mois de résil et mois de facturation                                                                                                                                                                                         &lt;br/&gt;                pMontant:=-(((LAST_DAY(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))-TRUNC(pLigne.DATE_RESIL__C))*(vAbo/vNbJMoisRes))+MONTHS_BETWEEN(TRUNC(pDateCalcFactu,&apos;MONTH&apos;),ADD_MONTHS(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),+1))*vAbo);                                                                                                                           &lt;br/&gt;                pMontantLocation:=-(((LAST_DAY(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))-TRUNC(pLigne.DATE_RESIL__C))*(vLoc/vNbJMoisRes))+MONTHS_BETWEEN(TRUNC(pDateCalcFactu,&apos;MONTH&apos;),ADD_MONTHS(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),+1))*vLoc);                                                                                                                   &lt;br/&gt;                pMsg := pMsg||&apos; Nombre de mois :+&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(pDateCalcFactu,&apos;MONTH&apos;),ADD_MONTHS(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),+1)))||&apos;, Nombre de jours :+&apos;||TO_CHAR(LAST_DAY(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))-TRUNC(pLigne.DATE_RESIL__C));                                                                                     &lt;br/&gt;                pLibTypePresta:=&apos;Régularisation suite à résiliation&apos;;                                                                                                                                                                                                                                                                                          &lt;br/&gt;                pLibPeriodeDeb:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                pLibPeriodeFin:=pDateCalcFactu-1;                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          -- Terme échu                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;          ELSIF vTerme = &apos;ECHU&apos; THEN                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;            -- Date de résil = n - 1                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;            IF TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                         &lt;br/&gt;              -- nb mois entre date de MES effective et date de résil &lt; durée d&apos;engagement, cad durée d&apos;engagement non terminée                                                                                                                                                                                                                                &lt;br/&gt;              IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN                                                                                                                                                                                                                                                   &lt;br/&gt;                -- pMontant = (Mois d&apos;engagement moins différence entre mois MES et mois de Résil)*ABO - Nb de jours entre fin de mois d&apos;engagement et date de fin d&apos;engagement                                                                                                                                                                                &lt;br/&gt;                pMontant:=((vDE-MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;))))*vAbo-(((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))+1)*(vAbo/vNbJMoisEng));                                                                                                                                      &lt;br/&gt;                pMontantLocation:=((vDE-MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;))))*vLoc-(((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))+1)*(vLoc/vNbJMoisEng));                                                                                                                              &lt;br/&gt;                pMsg := pMsg||&apos; Nombre de mois :+&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)))||&apos;, Nombre de jours :-&apos;||TO_CHAR((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))+1);                                                                                                 &lt;br/&gt;                pLibTypePresta:=&apos;Résiliations : Montants restant dus&apos;;                                                                                                                                                                                                                                                                                         &lt;br/&gt;                pLibPeriodeDeb:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                pLibPeriodeFin:=vDateFinEngagement;                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              -- Engagement terminé                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;              ELSIF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN                                                                                                                                                                                                                                               &lt;br/&gt;                -- On facture car non payé : nb de jour entre date résil et date deb mois resil(équivaut à n-1 dans ce cas présent)*ABO                                                                                                                                                                                                                        &lt;br/&gt;                pMontant:=((TRUNC(pLigne.DATE_RESIL__C)-TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))*(vAbo/vNbJMoisRes));                                                                                                                                                                                                                                              &lt;br/&gt;                pMontantLocation:=((TRUNC(pLigne.DATE_RESIL__C)-TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))*(vLoc/vNbJMoisRes));                                                                                                                                                                                                                                      &lt;br/&gt;                pMsg := pMsg||&apos; Nombre de mois :+&apos;||TO_CHAR(TRUNC(pLigne.DATE_RESIL__C)-TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;));                                                                                                                                                                                                                                  &lt;br/&gt;                pLibTypePresta:=&apos;Résiliations : Montants restant dus&apos;;                                                                                                                                                                                                                                                                                         &lt;br/&gt;                pLibPeriodeDeb:=TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;);                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLibPeriodeFin:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            -- Date résil &lt; n - 1                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;            ELSIF TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;) &lt; TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                      &lt;br/&gt;              -- nb mois entre date de MES effective et date de résil &lt; durée d&apos;engagement, cad durée d&apos;engagement non terminée                                                                                                                                                                                                                                &lt;br/&gt;              IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN                                                                                                                                                                                                                                                   &lt;br/&gt;                -- pMontant = (Mois d&apos;engagement moins différence entre mois MES et mois de Résil)*ABO + nb de jour entre date résil et date deb mois resil*ABO (car reste à payer)                                                                                                                                                                            &lt;br/&gt;                pMontant:=(MONTHS_BETWEEN(TRUNC(vDateFinEngagement,&apos;MONTH&apos;),TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;)))*vAbo-(((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))+1)*(vAbo/vNbJMoisEng));                                                                                                                              &lt;br/&gt;                pMontantLocation:=(MONTHS_BETWEEN(TRUNC(vDateFinEngagement,&apos;MONTH&apos;),TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;)))*vLoc-(((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))+1)*(vLoc/vNbJMoisEng));                                                                                                                      &lt;br/&gt;                pMsg := pMsg||&apos; Nombre de mois :+&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(vDateFinEngagement,&apos;MONTH&apos;),TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;)))||&apos;, Nombre de jours :-&apos;||TO_CHAR((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))+1);                                                                                       &lt;br/&gt;                pLibTypePresta:=&apos;Résiliations : Montants restant dus&apos;;                                                                                                                                                                                                                                                                                         &lt;br/&gt;                pLibPeriodeDeb:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                pLibPeriodeFin:=vDateFinEngagement;                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              -- Engagement terminé                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;              ELSIF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN                                                                                                                                                                                                                                               &lt;br/&gt;                -- On rembourse (résultat négatif) nombre de mois entre la date de résiliation et premier jour du mois n-1, on retire les premiers jours du mois de résiliation, la période qui reste correspond à celle devant être remboursée.                                                                                                               &lt;br/&gt;                pMontant:=(TO_NUMBER(MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;)))*vAbo)+(((TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;)-TRUNC(pLigne.DATE_RESIL__C)))*(vAbo/vNbJMoisRes));                                                                                                                         &lt;br/&gt;                pMsg := pMsg||&apos; Nombre de mois :+&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;)))||&apos;, Nombre de jours :+&apos;||TO_CHAR(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;)-TRUNC(pLigne.DATE_RESIL__C));                                                                                               &lt;br/&gt;                pLibTypePresta:=&apos;Régularisation suite à résiliation&apos;;                                                                                                                                                                                                                                                                                          &lt;br/&gt;                pLibPeriodeDeb:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                pLibPeriodeFin:=pDateCalcFactu-1;                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF; -- fin tests sur n-1                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;          END IF; -- fin terme                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- TRIMESTRI, SEMESTRI, ANNU -&gt; ELLE                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;        ELSE                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;          CASE pFacteur                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;            WHEN 3 THEN                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              vDateDebPeriodeEncours :=TRUNC(pDateCalcFactu,&apos;Q&apos;);                                                                                                                                                                                                                                                                                              &lt;br/&gt;              vDateDebPeriodeSuivante :=(TRUNC(ADD_MONTHS(pDateCalcFactu,+3),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                                          &lt;br/&gt;              vDateDebPeriodePrecedente :=TRUNC(ADD_MONTHS(pDateCalcFactu,-3),&apos;Q&apos;);                                                                                                                                                                                                                                                                            &lt;br/&gt;            WHEN 6 THEN                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              IF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;1&apos;,&apos;3&apos;) THEN                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                vDateDebPeriodeEncours :=TRUNC(pDateCalcFactu,&apos;Q&apos;);                                                                                                                                                                                                                                                                                            &lt;br/&gt;                vDateDebPeriodeSuivante :=TRUNC(ADD_MONTHS(pDateCalcFactu,+6),&apos;Q&apos;);                                                                                                                                                                                                                                                                            &lt;br/&gt;                vDateDebPeriodePrecedente :=TRUNC(ADD_MONTHS(pDateCalcFactu,-6),&apos;Q&apos;);                                                                                                                                                                                                                                                                          &lt;br/&gt;              ELSIF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;2&apos;,&apos;4&apos;) THEN                                                                                                                                                                                                                                                                                              &lt;br/&gt;                vDateDebPeriodeEncours :=TRUNC(ADD_MONTHS(pDateCalcFactu,-3),&apos;Q&apos;);                                                                                                                                                                                                                                                                             &lt;br/&gt;                vDateDebPeriodeSuivante :=TRUNC(ADD_MONTHS(pDateCalcFactu,+3),&apos;Q&apos;);                                                                                                                                                                                                                                                                            &lt;br/&gt;                vDateDebPeriodePrecedente :=TRUNC(ADD_MONTHS(pDateCalcFactu,-9),&apos;Q&apos;);                                                                                                                                                                                                                                                                          &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            WHEN 12 THEN                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;              vDateDebPeriodeEncours :=TRUNC(pDateCalcFactu,&apos;YEAR&apos;);                                                                                                                                                                                                                                                                                           &lt;br/&gt;              vDateDebPeriodeSuivante :=ADD_MONTHS(TRUNC(pDateCalcFactu,&apos;YEAR&apos;),+12);                                                                                                                                                                                                                                                                          &lt;br/&gt;              vDateDebPeriodePrecedente :=ADD_MONTHS(TRUNC(pDateCalcFactu,&apos;YEAR&apos;),-12);                                                                                                                                                                                                                                                                        &lt;br/&gt;          END CASE;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          IF vTerme = &apos;A ECHOIR&apos; THEN                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            IF TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                        &lt;br/&gt;              IF pMoisInclus THEN                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                -- nb mois entre date de MES effective et date de résil &lt; durée d&apos;engagement, cad durée d&apos;engagement non terminée                                                                                                                                                                                                                              &lt;br/&gt;                IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN                                                                                                                                                                                                                                                 &lt;br/&gt;                  pMontant:=(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;)))*vAbo-(((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))*vAbo)/vNbJMoisEng);                                                                                                                                                &lt;br/&gt;                  pMontantLocation:=(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;)))*vLoc-(((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))*vLoc)/vNbJMoisEng);                                                                                                                                        &lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :+&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;)))||&apos;, Nombre de jours :-&apos;||TO_CHAR(LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement));                                                                                                         &lt;br/&gt;                  pLibTypePresta:=&apos;Résiliations : Montants restant dus&apos;;                                                                                                                                                                                                                                                                                       &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                  pLibPeriodeFin:=vDateFinEngagement;                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                -- Engagement terminé                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                ELSIF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN     &lt;br/&gt;				        				&lt;br/&gt;                  -- remboursement   &lt;br/&gt;				  -- story 1347  				  &lt;br/&gt;                  pMontant:=-(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))*vAbo-(((TRUNC(pLigne.DATE_RESIL__C)-TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))*vAbo)/vNbJMoisRes));                                                                                                                                                            &lt;br/&gt;                  pMontantLocation:=-(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))*vLoc-(((TRUNC(pLigne.DATE_RESIL__C)-TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))*vLoc)/vNbJMoisRes));                                                                                                                                                    &lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :+&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),vDateDebPeriodeEncours))||&apos;, Nombre de jours :-&apos;||TO_CHAR(TRUNC(pLigne.DATE_RESIL__C)-TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;));                                                                                                                   &lt;br/&gt;                  pLibTypePresta:=&apos;Régularisation suite à résiliation&apos;;                                                                                                                                                                                                                                                                                        &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                  pLibPeriodeFin:=vDateDebPeriodeEncours-1;                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              -- Mois de facturation hors période                                                                                                                                                                                                                                                                                                              &lt;br/&gt;              ELSE                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                -- nb mois entre date de MES effective et date de résil &lt; durée d&apos;engagement, cad durée d&apos;engagement non terminée                                                                                                                                                                                                                              &lt;br/&gt;                IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN                                                                                                                                                                                                                                                 &lt;br/&gt;                  pMontant:=(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;)))*vAbo-(((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))*vAbo)/vNbJMoisEng);                                                                                                                                                &lt;br/&gt;                  pMontantLocation:=(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;)))*vLoc-(((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))*vLoc)/vNbJMoisEng);                                                                                                                                        &lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :+&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;)))||&apos;, Nombre de jours :-&apos;||TO_CHAR(LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement));                                                                                                         &lt;br/&gt;                  pLibTypePresta:=&apos;Résiliations : Montants restant dus&apos;;                                                                                                                                                                                                                                                                                       &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                  pLibPeriodeFin:=vDateFinEngagement;                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                -- Engagement terminé                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                ELSIF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN                                                                                                                                                                                                                                             &lt;br/&gt;                  -- remboursement                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;					-- story 1347  &lt;br/&gt;                  -- Mois entre date résil et début période suivante                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  pMontant:=-(MONTHS_BETWEEN(vDateDebPeriodeSuivante,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))*vAbo-(((TRUNC(pLigne.DATE_RESIL__C)-TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))*vAbo)/vNbJMoisRes));                                                                                                                                                           &lt;br/&gt;                  pMontantLocation:=-(MONTHS_BETWEEN(vDateDebPeriodeSuivante,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))*vLoc-(((TRUNC(pLigne.DATE_RESIL__C)-TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))*vLoc)/vNbJMoisRes));                                                                                                                                                   &lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :+&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),vDateDebPeriodeSuivante))||&apos;, Nombre de jours :-&apos;||TO_CHAR(TRUNC(pLigne.DATE_RESIL__C)-TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;));                                                                                                                  &lt;br/&gt;                  pLibTypePresta:=&apos;Régularisation suite à résiliation&apos;;                                                                                                                                                                                                                                                                                        &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                  pLibPeriodeFin:=vDateDebPeriodeSuivante-1;                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          END IF; -- Fin A echoir                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          -- Echu                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          IF vTerme = &apos;ECHU&apos; THEN                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;            IF TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                        &lt;br/&gt;              IF pMoisInclus THEN                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                -- nb mois entre date de MES effective et date de résil &lt; durée d&apos;engagement, cad durée d&apos;engagement non terminée                                                                                                                                                                                                                              &lt;br/&gt;                IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN                                                                                                                                                                                                                                                 &lt;br/&gt;                  pMontant:=(vDE-MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(vDateMESEffec,&apos;MONTH&apos;)))*vAbo-(((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))*vAbo)/vNbJMoisEng);                                                                                                                                                    &lt;br/&gt;                  pMontantLocation:=(vDE-MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(vDateMESEffec,&apos;MONTH&apos;)))*vLoc-(((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))*vLoc)/vNbJMoisEng);                                                                                                                                            &lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :+&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(vDateMESEffec,&apos;MONTH&apos;)))||&apos;, Nombre de jours :-&apos;||TO_CHAR(LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement));                                                                                                             &lt;br/&gt;                  pLibTypePresta:=&apos;Résiliations : Montants restant dus&apos;;                                                                                                                                                                                                                                                                                       &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                  pLibPeriodeFin:=vDateFinEngagement;                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                -- Engagement terminé                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                ELSIF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN                                                                                                                                                                                                                                             &lt;br/&gt;                  pMontant:=MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))*vAbo-(((LAST_DAY(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))-TRUNC(pLigne.DATE_RESIL__C))*vAbo)/vNbJMoisRes);                                                                                                                                               &lt;br/&gt;                  pMontantLocation:=MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))*vLoc-(((LAST_DAY(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))-TRUNC(pLigne.DATE_RESIL__C))*vLoc)/vNbJMoisRes);                                                                                                                                       &lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :+&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;)))||&apos;, Nombre de jours :-&apos;||TO_CHAR(LAST_DAY(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))-TRUNC(pLigne.DATE_RESIL__C));                                                                                                      &lt;br/&gt;                  pLibTypePresta:=&apos;Résiliations : Montants restant dus&apos;;                                                                                                                                                                                                                                                                                       &lt;br/&gt;                  pLibPeriodeDeb:=vDateDebPeriodePrecedente;                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                  pLibPeriodeFin:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              -- Mois de facturation hors période                                                                                                                                                                                                                                                                                                              &lt;br/&gt;              ELSE                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                -- nb mois entre date de MES effective et date de résil &lt; durée d&apos;engagement, cad durée d&apos;engagement non terminée                                                                                                                                                                                                                              &lt;br/&gt;                IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN                                                                                                                                                                                                                                                 &lt;br/&gt;                  pMontant:=(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;)))*vAbo-(((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))*vAbo)/vNbJMoisEng);                                                                                                                                                &lt;br/&gt;                  pMontantLocation:=(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;)))*vLoc-(((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))*vLoc)/vNbJMoisEng);                                                                                                                                        &lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :+&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;)))||&apos;, Nombre de jours :-&apos;||TO_CHAR(LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement));                                                                                                         &lt;br/&gt;                  pLibTypePresta:=&apos;Résiliations : Montants restant dus&apos;;                                                                                                                                                                                                                                                                                       &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                  pLibPeriodeFin:=vDateFinEngagement;                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                -- Engagement terminé                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                ELSIF MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN                                                                                                                                                                                                                                             &lt;br/&gt;                  -- si la date de MES effective est inférieure à la période de fréquence                                                                                                                                                                                                                                                                      &lt;br/&gt;                  IF (TRUNC(pLigne.DATE_RESIL__C,&apos;Q&apos;) = TRUNC(pDateCalcFactu,&apos;Q&apos;) AND pFacteur = 3)                                                                                                                                                                                                                                                            &lt;br/&gt;                    -- Pour le semestre on compare le numéro de trimestre en prenant soin de lier les trimestres 1 et 2 -&gt; 1, et 3 et 4 -&gt; 3.                                                                                                                                                                                                                  &lt;br/&gt;                    OR (TRANSLATE(TO_CHAR(pLigne.DATE_RESIL__C,&apos;Q&apos;),&apos;24&apos;,&apos;13&apos;) = TRANSLATE(TO_CHAR(pDateCalcFactu,&apos;Q&apos;),&apos;24&apos;,&apos;13&apos;) AND pFacteur = 6)                                                                                                                                                                                                            &lt;br/&gt;                    OR (TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;) = TRUNC(pDateCalcFactu,&apos;YEAR&apos;) AND pFacteur = 12) THEN                                                                                                                                                                                                                                             &lt;br/&gt;                    pMontant:=MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))*vAbo-(((LAST_DAY(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))-TRUNC(pLigne.DATE_RESIL__C))*vAbo)/vNbJMoisRes);                                                                                                                                             &lt;br/&gt;                    pMontantLocation:=MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))*vLoc-(((LAST_DAY(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))-TRUNC(pLigne.DATE_RESIL__C))*vLoc)/vNbJMoisRes);                                                                                                                                     &lt;br/&gt;                    pMsg := pMsg||&apos; Nombre de mois :+&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;)))||&apos;, Nombre de jours :-&apos;||TO_CHAR(LAST_DAY(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))-TRUNC(pLigne.DATE_RESIL__C));                                                                                                    &lt;br/&gt;                    pLibTypePresta:=&apos;Résiliations : Montants restant dus&apos;;                                                                                                                                                                                                                                                                                     &lt;br/&gt;                    pLibPeriodeDeb:=vDateDebPeriodePrecedente;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                    pLibPeriodeFin:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                    codRet:=0;                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  ELSIF (TRUNC(pLigne.DATE_RESIL__C,&apos;Q&apos;) &lt; TRUNC(pDateCalcFactu,&apos;Q&apos;) AND pFacteur = 3)                                                                                                                                                                                                                                                         &lt;br/&gt;                    -- Pour le semestre on compare le numéro de trimestre en prenant soin de lier les trimestres 1 et 2 -&gt; 1, et 3 et 4 -&gt; 3.                                                                                                                                                                                                                  &lt;br/&gt;                    OR (TRANSLATE(TO_CHAR(pLigne.DATE_RESIL__C,&apos;Q&apos;),&apos;24&apos;,&apos;13&apos;) &lt;&gt; TRANSLATE(TO_CHAR(pDateCalcFactu,&apos;Q&apos;),&apos;24&apos;,&apos;13&apos;) AND pFacteur = 6)                                                                                                                                                                                                           &lt;br/&gt;                    OR (TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;) &lt; TRUNC(pDateCalcFactu,&apos;YEAR&apos;) AND pFacteur = 12) THEN                                                                                                                                                                                                                                             &lt;br/&gt;                      -- remboursement                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                     pMontant:=MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),vDateDebPeriodeEncours)*vAbo-(((TRUNC(pLigne.DATE_RESIL__C)-TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))*vAbo)/vNbJMoisRes);&lt;br/&gt;                      pMontantLocation:=MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),vDateDebPeriodeEncours)*vLoc-(((TRUNC(pLigne.DATE_RESIL__C)-TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;))*vLoc)/vNbJMoisRes);&lt;br/&gt;                      pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;),vDateDebPeriodeEncours))||&apos;, Nombre de jours :&apos;||TO_CHAR(TRUNC(pLigne.DATE_RESIL__C)-TRUNC(pLigne.DATE_RESIL__C,&apos;MONTH&apos;));                                                                                                                 &lt;br/&gt;                      pLibTypePresta:=&apos;Régularisation suite à résiliation&apos;;                                                                                                                                                                                                                                                                                    &lt;br/&gt;                      pLibPeriodeDeb:=pLigne.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                      pLibPeriodeFin:=vDateDebPeriodeEncours-1;                                                                                                                                                                                                                                                                                                &lt;br/&gt;                      codRet:=0;                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                  END IF;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          END IF; -- Fin Echu                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;        END IF; -- Fin pFacteur = 1                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;        pMsg := pMsg||&apos; ##&apos;;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;      END IF; -- fin codRet = 0                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;    END IF; -- fin motif resil                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;  END IF; -- fin statut et date n-1                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;    if (pLigne.Location__C is nULL ) then                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;         pMontantLocation:=NULL;                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;    end if;&lt;br/&gt;  &lt;br/&gt;  --Story 431 (arrondi a 2)&lt;br/&gt;  pMontantLocation:= ROUND(pMontantLocation, 2); &lt;br/&gt;  pMontant        := ROUND(pMontant, 2);&lt;br/&gt;  pMontantFAS     := ROUND(pMontantFAS, 2);&lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;  RETURN codRet;                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;END F_FactuResilProrata;                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;-- Cas des upgrade et downgrade sans prorata temporis                                                                                                                                                                                                                                                                                                          &lt;br/&gt;/* retourne codRet                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt; * 1 = non traité, on passe                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt; * 2 = erreur, on trace si besoin                                                                                                                                                                                                                                                                                                                              &lt;br/&gt; * 0 = ok, on est passé dedans                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt; */                                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;FUNCTION F_UpDown(pLigne IN T_FDSL_SERVICE_SF%ROWTYPE, pDateCalcFactu IN Date, pMontant OUT NUMBER, pMontantFAS OUT NUMBER, pFacteur IN NUMBER, pMoisInclus IN BOOLEAN, pLibPeriodeDeb OUT DATE, pLibPeriodeFin OUT DATE, pMsg OUT VARCHAR2) RETURN INTEGER IS                                                                                                 &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;codRet INTEGER :=1;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;ancAbo T_FDSL_HISTO_DETAIL_FACTURE.MONTANT%TYPE;                                                                                                                                                                                                                                                                                                               &lt;br/&gt;ancLoc T_FDSL_HISTO_DETAIL_FACTURE.MONTANT%TYPE;                                                                                                                                                                                                                                                                                                               &lt;br/&gt;vAbo T_FDSL_HISTO_DETAIL_FACTURE.MONTANT%TYPE;                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;vLoc T_FDSL_DETAIL_FACTURE.MONTANT%TYPE;                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;vTerme T_FDSL_DETAIL_FACTURE.TERME_FACTU%TYPE;                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;vDateMESEffec DATE;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;vDE T_FDSL_DETAIL_FACTURE.DUREE_ENGAGEMENT%TYPE;                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;vDateDebPeriodeEncours DATE;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;vDateDebPeriodeSuivante DATE;                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;vDateDebPeriodePrecedente DATE;                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  -- Initialisation des variables                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;  vTerme := UPPER(TRANSLATE(pLigne.TERME_FACTU__C,&apos;éà&apos;,&apos;ea&apos;));                                                                                                                                                                                                                                                                                                 &lt;br/&gt;  vDateMESEffec :=TRUNC(NVL(pLigne.DATE_DEBUT_FACTU__C,pLigne.DATE_MES_EFFECTIVE__C));                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  pMsg := NULL;                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;  pMontant:=TO_NUMBER(NULL);                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;  pMontantFAS:=TO_NUMBER(NULL);                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;  pLibPeriodeDeb:=NULL;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;  pLibPeriodeFin:=NULL;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt; /* IF pLigne.TECHNO__C = &apos;TRANSIT IP&apos; THEN                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    vAbo:=TO_NUMBER(pLigne.TARIF_FORFAIT__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;);                                                                                                                                                                                                                                                                      &lt;br/&gt;  ELSE*/                                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;    vAbo:=TO_NUMBER(pLigne.ABONNEMENT_MENSUEL__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;);                                                                                                                                                                                                                                                                 &lt;br/&gt; /* END IF;*/                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  IF UPPER(pLigne.STATUT__C) = &apos;ACTIF&apos; THEN                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;    -- mois(date mise en modif) = n-1 et motif contient upgrade (car upgrade/downgrade)                                                                                                                                                                                                                                                                        &lt;br/&gt;    IF TRUNC(pLigne.DATE_MISE_EN_MODIF__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) AND (INSTR(UPPER(pLigne.MOTIF_MODIF__C),&apos;UPGRADE&apos;) &gt; 0 OR INSTR(UPPER(pLigne.MOTIF_MODIF__C),&apos;DOWNGRADE&apos;) &gt; 0) THEN                                                                                                                                          &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;      -- On récupère le FAS de modification dans tous les cas.&lt;br/&gt;      pMontantFAS := TO_NUMBER(pLigne.FAS__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;);&lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;      -- Récupération du tarif de l&apos;abonnement antérieur si existant                                                                                                                                                                                                                                                                                           &lt;br/&gt;      codRet := F_AncienAbo(pLigne,ancAbo,vDE,ancLoc,pMsg);                                                                                                                                                                                                                                                                                                    &lt;br/&gt;      IF codRet = 0 THEN                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- On note le montant de l&apos;abonnement et la durée d&apos;engagement à titre informatif                                                                                                                                                                                                                                                                      &lt;br/&gt;        pMsg:=&apos;##  Ancien Abonnement de : &apos;||TO_CHAR(ancAbo)||&apos;, Durée d&apos;&apos;engagement de :&apos;||TO_CHAR(vDE);                                                                                                                                                                                                                                                      &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- MENSUELLE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;        IF pFacteur = 1 THEN                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;          -- A Echoir                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          IF vTerme = &apos;A ECHOIR&apos; THEN                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            IF ancAbo &gt; vAbo THEN                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;              IF TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                               &lt;br/&gt;                -- Nb de mois entre la date de modif et la date de MES effective &lt; durée d&apos;engagement -- DE non terminée                                                                                                                                                                                                                                       &lt;br/&gt;                IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN                                                                                                                                                                                                                                          &lt;br/&gt;                  -- pMontant = durée d&apos;engagement moins nb de mois entre la date de facturation et la date de MES effective * (anc ABO- nv ABO)&lt;br/&gt;                  pMontant:=(vDE-MONTHS_BETWEEN(TRUNC(pDateCalcFactu,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)))*(ancAbo-vAbo);&lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :+&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(TRUNC(pDateCalcFactu,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)));                                                                                                                                                                                                                 &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  pLibPeriodeFin:=ADD_MONTHS(vDateMESEffec,+vDE);                                                                                                                                                                                                                                                                                              &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                -- Nb de mois entre la date de modif et la date de MES effective &gt;= durée d&apos;engagement -- DE terminée                                                                                                                                                                                                                                          &lt;br/&gt;                IF  MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN                                                                                                                                                                                                                                        &lt;br/&gt;                  -- On ne rembourse qu&apos;entre la date de modification et de facturation -1, le mois de modification restant à l&apos;ancien tarif.&lt;br/&gt;                  pMontant:=(MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo);&lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :-&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)));                                                                                                                                                                                        &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  pLibPeriodeFin:=pDateCalcFactu-1;                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            ELSE                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;              -- Nouveau tarif plus élevé que l&apos;ancien, on ne tient pas compte de la durée d&apos;engagement.                                                                                                                                                                                                                                                       &lt;br/&gt;              IF TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                               &lt;br/&gt;                -- On ne facture qu&apos;entre la date de modification et de facturation -1, le mois de modification restant à l&apos;ancien tarif.&lt;br/&gt;                pMontant:=(MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo);&lt;br/&gt;                pMsg := pMsg||&apos; Nombre de mois :+&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)));                                                                                                                                                                                          &lt;br/&gt;                pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                pLibPeriodeFin:=pDateCalcFactu-1;                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF; -- fin si  ancAbo &gt; vAbo                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;          END IF; -- fin si A Echoir                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;          -- Echu                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          IF vTerme = &apos;ECHU&apos; THEN                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;            IF ancAbo &gt; vAbo THEN                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;              IF TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                               &lt;br/&gt;                -- Nb de mois entre la date de modif et la date de MES effective &lt; durée d&apos;engagement -- DE non termimnée                                                                                                                                                                                                                                      &lt;br/&gt;                IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN                                                                                                                                                                                                                                          &lt;br/&gt;                  -- pMontant = durée d&apos;engagement moins nb de mois entre la date de facturation -1 et la date de MES effective * (anc ABO- nv ABO)&lt;br/&gt;                  pMontant:=(vDE-MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)))*(ancAbo-vAbo);&lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :+&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)));                                                                                                                                                                                                  &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  pLibPeriodeFin:=ADD_MONTHS(vDateMESEffec,+vDE);                                                                                                                                                                                                                                                                                              &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                -- Nb de mois entre la date de modif et la date de MES effective &gt;= durée d&apos;engagement -- DE terminée                                                                                                                                                                                                                                          &lt;br/&gt;                IF  MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN&lt;br/&gt;                  pMontant:=(MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-2),&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(ancAbo-vAbo);&lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-2),&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)));                                                                                                                                                                                         &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  pLibPeriodeFin:=pDateCalcFactu-1;                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            ELSE                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;              -- Nouveau tarif plus élevé que l&apos;ancien, on ne tient pas compte de la durée d&apos;engagement.                                                                                                                                                                                                                                                       &lt;br/&gt;              IF TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN&lt;br/&gt;                pMontant:=(MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-2),&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo);&lt;br/&gt;                pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-2),&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)));                                                                                                                                                                                           &lt;br/&gt;                pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                pLibPeriodeFin:=pDateCalcFactu-1;                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF; -- fin si  ancAbo &gt; vAbo                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;          END IF; -- fin si Echu                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- TRIMESTRI, SEMESTRI, ANNU -&gt; ELLE                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;        ELSE                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;          CASE pFacteur                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;            WHEN 3 THEN                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              vDateDebPeriodeEncours :=TRUNC(pDateCalcFactu,&apos;Q&apos;);                                                                                                                                                                                                                                                                                              &lt;br/&gt;              vDateDebPeriodeSuivante :=(TRUNC(ADD_MONTHS(pDateCalcFactu,+3),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                                          &lt;br/&gt;              vDateDebPeriodePrecedente :=TRUNC(ADD_MONTHS(pDateCalcFactu,-3),&apos;Q&apos;);                                                                                                                                                                                                                                                                            &lt;br/&gt;            WHEN 6 THEN                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              IF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;1&apos;,&apos;3&apos;) THEN                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                vDateDebPeriodeEncours :=TRUNC(pDateCalcFactu,&apos;Q&apos;);                                                                                                                                                                                                                                                                                            &lt;br/&gt;                vDateDebPeriodeSuivante :=TRUNC(ADD_MONTHS(pDateCalcFactu,+6),&apos;Q&apos;);                                                                                                                                                                                                                                                                            &lt;br/&gt;                vDateDebPeriodePrecedente :=TRUNC(ADD_MONTHS(pDateCalcFactu,-6),&apos;Q&apos;);                                                                                                                                                                                                                                                                          &lt;br/&gt;              ELSIF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;2&apos;,&apos;4&apos;) THEN                                                                                                                                                                                                                                                                                              &lt;br/&gt;                vDateDebPeriodeEncours :=TRUNC(ADD_MONTHS(pDateCalcFactu,-3),&apos;Q&apos;);                                                                                                                                                                                                                                                                             &lt;br/&gt;                vDateDebPeriodeSuivante :=TRUNC(ADD_MONTHS(pDateCalcFactu,+3),&apos;Q&apos;);                                                                                                                                                                                                                                                                            &lt;br/&gt;                vDateDebPeriodePrecedente :=TRUNC(ADD_MONTHS(pDateCalcFactu,-9),&apos;Q&apos;);                                                                                                                                                                                                                                                                          &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            WHEN 12 THEN                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;              vDateDebPeriodeEncours :=TRUNC(pDateCalcFactu,&apos;YEAR&apos;);                                                                                                                                                                                                                                                                                           &lt;br/&gt;              vDateDebPeriodeSuivante :=ADD_MONTHS(TRUNC(pDateCalcFactu,&apos;YEAR&apos;),+12);                                                                                                                                                                                                                                                                          &lt;br/&gt;              vDateDebPeriodePrecedente :=ADD_MONTHS(TRUNC(pDateCalcFactu,&apos;YEAR&apos;),-12);                                                                                                                                                                                                                                                                        &lt;br/&gt;          END CASE;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          IF TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                   &lt;br/&gt;            -- A Echoir                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;            IF vTerme = &apos;A ECHOIR&apos; THEN                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              IF ancAbo &gt; vAbo THEN                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                IF pMoisInclus THEN                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                  -- Nb de mois entre la date de modif et la date de MES effective &lt; durée d&apos;engagement -- DE non terminée                                                                                                                                                                                                                                     &lt;br/&gt;                  IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN                                                                                                                                                                                                                                        &lt;br/&gt;                    -- pMontant = durée d&apos;engagement moins nb de mois entre la date de début de période et la date de MES effective * (anc ABO- nv ABO)&lt;br/&gt;                    pMontant:=(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(vDateMESEffec,&apos;MONTH&apos;)))*(ancAbo-vAbo);&lt;br/&gt;                    pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(vDateMESEffec,&apos;MONTH&apos;)));                                                                                                                                                                                                                       &lt;br/&gt;                    pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                               &lt;br/&gt;                    pLibPeriodeFin:=ADD_MONTHS(vDateMESEffec,+vDE);                                                                                                                                                                                                                                                                                            &lt;br/&gt;                    codRet:=0;                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  -- Nb de mois entre la date de modif et la date de MES effective &gt;= durée d&apos;engagement -- DE terminée                                                                                                                                                                                                                                        &lt;br/&gt;                  ELSIF MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN                                                                                                                                                                                                                                    &lt;br/&gt;                    -- remboursement du trop perçu&lt;br/&gt;                    pMontant:=(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo);&lt;br/&gt;                    pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)));                                                                                                                                                                                                             &lt;br/&gt;                    pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                               &lt;br/&gt;                    pLibPeriodeFin:=vDateDebPeriodeEncours-1;                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                    codRet:=0;                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  END IF;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                -- Mois de facturation hors période                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  -- Nb de mois entre la date de modif et la date de MES effective &lt; durée d&apos;engagement -- DE non terminée                                                                                                                                                                                                                                     &lt;br/&gt;                  IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN&lt;br/&gt;                    pMontant:=(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(vDateMESEffec,&apos;MONTH&apos;)))*(ancAbo-vAbo);&lt;br/&gt;                    pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(vDateMESEffec,&apos;MONTH&apos;)));                                                                                                                                                                                                                       &lt;br/&gt;                    pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                               &lt;br/&gt;                    pLibPeriodeFin:=ADD_MONTHS(vDateMESEffec,+vDE);                                                                                                                                                                                                                                                                                            &lt;br/&gt;                    codRet:=0;                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  -- Nb de mois entre la date de modif et la date de MES effective &gt;= durée d&apos;engagement -- DE terminée                                                                                                                                                                                                                                        &lt;br/&gt;                  ELSIF MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN&lt;br/&gt;                    pMontant:=MONTHS_BETWEEN(vDateDebPeriodeSuivante,TRUNC(pDateCalcFactu,&apos;MONTH&apos;))*(vAbo-ancAbo);&lt;br/&gt;                    pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodeSuivante,TRUNC(pDateCalcFactu,&apos;MONTH&apos;)));                                                                                                                                                                                                                         &lt;br/&gt;                    pLibPeriodeDeb:=pDateCalcFactu;                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                    pLibPeriodeFin:=vDateDebPeriodeSuivante-1;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                    codRet:=0;                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  END IF;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              ELSE                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;              -- Nouveau tarif plus élevé que l&apos;ancien, on ne tient pas compte de la durée d&apos;engagement.                                                                                                                                                                                                                                                       &lt;br/&gt;                IF pMoisInclus THEN&lt;br/&gt;                  pMontant:=(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo);&lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)));                                                                                                                                                                                                               &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  pLibPeriodeFin:=vDateDebPeriodeEncours-1;                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                -- Mois de facturation hors période                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                ELSE&lt;br/&gt;                  pMontant:=MONTHS_BETWEEN(vDateDebPeriodeSuivante,TRUNC(pDateCalcFactu,&apos;MONTH&apos;))*(vAbo-ancAbo);&lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodeSuivante,TRUNC(pDateCalcFactu,&apos;MONTH&apos;)));                                                                                                                                                                                                                           &lt;br/&gt;                  pLibPeriodeDeb:=pDateCalcFactu;                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                  pLibPeriodeFin:=vDateDebPeriodeSuivante-1;                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF; -- fin si  ancAbo &gt; vAbo                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;            END IF; -- fin si A Echoir                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;            -- Echu                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;            IF vTerme = &apos;ECHU&apos; THEN                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;              IF ancAbo &gt; vAbo THEN                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                IF pMoisInclus THEN                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                  -- Nb de mois entre la date de modif et la date de MES effective &lt; durée d&apos;engagement -- DE non termimnée                                                                                                                                                                                                                                    &lt;br/&gt;                  IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN                                                                                                                                                                                                                                        &lt;br/&gt;                    -- pMontant = durée d&apos;engagement moins nb de mois entre la date de début de période précédente et la date de MES effective * (anc ABO- nv ABO)&lt;br/&gt;                    pMontant:=(vDE-MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(vDateMESEffec,&apos;MONTH&apos;)))*(ancAbo-vAbo);&lt;br/&gt;                    pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(vDateMESEffec,&apos;MONTH&apos;)));                                                                                                                                                                                                                    &lt;br/&gt;                    pLibPeriodeDeb:=vDateDebPeriodePrecedente;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                    pLibPeriodeFin:=ADD_MONTHS(vDateMESEffec,+vDE);                                                                                                                                                                                                                                                                                            &lt;br/&gt;                    codRet:=0;                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  -- Nb de mois entre la date de modif et la date de MES effective &gt;= durée d&apos;engagement -- DE terminée                                                                                                                                                                                                                                        &lt;br/&gt;                  ELSIF MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN&lt;br/&gt;                    pMontant:=(MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo);&lt;br/&gt;                    pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)));                                                                                                                                                                                                          &lt;br/&gt;                    pLibPeriodeDeb:=vDateDebPeriodePrecedente-1;                                                                                                                                                                                                                                                                                               &lt;br/&gt;                    pLibPeriodeFin:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                               &lt;br/&gt;                    codRet:=0;                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  END IF;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                -- Mois de facturation hors période                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  -- Nb de mois entre la date de modif et la date de MES effective &lt; durée d&apos;engagement -- DE non termimnée                                                                                                                                                                                                                                    &lt;br/&gt;                  IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN&lt;br/&gt;                    pMontant:=(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(vDateMESEffec,&apos;MONTH&apos;)))*(ancAbo-vAbo);&lt;br/&gt;                    pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(vDateMESEffec,&apos;MONTH&apos;)));                                                                                                                                                                                                                       &lt;br/&gt;                    pLibPeriodeDeb:=vDateDebPeriodeEncours;                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                    pLibPeriodeFin:=ADD_MONTHS(vDateMESEffec,+vDE);                                                                                                                                                                                                                                                                                            &lt;br/&gt;                    codRet:=0;                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  -- Nb de mois entre la date de modif et la date de MES effective &gt;= durée d&apos;engagement -- DE terminée                                                                                                                                                                                                                                        &lt;br/&gt;                  ELSIF MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN                                                                                                                                                                                                                                    &lt;br/&gt;                    -- remboursement&lt;br/&gt;                    pMontant:=MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))*(vAbo-ancAbo);&lt;br/&gt;                    pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)));                                                                                                                                                                                                             &lt;br/&gt;                    pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                               &lt;br/&gt;                    pLibPeriodeFin:=vDateDebPeriodeEncours-1;                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                    codRet:=0;                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  END IF;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              ELSE                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                -- Nouveau tarif plus élevé que l&apos;ancien, on ne tient pas compte de la durée d&apos;engagement.                                                                                                                                                                                                                                                     &lt;br/&gt;                IF pMoisInclus THEN&lt;br/&gt;                   pMontant:=(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo);&lt;br/&gt;                   pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)));                                                                                                                                                                                                             &lt;br/&gt;                   pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                               &lt;br/&gt;                   pLibPeriodeFin:=vDateDebPeriodeEncours-1;                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                   codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                ELSE&lt;br/&gt;                   pMontant:=(MONTHS_BETWEEN(vDateDebPeriodeSuivante,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo);&lt;br/&gt;                   pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodeSuivante,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)));                                                                                                                                                                                                            &lt;br/&gt;                   pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                               &lt;br/&gt;                   pLibPeriodeFin:=vDateDebPeriodeSuivante-1;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                   codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF; -- fin si  ancAbo &gt; vAbo                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;            END IF; -- fin si Echu                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          END IF; -- Fin date modif &lt;= n-1                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;        END IF; -- Fin pFacteur = 1                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;        pMsg := pMsg||&apos; ##&apos;;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;      END IF; -- fin codRet=0                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;    END IF; -- fin si mois(date mise en modif) = n-1 et Up ou Down                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;    -- Ajout VLAN                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;    IF TRUNC(pLigne.DATE_MISE_EN_MODIF__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) AND INSTR(UPPER(pLigne.MOTIF_MODIF__C),&apos;AJOUT&apos;) &gt; 0 THEN&lt;br/&gt;      pMontantFAS := TO_NUMBER(pLigne.FAS__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;);&lt;br/&gt;      codRet := 0;                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;    END IF;                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;    -- Réengagement, pas de durée d&apos;engagement à prendre en compte                                                                                                                                                                                                                                                                                             &lt;br/&gt;    IF TRUNC(pLigne.DATE_MISE_EN_MODIF__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) AND INSTR(UPPER(TRANSLATE(pLigne.MOTIF_MODIF__C,&apos;é&apos;,&apos;e&apos;)),&apos;REENGAGEMENT&apos;) &gt; 0 THEN                                                                                                                                                                           &lt;br/&gt;      -- Récupération du tarif de l&apos;abonnement antérieur si existant                                                                                                                                                                                                                                                                                           &lt;br/&gt;      ancAbo := TO_NUMBER(NULL);                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;      codRet := F_AncienAbo(pLigne,ancAbo,vDE,vLoc,pMsg);                                                                                                                                                                                                                                                                                                      &lt;br/&gt;      -- On ne prend pas en compte le code retour, mais le montant, car sinon on passe dans le cas d&apos;erreur de la DE                                                                                                                                                                                                                                           &lt;br/&gt;      -- hors, ici la DE n&apos;est pas obligatoire car non prise en compte                                                                                                                                                                                                                                                                                         &lt;br/&gt;      IF ancAbo IS NOT NULL THEN                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- On récupère le FAS de modification dans tous les cas.                                                                                                                                                                                                                                                                                               &lt;br/&gt;        pMontantFAS := TO_NUMBER(pLigne.FAS__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;);&lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- On note le montant de l&apos;abonnement et la durée d&apos;engagement à titre informatif                                                                                                                                                                                                                                                                      &lt;br/&gt;        pMsg:=&apos;## Abonnement de : &apos;||TO_CHAR(ancAbo);                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        codRet:=0; -- on le force à zéro ici pour éviter la sortie en erreur du à la DE nulle.                                                                                                                                                                                                                                                                 &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- MENSUELLE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;        IF pFacteur = 1 THEN                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;          -- A Echoir                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          IF vTerme = &apos;A ECHOIR&apos; THEN                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            IF TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN&lt;br/&gt;              pMontant:=(MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo);&lt;br/&gt;              pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)));                                                                                                                                                                                             &lt;br/&gt;              pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              pLibPeriodeFin:=pDateCalcFactu-1;                                                                                                                                                                                                                                                                                                                &lt;br/&gt;              codRet:=0;                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          END IF; -- fin si A Echoir                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;          -- Echu                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          IF vTerme = &apos;ECHU&apos; THEN                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;            IF TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN&lt;br/&gt;              pMontant:=(MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-2),&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(ancAbo-vAbo);&lt;br/&gt;              pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-2),&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)));                                                                                                                                                                                             &lt;br/&gt;              pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              pLibPeriodeFin:=ADD_MONTHS(pDateCalcFactu,-1)-1;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;              codRet:=0;                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          END IF; -- fin si Echu                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- TRIMESTRI, SEMESTRI, ANNU -&gt; ELLE                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;        ELSE                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;          CASE pFacteur                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;            WHEN 3 THEN                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              vDateDebPeriodeEncours :=TRUNC(pDateCalcFactu,&apos;Q&apos;);                                                                                                                                                                                                                                                                                              &lt;br/&gt;              vDateDebPeriodeSuivante :=(TRUNC(ADD_MONTHS(pDateCalcFactu,+3),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                                          &lt;br/&gt;              vDateDebPeriodePrecedente :=TRUNC(ADD_MONTHS(pDateCalcFactu,-3),&apos;Q&apos;);                                                                                                                                                                                                                                                                            &lt;br/&gt;            WHEN 6 THEN                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              IF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;1&apos;,&apos;3&apos;) THEN                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                vDateDebPeriodeEncours :=TRUNC(pDateCalcFactu,&apos;Q&apos;);                                                                                                                                                                                                                                                                                            &lt;br/&gt;                vDateDebPeriodeSuivante :=TRUNC(ADD_MONTHS(pDateCalcFactu,+6),&apos;Q&apos;);                                                                                                                                                                                                                                                                            &lt;br/&gt;                vDateDebPeriodePrecedente :=TRUNC(ADD_MONTHS(pDateCalcFactu,-6),&apos;Q&apos;);                                                                                                                                                                                                                                                                          &lt;br/&gt;              ELSIF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;2&apos;,&apos;4&apos;) THEN                                                                                                                                                                                                                                                                                              &lt;br/&gt;                vDateDebPeriodeEncours :=TRUNC(ADD_MONTHS(pDateCalcFactu,-3),&apos;Q&apos;);                                                                                                                                                                                                                                                                             &lt;br/&gt;                vDateDebPeriodeSuivante :=TRUNC(ADD_MONTHS(pDateCalcFactu,+3),&apos;Q&apos;);                                                                                                                                                                                                                                                                            &lt;br/&gt;                vDateDebPeriodePrecedente :=TRUNC(ADD_MONTHS(pDateCalcFactu,-9),&apos;Q&apos;);                                                                                                                                                                                                                                                                          &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            WHEN 12 THEN                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;              vDateDebPeriodeEncours :=TRUNC(pDateCalcFactu,&apos;YEAR&apos;);                                                                                                                                                                                                                                                                                           &lt;br/&gt;              vDateDebPeriodeSuivante :=ADD_MONTHS(TRUNC(pDateCalcFactu,&apos;YEAR&apos;),+12);                                                                                                                                                                                                                                                                          &lt;br/&gt;              vDateDebPeriodePrecedente :=ADD_MONTHS(TRUNC(pDateCalcFactu,&apos;YEAR&apos;),-12);                                                                                                                                                                                                                                                                        &lt;br/&gt;          END CASE;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          IF TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                   &lt;br/&gt;            -- A Echoir                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;            IF vTerme = &apos;A ECHOIR&apos; THEN                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              IF pMoisInclus THEN                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                -- remboursement du trop perçu&lt;br/&gt;                pMontant:=(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo);&lt;br/&gt;                pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)));                                                                                                                                                                                                                 &lt;br/&gt;                pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                pLibPeriodeFin:=vDateDebPeriodeEncours-1;                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              -- Mois de facturation hors période                                                                                                                                                                                                                                                                                                              &lt;br/&gt;              ELSE&lt;br/&gt;                pMontant:=MONTHS_BETWEEN(vDateDebPeriodeSuivante,TRUNC(pDateCalcFactu,&apos;MONTH&apos;))*(vAbo-ancAbo);&lt;br/&gt;                pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodeSuivante,TRUNC(pDateCalcFactu,&apos;MONTH&apos;)));                                                                                                                                                                                                                             &lt;br/&gt;                pLibPeriodeDeb:=pDateCalcFactu;                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                pLibPeriodeFin:=vDateDebPeriodeSuivante-1;                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF; -- fin si A Echoir                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;            -- Echu                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;            IF vTerme = &apos;ECHU&apos; THEN                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;              IF ancAbo &gt; vAbo THEN                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                IF pMoisInclus THEN&lt;br/&gt;                    pMontant:=(MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo);&lt;br/&gt;                    pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)));                                                                                                                                                                                                          &lt;br/&gt;                    pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                               &lt;br/&gt;                    pLibPeriodeFin:=vDateDebPeriodePrecedente-1;                                                                                                                                                                                                                                                                                               &lt;br/&gt;                    codRet:=0;                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                ELSE&lt;br/&gt;                    pMontant:=MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))*(vAbo-ancAbo);&lt;br/&gt;                    pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)));                                                                                                                                                                                                             &lt;br/&gt;                    pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                               &lt;br/&gt;                    pLibPeriodeFin:=vDateDebPeriodeEncours-1;                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                    codRet:=0;                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              ELSE                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                -- Nouveau tarif plus élevé que l&apos;ancien, on ne tient pas compte de la durée d&apos;engagement.                                                                                                                                                                                                                                                     &lt;br/&gt;                IF pMoisInclus THEN&lt;br/&gt;                  pMontant:=(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo);&lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)));                                                                                                                                                                                                               &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  pLibPeriodeFin:=vDateDebPeriodeEncours-1;                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                ELSE&lt;br/&gt;                  pMontant:=(MONTHS_BETWEEN(vDateDebPeriodeSuivante,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo);&lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodeSuivante,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)));                                                                                                                                                                                                              &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  pLibPeriodeFin:=vDateDebPeriodeSuivante-1;                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF; -- fin si  ancAbo &gt; vAbo                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;            END IF; -- fin si Echu                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          END IF; -- Fin date modif &lt;= n-1                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;        END IF; -- Fin pFacteur = 1                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;        pMsg := pMsg||&apos; ##&apos;;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;      END IF; -- fin AncAbo Is NOT NULL THEN                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;    END IF;                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;  END IF; -- Fin Actif                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;  &lt;br/&gt;  --Story 431 (arrondi a 2)&lt;br/&gt;  pMontant   := ROUND(pMontant, 2);&lt;br/&gt;  pMontantFAS:= ROUND(pMontantFAS, 2);&lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  RETURN codRet;                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;END F_UpDown;                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;-- Cas des upgrade et downgrade avec prorata temporis                                                                                                                                                                                                                                                                                                          &lt;br/&gt;/* retourne codRet                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt; * 1 = non traité, on passe                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt; * 2 = erreur, on trace si besoin                                                                                                                                                                                                                                                                                                                              &lt;br/&gt; * 0 = ok, on est passé dedans                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt; */                                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;FUNCTION F_UpDownProrata (pLigne IN T_FDSL_SERVICE_SF%ROWTYPE, pDateCalcFactu IN Date, pTypePresta varchar2, pMontant OUT NUMBER, pMontantFAS OUT NUMBER, pFacteur IN NUMBER, pMoisInclus IN BOOLEAN, pLibPeriodeDeb OUT DATE, pLibPeriodeFin OUT DATE, pMsg OUT VARCHAR2,pTestMotifModif IN BOOLEAN) RETURN INTEGER IS                                                                   &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;codRet INTEGER :=1;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;vNbJMoisMod NUMBER(5);                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;vNbJMoisEng NUMBER(5);                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;ancAbo T_FDSL_HISTO_DETAIL_FACTURE.MONTANT%TYPE;                                                                                                                                                                                                                                                                                                               &lt;br/&gt;ancLoc T_FDSL_HISTO_DETAIL_FACTURE.MONTANT%TYPE;                                                                                                                                                                                                                                                                                                               &lt;br/&gt;vAbo T_FDSL_HISTO_DETAIL_FACTURE.MONTANT%TYPE;                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;vLoc T_FDSL_DETAIL_FACTURE.MONTANT%TYPE;                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;vTerme T_FDSL_DETAIL_FACTURE.TERME_FACTU%TYPE;                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;vDateMESEffec DATE;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;vDE T_FDSL_DETAIL_FACTURE.DUREE_ENGAGEMENT%TYPE;                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;vDateDebPeriodeEncours DATE;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;vDateDebPeriodeSuivante DATE;                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;vDateDebPeriodePrecedente DATE;                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;VDATEFINENGAGEMENT date;                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;&lt;br/&gt;/* CURSOR motif_modification&lt;br/&gt;IS&lt;br/&gt;  SELECT MOTIF_MODIF__C FROM T_FDSL_CONF_MOTIFS_MODIF;&lt;br/&gt;  &lt;br/&gt;MotifDansTableConfig INTEGER :=1;    */    &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;  -- Initialisation des variables                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;  vTerme := UPPER(TRANSLATE(pLigne.TERME_FACTU__C,&apos;éà&apos;,&apos;ea&apos;));                                                                                                                                                                                                                                                                                                 &lt;br/&gt;  vDateMESEffec :=TRUNC(NVL(pLigne.DATE_DEBUT_FACTU__C,pLigne.DATE_MES_EFFECTIVE__C));&lt;br/&gt;  --STORY 436&lt;br/&gt;  --vDE :=NVL(TO_NUMBER(pLigne.DUREE_D_ENGAGEMENT__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;),0);&lt;br/&gt;  vDE:= TO_NUMBER( NVL( MONTHS_BETWEEN( TRUNC(pLigne.DATE_FIN_ENGAGEMENT__C, &apos;MONTH&apos;), TRUNC(pLigne.DATE_MES_EFFECTIVE__C, &apos;MONTH&apos;) ), pLigne.DUREE_D_ENGAGEMENT__C), &apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;);&lt;br/&gt;    &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  pMsg:=NULL;                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;  pMontant:=TO_NUMBER(NULL);                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;  vNbJMoisMod:=(LAST_DAY(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)+1);                                                                                                                                                                                                                                            &lt;br/&gt;  vAbo:=TO_NUMBER(pLigne.ABONNEMENT_MENSUEL__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;);                                                                                                                                                                                                                                                                   &lt;br/&gt;  vLoc:=TO_NUMBER(pLigne.LOCATION__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;);                                                                                                                                                                                                                                                                             &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  pLibPeriodeDeb:=NULL;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;  PLIBPERIODEFIN:=null;    &lt;br/&gt; &lt;br/&gt; /*&lt;br/&gt;For c in motif_modification loop&lt;br/&gt;	IF  pLigne.MOTIF_MODIF__C = c.MOTIF_MODIF__C THEN &lt;br/&gt;	MotifDansTableConfig := 0;&lt;br/&gt;	END IF;&lt;br/&gt;end LOOP; */&lt;br/&gt;&lt;br/&gt;  IF UPPER(pLigne.STATUT__C) = &apos;ACTIF&apos; THEN                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;    -- On récupère le FAS de modification dans tous les cas.                                                                                                                                                                                                                                                                                                   &lt;br/&gt;    pMontantFAS := TO_NUMBER(pLigne.FAS__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;);                                                                                                                                                                                                                                                                       &lt;br/&gt;    &lt;br/&gt;    -- mois(date mise en modif) = n-1 et motif contient upgrade (car upgrade/downgrade)                                                                                                                                                                                                                                                                        &lt;br/&gt;   -- IF TRUNC(pLigne.DATE_MISE_EN_MODIF__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) AND (INSTR(UPPER(pLigne.MOTIF_MODIF__C),&apos;UPGRADE&apos;) &gt; 0 OR INSTR(UPPER(pLigne.MOTIF_MODIF__C),&apos;DOWNGRADE&apos;) &gt; 0) THEN                                                                                                                                          &lt;br/&gt;     IF TRUNC(pLigne.DATE_MISE_EN_MODIF__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;)         THEN                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;      -- Récupération du tarif de l&apos;abonnement antérieur si existant                                                                                                                                                                                                                                                                                           &lt;br/&gt;      codRet := F_AncienAbo(pLigne,ancAbo,vDE,ancLoc ,pMsg);                                                                                                                                                                                                                                                                                                   &lt;br/&gt;      if pTypePresta = &apos;LOC&apos; then                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;         ancAbo:=ancLoc;                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;         vAbo:=vLoc;                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      end if;                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;      IF codRet = 0 THEN                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- Calcul Fin Engagement                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        vDateFinEngagement := ADD_MONTHS(vDateMESEffec,+vDE);                                                                                                                                                                                                                                                                                                  &lt;br/&gt;        vNbJMoisEng:=(LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement,&apos;MONTH&apos;)+1);                                                                                                                                                                                                                                                        &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- On note le montant de l&apos;abonnement et la durée d&apos;engagement à titre informatif                                                                                                                                                                                                                                                                      &lt;br/&gt;        pMsg:=&apos;## Abonnement de : &apos;||TO_CHAR(ancAbo)||&apos;, Durée d&apos;&apos;engagement de :&apos;||TO_CHAR(vDE);&lt;br/&gt;        -- MENSUELLE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;        IF pFacteur = 1 THEN    &lt;br/&gt;          -- A Echoir                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          IF vTerme = &apos;A ECHOIR&apos; THEN&lt;br/&gt;		   IF pTestMotifModif  = TRUE THEN&lt;br/&gt;            IF ancAbo &gt; vAbo THEN                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;              IF TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN&lt;br/&gt;                -- Nb de mois entre la date de modif et la date de MES effective &lt; durée d&apos;engagement -- DE non terminée                                                                                                                                                                                                                                       &lt;br/&gt;                IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN&lt;br/&gt;                  -- pMontant = durée d&apos;engagement moins nb de mois entre la date de facturation -1 et la date de MES effective * (anc ABO- nv ABO) - Nb jours entre la fin du mois d&apos;engagement et la date d&apos;engagement * différence entre ancien et nouveau tarif&lt;br/&gt;                  --Ancienne formule&lt;br/&gt;                  --pMontant:=(vDE-MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)))*(ancAbo-vAbo)-(((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))+1)*((ancAbo-vAbo)/vNbJMoisEng));&lt;br/&gt;                  --Story 428&lt;br/&gt;                  --Formule modifiee, on ne rajoute plus 1 jour supplementaire&lt;br/&gt;                  pMontant  :=(vDE-MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)))*(ancAbo-vAbo)-(((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))  )*((ancAbo-vAbo)/vNbJMoisEng));&lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))+1);                                                                                        &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  pLibPeriodeFin:=vDateFinEngagement;                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                -- Nb de mois entre la date de modif et la date de MES effective &gt;= durée d&apos;engagement -- DE terminée                                                                                                                                                                                                                                          &lt;br/&gt;                IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN                                                                                                                                                                                                                                         &lt;br/&gt;                  -- pMontant = Nombre de mois entre date de modification et N * (nv ABO - anc ABO) plus les jours du début de mois de modification à la date de modification * (anc ABO - nv ABO) car cette période (jours début du mois modif) doit rester à l&apos;ancien tarif.                                                                                 &lt;br/&gt;                  --Story 431 (formule modifiee)&lt;br/&gt;                  --pMontant:=((MONTHS_BETWEEN(TRUNC(pDateCalcFactu,&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo))+((TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))*((ancAbo-vAbo)/vNbJMoisMod));&lt;br/&gt;                  &lt;br/&gt;                  --cette formule correspond à ==&gt; pMontant:=(vAbo    - ancAbo )*( ( vNbJMoisMod - EXTRACT( DAY FROM pLigne.DATE_MODIFICATION__C ) ) / vNbJMoisMod);&lt;br/&gt;                  --                                         (NouvAbo - AncAbo )*( ( nbJrsMois   - nbJrs                                           ) / nbJrsMois)&lt;br/&gt;                  pMontant:=((MONTHS_BETWEEN(TRUNC(pDateCalcFactu,&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo))+(( EXTRACT( DAY FROM pLigne.DATE_MODIFICATION__C) )*((ancAbo-vAbo)/vNbJMoisMod));&lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(pDateCalcFactu,&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR(TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;));                                                                                         &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  pLibPeriodeFin:=pDateCalcFactu-1;                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                  codRet:=0;&lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            ELSE                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;              -- Nouveau tarif plus élevé que l&apos;ancien, on ne tient pas compte de la durée d&apos;engagement.                                                                                                                                                                                                                                                       &lt;br/&gt;              IF TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                               &lt;br/&gt;                -- pMontant = Nombre de mois entre date de modification et N * (nv ABO - anc ABO) plus les jours du début de mois de modification à la date de modification * (anc ABO - nv ABO) car cette période (jours début du mois modif) doit rester à l&apos;ancien tarif.&lt;br/&gt;                pMontant:=((MONTHS_BETWEEN(TRUNC(pDateCalcFactu,&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo))+((TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)+1)*((ancAbo-vAbo)/vNbJMoisMod));&lt;br/&gt;                pMsg := pMsg||&apos; Nombre de mois :+&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(pDateCalcFactu,&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))||&apos;, Nombre de jours :-&apos;||TO_CHAR(TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)+1);                                                                                       &lt;br/&gt;                pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                pLibPeriodeFin:=pDateCalcFactu-1;                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF; -- fin si  ancAbo &gt; vAbo                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;           end if;--	Fin test si motif est dan la table de config des motifs de modication	 &lt;br/&gt;		   end if; -- fin si A Echoir      &lt;br/&gt;         -- Echu                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          IF vTerme = &apos;ECHU&apos; THEN    &lt;br/&gt;			IF INSTR(UPPER(pLigne.MOTIF_MODIF__C),&apos;UPGRADE&apos;) &gt; 0 OR INSTR(UPPER(pLigne.MOTIF_MODIF__C),&apos;DOWNGRADE&apos;) &gt; 0	THEN		  &lt;br/&gt;            IF ancAbo &gt; vAbo THEN                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;              IF TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                &lt;br/&gt;                -- Nb de mois entre la date de modif et la date de MES effective &lt; durée d&apos;engagement -- DE non terminée                                                                                                                                                                                                                                       &lt;br/&gt;                IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN                                                                                                                                                                                                                                          &lt;br/&gt;                  -- pMontant = durée d&apos;engagement moins nb de mois entre la date de facturation -1 et la date de MES effective * (anc ABO- nv ABO) - Nb de jours entre fin de mois d&apos;engagement et date de fin d&apos;engagement&lt;br/&gt;                  pMontant:=(vDE-MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)))*(ancAbo-vAbo)-(((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))+1)*((ancAbo-vAbo)/vNbJMoisEng));&lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))+1);                                                                                        &lt;br/&gt;                  pLibPeriodeDeb:=pDateCalcFactu;                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                  pLibPeriodeFin:=vDateFinEngagement;                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                -- Nb de mois entre la date de modif et la date de MES effective &gt;= durée d&apos;engagement -- DE terminée                                                                                                                                                                                                                                          &lt;br/&gt;                IF  MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN&lt;br/&gt;                  pMontant :=(TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))*((ancAbo-vAbo)/vNbJMoisMod);&lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de jours :&apos;||TO_CHAR(TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;));                                                                                                                                                                                                                  &lt;br/&gt;                  pLibPeriodeDeb:=TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;);                                                                                                                                                                                                                                                                                  &lt;br/&gt;                  pLibPeriodeFin:=TRUNC(pLigne.DATE_MODIFICATION__C);                                                                                                                                                                                                                                                                                          &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              IF TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;) &lt; TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                &lt;br/&gt;                -- Nb de mois entre la date de modif et la date de MES effective &lt; durée d&apos;engagement -- DE non terminée                                                                                                                                                                                                                                       &lt;br/&gt;                IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN                                                                                                                                                                                                                                          &lt;br/&gt;                  -- pMontant = durée d&apos;engagement moins nb de mois entre la date de facturation -1 et la date de MES effective * (anc ABO- nv ABO) - Nb de jours entre fin de mois d&apos;engagement et date de fin d&apos;engagement&lt;br/&gt;                  pMontant:=(vDE-MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)))*(ancAbo-vAbo)-(((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))+1)*((ancAbo-vAbo)/vNbJMoisEng));&lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))+1);                                                                                        &lt;br/&gt;                  pLibPeriodeDeb:=pDateCalcFactu;                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                  pLibPeriodeFin:=vDateFinEngagement;                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                -- Nb de mois entre la date de modif et la date de MES effective &gt;= durée d&apos;engagement -- DE terminée                                                                                                                                                                                                                                          &lt;br/&gt;                IF  MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN                                                                                                                                                                                                                                        &lt;br/&gt;                  -- pMontant = Nombre de mois entre date de modification et N-1 * (nv ABO - anc ABO) plus les jours du début de mois de modification à la date de modification * (anc ABO - nv ABO) car cette période (jours début du mois modif) doit rester à l&apos;ancien tarif.&lt;br/&gt;                  pMontant:=((MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo))+((TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))*((ancAbo-vAbo)/vNbJMoisMod));&lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR(TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;));                                                                          &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  pLibPeriodeFin:=pDateCalcFactu-1;                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            ELSE                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;              -- Nouveau tarif plus élevé que l&apos;ancien, on ne tient pas compte de la durée d&apos;engagement.                                                                                                                                                                                                                                                       &lt;br/&gt;              IF TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN&lt;br/&gt;                pMontant:=((MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo))+((TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))*((ancAbo-vAbo)/vNbJMoisMod));&lt;br/&gt;                pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR(TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;));                                                                            &lt;br/&gt;                pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                pLibPeriodeFin:=pDateCalcFactu-1;                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF; -- fin si  ancAbo &gt; vAbo                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;          END IF; -- fin si UPGRADE ou DOWNGRADE   &lt;br/&gt;		end if; -- fin si Echu    		  &lt;br/&gt;        -- TRIMESTRI, SEMESTRI, ANNU -&gt; ELLE                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;        ELSE                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;          CASE pFacteur                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;            WHEN 3 THEN                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              vDateDebPeriodeEncours :=TRUNC(pDateCalcFactu,&apos;Q&apos;);                                                                                                                                                                                                                                                                                              &lt;br/&gt;              vDateDebPeriodeSuivante :=(TRUNC(ADD_MONTHS(pDateCalcFactu,+3),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                                          &lt;br/&gt;              vDateDebPeriodePrecedente :=TRUNC(ADD_MONTHS(pDateCalcFactu,-3),&apos;Q&apos;);                                                                                                                                                                                                                                                                            &lt;br/&gt;            WHEN 6 THEN                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              IF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;1&apos;,&apos;3&apos;) THEN                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                vDateDebPeriodeEncours :=TRUNC(pDateCalcFactu,&apos;Q&apos;);                                                                                                                                                                                                                                                                                            &lt;br/&gt;                vDateDebPeriodeSuivante :=TRUNC(ADD_MONTHS(pDateCalcFactu,+6),&apos;Q&apos;);                                                                                                                                                                                                                                                                            &lt;br/&gt;                vDateDebPeriodePrecedente :=TRUNC(ADD_MONTHS(pDateCalcFactu,-6),&apos;Q&apos;);                                                                                                                                                                                                                                                                          &lt;br/&gt;              ELSIF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;2&apos;,&apos;4&apos;) THEN                                                                                                                                                                                                                                                                                              &lt;br/&gt;                vDateDebPeriodeEncours :=TRUNC(ADD_MONTHS(pDateCalcFactu,-3),&apos;Q&apos;);                                                                                                                                                                                                                                                                             &lt;br/&gt;                vDateDebPeriodeSuivante :=TRUNC(ADD_MONTHS(pDateCalcFactu,+3),&apos;Q&apos;);                                                                                                                                                                                                                                                                            &lt;br/&gt;                vDateDebPeriodePrecedente :=TRUNC(ADD_MONTHS(pDateCalcFactu,-9),&apos;Q&apos;);                                                                                                                                                                                                                                                                          &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            WHEN 12 THEN                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;              vDateDebPeriodeEncours :=TRUNC(pDateCalcFactu,&apos;YEAR&apos;);                                                                                                                                                                                                                                                                                           &lt;br/&gt;              vDateDebPeriodeSuivante :=ADD_MONTHS(TRUNC(pDateCalcFactu,&apos;YEAR&apos;),+12);                                                                                                                                                                                                                                                                          &lt;br/&gt;              vDateDebPeriodePrecedente :=ADD_MONTHS(TRUNC(pDateCalcFactu,&apos;YEAR&apos;),-12);                                                                                                                                                                                                                                                                        &lt;br/&gt;          END CASE;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          IF TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                   &lt;br/&gt;            -- A Echoir                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;            IF vTerme = &apos;A ECHOIR&apos; THEN                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              IF ancAbo &gt; vAbo THEN                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                IF pMoisInclus THEN                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                  -- Nb de mois entre la date de modif et la date de MES effective &lt; durée d&apos;engagement -- DE non terminée                                                                                                                                                                                                                                     &lt;br/&gt;                  IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN                                                                                                                                                                                                                                        &lt;br/&gt;                    -- pMontant = durée d&apos;engagement moins nb de mois entre la date de début de période et la date de MES effective * (anc ABO- nv ABO)&lt;br/&gt;                    pMontant:=(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(vDateMESEffec,&apos;MONTH&apos;)))*(ancAbo-vAbo)-(((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))*(ancAbo-vAbo))/vNbJMoisEng);&lt;br/&gt;                    pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(vDateMESEffec,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR(LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement));                                                                                                                &lt;br/&gt;                    pLibPeriodeDeb:=vDateDebPeriodeEncours;                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                    pLibPeriodeFin:=vDateFinEngagement;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                    codRet:=0;                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  -- Nb de mois entre la date de modif et la date de MES effective &gt;= durée d&apos;engagement -- DE terminée                                                                                                                                                                                                                                        &lt;br/&gt;                  ELSIF MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN                                                                                                                                                                                                                                    &lt;br/&gt;                    -- remboursement du trop perçu&lt;br/&gt;                    pMontant:=(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo)+((TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))*((ancAbo-vAbo)/vNbJMoisMod));&lt;br/&gt;                    pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR(TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;));                                                                                              &lt;br/&gt;                    pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                               &lt;br/&gt;                    pLibPeriodeFin:=vDateDebPeriodeEncours-1;                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                    codRet:=0;                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  END IF;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                -- Mois de facturation hors période                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  -- Nb de mois entre la date de modif et la date de MES effective &lt; durée d&apos;engagement -- DE non terminée                                                                                                                                                                                                                                     &lt;br/&gt;                  IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN&lt;br/&gt;                    pMontant:=(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(vDateMESEffec,&apos;MONTH&apos;)))*(ancAbo-vAbo)-(((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))*(ancAbo-vAbo))/vNbJMoisEng);&lt;br/&gt;                    pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(vDateMESEffec,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR(LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement));                                                                                                                &lt;br/&gt;                    pLibPeriodeDeb:=vDateDebPeriodeEncours;                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                    pLibPeriodeFin:=vDateFinEngagement;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                    codRet:=0;                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  -- Nb de mois entre la date de modif et la date de MES effective &gt;= durée d&apos;engagement -- DE terminée                                                                                                                                                                                                                                        &lt;br/&gt;                  ELSIF MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN&lt;br/&gt;                    pMontant:=MONTHS_BETWEEN(vDateDebPeriodeSuivante,TRUNC(pDateCalcFactu,&apos;MONTH&apos;))*(vAbo-ancAbo);&lt;br/&gt;                    pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodeSuivante,TRUNC(pDateCalcFactu,&apos;MONTH&apos;)));                                                                                                                                                                                                                         &lt;br/&gt;                    pLibPeriodeDeb:=pDateCalcFactu;                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                    pLibPeriodeFin:=vDateDebPeriodeSuivante-1;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                    codRet:=0;                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  END IF;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              ELSE                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;              -- Nouveau tarif plus élevé que l&apos;ancien, on ne tient pas compte de la durée d&apos;engagement.                                                                                                                                                                                                                                                       &lt;br/&gt;                IF pMoisInclus THEN&lt;br/&gt;                  pMontant:=(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo)+((TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))*((ancAbo-vAbo)/vNbJMoisMod));&lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR(TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;));                                                                                                &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  pLibPeriodeFin:=vDateDebPeriodeEncours-1;                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                -- Mois de facturation hors période                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                ELSE&lt;br/&gt;                  pMontant:=MONTHS_BETWEEN(vDateDebPeriodeSuivante,TRUNC(pDateCalcFactu,&apos;MONTH&apos;))*(vAbo-ancAbo);&lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodeSuivante,TRUNC(pDateCalcFactu,&apos;MONTH&apos;)));                                                                                                                                                                                                                           &lt;br/&gt;                  pLibPeriodeDeb:=pDateCalcFactu;                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                  pLibPeriodeFin:=vDateDebPeriodeSuivante-1;                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF; -- fin si  ancAbo &gt; vAbo                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;            END IF; -- fin si A Echoir                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;            -- Echu                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;            IF vTerme = &apos;ECHU&apos; THEN                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;              IF ancAbo &gt; vAbo THEN                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                IF pMoisInclus THEN                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                  -- Nb de mois entre la date de modif et la date de MES effective &lt; durée d&apos;engagement -- DE non terminée                                                                                                                                                                                                                                     &lt;br/&gt;                  IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN                                                                                                                                                                                                                                        &lt;br/&gt;                    -- pMontant = durée d&apos;engagement moins nb de mois entre la date de début de période précédente et la date de MES effective * (anc ABO- nv ABO)&lt;br/&gt;                    pMontant:=(vDE-MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(vDateMESEffec,&apos;MONTH&apos;)))*(ancAbo-vAbo)-(((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))*(ancAbo-vAbo))/vNbJMoisEng);&lt;br/&gt;                    pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(vDateMESEffec,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR(LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement));                                                                                                             &lt;br/&gt;                    pLibPeriodeDeb:=vDateDebPeriodePrecedente;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                    pLibPeriodeFin:=vDateFinEngagement;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                    codRet:=0;                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  -- Nb de mois entre la date de modif et la date de MES effective &gt;= durée d&apos;engagement -- DE terminée                                                                                                                                                                                                                                        &lt;br/&gt;                  ELSIF MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN&lt;br/&gt;                    pMontant:=(MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo)+((TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))*((ancAbo-vAbo)/vNbJMoisMod));&lt;br/&gt;                    pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR(TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;));                                                                                           &lt;br/&gt;                    pLibPeriodeDeb:=vDateDebPeriodePrecedente;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                    pLibPeriodeFin:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                               &lt;br/&gt;                    codRet:=0;                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  END IF;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                -- Mois de facturation hors période                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  -- Nb de mois entre la date de modif et la date de MES effective &lt; durée d&apos;engagement -- DE non termimnée                                                                                                                                                                                                                                    &lt;br/&gt;                  IF MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &lt; vDE THEN&lt;br/&gt;                    pMontant:=(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(vDateMESEffec,&apos;MONTH&apos;)))*(ancAbo-vAbo)-(((LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement))*(ancAbo-vAbo))/vNbJMoisEng);&lt;br/&gt;                    pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(vDE-MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(vDateMESEffec,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR(LAST_DAY(TRUNC(vDateFinEngagement,&apos;MONTH&apos;))-TRUNC(vDateFinEngagement));                                                                                                                &lt;br/&gt;                    pLibPeriodeDeb:=vDateDebPeriodeEncours;                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                    pLibPeriodeFin:=vDateFinEngagement;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                    codRet:=0;                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  -- Nb de mois entre la date de modif et la date de MES effective &gt;= durée d&apos;engagement -- DE terminée                                                                                                                                                                                                                                        &lt;br/&gt;                  ELSIF MONTHS_BETWEEN(TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;),TRUNC(vDateMESEffec,&apos;MONTH&apos;)) &gt;= vDE THEN                                                                                                                                                                                                                                    &lt;br/&gt;                    -- remboursement&lt;br/&gt;                    pMontant:=MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))*(vAbo-ancAbo)+((TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))*((ancAbo-vAbo)/vNbJMoisMod));&lt;br/&gt;                    pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR(TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;));                                                                                              &lt;br/&gt;                    pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                               &lt;br/&gt;                    pLibPeriodeFin:=vDateDebPeriodeEncours-1;                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                    codRet:=0;                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  END IF;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              ELSE                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                -- Nouveau tarif plus élevé que l&apos;ancien, on ne tient pas compte de la durée d&apos;engagement.                                                                                                                                                                                                                                                     &lt;br/&gt;                IF pMoisInclus THEN&lt;br/&gt;                  pMontant:=(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo)+((TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))*((ancAbo-vAbo)/vNbJMoisMod));&lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR(TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;));                                                                                                &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  pLibPeriodeFin:=vDateDebPeriodeEncours-1;                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                ELSE&lt;br/&gt;                  pMontant:=(MONTHS_BETWEEN(vDateDebPeriodeSuivante,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo)+((TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))*((ancAbo-vAbo)/vNbJMoisMod));&lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodeSuivante,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR(TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;));                                                                                               &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  pLibPeriodeFin:=vDateDebPeriodeSuivante-1;                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF; -- fin si  ancAbo &gt; vAbo                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;            END IF; -- fin si Echu                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          END IF; -- Fin date modif &lt;= n-1                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;        END IF; -- Fin pFacteur = 1                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;        pMsg := pMsg||&apos; ##&apos;;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;      END IF; -- fin codRet=0                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;    END IF; -- fin si mois(date mise en modif) = n-1                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;    -- Ajout VLAN                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;    IF TRUNC(pLigne.DATE_MISE_EN_MODIF__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) AND INSTR(UPPER(pLigne.MOTIF_MODIF__C),&apos;AJOUT&apos;) &gt; 0 THEN&lt;br/&gt;      pMontantFAS := TO_NUMBER(pLigne.FAS__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;);&lt;br/&gt;      codRet := 0;                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;    END IF;                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;    -- Réengagement, pas de durée d&apos;engagement à prendre en compte                                                                                                                                                                                                                                                                                             &lt;br/&gt;    IF TRUNC(pLigne.DATE_MISE_EN_MODIF__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) AND INSTR(UPPER(TRANSLATE(pLigne.MOTIF_MODIF__C,&apos;é&apos;,&apos;e&apos;)),&apos;REENGAGEMENT&apos;) &gt; 0 THEN                                                                                                                                                                           &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;      -- Récupération du tarif de l&apos;abonnement antérieur si existant                                                                                                                                                                                                                                                                                           &lt;br/&gt;      ancAbo := TO_NUMBER(NULL);                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;      codRet := F_AncienAbo(pLigne,ancAbo,vDE,ancLoc,pMsg);                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;       if pTypePresta = &apos;LOC&apos; then                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;         ancAbo:=ancLoc;                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;         vAbo:=vLoc;                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;       end if;                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;      -- On ne prend pas en compte le code retour, mais le montant, car sinon on passe dans le cas d&apos;erreur de la DE                                                                                                                                                                                                                                           &lt;br/&gt;      -- hors, ici la DE n&apos;ai pas obligatoire car non prise en compte                                                                                                                                                                                                                                                                                          &lt;br/&gt;      IF ancAbo IS NOT NULL THEN                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- On récupère le FAS de modification dans tous les cas.                                                                                                                                                                                                                                                                                               &lt;br/&gt;        pMontantFAS := TO_NUMBER(pLigne.FAS__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;);                                                                                                                                                                                                                                                                   &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- On note le montant de l&apos;abonnement et la durée d&apos;engagement à titre informatif                                                                                                                                                                                                                                                                      &lt;br/&gt;        pMsg:=&apos;## Abonnement de : &apos;||TO_CHAR(ancAbo);                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        codRet:=0; -- on le force à zéro ici pour éviter la sortie en erreur du à la DE nulle.                                                                                                                                                                                                                                                                 &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- MENSUELLE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;        IF pFacteur = 1 THEN                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;          -- A Echoir                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          IF vTerme = &apos;A ECHOIR&apos; THEN                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            IF ancAbo &gt; vAbo THEN                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;              IF TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                               &lt;br/&gt;                -- pMontant = Nombre de mois entre date de modification et N * (nv ABO - anc ABO) plus les jours du début de mois de modification à la date de modification * (anc ABO - nv ABO) car cette période (jours début du mois modif) doit rester à l&apos;ancien tarif.&lt;br/&gt;                pMontant:=((MONTHS_BETWEEN(TRUNC(pDateCalcFactu,&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo))+((TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))*((ancAbo-vAbo)/vNbJMoisMod));&lt;br/&gt;                pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(pDateCalcFactu,&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR(TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;));                                                                                           &lt;br/&gt;                pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                pLibPeriodeFin:=pDateCalcFactu-1;                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            ELSE                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;              IF TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                               &lt;br/&gt;                -- pMontant = Nombre de mois entre date de modification et N-1 * (nv ABO - anc ABO) plus les jours du début de mois de modification à la date de modification * (anc ABO - nv ABO) car cette période (jours début du mois modif) doit rester à l&apos;ancien tarif.&lt;br/&gt;                pMontant:=((MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo))+((TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))*((ancAbo-vAbo)/vNbJMoisMod));&lt;br/&gt;                pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR(TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;));                                                                            &lt;br/&gt;                pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                pLibPeriodeFin:=pDateCalcFactu-1;                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF; -- fin si  ancAbo &gt; vAbo                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;          END IF; -- fin si A Echoir                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;          -- Echu                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          IF vTerme = &apos;ECHU&apos; THEN                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;            IF ancAbo &gt; vAbo THEN                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;              IF TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;) = TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN&lt;br/&gt;                pMontant :=(TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))*((ancAbo-vAbo)/vNbJMoisMod);&lt;br/&gt;                pMsg := pMsg||&apos; Nombre de jours :&apos;||TO_CHAR(TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;));                                                                                                                                                                                                                    &lt;br/&gt;                pLibPeriodeDeb:=TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;);                                                                                                                                                                                                                                                                                    &lt;br/&gt;                pLibPeriodeFin:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              IF TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;) &lt; TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN                                                                                                                                                                                                                                                &lt;br/&gt;                -- pMontant = Nombre de mois entre date de modification et N-1 * (nv ABO - anc ABO) plus les jours du début de mois de modification à la date de modification * (anc ABO - nv ABO) car cette période (jours début du mois modif) doit rester à l&apos;ancien tarif.&lt;br/&gt;                pMontant:=((MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo))+((TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))*((ancAbo-vAbo)/vNbJMoisMod));&lt;br/&gt;                pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR(TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;));                                                                            &lt;br/&gt;                pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                pLibPeriodeFin:=pDateCalcFactu-1;                                                                                                                                                                                                                                                                                                              &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            ELSE                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;              IF TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN&lt;br/&gt;                pMontant:=((MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo))+((TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))*((ancAbo-vAbo)/vNbJMoisMod));&lt;br/&gt;                pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;),TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR(TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;));                                                                            &lt;br/&gt;                pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                pLibPeriodeFin:=pDateCalcFactu-1;                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF; -- fin si  ancAbo &gt; vAbo                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;          END IF; -- fin si Echu                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- TRIMESTRI, SEMESTRI, ANNU -&gt; ELLE                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;        ELSE                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;          CASE pFacteur                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;            WHEN 3 THEN                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              vDateDebPeriodeEncours :=TRUNC(pDateCalcFactu,&apos;Q&apos;);&lt;br/&gt;              vDateDebPeriodeSuivante :=(TRUNC(ADD_MONTHS(pDateCalcFactu,+3),&apos;Q&apos;)-1);&lt;br/&gt;              vDateDebPeriodePrecedente :=TRUNC(ADD_MONTHS(pDateCalcFactu,-3),&apos;Q&apos;);&lt;br/&gt;            WHEN 6 THEN&lt;br/&gt;              IF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;1&apos;,&apos;3&apos;) THEN&lt;br/&gt;                vDateDebPeriodeEncours :=TRUNC(pDateCalcFactu,&apos;Q&apos;);&lt;br/&gt;                vDateDebPeriodeSuivante :=TRUNC(ADD_MONTHS(pDateCalcFactu,+6),&apos;Q&apos;);&lt;br/&gt;                vDateDebPeriodePrecedente :=TRUNC(ADD_MONTHS(pDateCalcFactu,-6),&apos;Q&apos;);&lt;br/&gt;              ELSIF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;2&apos;,&apos;4&apos;) THEN&lt;br/&gt;                vDateDebPeriodeEncours :=TRUNC(ADD_MONTHS(pDateCalcFactu,-3),&apos;Q&apos;);&lt;br/&gt;                vDateDebPeriodeSuivante :=TRUNC(ADD_MONTHS(pDateCalcFactu,+3),&apos;Q&apos;);&lt;br/&gt;                vDateDebPeriodePrecedente :=TRUNC(ADD_MONTHS(pDateCalcFactu,-9),&apos;Q&apos;);&lt;br/&gt;              END IF;&lt;br/&gt;            WHEN 12 THEN&lt;br/&gt;              vDateDebPeriodeEncours :=TRUNC(pDateCalcFactu,&apos;YEAR&apos;);&lt;br/&gt;              vDateDebPeriodeSuivante :=ADD_MONTHS(TRUNC(pDateCalcFactu,&apos;YEAR&apos;),+12);&lt;br/&gt;              vDateDebPeriodePrecedente :=ADD_MONTHS(TRUNC(pDateCalcFactu,&apos;YEAR&apos;),-12);&lt;br/&gt;          END CASE;&lt;br/&gt;&lt;br/&gt;          IF TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;) &lt;= TRUNC(ADD_MONTHS(pDateCalcFactu,-1),&apos;MONTH&apos;) THEN&lt;br/&gt;            -- A Echoir&lt;br/&gt;            IF vTerme = &apos;A ECHOIR&apos; THEN&lt;br/&gt;              IF pMoisInclus THEN                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                -- remboursement du trop perçu&lt;br/&gt;                pMontant:=(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo)+((TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))*((ancAbo-vAbo)/vNbJMoisMod));&lt;br/&gt;                pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR(TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;));                                                                                                  &lt;br/&gt;                pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                pLibPeriodeFin:=vDateDebPeriodeEncours-1;                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              -- Mois de facturation hors période                                                                                                                                                                                                                                                                                                              &lt;br/&gt;              ELSE&lt;br/&gt;                pMontant:=MONTHS_BETWEEN(vDateDebPeriodeSuivante,TRUNC(pDateCalcFactu,&apos;MONTH&apos;))*(vAbo-ancAbo);&lt;br/&gt;                pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodeSuivante,TRUNC(pDateCalcFactu,&apos;MONTH&apos;)));                                                                                                                                                                                                                             &lt;br/&gt;                pLibPeriodeDeb:=pDateCalcFactu;                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                pLibPeriodeFin:=vDateDebPeriodeSuivante-1;                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                codRet:=0;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF; -- fin si A Echoir                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;            -- Echu                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;            IF vTerme = &apos;ECHU&apos; THEN                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;              IF ancAbo &gt; vAbo THEN                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                IF pMoisInclus THEN&lt;br/&gt;                  pMontant:=(MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo)+((TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))*((ancAbo-vAbo)/vNbJMoisMod));&lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodePrecedente,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR(TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;));                                                                                             &lt;br/&gt;                  pLibPeriodeDeb:=vDateDebPeriodePrecedente;                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                  pLibPeriodeFin:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                -- Mois de facturation hors période                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  -- remboursement&lt;br/&gt;                  pMontant:=MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))*(vAbo-ancAbo)+((TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))*((ancAbo-vAbo)/vNbJMoisMod));&lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR(TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;));                                                                                                &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  pLibPeriodeFin:=vDateDebPeriodeEncours-1;                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              ELSE                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                -- Nouveau tarif plus élevé que l&apos;ancien, on ne tient pas compte de la durée d&apos;engagement.                                                                                                                                                                                                                                                     &lt;br/&gt;                IF pMoisInclus THEN&lt;br/&gt;                  pMontant:=(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo)+((TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))*((ancAbo-vAbo)/vNbJMoisMod));&lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodeEncours,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR(TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;));                                                                                                &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  pLibPeriodeFin:=vDateDebPeriodeEncours-1;                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                ELSE&lt;br/&gt;                  pMontant:=(MONTHS_BETWEEN(vDateDebPeriodeSuivante,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))*(vAbo-ancAbo)+((TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;))*((ancAbo-vAbo)/vNbJMoisMod));&lt;br/&gt;                  pMsg := pMsg||&apos; Nombre de mois :&apos;||TO_CHAR(MONTHS_BETWEEN(vDateDebPeriodeSuivante,TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;)))||&apos;, Nombre de jours :&apos;||TO_CHAR(TRUNC(pLigne.DATE_MODIFICATION__C)-TRUNC(pLigne.DATE_MODIFICATION__C,&apos;MONTH&apos;));                                                                                               &lt;br/&gt;                  pLibPeriodeDeb:=pLigne.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  pLibPeriodeFin:=vDateDebPeriodeSuivante-1;                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                  codRet:=0;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF; -- fin si  ancAbo &gt; vAbo                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;            END IF; -- fin si Echu                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          END IF; -- Fin date modif &lt;= n-1                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;        END IF; -- Fin pFacteur = 1                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;        pMsg := pMsg||&apos; ##&apos;;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;      END IF; -- fin ancAbo IS NOT NULL                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    END IF; -- fin si mois(date mise en modif) = n-1                                                                                                                                                                                                                                                                                                           &lt;br/&gt;  END IF; -- fin Actif                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;  &lt;br/&gt;  --Story 431 (arrondi a 2)&lt;br/&gt;  pMontant   := ROUND(pMontant   , 2);&lt;br/&gt;  pMontantFAS:= ROUND(pMontantFAS, 2);&lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  RETURN codRet;                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;END F_UpDownProrata;                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;-- Insertion des données sources dans la table T_FDSL_SERVICE_SF                                                                                                                                                                                                                                                                                               &lt;br/&gt;PROCEDURE P_InsertServiceSF (pDateCalcFactu IN DATE) IS                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;vErr INTEGER:=0;                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;vMois NUMBER(2);                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;vAnnee NUMBER(4);                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  vMois := EXTRACT(MONTH FROM pDateCalcFactu);                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;  vAnnee := EXTRACT(YEAR FROM pDateCalcFactu);                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    INSERT INTO T_FDSL_SERVICE_SF                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;    (                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;     MOIS                        ,                                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;     ANNEE                       ,                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;     ANALYSE_FACTU__C            ,                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;     ABONNE_COMMANDE__C          ,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;     COMMENTAIRE_FACTURATION__C  ,                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     DATE_DEBUT_FACTU__C         ,                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;     DATE_MES_EFFECTIVE__C       ,                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;     DATE_MISE_EN_FACTU__C       ,                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;     DATE_MISE_EN_MODIF__C       ,                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;     DATE_MISE_EN_RESIL__C       ,                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;     DATE_MODIFICATION__C        ,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;     DATE_RESIL__C               ,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;     DETAIL_ANALYSE__C           ,                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;     DUREE_D_ENGAGEMENT__C       ,                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;     FAI__C                      ,                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;     FAS__C                      ,                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;     ID_SERVICE__C               ,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;     IRU__C                      ,                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;     SERVICE_ID                  ,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     MODE_FACTU__C               ,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;     NDI__C                      ,                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;     NAME                        ,                                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;     PFRO__C                     ,                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;     PDC_ID                      ,                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;     SIRET__C                    ,                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;     REF_FAI__C                  ,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     STATUT__C                   ,                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;     TECHNO__C                   ,                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;     TERME_FACTU__C              ,                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;     VIA_DGT__C                  ,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     VIA_GTR__C                  ,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     FREQUENCE_FACTU__C          ,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;     MOTIF_RESILIATION__C        ,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;     MOTIF_MODIF__C              ,                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;     TYPE_DEGROUPAGE__C          ,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;     NOM_PDC                     ,                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;     NOM_PROJET__C               ,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;     DSP__C                      ,                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;     VILLE__C                    ,                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;     SEUIL__C                    ,                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;     TARIF_FORFAIT__C            ,                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;     TARIF_DEPASSEMENT__C        ,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;     NOM_FAI                     ,                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;     ABONNEMENT_MENSUEL__C       ,                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;     LOCATION__C                 ,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;     SIREN__C                    ,                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;     MAILS_COPIES_D_TAIL_FACTU__C,                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;     MAILS_DEST_D_TAIL_FACTU__C  ,                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     DATE_CALC_FACTU             ,&lt;br/&gt;     DATE_FIN_ENGAGEMENT__C      , --Story URL855&lt;br/&gt;     PROFIL__C                   ,&lt;br/&gt;     ADRESSE_1__C                ,&lt;br/&gt;     CP__C						 ,&lt;br/&gt;	 TYPE_VENTE__C&lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;    )                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;    SELECT                                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          vMois                           ,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          vAnnee                          ,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          TSERV.ANALYSE_FACTU__C          ,                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          TSERV.ABONNE_COMMANDE__C        ,                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          TSERV.COMMENTAIRE_FACTURATION__C,                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;          TSERV.DATE_DEBUT_FACTU__C       ,                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;          TSERV.DATE_MES_EFFECTIVE__C     ,                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;          TSERV.DATE_MISE_EN_FACTU__C     ,                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;          TSERV.DATE_MISE_EN_MODIF__C     ,                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;          TSERV.DATE_MISE_EN_RESIL__C     ,                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;          TSERV.DATE_MODIFICATION__C      ,                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          TSERV.DATE_RESIL__C             ,                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;          TSERV.DETAIL_ANALYSE__C         ,                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          TSERV.DUREE_D_ENGAGEMENT__C     ,                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;          TSERV.FAI__C                    ,                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;          TSERV.FAS__C                    ,                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;          TSERV.ID_SERVICE__C             ,                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;          TSERV.IRU__C                    ,                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;          TSERV.ID                        ,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          TSERV.MODE_FACTU__C             ,                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;          TSERV.NDI__C                    ,                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;          TSERV.NAME                      ,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          TSERV.PFRO__C                   ,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;          TSERV.PRISE_DE_COMMANDE__C      ,                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          TPDC.SIRET__C                   ,                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;          TSERV.REF_FAI__C                ,                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;          TSERV.STATUT__C                 ,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          TSERV.TECHNO__C                 ,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          TSERV.TERME_FACTU__C            ,                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;          TSERV.VIA_DGT__C                ,                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;          TSERV.VIA_GTR__C                ,                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;          TSERV.FREQUENCE_FACTU__C        ,                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          TSERV.MOTIF_RESILIATION__C      ,                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          TSERV.MOTIF_MODIF__C            ,                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;          TPDC.TYPE_DEGROUPAGE__C         ,                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          TPDC.Name NOM_PDC               ,                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;          TPDC.NOM_PROJET__C              ,                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;          TPDC.DSP__C                     ,                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;          TSERV.VILLE__C                  ,  --Story URL855 !                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          TPDC.SEUIL__C                   ,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;          CASE TSERV.TECHNO__C&lt;br/&gt;            WHEN  &apos;TRANSIT IP&apos; THEN  TSERV.ABONNEMENT_MENSUEL__C&lt;br/&gt;	    ELSE TSERV.TARIF_FORFAIT__C&lt;br/&gt;          END                               , --le champ TARIF_FORFAIT n est plus alimenté dans SF pour TRANSIT IP                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          TSERV.TARIF_DEPASSEMENT__C        ,                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          TCOMP.Name NOM_FAI                ,                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;          TSERV.ABONNEMENT_MENSUEL__C       ,                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;          TSERV.LOCATION__C                 ,                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;          TCOMP.siren__C                    ,                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;          TCOMP.MAILS_COPIES_D_TAIL_FACTU__C,                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;          TCOMP.MAILS_DEST_D_TAIL_FACTU__C  ,                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;          pDateCalcFactu                    ,&lt;br/&gt;          TSERV.DATE_FIN_ENGAGEMENT__C      , --Story URL855&lt;br/&gt;          TSERV.PROFIL__C                   , &lt;br/&gt;          TSERV.ADRESSE_1__C                ,&lt;br/&gt;          TSERV.CP__C                       ,&lt;br/&gt;		  TSERV.TYPE_VENTE__C&lt;br/&gt;    FROM                                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;        S_SF_PDC TPDC                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;        INNER JOIN S_SF_SERVICE TSERV                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;        ON TPDC.ID = TSERV.PRISE_DE_COMMANDE__C                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;        INNER JOIN S_SF_COMPTE TCOMP                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;        ON TPDC.FAI__C = TCOMP.ID                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;    ;&lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN NO_DATA_FOUND THEN                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;       vErr:=1;                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      vErr:=0;                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  IF vErr = 0 THEN                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;    COMMIT;                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;  ELSE                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;    ROLLBACK;                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;    RAISE_APPLICATION_ERROR(-20001,&apos;Erreur lors de l&apos;&apos;insertion des nouvelles données de la table T_FDSL_SERVICE_SF&apos;||SQLERRM);                                                                                                                                                                                                                                &lt;br/&gt;  END IF;                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;END P_InsertServiceSF;                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;PROCEDURE P_InsertComptaFactu (pDateCalcFactu IN DATE) IS                                                                                                                                                                                                                                                                                                      &lt;br/&gt;vMois NUMBER(2);                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;vAnnee NUMBER(4);                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;vMoisCompta NUMBER(2);                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;vAnneeCompta NUMBER(4);                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;vErr INTEGER:=0;                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  vMoisCompta := EXTRACT(MONTH FROM pDateCalcFactu);                                                                                                                                                                                                                                                                                                           &lt;br/&gt;  vAnneeCompta := EXTRACT(YEAR FROM pDateCalcFactu);                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    SELECT DISTINCT                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;         MOIS,                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;         ANNEE                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;           into                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;            vMois,                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;            vAnnee                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;              FROM T_FDSL_DETAIL_FACTURE                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                 WHERE ROWNUM=1;                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     DELETE T_FDSL_COMPTA_FACTURE                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                 WHERE MOIS=vMois                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                       AND ANNEE =vAnnee;                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;  WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;  vMois :=0;                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;  vAnnee :=0;                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;    INSERT INTO T_FDSL_COMPTA_FACTURE (                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                       ID_SERVICE,                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                       ABONNE,                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                       FAI,                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                       DSP,                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                       TECHNO,                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                       MOIS,                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                                       ANNEE,                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                       DATE_DEB_FACTU,                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                       DATE_SAISIE_MES,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                       DATE_MES_EFFECTIVE,                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                                       DATE_SAISIE_MODIF,                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                       DATE_DE_MODIF,                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                       DATE_SAISIE_RESIL,                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                       DATE_RESIL,                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                       DATE_CALC_FACTU,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                       SDFC,                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                                       COMMANDE,                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                       REF_CLIENT,                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                       NOM_PROJET,                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                       VILLE,                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                       DUREE_ENGAGEMENT,                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                       FREQUENCE_FACTU,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                       NDI,                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                       VIA_DGT,                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                       VIA_GTR,                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                       TERME_FACTU,                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                       MODE_FACTU,                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                       LIBELLE,                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                       LIB_TYPE_PRESTA,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                       LIB_PERIODE_DEB,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                       LIB_PERIODE_FIN,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                       CONSOMMATION,                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                                       TARIF_FORFAIT,                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                       SEUIL,                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                       TARIF_DEPASSEMENT,                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                       MONTANT,                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                       COMMENTAIRE,                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                       ANALYSE,                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                       DETAIL_ANALYSE,                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                       STATUT,                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                       TYPE_FACTU,                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                       MOTIF_RESIL,                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                       MOTIF_MODIF,                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                       MAIL_DEST,                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                       MAIL_CC,                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                       ID_SALESFORCE,                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                       DATE_COMPTA_FACTU  ,&lt;br/&gt;                                       DATE_FIN_ENGAGEMENT,&lt;br/&gt;                                       PROFIL             ,--Story URL855&lt;br/&gt;                                       ADRESSE_1          ,&lt;br/&gt;                                       CP                  &lt;br/&gt;                                      )                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                      SELECT                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                                         ID_SERVICE,                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                                         ABONNE,                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                         FAI,                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                         DSP,                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                         TECHNO,                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                         MOIS,                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                         ANNEE,                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                         DATE_DEB_FACTU,                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                         DATE_SAISIE_MES,                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                         DATE_MES_EFFECTIVE,                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                                         DATE_SAISIE_MODIF,                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                         DATE_DE_MODIF,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                         DATE_SAISIE_RESIL,                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                         DATE_RESIL,                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                                         DATE_CALC_FACTU,                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                         SDFC,                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                         COMMANDE,                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                         REF_CLIENT,                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                                         NOM_PROJET,                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                                         VILLE,                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                         DUREE_ENGAGEMENT,                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                                         FREQUENCE_FACTU,                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                         NDI,                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                         VIA_DGT,                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                         VIA_GTR,                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                         TERME_FACTU,                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                         MODE_FACTU,                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                                         LIBELLE,                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                         LIB_TYPE_PRESTA,                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                         LIB_PERIODE_DEB,                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                         LIB_PERIODE_FIN,                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                         CONSOMMATION,                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                         TARIF_FORFAIT,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                         SEUIL,                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                         TARIF_DEPASSEMENT,                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                         MONTANT,                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                         COMMENTAIRE,                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                         ANALYSE,                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                         DETAIL_ANALYSE,                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                         STATUT,                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                         TYPE_FACTU,                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                                         MOTIF_RESIL,                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                         MOTIF_MODIF,                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                         MAIL_DEST,                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                         MAIL_CC,                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                         ID_SALESFORCE,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                         pDateCalcFactu,&lt;br/&gt;                                         DATE_FIN_ENGAGEMENT,&lt;br/&gt;                                         PROFIL             ,--Story URL855&lt;br/&gt;                                         ADRESSE_1          ,&lt;br/&gt;                                         CP                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                       FROM T_FDSL_DETAIL_FACTURE;                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      vErr:=1;                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    INSERT INTO T_FDSL_COMPTA_FACTURE (                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                       ID_SERVICE,                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                       ABONNE,                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                       FAI,                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                       DSP,                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                       TECHNO,                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                       MOIS,                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                                       ANNEE,                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                       DATE_DEB_FACTU,                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                       DATE_SAISIE_MES,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                       DATE_MES_EFFECTIVE,                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                                       DATE_SAISIE_MODIF,                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                       DATE_DE_MODIF,                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                       DATE_SAISIE_RESIL,                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                       DATE_RESIL,                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                       DATE_CALC_FACTU,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                       SDFC,                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                                       COMMANDE,                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                       REF_CLIENT,                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                       NOM_PROJET,                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                       VILLE,                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                       DUREE_ENGAGEMENT,                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                       FREQUENCE_FACTU,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                       NDI,                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                       VIA_DGT,                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                       VIA_GTR,                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                       TERME_FACTU,                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                       MODE_FACTU,                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                       LIBELLE,                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                       LIB_TYPE_PRESTA,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                       LIB_PERIODE_DEB,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                       LIB_PERIODE_FIN,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                       CONSOMMATION,                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                                       TARIF_FORFAIT,                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                       SEUIL,                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                       TARIF_DEPASSEMENT,                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                       MONTANT,                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                       COMMENTAIRE,                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                       ANALYSE,                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                       DETAIL_ANALYSE,                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                       STATUT,                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                       TYPE_FACTU,                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                       MOTIF_RESIL,                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                       MOTIF_MODIF,                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                       MAIL_DEST,                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                       MAIL_CC,                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                       ID_SALESFORCE,                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                       DATE_COMPTA_FACTU,&lt;br/&gt;                                       DATE_FIN_ENGAGEMENT,&lt;br/&gt;                                       PROFIL             ,--Story URL855&lt;br/&gt;                                       ADRESSE_1          ,&lt;br/&gt;                                       CP                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                      )                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;            SELECT                      service_sf.ID_SERVICE__C,                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                        service_sf.ABONNE_COMMANDE__C,                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                        service_sf.FAI__C,                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                                        service_sf.DSP__C,                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                                        service_sf.TECHNO__C,                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                        service_sf.MOIS,                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                        service_sf.ANNEE,                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                        service_sf.DATE_DEBUT_FACTU__C,                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                        service_sf.DATE_MISE_EN_FACTU__C,                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                        service_sf.DATE_MES_EFFECTIVE__C,                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                        service_sf.DATE_MISE_EN_MODIF__C,                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                        service_sf.DATE_MODIFICATION__C,                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                        service_sf.DATE_MISE_EN_RESIL__C,                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                        service_sf.DATE_RESIL__C,                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                        service_sf.DATE_CALC_FACTU,                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                        null,                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                        service_sf.NOM_PDC,                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                        service_sf.REF_FAI__C,                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                        service_sf.VILLE__C,                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                                        service_sf.NOM_PROJET__C,                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                        service_sf.DUREE_D_ENGAGEMENT__C,                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                        service_sf.FREQUENCE_FACTU__C,                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                        service_sf.NDI__C,                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                                        service_sf.VIA_DGT__C,                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                        service_sf.VIA_GTR__C,                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                        service_sf.TERME_FACTU__C,                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                        service_sf.MODE_FACTU__C,                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                        &apos;Non facturée ce mois&apos; libelle,                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                        &apos;Non facturée ce mois&apos; libelle_presta,                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                        trunc( ADD_MONTHS(service_sf.DATE_CALC_FACTU,-1),&apos;MONTH&apos;) lib_debut,                                                                                                                                                                                                                                                   &lt;br/&gt;                                        LAST_DAY(ADD_MONTHS(TRUNC(service_sf.DATE_CALC_FACTU),-1)) lib_fin,                                                                                                                                                                                                                                                    &lt;br/&gt;                                        0 consommation,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                        TO_NUMBER(service_sf.TARIF_FORFAIT__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;) forfait,                                                                                                                                                                                                                            &lt;br/&gt;                                        TO_NUMBER(service_sf.SEUIL__C) seuil,                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                        TO_NUMBER(service_sf.TARIF_DEPASSEMENT__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;) depassement,                                                                                                                                                                                                                    &lt;br/&gt;                                        0 montant,                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                        service_sf.COMMENTAIRE_FACTURATION__C,                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                        service_sf.ANALYSE_FACTU__C,                                                                                                                                                                                                                                                                                           &lt;br/&gt;                                        service_sf.DETAIL_ANALYSE__C,                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                        service_sf.STATUT__C,                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                                            &apos;COMPTA&apos; type_factu,                                                                                                                                                                                                                                                                               &lt;br/&gt;                                        service_sf.MOTIF_RESILIATION__C,                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                        service_sf.MOTIF_MODIF__C,                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                        service_sf.MAILS_DEST_D_TAIL_FACTU__C,                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                        service_sf.MAILS_COPIES_D_TAIL_FACTU__C,                                                                                                                                                                                                                                                                               &lt;br/&gt;                                        service_sf.PDC_ID,                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                                        pDateCalcFactu,&lt;br/&gt;                                        service_sf.DATE_FIN_ENGAGEMENT__C,&lt;br/&gt;                                        service_sf.PROFIL__C             ,--Story URL855&lt;br/&gt;                                        service_sf.ADRESSE_1__C          ,&lt;br/&gt;                                        service_sf.CP__C                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                      FROM T_FDSL_SERVICE_SF service_sf                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                      WHERE NOT EXISTS (SELECT DISTINCT ID_SERVICE from T_FDSL_DETAIL_FACTURE detail where                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                                          detail.ID_SERVICE=service_sf.ID_SERVICE__C                                                                                                                                                                                                                                                           &lt;br/&gt;                                                          AND detail.MOIS=service_sf.MOIS                                                                                                                                                                                                                                                                      &lt;br/&gt;                                                          AND detail.ANNEE=service_sf.ANNEE                                                                                                                                                                                                                                                                    &lt;br/&gt;                                                        );                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      vErr:=1;                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;  IF vErr = 0 THEN                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;    COMMIT;                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;  ELSE                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;    ROLLBACK;                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;    RAISE_APPLICATION_ERROR(-20017,&apos;Erreur lors de l&apos;&apos;insertion des nouvelles données de la table T_FDSL_COMPTA_FACTU&apos;);                                                                                                                                                                                                                                       &lt;br/&gt;  END IF;                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;END P_InsertComptaFactu;                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;PROCEDURE P_InsertHistoComptaHisto (pDateCalcFactu IN DATE) IS&lt;br/&gt;vMois NUMBER(2);&lt;br/&gt;vAnnee NUMBER(4);&lt;br/&gt;vErr INTEGER:=0;&lt;br/&gt;BEGIN&lt;br/&gt;  vMois := EXTRACT(MONTH FROM pDateCalcFactu);&lt;br/&gt;  vAnnee := EXTRACT(YEAR FROM pDateCalcFactu);&lt;br/&gt;&lt;br/&gt;  BEGIN&lt;br/&gt;    SELECT DISTINCT 1 into vErr&lt;br/&gt;              FROM T_FDSL_HISTO_COMPTA_FACTURE&lt;br/&gt;                 WHERE MOIS=vMois&lt;br/&gt;                       AND ANNEE =vAnnee;&lt;br/&gt;  EXCEPTION&lt;br/&gt;     WHEN OTHERS THEN&lt;br/&gt;       vErr:=0;&lt;br/&gt;  END;&lt;br/&gt;&lt;br/&gt;  if  vErr = 0 then&lt;br/&gt;     BEGIN&lt;br/&gt;         INSERT INTO T_FDSL_HISTO_COMPTA_FACTURE (&lt;br/&gt;                                            ID_SERVICE         ,&lt;br/&gt;                                            ABONNE             ,&lt;br/&gt;                                            FAI                ,&lt;br/&gt;                                            DSP                ,&lt;br/&gt;                                            TECHNO             ,&lt;br/&gt;                                            MOIS               ,&lt;br/&gt;                                            ANNEE              ,&lt;br/&gt;                                            DATE_DEB_FACTU     ,&lt;br/&gt;                                            DATE_SAISIE_MES    ,&lt;br/&gt;                                            DATE_MES_EFFECTIVE ,&lt;br/&gt;                                            DATE_SAISIE_MODIF  ,&lt;br/&gt;                                            DATE_DE_MODIF      ,&lt;br/&gt;                                            DATE_SAISIE_RESIL  ,&lt;br/&gt;                                            DATE_RESIL         ,&lt;br/&gt;                                            DATE_CALC_FACTU    ,&lt;br/&gt;                                            SDFC               ,&lt;br/&gt;                                            COMMANDE           ,&lt;br/&gt;                                            REF_CLIENT         ,&lt;br/&gt;                                            VILLE              ,&lt;br/&gt;                                            DUREE_ENGAGEMENT   ,&lt;br/&gt;                                            FREQUENCE_FACTU    ,&lt;br/&gt;                                            NDI                ,&lt;br/&gt;                                            VIA_DGT            ,&lt;br/&gt;                                            VIA_GTR            ,&lt;br/&gt;                                            TERME_FACTU        ,&lt;br/&gt;                                            MODE_FACTU         ,&lt;br/&gt;                                            LIBELLE            ,&lt;br/&gt;                                            LIB_TYPE_PRESTA    ,&lt;br/&gt;                                            LIB_PERIODE_DEB    ,&lt;br/&gt;                                            LIB_PERIODE_FIN    ,&lt;br/&gt;                                            CONSOMMATION       ,&lt;br/&gt;                                            TARIF_FORFAIT      ,&lt;br/&gt;                                            SEUIL              ,&lt;br/&gt;                                            TARIF_DEPASSEMENT  ,&lt;br/&gt;                                            MONTANT            ,&lt;br/&gt;                                            COMMENTAIRE        ,&lt;br/&gt;                                            ANALYSE            ,&lt;br/&gt;                                            DETAIL_ANALYSE     ,&lt;br/&gt;                                            STATUT             ,&lt;br/&gt;                                            TYPE_FACTU         ,&lt;br/&gt;                                            MOTIF_RESIL        ,&lt;br/&gt;                                            MOTIF_MODIF        ,&lt;br/&gt;                                            MAIL_DEST          ,&lt;br/&gt;                                            MAIL_CC            ,&lt;br/&gt;                                            ID_SALESFORCE      ,&lt;br/&gt;                                            DATE_COMPTA_FACTU  ,&lt;br/&gt;                                            DATE_CREATION      ,&lt;br/&gt;                                            USER_CREATION      ,&lt;br/&gt;                                            DATE_MODIF         ,&lt;br/&gt;                                            USER_MODIF         ,&lt;br/&gt;                                            DATE_FIN_ENGAGEMENT,&lt;br/&gt;                                            PROFIL             ,--Story URL855&lt;br/&gt;                                            ADRESSE_1          ,&lt;br/&gt;                                            CP&lt;br/&gt;                                           )                     &lt;br/&gt;                                           SELECT                &lt;br/&gt;                                              ID_SERVICE         ,&lt;br/&gt;                                              ABONNE             ,&lt;br/&gt;                                              FAI                ,&lt;br/&gt;                                              DSP                ,&lt;br/&gt;                                              TECHNO             ,&lt;br/&gt;                                              MOIS               ,&lt;br/&gt;                                              ANNEE              ,&lt;br/&gt;                                              DATE_DEB_FACTU     ,&lt;br/&gt;                                              DATE_SAISIE_MES    ,&lt;br/&gt;                                              DATE_MES_EFFECTIVE ,&lt;br/&gt;                                              DATE_SAISIE_MODIF  ,&lt;br/&gt;                                              DATE_DE_MODIF      ,&lt;br/&gt;                                              DATE_SAISIE_RESIL  ,&lt;br/&gt;                                              DATE_RESIL         ,&lt;br/&gt;                                              DATE_CALC_FACTU    ,&lt;br/&gt;                                              SDFC               ,&lt;br/&gt;                                              COMMANDE           ,&lt;br/&gt;                                              REF_CLIENT         ,&lt;br/&gt;                                              VILLE              ,&lt;br/&gt;                                              DUREE_ENGAGEMENT   ,&lt;br/&gt;                                              FREQUENCE_FACTU    ,&lt;br/&gt;                                              NDI                ,&lt;br/&gt;                                              VIA_DGT            ,&lt;br/&gt;                                              VIA_GTR            ,&lt;br/&gt;                                              TERME_FACTU        ,&lt;br/&gt;                                              MODE_FACTU         ,&lt;br/&gt;                                              LIBELLE            ,&lt;br/&gt;                                              LIB_TYPE_PRESTA    ,&lt;br/&gt;                                              LIB_PERIODE_DEB    ,&lt;br/&gt;                                              LIB_PERIODE_FIN    ,&lt;br/&gt;                                              CONSOMMATION       ,&lt;br/&gt;                                              TARIF_FORFAIT      ,&lt;br/&gt;                                              SEUIL              ,&lt;br/&gt;                                              TARIF_DEPASSEMENT  ,&lt;br/&gt;                                              MONTANT            ,&lt;br/&gt;                                              COMMENTAIRE        ,&lt;br/&gt;                                              ANALYSE            ,&lt;br/&gt;                                              DETAIL_ANALYSE     ,&lt;br/&gt;                                              STATUT             ,&lt;br/&gt;                                              TYPE_FACTU         ,&lt;br/&gt;                                              MOTIF_RESIL        ,&lt;br/&gt;                                              MOTIF_MODIF        ,&lt;br/&gt;                                              MAIL_DEST          ,&lt;br/&gt;                                              MAIL_CC            ,&lt;br/&gt;                                              ID_SALESFORCE      ,&lt;br/&gt;                                              pDateCalcFactu     ,&lt;br/&gt;                                              DATE_CREATION      ,&lt;br/&gt;                                              USER_CREATION      ,&lt;br/&gt;                                              sysdate            ,&lt;br/&gt;                                              &apos;REPRISE_DONNEES&apos;  ,&lt;br/&gt;                                              DATE_FIN_ENGAGEMENT,&lt;br/&gt;                                              PROFIL             ,--Story URL855&lt;br/&gt;                                              ADRESSE_1          ,&lt;br/&gt;                                              CP&lt;br/&gt;                                        FROM T_FDSL_HISTO_DETAIL_FACTURE&lt;br/&gt;                                        WHERE MOIS= vMois&lt;br/&gt;                                        AND ANNEE =vAnnee ;&lt;br/&gt;&lt;br/&gt;        EXCEPTION&lt;br/&gt;          WHEN OTHERS THEN&lt;br/&gt;            vErr:=1;&lt;br/&gt;     END;&lt;br/&gt;       &lt;br/&gt;     BEGIN&lt;br/&gt;         INSERT INTO T_FDSL_HISTO_COMPTA_FACTURE (&lt;br/&gt;                                            ID_SERVICE        ,&lt;br/&gt;                                            ABONNE            ,&lt;br/&gt;                                            FAI               ,&lt;br/&gt;                                            DSP               ,&lt;br/&gt;                                            TECHNO            ,&lt;br/&gt;                                            MOIS              ,&lt;br/&gt;                                            ANNEE             ,&lt;br/&gt;                                            DATE_DEB_FACTU    ,&lt;br/&gt;                                            DATE_SAISIE_MES   ,&lt;br/&gt;                                            DATE_MES_EFFECTIVE,&lt;br/&gt;                                            DATE_SAISIE_MODIF ,&lt;br/&gt;                                            DATE_DE_MODIF     ,&lt;br/&gt;                                            DATE_SAISIE_RESIL ,&lt;br/&gt;                                            DATE_RESIL        ,&lt;br/&gt;                                            DATE_CALC_FACTU   ,&lt;br/&gt;                                            SDFC              ,&lt;br/&gt;                                            COMMANDE          ,&lt;br/&gt;                                            REF_CLIENT        ,&lt;br/&gt;                                            VILLE             ,&lt;br/&gt;                                            DUREE_ENGAGEMENT  ,&lt;br/&gt;                                            FREQUENCE_FACTU   ,&lt;br/&gt;                                            NDI               ,&lt;br/&gt;                                            VIA_DGT           ,&lt;br/&gt;                                            VIA_GTR           ,&lt;br/&gt;                                            TERME_FACTU       ,&lt;br/&gt;                                            MODE_FACTU        ,&lt;br/&gt;                                            LIBELLE           ,&lt;br/&gt;                                            LIB_TYPE_PRESTA   ,&lt;br/&gt;                                            LIB_PERIODE_DEB   ,&lt;br/&gt;                                            LIB_PERIODE_FIN   ,&lt;br/&gt;                                            CONSOMMATION      ,&lt;br/&gt;                                            TARIF_FORFAIT     ,&lt;br/&gt;                                            SEUIL             ,&lt;br/&gt;                                            TARIF_DEPASSEMENT ,&lt;br/&gt;                                            MONTANT           ,&lt;br/&gt;                                            COMMENTAIRE       ,&lt;br/&gt;                                            ANALYSE           ,&lt;br/&gt;                                            DETAIL_ANALYSE    ,&lt;br/&gt;                                            STATUT            ,&lt;br/&gt;                                            TYPE_FACTU        ,&lt;br/&gt;                                            MOTIF_RESIL       ,&lt;br/&gt;                                            MOTIF_MODIF       ,&lt;br/&gt;                                            MAIL_DEST         ,&lt;br/&gt;                                            MAIL_CC           ,&lt;br/&gt;                                            ID_SALESFORCE     ,&lt;br/&gt;                                            DATE_COMPTA_FACTU ,&lt;br/&gt;                                            DATE_CREATION     ,&lt;br/&gt;                                            USER_CREATION     ,&lt;br/&gt;                                            DATE_MODIF        ,&lt;br/&gt;                                            USER_MODIF        ,&lt;br/&gt;                                            DATE_FIN_ENGAGEMENT,&lt;br/&gt;                                            PROFIL             ,--Story URL855&lt;br/&gt;                                            ADRESSE_1          ,&lt;br/&gt;                                            CP&lt;br/&gt;                                            &lt;br/&gt;                                           )&lt;br/&gt;           SELECT                            service_sf.ID_SERVICE__C         ,&lt;br/&gt;                                             service_sf.ABONNE_COMMANDE__C    ,&lt;br/&gt;                                             service_sf.FAI__C                ,&lt;br/&gt;                                             service_sf.DSP__C                ,&lt;br/&gt;                                             service_sf.TECHNO__C             ,&lt;br/&gt;                                             service_sf.MOIS                  ,&lt;br/&gt;                                             service_sf.ANNEE                 ,&lt;br/&gt;                                             service_sf.DATE_DEBUT_FACTU__C   ,&lt;br/&gt;                                             service_sf.DATE_MISE_EN_FACTU__C ,&lt;br/&gt;                                             service_sf.DATE_MES_EFFECTIVE__C ,&lt;br/&gt;                                             service_sf.DATE_MISE_EN_MODIF__C ,&lt;br/&gt;                                             service_sf.DATE_MODIFICATION__C  ,&lt;br/&gt;                                             service_sf.DATE_MISE_EN_RESIL__C ,&lt;br/&gt;                                             service_sf.DATE_RESIL__C         ,&lt;br/&gt;                                             service_sf.DATE_CALC_FACTU       ,&lt;br/&gt;                                             null                             ,&lt;br/&gt;                                             service_sf.NOM_PDC               ,&lt;br/&gt;                                             service_sf.REF_FAI__C            ,&lt;br/&gt;                                             service_sf.VILLE__C              ,&lt;br/&gt;                                             service_sf.DUREE_D_ENGAGEMENT__C ,&lt;br/&gt;                                             service_sf.FREQUENCE_FACTU__C    ,&lt;br/&gt;                                             service_sf.NDI__C                ,&lt;br/&gt;                                             service_sf.VIA_DGT__C            ,&lt;br/&gt;                                             service_sf.VIA_GTR__C            ,&lt;br/&gt;                                             service_sf.TERME_FACTU__C        ,&lt;br/&gt;                                             service_sf.MODE_FACTU__C         ,&lt;br/&gt;                                             &apos;Non facturée ce mois&apos; libelle   ,&lt;br/&gt;                                             &apos;Non facturée ce mois&apos; libelle_pr,&lt;br/&gt;                                             trunc( ADD_MONTHS(service_sf.DATE_CALC_FACTU,-1),&apos;MONTH&apos;) lib_debut,&lt;br/&gt;                                             LAST_DAY(ADD_MONTHS(TRUNC(service_sf.DATE_CALC_FACTU),-1)) lib_fin ,&lt;br/&gt;                                             0 consommation,&lt;br/&gt;                                             TO_NUMBER(service_sf.TARIF_FORFAIT__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;) forfait,&lt;br/&gt;                                             TO_NUMBER(service_sf.SEUIL__C) seuil,&lt;br/&gt;                                             TO_NUMBER(service_sf.TARIF_DEPASSEMENT__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;) depassement,&lt;br/&gt;                                             0 montant                              ,&lt;br/&gt;                                             service_sf.COMMENTAIRE_FACTURATION__C  ,&lt;br/&gt;                                             service_sf.ANALYSE_FACTU__C            ,&lt;br/&gt;                                             service_sf.DETAIL_ANALYSE__C           ,&lt;br/&gt;                                             service_sf.STATUT__C                   ,&lt;br/&gt;                                             &apos;COMPTA&apos; type_factu                    ,&lt;br/&gt;                                             service_sf.MOTIF_RESILIATION__C        ,&lt;br/&gt;                                             service_sf.MOTIF_MODIF__C              ,&lt;br/&gt;                                             service_sf.MAILS_DEST_D_TAIL_FACTU__C  ,&lt;br/&gt;                                             service_sf.MAILS_COPIES_D_TAIL_FACTU__C,&lt;br/&gt;                                             service_sf.PDC_ID                      ,&lt;br/&gt;                                             pDateCalcFactu                         ,&lt;br/&gt;                                             service_sf.DATE_CREATION               ,&lt;br/&gt;                                             service_sf.USER_CREATION               ,&lt;br/&gt;                                             sysdate                                ,&lt;br/&gt;                                             &apos;REPRISE_DONNEES&apos;                      ,&lt;br/&gt;                                             service_sf.DATE_FIN_ENGAGEMENT__C      ,&lt;br/&gt;                                             PROFIL__C                              ,--Story URL855&lt;br/&gt;                                             ADRESSE_1__C                           ,&lt;br/&gt;                                             CP__C&lt;br/&gt;                                         FROM T_FDSL_HISTO_SERVICE_SF service_sf&lt;br/&gt;                                         WHERE NOT EXISTS (select distinct ID_SERVICE from T_FDSL_HISTO_DETAIL_FACTURE detail&lt;br/&gt;                                                  where&lt;br/&gt;                                                    detail.ID_SERVICE=service_sf.ID_SERVICE__C&lt;br/&gt;                                                    AND detail.MOIS=service_sf.MOIS&lt;br/&gt;                                                    AND detail.ANNEE=service_sf.ANNEE&lt;br/&gt;                                                  )&lt;br/&gt;                                         AND service_sf.MOIS=   vMois&lt;br/&gt;                                         AND service_sf.ANNEE = vAnnee ;&lt;br/&gt;     &lt;br/&gt;       EXCEPTION&lt;br/&gt;         WHEN OTHERS THEN&lt;br/&gt;           vErr:=1;&lt;br/&gt;     END;&lt;br/&gt;  END IF;&lt;br/&gt;  &lt;br/&gt;  IF vErr = 0 THEN&lt;br/&gt;    COMMIT;&lt;br/&gt;  ELSE&lt;br/&gt;    ROLLBACK;&lt;br/&gt;    RAISE_APPLICATION_ERROR(-20085,&apos;Erreur lors du rattrappage d&apos;&apos;historisation Comptabilité&apos;);&lt;br/&gt;  END IF;&lt;br/&gt;  &lt;br/&gt;END P_InsertHistoComptaHisto;&lt;br/&gt;&lt;br/&gt;-- refactored                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;procedure P_InitialiserDetailFactu(enr IN OUT T_FDSL_SERVICE_SF%ROWTYPE                                                                                                                                                                                                                                                                                        &lt;br/&gt;   ,pDateCalcFactu IN  Date                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;   ,pLigneDetailFactu IN OUT T_FDSL_DETAIL_FACTURE%ROWTYPE                                                                                                                                                                                                                                                                                                     &lt;br/&gt;   ,vAnnee IN  NUMBER                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;   ,vMois IN  NUMBER                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;   ) as                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;begin                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;        pLigneDetailFactu.MOIS               := vMois;                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;        pLigneDetailFactu.ANNEE              := vAnnee;                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;        pLigneDetailFactu.ID_SERVICE         := enr.ID_SERVICE__C;                                                                                                                                                                                                                                                                                                       &lt;br/&gt;        pLigneDetailFactu.ABONNE             := enr.ABONNE_COMMANDE__C;                                                                                                                                                                                                                                                                                                      &lt;br/&gt;        pLigneDetailFactu.FAI                := enr.NOM_FAI;                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;        pLigneDetailFactu.DSP                := enr.DSP__C;                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;        pLigneDetailFactu.TECHNO             := enr.TECHNO__C;                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        pLigneDetailFactu.DATE_DEB_FACTU     := enr.DATE_DEBUT_FACTU__C;                                                                                                                                                                                                                                                                                             &lt;br/&gt;        pLigneDetailFactu.DATE_SAISIE_MES    := enr.DATE_MISE_EN_FACTU__C;                                                                                                                                                                                                                                                                                          &lt;br/&gt;        pLigneDetailFactu.DATE_MES_EFFECTIVE := enr.DATE_MES_EFFECTIVE__C;                                                                                                                                                                                                                                                                                       &lt;br/&gt;        pLigneDetailFactu.DATE_SAISIE_MODIF  := enr.DATE_MISE_EN_MODIF__C;                                                                                                                                                                                                                                                                                        &lt;br/&gt;        pLigneDetailFactu.DATE_DE_MODIF      := enr.DATE_MODIFICATION__C;                                                                                                                                                                                                                                                                                             &lt;br/&gt;        pLigneDetailFactu.DATE_SAISIE_RESIL  := enr.DATE_MISE_EN_RESIL__C;                                                                                                                                                                                                                                                                                        &lt;br/&gt;        pLigneDetailFactu.DATE_RESIL         := enr.DATE_RESIL__C;                                                                                                                                                                                                                                                                                                       &lt;br/&gt;        pLigneDetailFactu.SDFC               := NULL; -- A ALIMENTER                                                                                                                                                                                                                                                                                                           &lt;br/&gt;        pLigneDetailFactu.COMMANDE           := enr.NOM_PDC;                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        pLigneDetailFactu.REF_CLIENT         := enr.REF_FAI__C;                                                                                                                                                                                                                                                                                                          &lt;br/&gt;        pLigneDetailFactu.NOM_PROJET         := enr.NOM_PROJET__C;                                                                                                                                                                                                                                                                                                       &lt;br/&gt;        pLigneDetailFactu.PRODUITS_COMMANDES := enr.PRODUITS_COMMANDES__C;                                                                                                                                                                                                                                                                                      &lt;br/&gt;        pLigneDetailFactu.VILLE              := enr.VILLE__C;                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;        pLigneDetailFactu.DUREE_ENGAGEMENT   := enr.DUREE_D_ENGAGEMENT__C;                                                                                                                                                                                                                                                                                         &lt;br/&gt;        pLigneDetailFactu.FREQUENCE_FACTU    := enr.FREQUENCE_FACTU__C;                                                                                                                                                                                                                                                                                             &lt;br/&gt;        pLigneDetailFactu.NDI                := enr.NDI__C;                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;        pLigneDetailFactu.VIA_DGT            := enr.VIA_DGT__C;                                                                                                                                                                                                                                                                                                             &lt;br/&gt;        pLigneDetailFactu.VIA_GTR            := enr.VIA_GTR__C;                                                                                                                                                                                                                                                                                                             &lt;br/&gt;        pLigneDetailFactu.TERME_FACTU        := enr.TERME_FACTU__C;                                                                                                                                                                                                                                                                                                     &lt;br/&gt;        pLigneDetailFactu.MODE_FACTU         := enr.MODE_FACTU__C;                                                                                                                                                                                                                                                                                                       &lt;br/&gt;        pLigneDetailFactu.MONTANT            := TO_NUMBER(NULL); -- initialisation                                                                                                                                                                                                                                                                                          &lt;br/&gt;        pLigneDetailFactu.CONSOMMATION       := TO_NUMBER(NULL); -- initialisation                                                                                                                                                                                                                                                                                     &lt;br/&gt;        pLigneDetailFactu.COMMENTAIRE        := enr.COMMENTAIRE_FACTURATION__C;                                                                                                                                                                                                                                                                                         &lt;br/&gt;        pLigneDetailFactu.TARIF_FORFAIT      := TO_NUMBER(enr.TARIF_FORFAIT__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;);                                                                                                                                                                                                                                          &lt;br/&gt;        pLigneDetailFactu.SEUIL              := TO_NUMBER(enr.SEUIL__C);                                                                                                                                                                                                                                                                                                      &lt;br/&gt;        pLigneDetailFactu.TARIF_DEPASSEMENT  := TO_NUMBER(enr.TARIF_DEPASSEMENT__C,&apos;999999D99&apos;,&apos;NLS_NUMERIC_CHARACTERS=&apos;&apos;. &apos;&apos;&apos;);                                                                                                                                                                                                                                  &lt;br/&gt;        pLigneDetailFactu.MOTIF_RESIL        := enr.MOTIF_RESILIATION__C;                                                                                                                                                                                                                                                                                               &lt;br/&gt;        pLigneDetailFactu.MOTIF_MODIF        := enr.MOTIF_MODIF__C;                                                                                                                                                                                                                                                                                                     &lt;br/&gt;        pLigneDetailFactu.MAIL_DEST          := enr.MAILS_DEST_D_TAIL_FACTU__C;                                                                                                                                                                                                                                                                                         &lt;br/&gt;        pLigneDetailFactu.MAIL_CC            := enr.MAILS_COPIES_D_TAIL_FACTU__C;                                                                                                                                                                                                                                                                                         &lt;br/&gt;        pLigneDetailFactu.ANALYSE            := enr.ANALYSE_FACTU__C;                                                                                                                                                                                                                                                                                                       &lt;br/&gt;        pLigneDetailFactu.DETAIL_ANALYSE     := enr.DETAIL_ANALYSE__C;                                                                                                                                                                                                                                                                                               &lt;br/&gt;        pLigneDetailFactu.STATUT             := enr.STATUT__C;                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        pLigneDetailFactu.DATE_CALC_FACTU    := pDateCalcFactu;                                                                                                                                                                                                                                                                                                     &lt;br/&gt;        pLigneDetailFactu.ID_SALESFORCE      := enr.PDC_ID;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;        pLigneDetailFactu.LIBELLE            := NULL;                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;        pLigneDetailFactu.LIB_TYPE_PRESTA    := NULL;                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        pLigneDetailFactu.LIB_PERIODE_DEB    := NULL;                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        pLigneDetailFactu.LIB_PERIODE_FIN    := NULL;&lt;br/&gt;        pLigneDetailFactu.DATE_FIN_ENGAGEMENT:= enr.DATE_FIN_ENGAGEMENT__C;&lt;br/&gt;        pLigneDetailFactu.PROFIL             := enr.PROFIL__C;&lt;br/&gt;        pLigneDetailFactu.ADRESSE_1          := enr.ADRESSE_1__C;&lt;br/&gt;        pLigneDetailFactu.CP                 := enr.CP__C;&lt;br/&gt;		pLigneDetailFactu.TYPE_VENTE		 := enr.TYPE_VENTE__C;&lt;br/&gt;end P_InitialiserDetailFactu;                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;-- refactored                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;procedure P_DeterminerMoisInclus(codeRetour IN OUT INTEGER                                                                                                                                                                                                                                                                                                     &lt;br/&gt;   ,enr IN OUT T_FDSL_SERVICE_SF%ROWTYPE                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;   ,pLigneDetailFactu IN OUT T_FDSL_DETAIL_FACTURE%ROWTYPE                                                                                                                                                                                                                                                                                                     &lt;br/&gt;   ,vFacteur IN OUT NUMBER                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;   ,vMois IN  NUMBER                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;   ,vMoisInclus IN OUT BOOLEAN                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;   ,vTraitementLigne IN OUT BOOLEAN                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;   ) as                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;begin                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt; CASE UPPER(enr.FREQUENCE_FACTU__C)                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          WHEN &apos;MENSUELLE&apos; THEN                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;            vMoisInclus := TRUE;                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;            vFacteur := 1;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          WHEN &apos;TRIMESTRIELLE&apos; THEN                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;            vFacteur := 3;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;            IF vMois IN (1,4,7,10) THEN                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              vMoisInclus := TRUE;                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          WHEN &apos;SEMESTRIELLE&apos; THEN                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;            vFacteur := 6;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;            IF vMois IN (1,7) THEN                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;              vMoisInclus := TRUE;                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          WHEN &apos;ANNUELLE&apos; THEN                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;            vFacteur := 12;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;            IF vMois = 1 THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;              vMoisInclus := TRUE;                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          ELSE                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;            vTraitementLigne:=FALSE;                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;            pLigneDetailFactu.DETAIL_ANALYSE:=pLigneDetailFactu.DETAIL_ANALYSE||&apos;-Fréquence inconnue ou non renseignée&apos;;                                                                                                                                                                                                                                       &lt;br/&gt;            pLigneDetailFactu.ANALYSE:=&apos;true&apos;;                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;            --insertion de la ligne pour que l&apos;ADV analyse l&apos;erreur                                                                                                                                                                                                                                                                                            &lt;br/&gt;            codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                           &lt;br/&gt;            IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;              COMMIT;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            ELSE                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;              ROLLBACK;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;        END CASE;                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;end P_DeterminerMoisInclus;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;-- refactored                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;procedure P_FactureProrataTemporis(codeRetour IN OUT INTEGER                                                                                                                                                                                                                                                                                                   &lt;br/&gt;   ,enr IN OUT T_FDSL_SERVICE_SF%ROWTYPE                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;   ,pDateCalcFactu IN  Date                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;   ,pLigneDetailFactu IN OUT T_FDSL_DETAIL_FACTURE%ROWTYPE                                                                                                                                                                                                                                                                                                     &lt;br/&gt;   ,vFacteur IN OUT NUMBER                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;   ,vLibPeriodeDeb IN OUT T_FDSL_DETAIL_FACTURE.LIB_PERIODE_DEB%TYPE                                                                                                                                                                                                                                                                                           &lt;br/&gt;   ,vLibPeriodeDebProrata IN OUT T_FDSL_DETAIL_FACTURE.LIB_PERIODE_DEB%TYPE                                                                                                                                                                                                                                                                                    &lt;br/&gt;   ,vLibPeriodeFin IN OUT T_FDSL_DETAIL_FACTURE.LIB_PERIODE_FIN%TYPE                                                                                                                                                                                                                                                                                           &lt;br/&gt;   ,vLibPeriodeFinProrata IN OUT T_FDSL_DETAIL_FACTURE.LIB_PERIODE_FIN%TYPE                                                                                                                                                                                                                                                                                    &lt;br/&gt;   ,vLibTypePresta IN OUT T_FDSL_DETAIL_FACTURE.LIB_TYPE_PRESTA%TYPE                                                                                                                                                                                                                                                                                           &lt;br/&gt;   ,vLibTypePrestaProrata IN OUT T_FDSL_DETAIL_FACTURE.LIB_TYPE_PRESTA%TYPE                                                                                                                                                                                                                                                                                    &lt;br/&gt;   ,vLibelleProrata IN OUT T_FDSL_DETAIL_FACTURE.LIBELLE%TYPE                                                                                                                                                                                                                                                                                                  &lt;br/&gt;   ,vMoisInclus IN OUT BOOLEAN                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;   ,vMontant IN OUT T_FDSL_DETAIL_FACTURE.MONTANT%TYPE                                                                                                                                                                                                                                                                                                         &lt;br/&gt;   ,vMontantFAS IN OUT T_FDSL_DETAIL_FACTURE.MONTANT%TYPE                                                                                                                                                                                                                                                                                                      &lt;br/&gt;   ,vMontantProrata IN OUT T_FDSL_DETAIL_FACTURE.MONTANT%TYPE                                                                                                                                                                                                                                                                                                  &lt;br/&gt;   ,vMsg IN OUT T_FDSL_DETAIL_FACTURE.DETAIL_ANALYSE%TYPE     &lt;br/&gt;   ,vTestMotifModif IN OUT BOOLEAN     &lt;br/&gt;   ) as                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    vMontantLoc  T_FDSL_DETAIL_FACTURE.MONTANT%TYPE;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;    vMontantLocProrata  T_FDSL_DETAIL_FACTURE.MONTANT%TYPE;                                                                                                                                                                                                                                                                                                    &lt;br/&gt;begin                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;        -- Calcul de la location de modem                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;            codeRetour:=F_FactuAboProrata(enr,pDateCalcFactu,&apos;LOC&apos;,vMontantLoc,vMontantLocProrata,vLibelleProrata,vLibTypePrestaProrata,vLibPeriodeDebProrata,vLibPeriodeFinProrata,vFacteur,vMoisInclus);                                                                                                                                                     &lt;br/&gt;            IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;              IF (vMontantLoc IS NOT NULL and (vMontantLoc&lt;&gt; 0 or enr.DATE_RESIL__C is null)) THEN -- On enregistre si vMontant = 0 car informatif                                                                                                                                                                                                             &lt;br/&gt;                pLigneDetailFactu.MONTANT:=vMontantLoc;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                pLigneDetailFactu.TYPE_FACTU:=&apos;LOC&apos;;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIB_TYPE_PRESTA := &apos;Location&apos;;                                                                                                                                                                                                                                                                                               &lt;br/&gt;                IF UPPER(TRANSLATE(enr.TERME_FACTU__C,&apos;éà&apos;,&apos;ea&apos;)) = &apos;A ECHOIR&apos; THEN                                                                                                                                                                                                                                                                            &lt;br/&gt;                 CASE vFacteur                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  WHEN 1 THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(pDateCalcFactu,&apos;MONTH&apos;);                                                                                                                                                                                                                                                                        &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_FIN := TRUNC(ADD_MONTHS(pDateCalcFactu,1*vFacteur),&apos;MONTH&apos;)-1;                                                                                                                                                                                                                                               &lt;br/&gt;                  WHEN 3 THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                    -- Début à fin du trimestre actuel                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(pDateCalcFactu,&apos;Q&apos;);                                                                                                                                                                                                                                                                            &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_FIN :=(TRUNC(ADD_MONTHS(pDateCalcFactu,+3),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                          &lt;br/&gt;                  WHEN 6 THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                    -- Début à fin du semestre actuel                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                    IF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;1&apos;,&apos;3&apos;) THEN                                                                                                                                                                                                                                                                                           &lt;br/&gt;                      pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(pDateCalcFactu,&apos;Q&apos;);                                                                                                                                                                                                                                                                          &lt;br/&gt;                      pLigneDetailFactu.LIB_PERIODE_FIN :=(TRUNC(ADD_MONTHS(pDateCalcFactu,+6),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                        &lt;br/&gt;                    ELSIF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;2&apos;,&apos;4&apos;) THEN                                                                                                                                                                                                                                                                                        &lt;br/&gt;                      pLigneDetailFactu.LIB_PERIODE_DEB :=(TRUNC(ADD_MONTHS(pDateCalcFactu,-3),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                        &lt;br/&gt;                      pLigneDetailFactu.LIB_PERIODE_FIN :=(TRUNC(ADD_MONTHS(pDateCalcFactu,+3),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                        &lt;br/&gt;                    END IF;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                  WHEN 12 THEN                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  -- Début à fin de l&apos;année                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(pDateCalcFactu,&apos;YEAR&apos;);                                                                                                                                                                                                                                                                         &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_FIN :=(ADD_MONTHS(TRUNC(pDateCalcFactu,&apos;YEAR&apos;),+12)-1);                                                                                                                                                                                                                                                      &lt;br/&gt;                  END CASE;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                 -- pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(pDateCalcFactu,&apos;MONTH&apos;);                                                                                                                                                                                                                                                                        &lt;br/&gt;                  --pLigneDetailFactu.LIB_PERIODE_FIN := TRUNC(ADD_MONTHS(pDateCalcFactu,1*vFacteur),&apos;MONTH&apos;)-1;                                                                                                                                                                                                                                               &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(ADD_MONTHS(pDateCalcFactu,-1*vFacteur),&apos;MONTH&apos;);                                                                                                                                                                                                                                                  &lt;br/&gt;                  pLigneDetailFactu.LIB_PERIODE_FIN := TRUNC(ADD_MONTHS(ADD_MONTHS(pDateCalcFactu,-1*vFacteur),1*vFacteur),&apos;MONTH&apos;)-1;                                                                                                                                                                                                                         &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                pLigneDetailFactu.LIBELLE := pLigneDetailFactu.LIB_TYPE_PRESTA||&apos; (&apos;||enr.TERME_FACTU__C||&apos;) du &apos;||TO_CHAR(pLigneDetailFactu.LIB_PERIODE_DEB,&apos;DD/MM/YYYY&apos;)||&apos; au &apos;||TO_CHAR(pLigneDetailFactu.LIB_PERIODE_FIN,&apos;DD/MM/YYYY&apos;);                                                                                                                   &lt;br/&gt;                --insertion de la ligne                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                       &lt;br/&gt;                IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  COMMIT;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  ROLLBACK;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              IF (vMontantLocProrata IS NOT NULL and (vMontantLocProrata&lt;&gt; 0 or enr.DATE_RESIL__C is null)) THEN -- On enregistre si vMontant = 0 car informatif                                                                                                                                                                                               &lt;br/&gt;                pLigneDetailFactu.MONTANT:=vMontantLocProrata;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                pLigneDetailFactu.TYPE_FACTU:=&apos;LOC PRORATA&apos;;                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                pLigneDetailFactu.LIBELLE:=&apos;Location - &apos;||vLibelleProrata;                                                                                                                                                                                                                                                                                     &lt;br/&gt;                pLigneDetailFactu.LIB_TYPE_PRESTA := vLibTypePrestaProrata;                                                                                                                                                                                                                                                                                    &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_DEB := vLibPeriodeDebProrata;                                                                                                                                                                                                                                                                                    &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_FIN := vLibPeriodeFinProrata;                                                                                                                                                                                                                                                                                    &lt;br/&gt;                --insertion de la ligne                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                       &lt;br/&gt;                IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  COMMIT;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  ROLLBACK;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;             -- Calcul de l&apos;abonnement mensuel                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;            codeRetour:=F_FactuAboProrata(enr,pDateCalcFactu,&apos;ABO&apos;,vMontant,vMontantProrata,vLibelleProrata,vLibTypePrestaProrata,vLibPeriodeDebProrata,vLibPeriodeFinProrata,vFacteur,vMoisInclus);                                                                                                                                                           &lt;br/&gt;            IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;              IF vMontant IS NOT NULL THEN -- On enregistre si vMontant = 0 car informatif                                                                                                                                                                                                                                                                     &lt;br/&gt;                pLigneDetailFactu.MONTANT:=vMontant;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.TYPE_FACTU:=&apos;ABO&apos;;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIB_TYPE_PRESTA := &apos;Abonnements&apos;;                                                                                                                                                                                                                                                                                            &lt;br/&gt;                IF UPPER(TRANSLATE(enr.TERME_FACTU__C,&apos;éà&apos;,&apos;ea&apos;)) = &apos;A ECHOIR&apos; THEN                                                                                                                                                                                                                                                                            &lt;br/&gt;                 CASE vFacteur                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  WHEN 1 THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(pDateCalcFactu,&apos;MONTH&apos;);                                                                                                                                                                                                                                                                        &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_FIN := TRUNC(ADD_MONTHS(pDateCalcFactu,1*vFacteur),&apos;MONTH&apos;)-1;                                                                                                                                                                                                                                               &lt;br/&gt;                  WHEN 3 THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                    -- Début à fin du trimestre actuel                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(pDateCalcFactu,&apos;Q&apos;);                                                                                                                                                                                                                                                                            &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_FIN :=(TRUNC(ADD_MONTHS(pDateCalcFactu,+3),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                          &lt;br/&gt;                  WHEN 6 THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                    -- Début à fin du semestre actuel                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                    IF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;1&apos;,&apos;3&apos;) THEN                                                                                                                                                                                                                                                                                           &lt;br/&gt;                      pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(pDateCalcFactu,&apos;Q&apos;);                                                                                                                                                                                                                                                                          &lt;br/&gt;                      pLigneDetailFactu.LIB_PERIODE_FIN :=(TRUNC(ADD_MONTHS(pDateCalcFactu,+6),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                        &lt;br/&gt;                    ELSIF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;2&apos;,&apos;4&apos;) THEN                                                                                                                                                                                                                                                                                        &lt;br/&gt;                      pLigneDetailFactu.LIB_PERIODE_DEB :=(TRUNC(ADD_MONTHS(pDateCalcFactu,-3),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                        &lt;br/&gt;                      pLigneDetailFactu.LIB_PERIODE_FIN :=(TRUNC(ADD_MONTHS(pDateCalcFactu,+3),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                        &lt;br/&gt;                    END IF;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                  WHEN 12 THEN                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  -- Début à fin de l&apos;année                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(pDateCalcFactu,&apos;YEAR&apos;);                                                                                                                                                                                                                                                                         &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_FIN :=(ADD_MONTHS(TRUNC(pDateCalcFactu,&apos;YEAR&apos;),+12)-1);                                                                                                                                                                                                                                                      &lt;br/&gt;                  END CASE;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                 -- pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(pDateCalcFactu,&apos;MONTH&apos;);                                                                                                                                                                                                                                                                        &lt;br/&gt;                  --pLigneDetailFactu.LIB_PERIODE_FIN := TRUNC(ADD_MONTHS(pDateCalcFactu,1*vFacteur),&apos;MONTH&apos;)-1;                                                                                                                                                                                                                                               &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(ADD_MONTHS(pDateCalcFactu,-1*vFacteur),&apos;MONTH&apos;);                                                                                                                                                                                                                                                  &lt;br/&gt;                  pLigneDetailFactu.LIB_PERIODE_FIN := TRUNC(ADD_MONTHS(ADD_MONTHS(pDateCalcFactu,-1*vFacteur),1*vFacteur),&apos;MONTH&apos;)-1;                                                                                                                                                                                                                         &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                pLigneDetailFactu.LIBELLE := pLigneDetailFactu.LIB_TYPE_PRESTA||&apos; (&apos;||enr.TERME_FACTU__C||&apos;) du &apos;||TO_CHAR(pLigneDetailFactu.LIB_PERIODE_DEB,&apos;DD/MM/YYYY&apos;)||&apos; au &apos;||TO_CHAR(pLigneDetailFactu.LIB_PERIODE_FIN,&apos;DD/MM/YYYY&apos;);                                                                                                                   &lt;br/&gt;                --insertion de la ligne                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                       &lt;br/&gt;                IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  COMMIT;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  ROLLBACK;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              IF vMontantProrata IS NOT NULL THEN -- On enregistre si vMontant = 0 car informatif                                                                                                                                                                                                                                                              &lt;br/&gt;                pLigneDetailFactu.MONTANT:=vMontantProrata;                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                pLigneDetailFactu.TYPE_FACTU:=&apos;PRORATA&apos;;                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                pLigneDetailFactu.LIBELLE:=vLibelleProrata;                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                pLigneDetailFactu.LIB_TYPE_PRESTA := vLibTypePrestaProrata;                                                                                                                                                                                                                                                                                    &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_DEB := vLibPeriodeDebProrata;                                                                                                                                                                                                                                                                                    &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_FIN := vLibPeriodeFinProrata;                                                                                                                                                                                                                                                                                    &lt;br/&gt;                --insertion de la ligne                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                       &lt;br/&gt;                IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  COMMIT;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  ROLLBACK;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;            vLibTypePresta:=&apos;&apos;;                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;            -- Calcul des résil                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;            codeRetour:=F_FactuResilProrata(enr,pDateCalcFactu,vMontant,vMontantLoc,vMontantFAS,vFacteur,vMoisInclus,vLibTypePresta,vLibPeriodeDeb,vLibPeriodeFin,vMsg);                                                                                                                                                                                       &lt;br/&gt;            IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                pLigneDetailFactu.MONTANT:=vMontant;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.TYPE_FACTU:=&apos;RESIL&apos;;                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                pLigneDetailFactu.LIB_TYPE_PRESTA := vLibTypePresta;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_DEB := vLibPeriodeDeb;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_FIN := vLibPeriodeFin;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIBELLE:= vLibTypePresta||&apos; du &apos;||TO_CHAR(vLibPeriodeDeb,&apos;DD/MM/YYYY&apos;)||&apos; au &apos;||TO_CHAR(vLibPeriodeFin,&apos;DD/MM/YYYY&apos;);                                                                                                                                                                                                        &lt;br/&gt;                pLigneDetailFactu.DETAIL_ANALYSE := pLigneDetailFactu.DETAIL_ANALYSE||&apos;-&apos;||vMsg;                                                                                                                                                                                                                                                               &lt;br/&gt;                --insertion de la ligne                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                       &lt;br/&gt;                IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  COMMIT;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  ROLLBACK;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              IF vMontantFAS IS NOT NULL AND vMontantFAS &lt;&gt; 0 THEN -- On n&apos;enregistre pas si vMontantFAS = 0, inutile dans ce cas                                                                                                                                                                                                                              &lt;br/&gt;                pLigneDetailFactu.MONTANT:=vMontantFAS;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                pLigneDetailFactu.TYPE_FACTU:=&apos;FAS&apos;;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIBELLE:=&apos;FAS de résiliation&apos;;                                                                                                                                                                                                                                                                                               &lt;br/&gt;                pLigneDetailFactu.LIB_TYPE_PRESTA:= pLigneDetailFactu.LIBELLE;&lt;br/&gt;				--hle : ne pas remplir LIB_PERIODE_DEB et LIB_PERIODE_FIN dans le cas FAS de résiliation&lt;br/&gt;                PLIGNEDETAILFACTU.LIB_PERIODE_DEB := &apos;&apos;;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_FIN := &apos;&apos;;&lt;br/&gt;                --insertion de la ligne                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                       &lt;br/&gt;                IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  COMMIT;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  ROLLBACK;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                IF (vMontantLoc IS NOT NULL and (vMontantLoc&lt;&gt; 0 or enr.DATE_RESIL__C is null)) THEN -- On enregistre si vMontant = 0 car informatif                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.MONTANT:=vMontantLoc;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                pLigneDetailFactu.TYPE_FACTU:=&apos;LOC RESIL&apos;;                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                pLigneDetailFactu.LIB_TYPE_PRESTA := &apos;Location - &apos;||vLibTypePresta;                                                                                                                                                                                                                                                                            &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_DEB := vLibPeriodeDeb;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_FIN := vLibPeriodeFin;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIBELLE:= vLibTypePresta||&apos; du &apos;||TO_CHAR(vLibPeriodeDeb,&apos;DD/MM/YYYY&apos;)||&apos; au &apos;||TO_CHAR(vLibPeriodeFin,&apos;DD/MM/YYYY&apos;);                                                                                                                                                                                                        &lt;br/&gt;                --pLigneDetailFactu.DETAIL_ANALYSE := pLigneDetailFactu.DETAIL_ANALYSE||&apos;-&apos;||vMsg;                                                                                                                                                                                                                                                             &lt;br/&gt;                --insertion de la ligne                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                       &lt;br/&gt;                IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  COMMIT;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  ROLLBACK;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            ELSIF codeRetour = 2 THEN                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              -- On enregistre le problème survenu                                                                                                                                                                                                                                                                                                             &lt;br/&gt;              pLigneDetailFactu.TYPE_FACTU:=&apos;RESIL&apos;;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;              pLigneDetailFactu.LIBELLE:=&apos;Resiliations&apos;;                                                                                                                                                                                                                                                                                                       &lt;br/&gt;              pLigneDetailFactu.LIB_TYPE_PRESTA:= pLigneDetailFactu.LIBELLE;                                                                                                                                                                                                                                                                                   &lt;br/&gt;              pLigneDetailFactu.DETAIL_ANALYSE := pLigneDetailFactu.DETAIL_ANALYSE||&apos;-&apos;||vMsg;                                                                                                                                                                                                                                                                 &lt;br/&gt;              pLigneDetailFactu.ANALYSE := &apos;true&apos;; -- on force l&apos;analyse pour une vérification par l&apos;ADV                                                                                                                                                                                                                                                       &lt;br/&gt;              pLigneDetailFactu.MONTANT := 0;                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;              --insertion de la ligne                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  --insertion de la ligne                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;              pLigneDetailFactu.TYPE_FACTU:=&apos;LOC RESIL&apos;;                                                                                                                                                                                                                                                                                                       &lt;br/&gt;              pLigneDetailFactu.LIBELLE:=&apos;Location - Resiliations&apos;;                                                                                                                                                                                                                                                                                            &lt;br/&gt;              codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                         &lt;br/&gt;              IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                COMMIT;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              ELSE                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                ROLLBACK;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;            -- Calcul Up/Downgrade ABO                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;            codeRetour:=F_UpDownProrata(enr,pDateCalcFactu,&apos;ABO&apos;,vMontant,vMontantFAS,vFacteur,vMoisInclus,vLibPeriodeDeb,vLibPeriodeFin,vMsg,vTestMotifModif);                                                                                                                                                                                                                &lt;br/&gt;            IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;              IF vMontant IS NOT NULL THEN -- On enregistre si vMontant = 0 car informatif                                                                                                                                                                                                                                                                     &lt;br/&gt;                pLigneDetailFactu.MONTANT:=vMontant;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.TYPE_FACTU:=&apos;PRORATA&apos;;                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                pLigneDetailFactu.LIB_TYPE_PRESTA:=&apos;Régularisation suite à &apos;||pLigneDetailFactu.MOTIF_MODIF;                                                                                                                                                                                                                                                   &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_DEB := vLibPeriodeDeb;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_FIN := vLibPeriodeFin;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIBELLE:= pLigneDetailFactu.LIB_TYPE_PRESTA||&apos; du &apos;||TO_CHAR(vLibPeriodeDeb,&apos;DD/MM/YYYY&apos;)||&apos; au &apos;||TO_CHAR(vLibPeriodeFin,&apos;DD/MM/YYYY&apos;);                                                                                                                                                                                     &lt;br/&gt;                pLigneDetailFactu.DETAIL_ANALYSE := pLigneDetailFactu.DETAIL_ANALYSE||&apos;-&apos;||vMsg;                                                                                                                                                                                                                                                               &lt;br/&gt;                --insertion de la ligne                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                       &lt;br/&gt;                IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  COMMIT;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  ROLLBACK;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;              IF vMontantFAS IS NOT NULL AND vMontantFAS &lt;&gt; 0 THEN -- On n&apos;enregistre pas si vMontantFAS = 0, inutile dans ce cas                                                                                                                                                                                                                              &lt;br/&gt;                pLigneDetailFactu.MONTANT:=vMontantFAS;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                pLigneDetailFactu.TYPE_FACTU:=&apos;FAS&apos;;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIBELLE:=&apos;FAS de migration&apos;;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                pLigneDetailFactu.LIB_TYPE_PRESTA:= pLigneDetailFactu.LIBELLE;&lt;br/&gt;				--hle : ne pas remplir LIB_PERIODE_DEB et LIB_PERIODE_FIN dans le cas FAS de migration&lt;br/&gt;                PLIGNEDETAILFACTU.LIB_PERIODE_DEB := &apos;&apos;;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_FIN := &apos;&apos;;&lt;br/&gt;                --insertion de la ligne                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                       &lt;br/&gt;                IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  COMMIT;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  ROLLBACK;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            ELSIF codeRetour = 2 THEN                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              -- On enregistre le problème survenu                                                                                                                                                                                                                                                                                                             &lt;br/&gt;              pLigneDetailFactu.TYPE_FACTU:=&apos;PRORATA&apos;;                                                                                                                                                                                                                                                                                                         &lt;br/&gt;              pLigneDetailFactu.LIBELLE:=&apos;Régularisation suite à &apos;||pLigneDetailFactu.MOTIF_MODIF;                                                                                                                                                                                                                                                             &lt;br/&gt;              pLigneDetailFactu.LIB_TYPE_PRESTA:= pLigneDetailFactu.LIBELLE;                                                                                                                                                                                                                                                                                   &lt;br/&gt;              pLigneDetailFactu.DETAIL_ANALYSE := pLigneDetailFactu.DETAIL_ANALYSE||&apos;-&apos;||vMsg;                                                                                                                                                                                                                                                                 &lt;br/&gt;              pLigneDetailFactu.ANALYSE := &apos;true&apos;; -- on force l&apos;analyse pour une vérification par l&apos;ADV                                                                                                                                                                                                                                                       &lt;br/&gt;              pLigneDetailFactu.MONTANT := 0;                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;              --insertion de la ligne                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;              IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                COMMIT;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              ELSE                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                ROLLBACK;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;              -- Calcul Up/Downgrade LOC                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;            codeRetour:=F_UpDownProrata(enr,pDateCalcFactu,&apos;LOC&apos;,vmontantloc,vMontantFAS,vFacteur,vMoisInclus,vLibPeriodeDeb,vLibPeriodeFin,vMsg,vTestMotifModif);                                                                                                                                                                                                             &lt;br/&gt;            IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;              IF (vMontantLoc IS NOT NULL and (vMontantLoc&lt;&gt; 0 or enr.DATE_RESIL__C is null)) THEN -- On enregistre si vMontant = 0 car informatif                                                                                                                                                                                                             &lt;br/&gt;                pLigneDetailFactu.MONTANT:=vMontantLoc;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                pLigneDetailFactu.TYPE_FACTU:=&apos;LOC PRORATA&apos;;                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                pLigneDetailFactu.LIB_TYPE_PRESTA:=&apos;Régularisation suite à &apos;||pLigneDetailFactu.MOTIF_MODIF;                                                                                                                                                                                                                                                   &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_DEB := vLibPeriodeDeb;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_FIN := vLibPeriodeFin;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIBELLE:= &apos;Location - &apos; ||pLigneDetailFactu.LIB_TYPE_PRESTA||&apos; du &apos;||TO_CHAR(vLibPeriodeDeb,&apos;DD/MM/YYYY&apos;)||&apos; au &apos;||TO_CHAR(vLibPeriodeFin,&apos;DD/MM/YYYY&apos;);                                                                                                                                                                     &lt;br/&gt;                pLigneDetailFactu.DETAIL_ANALYSE := pLigneDetailFactu.DETAIL_ANALYSE||&apos;-&apos;||vMsg;                                                                                                                                                                                                                                                               &lt;br/&gt;                --insertion de la ligne                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                       &lt;br/&gt;                IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  COMMIT;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  ROLLBACK;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;            ELSIF codeRetour = 2 THEN                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              -- On enregistre le problème survenu                                                                                                                                                                                                                                                                                                             &lt;br/&gt;              pLigneDetailFactu.TYPE_FACTU:=&apos;LOC PRORATA&apos;;                                                                                                                                                                                                                                                                                                     &lt;br/&gt;              pLigneDetailFactu.LIBELLE:=&apos;Régularisation suite à &apos;||pLigneDetailFactu.MOTIF_MODIF;                                                                                                                                                                                                                                                             &lt;br/&gt;              pLigneDetailFactu.LIBELLE:= &apos;Location - &apos; ||pLigneDetailFactu.LIBELLE;                                                                                                                                                                                                                                                                           &lt;br/&gt;              pLigneDetailFactu.LIB_TYPE_PRESTA:= pLigneDetailFactu.LIBELLE;                                                                                                                                                                                                                                                                                   &lt;br/&gt;              pLigneDetailFactu.DETAIL_ANALYSE := pLigneDetailFactu.DETAIL_ANALYSE||&apos;-&apos;||vMsg;                                                                                                                                                                                                                                                                 &lt;br/&gt;              pLigneDetailFactu.ANALYSE := &apos;true&apos;; -- on force l&apos;analyse pour une vérification par l&apos;ADV                                                                                                                                                                                                                                                       &lt;br/&gt;              pLigneDetailFactu.MONTANT := 0;                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;              --insertion de la ligne                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;              IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                COMMIT;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              ELSE                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                ROLLBACK;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;end P_FactureProrataTemporis;                                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;-- Lecture des données de la table T_FDSL_SERVICE_SF pour alimentation dans T_FDSL_DETAIL_FACTURE                                                                                                                                                                                                                                                              &lt;br/&gt;PROCEDURE P_InsertDetailFactu (pDateCalcFactu IN DATE) IS                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;CURSOR C_SERVICES IS                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;SELECT *                                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;FROM                                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;    T_FDSL_SERVICE_SF                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;;                                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;pLigneDetailFactu T_FDSL_DETAIL_FACTURE%ROWTYPE;                                                                                                                                                                                                                                                                                                               &lt;br/&gt;vMontant              T_FDSL_DETAIL_FACTURE.MONTANT%TYPE;&lt;br/&gt;/*ontantLoc           T_FDSL_DETAIL_FACTURE.MONTANT%TYP*/&lt;br/&gt;vMontantFAS           T_FDSL_DETAIL_FACTURE.MONTANT%TYPE;&lt;br/&gt;vMontantPFRO          T_FDSL_DETAIL_FACTURE.MONTANT%TYPE;&lt;br/&gt;vMontantIRU           T_FDSL_DETAIL_FACTURE.MONTANT%TYPE;&lt;br/&gt;vMontantProrata       T_FDSL_DETAIL_FACTURE.MONTANT%TYPE;&lt;br/&gt;vLibelleProrata       T_FDSL_DETAIL_FACTURE.LIBELLE%TYPE;&lt;br/&gt;vLibTypePrestaProrata T_FDSL_DETAIL_FACTURE.LIB_TYPE_PRESTA%TYPE;&lt;br/&gt;vLibPeriodeDebProrata T_FDSL_DETAIL_FACTURE.LIB_PERIODE_DEB%TYPE;&lt;br/&gt;vLibPeriodeFinProrata T_FDSL_DETAIL_FACTURE.LIB_PERIODE_FIN%TYPE;&lt;br/&gt;vLibTypePresta        T_FDSL_DETAIL_FACTURE.LIB_TYPE_PRESTA%TYPE;&lt;br/&gt;vLibPeriodeDeb        T_FDSL_DETAIL_FACTURE.LIB_PERIODE_DEB%TYPE;&lt;br/&gt;vLibPeriodeFin        T_FDSL_DETAIL_FACTURE.LIB_PERIODE_FIN%TYPE;&lt;br/&gt;vType                 T_FDSL_DETAIL_FACTURE.TYPE_FACTU%TYPE;&lt;br/&gt;vTypeProrata          T_FDSL_DETAIL_FACTURE.TYPE_FACTU%TYPE;&lt;br/&gt;vMsg                  T_FDSL_DETAIL_FACTURE.DETAIL_ANALYSE%TYPE := NULL;&lt;br/&gt;vMoisInclus           BOOLEAN := FALSE; -- Défini si le mois de facturation en cours est compris dans la période définie (en fonction de la fréquence)&lt;br/&gt;vFacteur              NUMBER:=1;&lt;br/&gt;vTraitementLigne      BOOLEAN:=TRUE;&lt;br/&gt;codeRetour            INTEGER:=1;&lt;br/&gt;vEnrExists            NUMBER:=0;&lt;br/&gt;vMois                 NUMBER(2);&lt;br/&gt;vAnnee                NUMBER(4);&lt;br/&gt;&lt;br/&gt;vliste_motifs_configures VARCHAR2(2000);&lt;br/&gt;CURSOR motif_modification&lt;br/&gt;IS&lt;br/&gt;SELECT MOTIF_MODIF__C FROM T_FDSL_CONF_MOTIFS_MODIF;&lt;br/&gt;&lt;br/&gt;vTestMotifModif      BOOLEAN:=FALSE;&lt;br/&gt;&lt;br/&gt;BEGIN&lt;br/&gt;&lt;br/&gt;  vMois := EXTRACT(MONTH FROM pDateCalcFactu);&lt;br/&gt;  vAnnee := EXTRACT(YEAR FROM pDateCalcFactu);&lt;br/&gt;    &lt;br/&gt;	--RWA  recuperation de l&apos; ensemble des motifs de modication depuis la table de config &lt;br/&gt;	BEGIN&lt;br/&gt;	  FOR c IN motif_modification&lt;br/&gt;	  loop&lt;br/&gt;		vliste_motifs_configures:=vliste_motifs_configures||&apos;,&apos;||upper(c.MOTIF_MODIF__C);&lt;br/&gt;	  end loop;&lt;br/&gt;	   vliste_motifs_configures:=ltrim(vliste_motifs_configures,&apos;,&apos;);&lt;br/&gt;	END;	&lt;br/&gt;	&lt;br/&gt;  -- Vérification des enregistrements présents dans la table                                                                                                                                                                                                                                                                                                   &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    SELECT COUNT(1)                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;    INTO vEnrExists                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;    FROM                                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;        T_FDSL_DETAIL_FACTURE                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;    ;                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;    EXCEPTION                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;      WHEN NO_DATA_FOUND THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;        vEnrExists:=0;                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;      WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;        vEnrExists:=-1;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    END;                                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;    -- S&apos;il existe une erreur on sort                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;    IF vEnrExists = -1 THEN                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;      RAISE_APPLICATION_ERROR(-20011,&apos;Un problème est survenu lors de l&apos;&apos;alimentation de la table T_FDSL_DETAIL_FACTURE&apos;||SQLERRM);                                                                                                                                                                                                                            &lt;br/&gt;    END IF;                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    -- S&apos;il existe des enregistrements dans la table des détails, on sort, les données doivent être archivées par un autre traitement au préalable et la table vidée par ce même traitement                                                                                                                                                                    &lt;br/&gt;    IF vEnrExists = 0 THEN                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;      FOR enr IN C_SERVICES LOOP                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- Initialisation des données de la ligne à enregistrer                                                                                                                                                                                                                                                                                                &lt;br/&gt;    P_InitialiserDetailFactu(enr=&gt;enr                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;   ,pDateCalcFactu=&gt;pDateCalcFactu                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;   ,pLigneDetailFactu=&gt;pLigneDetailFactu                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;   ,vAnnee=&gt;vAnnee                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;   ,vMois=&gt;vMois                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;   );                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- Réinitialisation de la variable de traitement de la ligne                                                                                                                                                                                                                                                                                           &lt;br/&gt;        vTraitementLigne:=TRUE;                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        -- Cas des fréquences, permet le calcul ou non et affecte la variable de calcul                                                                                                                                                                                                                                                                        &lt;br/&gt;        vMoisInclus := FALSE;                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;               P_DeterminerMoisInclus(codeRetour=&gt;codeRetour                                                                                                                                                                                                                                                                                                   &lt;br/&gt;   ,enr=&gt;enr                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;   ,pLigneDetailFactu=&gt;pLigneDetailFactu                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;   ,vFacteur=&gt;vFacteur                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;   ,vMois=&gt;vMois                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;   ,vMoisInclus=&gt;vMoisInclus                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;   ,vTraitementLigne=&gt;vTraitementLigne                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;   );      &lt;br/&gt;&lt;br/&gt;		vTestMotifModif      :=FALSE;&lt;br/&gt;        IF instr(vliste_motifs_configures,upper(enr.MOTIF_MODIF__C))&gt;0 THEN     &lt;br/&gt;			vTestMotifModif      :=TRUE;&lt;br/&gt;		END IF;		  &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;        IF vTraitementLigne THEN                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          -- Calcul des FAS/PFRO/IRU -&gt; Identique dans tous les cas de figure                                                                                                                                                                                                                                                                                  &lt;br/&gt;          codeRetour:=F_FactuFASPFROIRU(enr,pDateCalcFactu,vMontantFAS,vMontantPFRO,vMontantIRU);                                                                                                                                                                                                                                                              &lt;br/&gt;          IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;            -- Les FAS                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;            IF vMontantFAS IS NOT NULL THEN                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;              pLigneDetailFactu.MONTANT:=vMontantFAS;                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              pLigneDetailFactu.TYPE_FACTU:=&apos;FAS&apos;;                                                                                                                                                                                                                                                                                                             &lt;br/&gt;              pLigneDetailFactu.LIBELLE:=&apos;FAS nouvelles lignes&apos;;                                                                                                                                                                                                                                                                                               &lt;br/&gt;              pLigneDetailFactu.LIB_TYPE_PRESTA:= pLigneDetailFactu.LIBELLE;                                                                                                                                                                                                                                                                                   &lt;br/&gt;              --insertion de la ligne                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                         &lt;br/&gt;              IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                COMMIT;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              ELSE                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                ROLLBACK;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;            -- les PFRO                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;            IF (vMontantPFRO IS NOT NULL and vMontantPFRO &lt;&gt; 0)  THEN                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;              pLigneDetailFactu.MONTANT:=vMontantPFRO;                                                                                                                                                                                                                                                                                                         &lt;br/&gt;              pLigneDetailFactu.TYPE_FACTU:=&apos;PFRO&apos;;                                                                                                                                                                                                                                                                                                            &lt;br/&gt;              pLigneDetailFactu.LIBELLE:=&apos;PFRO nouvelles lignes&apos;;                                                                                                                                                                                                                                                                                              &lt;br/&gt;              pLigneDetailFactu.LIB_TYPE_PRESTA:= pLigneDetailFactu.LIBELLE;                                                                                                                                                                                                                                                                                   &lt;br/&gt;              --insertion de la ligne                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                         &lt;br/&gt;              IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                COMMIT;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              ELSE                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                ROLLBACK;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;            -- Les IRU                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;            IF (vMontantIRU IS NOT NULL AND vMontantIRU &lt;&gt; 0) THEN                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;              pLigneDetailFactu.MONTANT:=vMontantIRU;                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              pLigneDetailFactu.TYPE_FACTU:=&apos;IRU&apos;;                                                                                                                                                                                                                                                                                                             &lt;br/&gt;              pLigneDetailFactu.LIBELLE:=&apos;IRU nouvelles lignes&apos;;                                                                                                                                                                                                                                                                                               &lt;br/&gt;              pLigneDetailFactu.LIB_TYPE_PRESTA:= pLigneDetailFactu.LIBELLE;                                                                                                                                                                                                                                                                                   &lt;br/&gt;              --insertion de la ligne                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                         &lt;br/&gt;              IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                COMMIT;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              ELSE                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                ROLLBACK;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          END IF;                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          -- On réinitialise vMontantFAS car utilisé pour les résiliations par la suite                                                                                                                                                                                                                                                                        &lt;br/&gt;          vMontantFAS:=NULL;                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          IF UPPER(enr.TECHNO__C) = &apos;ADSL&apos; THEN                                                                                                                                                                                                                                                                                                                &lt;br/&gt;            -- Calcul de l&apos;abonnement                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            codeRetour:=F_FactuAbo(enr,pDateCalcFactu,vMontant,vMontantProrata,vLibelleProrata,vLibTypePrestaProrata,vLibPeriodeDebProrata,vLibPeriodeFinProrata,vFacteur,vMoisInclus);                                                                                                                                                                        &lt;br/&gt;            IF codeRetour = 0 THEN -- On enregistre si vMontant = 0 car informatif                                                                                                                                                                                                                                                                             &lt;br/&gt;              IF vMontant IS NOT NULL THEN                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                pLigneDetailFactu.MONTANT:=vMontant;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.TYPE_FACTU:=&apos;ABO&apos;;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIB_TYPE_PRESTA := &apos;Abonnements&apos;;                                                                                                                                                                                                                                                                                            &lt;br/&gt;                IF UPPER(TRANSLATE(enr.TERME_FACTU__C,&apos;éà&apos;,&apos;ea&apos;)) = &apos;A ECHOIR&apos; THEN                                                                                                                                                                                                                                                                            &lt;br/&gt;                 CASE vFacteur                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  WHEN 1 THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(pDateCalcFactu,&apos;MONTH&apos;);                                                                                                                                                                                                                                                                        &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_FIN := TRUNC(ADD_MONTHS(pDateCalcFactu,1*vFacteur),&apos;MONTH&apos;)-1;                                                                                                                                                                                                                                               &lt;br/&gt;                  WHEN 3 THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                    -- Début à fin du trimestre actuel                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(pDateCalcFactu,&apos;Q&apos;);                                                                                                                                                                                                                                                                            &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_FIN :=(TRUNC(ADD_MONTHS(pDateCalcFactu,+3),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                          &lt;br/&gt;                  WHEN 6 THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                    -- Début à fin du semestre actuel                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                    IF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;1&apos;,&apos;3&apos;) THEN                                                                                                                                                                                                                                                                                           &lt;br/&gt;                      pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(pDateCalcFactu,&apos;Q&apos;);                                                                                                                                                                                                                                                                          &lt;br/&gt;                      pLigneDetailFactu.LIB_PERIODE_FIN :=(TRUNC(ADD_MONTHS(pDateCalcFactu,+6),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                        &lt;br/&gt;                    ELSIF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;2&apos;,&apos;4&apos;) THEN                                                                                                                                                                                                                                                                                        &lt;br/&gt;                      pLigneDetailFactu.LIB_PERIODE_DEB :=TRUNC(ADD_MONTHS(pDateCalcFactu,-3),&apos;Q&apos;);                                                                                                                                                                                                                                                            &lt;br/&gt;                      pLigneDetailFactu.LIB_PERIODE_FIN :=(TRUNC(ADD_MONTHS(pDateCalcFactu,+3),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                        &lt;br/&gt;                    END IF;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                  WHEN 12 THEN                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  -- Début à fin de l&apos;année                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(pDateCalcFactu,&apos;YEAR&apos;);                                                                                                                                                                                                                                                                         &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_FIN :=(ADD_MONTHS(TRUNC(pDateCalcFactu,&apos;YEAR&apos;),+12)-1);                                                                                                                                                                                                                                                      &lt;br/&gt;                  END CASE;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                 -- pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(pDateCalcFactu,&apos;MONTH&apos;);                                                                                                                                                                                                                                                                        &lt;br/&gt;                 -- pLigneDetailFactu.LIB_PERIODE_FIN := TRUNC(ADD_MONTHS(pDateCalcFactu,1*vFacteur),&apos;MONTH&apos;)-1;                                                                                                                                                                                                                                               &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(ADD_MONTHS(pDateCalcFactu,-1*vFacteur),&apos;MONTH&apos;);                                                                                                                                                                                                                                                  &lt;br/&gt;                  pLigneDetailFactu.LIB_PERIODE_FIN := TRUNC(ADD_MONTHS(ADD_MONTHS(pDateCalcFactu,-1*vFacteur),1*vFacteur),&apos;MONTH&apos;)-1;                                                                                                                                                                                                                         &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                pLigneDetailFactu.LIBELLE := pLigneDetailFactu.LIB_TYPE_PRESTA||&apos; (&apos;||enr.TERME_FACTU__C||&apos;) du &apos;||TO_CHAR(pLigneDetailFactu.LIB_PERIODE_DEB,&apos;DD/MM/YYYY&apos;)||&apos; au &apos;||TO_CHAR(pLigneDetailFactu.LIB_PERIODE_FIN,&apos;DD/MM/YYYY&apos;);                                                                                                                   &lt;br/&gt;                --insertion de la ligne                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                       &lt;br/&gt;                IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  COMMIT;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  ROLLBACK;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              IF vMontantProrata IS NOT NULL THEN -- On enregistre si vMontantProrata = 0 car informatif                                                                                                                                                                                                                                                       &lt;br/&gt;                pLigneDetailFactu.MONTANT:=vMontantProrata;                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                pLigneDetailFactu.TYPE_FACTU:=&apos;PRORATA&apos;;                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                pLigneDetailFactu.LIBELLE:=vLibelleProrata;                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                pLigneDetailFactu.LIB_TYPE_PRESTA := vLibTypePrestaProrata;                                                                                                                                                                                                                                                                                    &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_DEB := vLibPeriodeDebProrata;                                                                                                                                                                                                                                                                                    &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_FIN := vLibPeriodeFinProrata;                                                                                                                                                                                                                                                                                    &lt;br/&gt;                --insertion de la ligne                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                       &lt;br/&gt;                IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  COMMIT;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  ROLLBACK;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;            -- Calcul des résil                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;            codeRetour:=F_FactuResil(enr,pDateCalcFactu,vMontant,vMontantFAS,vFacteur,vMoisInclus,vLibTypePresta,vLibPeriodeDeb,vLibPeriodeFin,vMsg);                                                                                                                                                                                                          &lt;br/&gt;            IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;              IF vMontant IS NOT NULL THEN -- On enregistre si vMontant = 0 car informatif                                                                                                                                                                                                                                                                     &lt;br/&gt;                pLigneDetailFactu.MONTANT:=vMontant;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.TYPE_FACTU:=&apos;RESIL&apos;;                                                                                                                                                                                                                                                                                                         &lt;br/&gt;--                pLigneDetailFactu.LIBELLE:=&apos;Resiliations : Montants restants dus&apos;;                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIB_TYPE_PRESTA := vLibTypePresta;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_DEB := vLibPeriodeDeb;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_FIN := vLibPeriodeFin;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIBELLE:= vLibTypePresta||&apos; du &apos;||TO_CHAR(vLibPeriodeDeb,&apos;DD/MM/YYYY&apos;)||&apos; au &apos;||TO_CHAR(vLibPeriodeFin,&apos;DD/MM/YYYY&apos;);                                                                                                                                                                                                        &lt;br/&gt;                pLigneDetailFactu.DETAIL_ANALYSE := pLigneDetailFactu.DETAIL_ANALYSE||&apos;-&apos;||vMsg;                                                                                                                                                                                                                                                               &lt;br/&gt;                --insertion de la ligne                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                       &lt;br/&gt;                IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  COMMIT;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  ROLLBACK;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              IF vMontantFAS IS NOT NULL AND vMontantFAS &lt;&gt; 0 THEN -- On n&apos;enregistre pas si vMontantFAS = 0, inutile dans ce cas                                                                                                                                                                                                                              &lt;br/&gt;                pLigneDetailFactu.MONTANT:=vMontantFAS;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                pLigneDetailFactu.TYPE_FACTU:=&apos;FAS&apos;;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIBELLE:=&apos;FAS de résiliation&apos;;                                                                                                                                                                                                                                                                                               &lt;br/&gt;                pLigneDetailFactu.LIB_TYPE_PRESTA:= pLigneDetailFactu.LIBELLE;&lt;br/&gt;				--hle : ne pas remplir LIB_PERIODE_DEB et LIB_PERIODE_FIN dans le cas FAS de résiliation&lt;br/&gt;                PLIGNEDETAILFACTU.LIB_PERIODE_DEB := &apos;&apos;;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_FIN := &apos;&apos;;&lt;br/&gt;                --insertion de la ligne                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                       &lt;br/&gt;                IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  COMMIT;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  ROLLBACK;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            ELSIF codeRetour = 2 THEN                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              -- On enregistre le problème survenu                                                                                                                                                                                                                                                                                                             &lt;br/&gt;              pLigneDetailFactu.TYPE_FACTU:=&apos;RESIL&apos;;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;              pLigneDetailFactu.LIBELLE:=&apos;Resiliations&apos;;                                                                                                                                                                                                                                                                                                       &lt;br/&gt;              pLigneDetailFactu.LIB_TYPE_PRESTA:= pLigneDetailFactu.LIBELLE;                                                                                                                                                                                                                                                                                   &lt;br/&gt;              pLigneDetailFactu.DETAIL_ANALYSE := pLigneDetailFactu.DETAIL_ANALYSE||&apos;-&apos;||vMsg;                                                                                                                                                                                                                                                                 &lt;br/&gt;              pLigneDetailFactu.ANALYSE := &apos;true&apos;; -- on force l&apos;analyse pour une vérification par l&apos;ADV                                                                                                                                                                                                                                                       &lt;br/&gt;              pLigneDetailFactu.MONTANT := 0;                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;              --insertion de la ligne                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                         &lt;br/&gt;              IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                COMMIT;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              ELSE                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                ROLLBACK;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;            -- Calcul Up/Downgrade                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;            codeRetour:=F_UpDown(enr,pDateCalcFactu,vMontant,vMontantFAS,vFacteur,vMoisInclus,vLibPeriodeDeb,vLibPeriodeFin,vMsg);                                                                                                                                                                                                                             &lt;br/&gt;            IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;              IF vMontant IS NOT NULL THEN -- On enregistre si vMontant = 0 car informatif                                                                                                                                                                                                                                                                     &lt;br/&gt;                pLigneDetailFactu.MONTANT:=vMontant;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.TYPE_FACTU:=&apos;PRORATA&apos;;                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                pLigneDetailFactu.LIB_TYPE_PRESTA:=&apos;Régularisation suite à &apos;||pLigneDetailFactu.MOTIF_MODIF;                                                                                                                                                                                                                                                   &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_DEB := vLibPeriodeDeb;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_FIN := vLibPeriodeFin;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIBELLE:= pLigneDetailFactu.LIB_TYPE_PRESTA||&apos; du &apos;||TO_CHAR(vLibPeriodeDeb,&apos;DD/MM/YYYY&apos;)||&apos; au &apos;||TO_CHAR(vLibPeriodeFin,&apos;DD/MM/YYYY&apos;);                                                                                                                                                                                     &lt;br/&gt;                pLigneDetailFactu.DETAIL_ANALYSE := pLigneDetailFactu.DETAIL_ANALYSE||&apos;-&apos;||vMsg;                                                                                                                                                                                                                                                               &lt;br/&gt;                --insertion de la ligne                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                       &lt;br/&gt;                IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  COMMIT;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  ROLLBACK;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              IF vMontantFAS IS NOT NULL AND vMontantFAS &lt;&gt; 0 THEN -- On n&apos;enregistre pas si vMontantFAS = 0, inutile dans ce cas                                                                                                                                                                                                                              &lt;br/&gt;                pLigneDetailFactu.MONTANT:=vMontantFAS;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                pLigneDetailFactu.TYPE_FACTU:=&apos;FAS&apos;;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIBELLE:=&apos;FAS de migration&apos;;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                pLigneDetailFactu.LIB_TYPE_PRESTA:= pLigneDetailFactu.LIBELLE; &lt;br/&gt;				--hle : ne pas remplir LIB_PERIODE_DEB et LIB_PERIODE_FIN dans le cas FAS de migration&lt;br/&gt;                PLIGNEDETAILFACTU.LIB_PERIODE_DEB := &apos;&apos;;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_FIN := &apos;&apos;;&lt;br/&gt;                --insertion de la ligne                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                       &lt;br/&gt;                IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  COMMIT;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  ROLLBACK;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            ELSIF codeRetour = 2 THEN                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              -- On enregistre le problème survenu                                                                                                                                                                                                                                                                                                             &lt;br/&gt;              pLigneDetailFactu.TYPE_FACTU:=&apos;PRORATA&apos;;                                                                                                                                                                                                                                                                                                         &lt;br/&gt;              pLigneDetailFactu.LIBELLE:=&apos;Régularisation suite à &apos;||pLigneDetailFactu.MOTIF_MODIF;                                                                                                                                                                                                                                                             &lt;br/&gt;              pLigneDetailFactu.LIB_TYPE_PRESTA:= pLigneDetailFactu.LIBELLE;                                                                                                                                                                                                                                                                                   &lt;br/&gt;              pLigneDetailFactu.DETAIL_ANALYSE := pLigneDetailFactu.DETAIL_ANALYSE||&apos;-&apos;||vMsg;                                                                                                                                                                                                                                                                 &lt;br/&gt;              pLigneDetailFactu.ANALYSE := &apos;true&apos;; -- on force l&apos;analyse pour une vérification par l&apos;ADV                                                                                                                                                                                                                                                       &lt;br/&gt;              pLigneDetailFactu.MONTANT := 0;                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;              --insertion de la ligne                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                         &lt;br/&gt;              IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                COMMIT;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              ELSE                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                ROLLBACK;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          ELSIF UPPER(enr.TECHNO__C) IN (&apos;FTTO&apos;,&apos;FTTH&apos;,&apos;TRANSIT IP&apos;) THEN                                                                                                                                                                                                                                                                                      &lt;br/&gt;            -- Calcul de l&apos;abonnement                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            codeRetour:=F_FactuAbo(enr,pDateCalcFactu,vMontant,vMontantProrata,vLibelleProrata,vLibTypePrestaProrata,vLibPeriodeDebProrata,vLibPeriodeFinProrata,vFacteur,vMoisInclus);                                                                                                                                                                        &lt;br/&gt;            IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;              IF vMontant IS NOT NULL THEN -- On enregistre si vMontant = 0 car informatif                                                                                                                                                                                                                                                                     &lt;br/&gt;                pLigneDetailFactu.MONTANT:=vMontant;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;               IF UPPER(enr.TECHNO__C) = &apos;TRANSIT IP&apos; THEN -- TRANSIT IP RESTE en CONSO 04102011                                                                                                                                                                                                                                                               &lt;br/&gt;                  pLigneDetailFactu.TYPE_FACTU:=&apos;CONSO&apos;;                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                  pLigneDetailFactu.LIB_TYPE_PRESTA := &apos;Consommation&apos;;                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(ADD_MONTHS(pDateCalcFactu,-1*vFacteur),&apos;MONTH&apos;);                                                                                                                                                                                                                                                  &lt;br/&gt;                  pLigneDetailFactu.LIB_PERIODE_FIN := TRUNC(ADD_MONTHS(ADD_MONTHS(pDateCalcFactu,-1*vFacteur),1*vFacteur),&apos;MONTH&apos;)-1;                                                                                                                                                                                                                         &lt;br/&gt;                  pLigneDetailFactu.LIBELLE:=pLigneDetailFactu.LIB_TYPE_PRESTA||&apos; du &apos;||TO_CHAR(pLigneDetailFactu.LIB_PERIODE_DEB,&apos;DD/MM/YYYY&apos;)||&apos; au &apos;||TO_CHAR(pLigneDetailFactu.LIB_PERIODE_FIN,&apos;DD/MM/YYYY&apos;);                                                                                                                                              &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  pLigneDetailFactu.TYPE_FACTU:=&apos;ABO&apos;;                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  pLigneDetailFactu.LIB_TYPE_PRESTA := &apos;Abonnements&apos;;                                                                                                                                                                                                                                                                                          &lt;br/&gt;                  IF UPPER(TRANSLATE(enr.TERME_FACTU__C,&apos;éà&apos;,&apos;ea&apos;)) = &apos;A ECHOIR&apos; THEN                                                                                                                                                                                                                                                                          &lt;br/&gt;                    CASE vFacteur                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                  WHEN 1 THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(pDateCalcFactu,&apos;MONTH&apos;);                                                                                                                                                                                                                                                                        &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_FIN := TRUNC(ADD_MONTHS(pDateCalcFactu,1*vFacteur),&apos;MONTH&apos;)-1;                                                                                                                                                                                                                                               &lt;br/&gt;                  WHEN 3 THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                    -- Début à fin du trimestre actuel                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(pDateCalcFactu,&apos;Q&apos;);                                                                                                                                                                                                                                                                            &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_FIN :=(TRUNC(ADD_MONTHS(pDateCalcFactu,+3),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                          &lt;br/&gt;                  WHEN 6 THEN                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                    -- Début à fin du semestre actuel                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                    IF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;1&apos;,&apos;3&apos;) THEN                                                                                                                                                                                                                                                                                           &lt;br/&gt;                      pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(pDateCalcFactu,&apos;Q&apos;);                                                                                                                                                                                                                                                                          &lt;br/&gt;                      pLigneDetailFactu.LIB_PERIODE_FIN :=(TRUNC(ADD_MONTHS(pDateCalcFactu,+6),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                        &lt;br/&gt;                    ELSIF TO_CHAR(pDateCalcFactu,&apos;Q&apos;) IN (&apos;2&apos;,&apos;4&apos;) THEN                                                                                                                                                                                                                                                                                        &lt;br/&gt;                      pLigneDetailFactu.LIB_PERIODE_DEB :=TRUNC(ADD_MONTHS(pDateCalcFactu,-3),&apos;Q&apos;);                                                                                                                                                                                                                                                            &lt;br/&gt;                      pLigneDetailFactu.LIB_PERIODE_FIN :=(TRUNC(ADD_MONTHS(pDateCalcFactu,+3),&apos;Q&apos;)-1);                                                                                                                                                                                                                                                        &lt;br/&gt;                    END IF;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                  WHEN 12 THEN                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                  -- Début à fin de l&apos;année                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(pDateCalcFactu,&apos;YEAR&apos;);                                                                                                                                                                                                                                                                         &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_FIN :=(ADD_MONTHS(TRUNC(pDateCalcFactu,&apos;YEAR&apos;),+12)-1);                                                                                                                                                                                                                                                      &lt;br/&gt;                  END CASE;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                    --pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(pDateCalcFactu,&apos;MONTH&apos;);                                                                                                                                                                                                                                                                      &lt;br/&gt;                    --pLigneDetailFactu.LIB_PERIODE_FIN := TRUNC(ADD_MONTHS(pDateCalcFactu,1*vFacteur),&apos;MONTH&apos;)-1;                                                                                                                                                                                                                                             &lt;br/&gt;                  ELSE                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_DEB := TRUNC(ADD_MONTHS(pDateCalcFactu,-1*vFacteur),&apos;MONTH&apos;);                                                                                                                                                                                                                                                &lt;br/&gt;                    pLigneDetailFactu.LIB_PERIODE_FIN := TRUNC(ADD_MONTHS(ADD_MONTHS(pDateCalcFactu,-1*vFacteur),1*vFacteur),&apos;MONTH&apos;)-1;                                                                                                                                                                                                                       &lt;br/&gt;                  END IF;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                  pLigneDetailFactu.LIBELLE := pLigneDetailFactu.LIB_TYPE_PRESTA||&apos; (&apos;||enr.TERME_FACTU__C||&apos;) du &apos;||TO_CHAR(pLigneDetailFactu.LIB_PERIODE_DEB,&apos;DD/MM/YYYY&apos;)||&apos; au &apos;||TO_CHAR(pLigneDetailFactu.LIB_PERIODE_FIN,&apos;DD/MM/YYYY&apos;);                                                                                                                 &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                --insertion de la ligne                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                       &lt;br/&gt;                IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  COMMIT;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  ROLLBACK;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              IF vMontantProrata IS NOT NULL THEN -- On enregistre si vMontant = 0 car informatif                                                                                                                                                                                                                                                              &lt;br/&gt;                pLigneDetailFactu.MONTANT:=vMontantProrata;                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                pLigneDetailFactu.TYPE_FACTU:=&apos;PRORATA&apos;;                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                pLigneDetailFactu.LIBELLE:=vLibelleProrata;                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                pLigneDetailFactu.LIB_TYPE_PRESTA := vLibTypePrestaProrata;                                                                                                                                                                                                                                                                                    &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_DEB := vLibPeriodeDebProrata;                                                                                                                                                                                                                                                                                    &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_FIN := vLibPeriodeFinProrata;                                                                                                                                                                                                                                                                                    &lt;br/&gt;                --insertion de la ligne                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                       &lt;br/&gt;                IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  COMMIT;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  ROLLBACK;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;            -- Calcul des résil                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;            codeRetour:=F_FactuResil(enr,pDateCalcFactu,vMontant,vMontantFAS,vFacteur,vMoisInclus,vLibTypePresta,vLibPeriodeDeb,vLibPeriodeFin,vMsg);                                                                                                                                                                                                          &lt;br/&gt;            IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;              IF vMontant IS NOT NULL THEN -- On enregistre si vMontant = 0 car informatif                                                                                                                                                                                                                                                                     &lt;br/&gt;                pLigneDetailFactu.MONTANT:=vMontant;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.TYPE_FACTU:=&apos;RESIL&apos;;                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                pLigneDetailFactu.LIB_TYPE_PRESTA := vLibTypePresta;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_DEB := vLibPeriodeDeb;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_FIN := vLibPeriodeFin;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIBELLE:= vLibTypePresta||&apos; du &apos;||TO_CHAR(vLibPeriodeDeb,&apos;DD/MM/YYYY&apos;)||&apos; au &apos;||TO_CHAR(vLibPeriodeFin,&apos;DD/MM/YYYY&apos;);                                                                                                                                                                                                        &lt;br/&gt;                pLigneDetailFactu.DETAIL_ANALYSE := pLigneDetailFactu.DETAIL_ANALYSE||&apos;-&apos;||vMsg;                                                                                                                                                                                                                                                               &lt;br/&gt;                --insertion de la ligne                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                       &lt;br/&gt;                IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  COMMIT;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  ROLLBACK;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              IF vMontantFAS IS NOT NULL AND vMontantFAS &lt;&gt; 0 THEN -- On n&apos;enregistre pas si vMontantFAS = 0, inutile dans ce cas                                                                                                                                                                                                                              &lt;br/&gt;                pLigneDetailFactu.MONTANT:=vMontantFAS;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                pLigneDetailFactu.TYPE_FACTU:=&apos;FAS&apos;;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIBELLE:=&apos;FAS de résiliation&apos;;                                                                                                                                                                                                                                                                                               &lt;br/&gt;                pLigneDetailFactu.LIB_TYPE_PRESTA:= pLigneDetailFactu.LIBELLE; &lt;br/&gt;				--hle : ne pas remplir LIB_PERIODE_DEB et LIB_PERIODE_FIN dans le cas FAS de résiliation&lt;br/&gt;                PLIGNEDETAILFACTU.LIB_PERIODE_DEB := &apos;&apos;;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_FIN := &apos;&apos;;&lt;br/&gt;                --insertion de la ligne                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                       &lt;br/&gt;                IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  COMMIT;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  ROLLBACK;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            ELSIF codeRetour = 2 THEN                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              -- On enregistre le problème survenu                                                                                                                                                                                                                                                                                                             &lt;br/&gt;              pLigneDetailFactu.TYPE_FACTU:=&apos;RESIL&apos;;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;              pLigneDetailFactu.LIBELLE:=&apos;Resiliations&apos;;                                                                                                                                                                                                                                                                                                       &lt;br/&gt;              pLigneDetailFactu.LIB_TYPE_PRESTA:= pLigneDetailFactu.LIBELLE;                                                                                                                                                                                                                                                                                   &lt;br/&gt;              pLigneDetailFactu.DETAIL_ANALYSE := pLigneDetailFactu.DETAIL_ANALYSE||&apos;-&apos;||vMsg;                                                                                                                                                                                                                                                                 &lt;br/&gt;              pLigneDetailFactu.ANALYSE := &apos;true&apos;; -- on force l&apos;analyse pour une vérification par l&apos;ADV                                                                                                                                                                                                                                                       &lt;br/&gt;              pLigneDetailFactu.MONTANT := 0;                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;              --insertion de la ligne                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                         &lt;br/&gt;              IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                COMMIT;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              ELSE                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                ROLLBACK;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;            -- Calcul Up/Downgrade                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;            codeRetour:=F_UpDown(enr,pDateCalcFactu,vMontant,vMontantFAS,vFacteur,vMoisInclus,vLibPeriodeDeb,vLibPeriodeFin,vMsg);                                                                                                                                                                                                                             &lt;br/&gt;            IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;              IF vMontant IS NOT NULL THEN -- On enregistre si vMontant = 0 car informatif                                                                                                                                                                                                                                                                     &lt;br/&gt;                pLigneDetailFactu.MONTANT:=vMontant;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.TYPE_FACTU:=&apos;PRORATA&apos;;                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                pLigneDetailFactu.LIB_TYPE_PRESTA:=&apos;Régularisation suite à &apos;||pLigneDetailFactu.MOTIF_MODIF;                                                                                                                                                                                                                                                   &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_DEB := vLibPeriodeDeb;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_FIN := vLibPeriodeFin;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIBELLE:= pLigneDetailFactu.LIB_TYPE_PRESTA||&apos; du &apos;||TO_CHAR(vLibPeriodeDeb,&apos;DD/MM/YYYY&apos;)||&apos; au &apos;||TO_CHAR(vLibPeriodeFin,&apos;DD/MM/YYYY&apos;);                                                                                                                                                                                     &lt;br/&gt;                pLigneDetailFactu.DETAIL_ANALYSE := pLigneDetailFactu.DETAIL_ANALYSE||&apos;-&apos;||vMsg;                                                                                                                                                                                                                                                               &lt;br/&gt;                --insertion de la ligne                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                       &lt;br/&gt;                IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  COMMIT;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  ROLLBACK;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              IF vMontantFAS IS NOT NULL AND vMontantFAS &lt;&gt; 0 THEN -- On n&apos;enregistre pas si vMontantFAS = 0, inutile dans ce cas                                                                                                                                                                                                                              &lt;br/&gt;                pLigneDetailFactu.MONTANT:=vMontantFAS;                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                pLigneDetailFactu.TYPE_FACTU:=&apos;FAS&apos;;                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIBELLE:=&apos;FAS de migration&apos;;                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                pLigneDetailFactu.LIB_TYPE_PRESTA:= pLigneDetailFactu.LIBELLE;&lt;br/&gt;				--hle : ne pas remplir LIB_PERIODE_DEB et LIB_PERIODE_FIN dans le cas FAS de migration&lt;br/&gt;                PLIGNEDETAILFACTU.LIB_PERIODE_DEB := &apos;&apos;;                                                                                                                                                                                                                                                                                           &lt;br/&gt;                pLigneDetailFactu.LIB_PERIODE_FIN := &apos;&apos;;&lt;br/&gt;                --insertion de la ligne                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                       &lt;br/&gt;                IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                  COMMIT;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                ELSE                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                  ROLLBACK;                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                END IF;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            ELSIF codeRetour = 2 THEN                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              -- On enregistre le problème survenu                                                                                                                                                                                                                                                                                                             &lt;br/&gt;              pLigneDetailFactu.TYPE_FACTU:=&apos;PRORATA&apos;;                                                                                                                                                                                                                                                                                                         &lt;br/&gt;              pLigneDetailFactu.LIBELLE:=&apos;Régularisation suite à &apos;||pLigneDetailFactu.MOTIF_MODIF;                                                                                                                                                                                                                                                             &lt;br/&gt;              pLigneDetailFactu.LIB_TYPE_PRESTA:= pLigneDetailFactu.LIBELLE;                                                                                                                                                                                                                                                                                   &lt;br/&gt;              pLigneDetailFactu.DETAIL_ANALYSE := pLigneDetailFactu.DETAIL_ANALYSE||&apos;-&apos;||vMsg;                                                                                                                                                                                                                                                                 &lt;br/&gt;              pLigneDetailFactu.ANALYSE := &apos;true&apos;; -- on force l&apos;analyse pour une vérification par l&apos;ADV                                                                                                                                                                                                                                                       &lt;br/&gt;              pLigneDetailFactu.MONTANT := 0;                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;              --insertion de la ligne                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;              codeRetour:=F_InsertLigneDetailFactu(pLigneDetailFactu);                                                                                                                                                                                                                                                                                         &lt;br/&gt;              IF codeRetour = 0 THEN                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                COMMIT;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;              ELSE                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                ROLLBACK;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;              END IF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;            END IF;                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;            -- Toutes les autres technos                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;          ELSE                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;    P_FactureProrataTemporis(codeRetour=&gt;codeRetour                                                                                                                                                                                                                                                                                                            &lt;br/&gt;   ,enr=&gt;enr                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;   ,pDateCalcFactu=&gt;pDateCalcFactu                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;   ,pLigneDetailFactu=&gt;pLigneDetailFactu                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;   ,vFacteur=&gt;vFacteur                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;   ,vLibPeriodeDeb=&gt;vLibPeriodeDeb                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;   ,vLibPeriodeDebProrata=&gt;vLibPeriodeDebProrata                                                                                                                                                                                                                                                                                                               &lt;br/&gt;   ,vLibPeriodeFin=&gt;vLibPeriodeFin                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;   ,vLibPeriodeFinProrata=&gt;vLibPeriodeFinProrata                                                                                                                                                                                                                                                                                                               &lt;br/&gt;   ,vLibTypePresta=&gt;vLibTypePresta                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;   ,vLibTypePrestaProrata=&gt;vLibTypePrestaProrata                                                                                                                                                                                                                                                                                                               &lt;br/&gt;   ,vLibelleProrata=&gt;vLibelleProrata                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;   ,vMoisInclus=&gt;vMoisInclus                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;   ,vMontant=&gt;vMontant                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;   ,vMontantFAS=&gt;vMontantFAS                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;   ,vMontantProrata=&gt;vMontantProrata                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;   ,vMsg=&gt;vMsg     &lt;br/&gt;   ,vTestMotifModif=&gt;vTestMotifModif&lt;br/&gt;   );                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          END IF; -- Fin du choix des technos                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;        END IF; -- Fin vTraitementLigne                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;      END LOOP;                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;    ELSE                                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;      RAISE_APPLICATION_ERROR(-20012,&apos;La table T_FDSL_DETAIL_FACTURE n&apos;&apos;est pas vide, le traitement est arrete&apos;);                                                                                                                                                                                                                                              &lt;br/&gt;    END IF; --Fin IF vEnrExists=0                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;&lt;br/&gt;  --ADS 25/05/2012 story 529 &lt;br/&gt;  DELETE T_FDSL_DETAIL_FACTURE WHERE UPPER(LIB_TYPE_PRESTA) LIKE &apos;LOCATION%&apos; AND MONTANT = 0 ;&lt;br/&gt;  COMMIT;     &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;END P_InsertDetailFactu;                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;-- Copie des données de Detail vers Recap suite à l&apos;insertion dans la table Detail                                                                                                                                                                                                                                                                             &lt;br/&gt;PROCEDURE P_InsertRecapFactu IS                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;vErr INTEGER :=0;                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    INSERT INTO T_FDSL_RECAP_FACTURE (                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                      FAI,                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                                      DSP,                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                                      TECHNO,                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                      MOIS,                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                      ANNEE,                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                                      LIBELLE,                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;                                      TYPE_FACTU,                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                      DATE_CALC_FACTU,                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                      MODE_FACTU,                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                      TERME_FACTU,                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                      FREQUENCE_FACTU,                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                      STATUT,                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                      MONTANT                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;                                     )                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;    SELECT                                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          FAI,                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;          DSP,                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;          TECHNO,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          MOIS,                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;          ANNEE,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          LIBELLE,                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          TYPE_FACTU,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          DATE_CALC_FACTU,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          MODE_FACTU,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          TERME_FACTU,                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;          FREQUENCE_FACTU,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          STATUT,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          SUM(MONTANT) MONTANT                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;    FROM T_FDSL_DETAIL_FACTURE                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;    GROUP BY                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;            FAI,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;            DSP,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;            TECHNO,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;            MOIS,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;            ANNEE,                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;            LIBELLE,                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;            TYPE_FACTU,                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;            DATE_CALC_FACTU,                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;            MODE_FACTU,                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;            TERME_FACTU,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;            FREQUENCE_FACTU,                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;            STATUT                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;    ;                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      vErr:=1;                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  IF vErr = 0 THEN                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;    COMMIT;                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;  ELSE                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;    ROLLBACK;                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;    RAISE_APPLICATION_ERROR(-20031,&apos;Problème lors du chargement de la table T_FDSL_RECAP_FACTURE &apos;||SQLERRM);                                                                                                                                                                                                                                                  &lt;br/&gt;  END IF;                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;END P_InsertRecapFactu;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;-- Historisation de la table T_FDSL_SERVICE_SF -&gt; Insertion dans la table T_FDSL_HISTO_SERVICE_SF                                                                                                                                                                                                                                                              &lt;br/&gt;PROCEDURE P_HistoServiceSF(pMois IN NUMBER, pAnnee IN NUMBER) IS                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;vErr INTEGER:=0;                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    INSERT INTO T_FDSL_HISTO_SERVICE_SF                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    (                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;     MOIS                        ,                                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;     ANNEE                       ,                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;     ANALYSE_FACTU__C            ,                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;     ABONNE_COMMANDE__C          ,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;     COMMENTAIRE_FACTURATION__C  ,                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     DATE_DEBUT_FACTU__C         ,                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;     DATE_MES_EFFECTIVE__C       ,                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;     DATE_MISE_EN_FACTU__C       ,                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;     DATE_MISE_EN_MODIF__C       ,                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;     DATE_MISE_EN_RESIL__C       ,                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;     DATE_MODIFICATION__C        ,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;     DATE_RESIL__C               ,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;     DETAIL_ANALYSE__C           ,                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;     DUREE_D_ENGAGEMENT__C       ,                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;     FAI__C                      ,                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;     FAS__C                      ,                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;     ID_SERVICE__C               ,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;     IRU__C                      ,                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;     SERVICE_ID                  ,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     MODE_FACTU__C               ,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;     NDI__C                      ,                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;     NAME                        ,                                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;     PFRO__C                     ,                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;     PDC_ID                      ,                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;     SIRET__C                    ,                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;     REF_FAI__C                  ,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     STATUT__C                   ,                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;     TECHNO__C                   ,                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;     TERME_FACTU__C              ,                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;     VIA_DGT__C                  ,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     VIA_GTR__C                  ,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     FREQUENCE_FACTU__C          ,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;     MOTIF_RESILIATION__C        ,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;     MOTIF_MODIF__C              ,                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;     TYPE_DEGROUPAGE__C          ,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;     NOM_PDC                     ,                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;     NOM_PROJET__C               ,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;     PRODUITS_COMMANDES__C       ,                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;     DSP__C                      ,                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;     VILLE__C                    ,                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;     SEUIL__C                    ,                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;     TARIF_FORFAIT__C            ,                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;     TARIF_DEPASSEMENT__C        ,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;     NOM_FAI                     ,                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;     ABONNEMENT_MENSUEL__C       ,                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;     LOCATION__C                 ,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;     SIREN__C                    ,                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;     MAILS_COPIES_D_TAIL_FACTU__C,                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;     MAILS_DEST_D_TAIL_FACTU__C  ,                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     DATE_CALC_FACTU             ,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;     USER_CREATION               ,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;     DATE_CREATION               ,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;     USER_MODIF                  ,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     DATE_MODIF                  ,&lt;br/&gt;     DATE_FIN_ENGAGEMENT__C      ,&lt;br/&gt;     PROFIL__C                   ,--Story URL855&lt;br/&gt;     ADRESSE_1__C                ,&lt;br/&gt;     CP__C                       ,&lt;br/&gt;	 TYPE_VENTE__C&lt;br/&gt;    )                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;    SELECT                                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          MOIS                        ,                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;          ANNEE                       ,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          ANALYSE_FACTU__C            ,                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;          ABONNE_COMMANDE__C          ,                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;          COMMENTAIRE_FACTURATION__C  ,                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          DATE_DEBUT_FACTU__C         ,                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;          DATE_MES_EFFECTIVE__C       ,                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          DATE_MISE_EN_FACTU__C       ,                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          DATE_MISE_EN_MODIF__C       ,                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          DATE_MISE_EN_RESIL__C       ,                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          DATE_MODIFICATION__C        ,                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;          DATE_RESIL__C               ,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;          DETAIL_ANALYSE__C           ,                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;          DUREE_D_ENGAGEMENT__C       ,                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          FAI__C                      ,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          FAS__C                      ,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          ID_SERVICE__C               ,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;          IRU__C                      ,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          SERVICE_ID                  ,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          MODE_FACTU__C               ,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;          NDI__C                      ,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          NAME                        ,                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;          PFRO__C                     ,                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          PDC_ID                      ,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          SIRET__C                    ,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          REF_FAI__C                  ,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          STATUT__C                   ,                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;          TECHNO__C                   ,                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;          TERME_FACTU__C              ,                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;          VIA_DGT__C                  ,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          VIA_GTR__C                  ,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          FREQUENCE_FACTU__C          ,                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;          MOTIF_RESILIATION__C        ,                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;          MOTIF_MODIF__C              ,                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;          TYPE_DEGROUPAGE__C          ,                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;          NOM_PDC                     ,                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          NOM_PROJET__C               ,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;          PRODUITS_COMMANDES__C       ,                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          DSP__C                      ,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          VILLE__C                    ,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          SEUIL__C                    ,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          TARIF_FORFAIT__C            ,                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;          TARIF_DEPASSEMENT__C        ,                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;          NOM_FAI                     ,                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          ABONNEMENT_MENSUEL__C       ,                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          LOCATION__C                 ,                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;          SIREN__C                    ,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          MAILS_COPIES_D_TAIL_FACTU__C,                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;          MAILS_DEST_D_TAIL_FACTU__C  ,                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          DATE_CALC_FACTU             ,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          USER_CREATION               ,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;          DATE_CREATION               ,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;          USER_MODIF                  ,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          DATE_MODIF                  ,&lt;br/&gt;          DATE_FIN_ENGAGEMENT__C      ,&lt;br/&gt;          PROFIL__C                   ,----Story URL855&lt;br/&gt;          ADRESSE_1__C                ,&lt;br/&gt;          CP__C                       ,&lt;br/&gt;		  TYPE_VENTE__C&lt;br/&gt;    FROM                                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;        T_FDSL_SERVICE_SF                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;    WHERE                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;         MOIS = pMois                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;     AND ANNEE = pAnnee                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    ;                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      vErr:=1;                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;  IF vErr = 0 THEN                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;    COMMIT;                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;  ELSE                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;    ROLLBACK;                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;    RAISE_APPLICATION_ERROR(-20043,&apos;Erreur lors de l&apos;&apos;historisation de la table T_FDSL_SERVICE_SF&apos;);                                                                                                                                                                                                                                                           &lt;br/&gt;  END IF;                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;END P_HistoServiceSF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;-- Historisation de la table T_FDSL_COMPTA_FACTURE -&gt; Insertion dans la table T_FDSL_HISTO_COMPTA_FACTURE                                                                                                                                                                                                                                                      &lt;br/&gt;PROCEDURE P_HistoComptaFactu(pMois IN NUMBER, pAnnee IN NUMBER) IS                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;vErr INTEGER :=0;                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    INSERT INTO T_FDSL_HISTO_COMPTA_FACTURE                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    (                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;     ID_SERVICE,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     ABONNE,                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;     FAI,                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;     DSP,                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;     TECHNO,                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;     MOIS,                                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;     ANNEE,                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;     DATE_DEB_FACTU,                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;     DATE_SAISIE_MES,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;     DATE_SAISIE_MODIF,                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;     DATE_SAISIE_RESIL,                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;     DATE_MES_EFFECTIVE,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;     DATE_DE_MODIF,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;     DATE_RESIL,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     DATE_CALC_FACTU,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;     SDFC,                                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;     COMMANDE,                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;     REF_CLIENT,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     NOM_PROJET,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     PRODUITS_COMMANDES,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;     VILLE,                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;     DUREE_ENGAGEMENT,                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;     FREQUENCE_FACTU,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;     NDI,                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;     VIA_DGT,                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;     VIA_GTR,                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;     TERME_FACTU,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;     MODE_FACTU,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     LIBELLE,                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;     LIB_TYPE_PRESTA,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;     LIB_PERIODE_DEB,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;     LIB_PERIODE_FIN,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;     CONSOMMATION,                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;     TARIF_FORFAIT,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;     SEUIL,                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;     TARIF_DEPASSEMENT,                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;     MONTANT,                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;     COMMENTAIRE,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;     ANALYSE,                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;     DETAIL_ANALYSE,                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;     STATUT,                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;     TYPE_FACTU,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     MOTIF_RESIL,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;     MOTIF_MODIF,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;     MAIL_DEST,                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;     MAIL_CC,                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;     ID_SALESFORCE,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;     USER_CREATION,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;     DATE_CREATION,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;     USER_MODIF,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     DATE_MODIF,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     DATE_COMPTA_FACTU  ,&lt;br/&gt;     DATE_FIN_ENGAGEMENT,&lt;br/&gt;     PROFIL             ,--Story URL855&lt;br/&gt;     ADRESSE_1          ,&lt;br/&gt;     CP                  &lt;br/&gt;    )                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;    SELECT                                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          ID_SERVICE,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          ABONNE,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          FAI,                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;          DSP,                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;          TECHNO,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          MOIS,                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;          ANNEE,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          DATE_DEB_FACTU,                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;          DATE_SAISIE_MES,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          DATE_SAISIE_MODIF,                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;          DATE_SAISIE_RESIL,                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;          DATE_MES_EFFECTIVE,                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;          DATE_DE_MODIF,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;          DATE_RESIL,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          DATE_CALC_FACTU,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          SDFC,                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;          COMMANDE,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          REF_CLIENT,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          NOM_PROJET,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          PRODUITS_COMMANDES,                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;          VILLE,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          DUREE_ENGAGEMENT,                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;          FREQUENCE_FACTU,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          NDI,                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;          VIA_DGT,                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          VIA_GTR,                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          TERME_FACTU,                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;          MODE_FACTU,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          LIBELLE,                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          LIB_TYPE_PRESTA,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          LIB_PERIODE_DEB,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          LIB_PERIODE_FIN,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          CONSOMMATION,                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;          TARIF_FORFAIT,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;          SEUIL,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          TARIF_DEPASSEMENT,                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;          MONTANT,                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          COMMENTAIRE,                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;          ANALYSE,                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          DETAIL_ANALYSE,                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;          STATUT,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          TYPE_FACTU,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          MOTIF_RESIL,                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;          MOTIF_MODIF,                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;          MAIL_DEST,                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;          MAIL_CC,                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          ID_SALESFORCE,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;          USER_CREATION,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;          DATE_CREATION,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;          USER_MODIF,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          DATE_MODIF,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          DATE_COMPTA_FACTU  ,&lt;br/&gt;          DATE_FIN_ENGAGEMENT,&lt;br/&gt;          PROFIL             ,--Story URL855&lt;br/&gt;          ADRESSE_1          ,&lt;br/&gt;          CP                  &lt;br/&gt;    FROM                                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;        T_FDSL_COMPTA_FACTURE                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;    WHERE                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;         MOIS = pMois                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;     AND ANNEE = pAnnee                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    ;                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      vErr:=1;                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;  IF vErr = 0 THEN                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;    COMMIT;                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;  ELSE                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;    ROLLBACK;                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;    RAISE_APPLICATION_ERROR(-20055,&apos;Erreur lors de l&apos;&apos;historisation de la table T_FDSL_COMPTA_FACTURE&apos;);                                                                                                                                                                                                                                                       &lt;br/&gt;  END IF;                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;END P_HistoComptaFactu;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;-- Historisation de la table T_FDSL_DETAIL_FACTURE -&gt; Insertion dans la table T_FDSL_HISTO_DETAIL_FACTURE                                                                                                                                                                                                                                                      &lt;br/&gt;PROCEDURE P_HistoDetailFactu(pMois IN NUMBER, pAnnee IN NUMBER) IS                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;vErr INTEGER :=0;                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    INSERT INTO T_FDSL_HISTO_DETAIL_FACTURE                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    (                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;     ID_SERVICE,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     ABONNE,                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;     FAI,                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;     DSP,                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;     TECHNO,                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;     MOIS,                                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;     ANNEE,                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;     DATE_DEB_FACTU,                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;     DATE_SAISIE_MES,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;     DATE_SAISIE_MODIF,                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;     DATE_SAISIE_RESIL,                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;     DATE_MES_EFFECTIVE,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;     DATE_DE_MODIF,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;     DATE_RESIL,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     DATE_CALC_FACTU,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;     SDFC,                                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;     COMMANDE,                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;     REF_CLIENT,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     NOM_PROJET,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     VILLE,                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;     DUREE_ENGAGEMENT,                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;     FREQUENCE_FACTU,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;     NDI,                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;     VIA_DGT,                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;     VIA_GTR,                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;     TERME_FACTU,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;     MODE_FACTU,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     LIBELLE,                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;     LIB_TYPE_PRESTA,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;     LIB_PERIODE_DEB,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;     LIB_PERIODE_FIN,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;     CONSOMMATION,                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;     TARIF_FORFAIT,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;     SEUIL,                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;     TARIF_DEPASSEMENT,                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;     MONTANT,                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;     COMMENTAIRE,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;     ANALYSE,                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;     DETAIL_ANALYSE,                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;     STATUT,                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;     TYPE_FACTU,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     MOTIF_RESIL,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;     MOTIF_MODIF,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;     MAIL_DEST,                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;     MAIL_CC,                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;     ID_SALESFORCE,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;     USER_CREATION,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;     DATE_CREATION,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;     USER_MODIF,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;     DATE_MODIF,&lt;br/&gt;     DATE_FIN_ENGAGEMENT,&lt;br/&gt;     PROFIL             ,--Story URL855&lt;br/&gt;     ADRESSE_1          ,&lt;br/&gt;     CP                 ,&lt;br/&gt;	 TYPE_VENTE&lt;br/&gt;    )                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;    SELECT                                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          ID_SERVICE,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          ABONNE,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          FAI,                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;          DSP,                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;          TECHNO,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          MOIS,                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;          ANNEE,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          DATE_DEB_FACTU,                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;          DATE_SAISIE_MES,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          DATE_SAISIE_MODIF,                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;          DATE_SAISIE_RESIL,                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;          DATE_MES_EFFECTIVE,                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;          DATE_DE_MODIF,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;          DATE_RESIL,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          DATE_CALC_FACTU,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          SDFC,                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;          COMMANDE,                                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;          REF_CLIENT,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          NOM_PROJET,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          VILLE,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          DUREE_ENGAGEMENT,                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;          FREQUENCE_FACTU,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          NDI,                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;          VIA_DGT,                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          VIA_GTR,                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          TERME_FACTU,                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;          MODE_FACTU,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          LIBELLE,                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          LIB_TYPE_PRESTA,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          LIB_PERIODE_DEB,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          LIB_PERIODE_FIN,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          CONSOMMATION,                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;          TARIF_FORFAIT,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;          SEUIL,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          TARIF_DEPASSEMENT,                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;          MONTANT,                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          COMMENTAIRE,                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;          ANALYSE,                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          DETAIL_ANALYSE,                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;          STATUT,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          TYPE_FACTU,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          MOTIF_RESIL,                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;          MOTIF_MODIF,                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;          MAIL_DEST,                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;          MAIL_CC,                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          ID_SALESFORCE,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;          USER_CREATION,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;          DATE_CREATION,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;          USER_MODIF,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          DATE_MODIF,&lt;br/&gt;          DATE_FIN_ENGAGEMENT,&lt;br/&gt;          PROFIL             ,--Story URL855&lt;br/&gt;          ADRESSE_1          ,&lt;br/&gt;          CP                 ,&lt;br/&gt;		  TYPE_VENTE&lt;br/&gt;    FROM                                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;        T_FDSL_DETAIL_FACTURE                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;    WHERE                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;         MOIS = pMois                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;     AND ANNEE = pAnnee                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    ;                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      vErr:=1;                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;  IF vErr = 0 THEN                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;    COMMIT;                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;  ELSE                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;    ROLLBACK;                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;    RAISE_APPLICATION_ERROR(-20055,&apos;Erreur lors de l&apos;&apos;historisation de la table T_FDSL_DETAIL_FACTURE&apos;);                                                                                                                                                                                                                                                       &lt;br/&gt;  END IF;                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;END P_HistoDetailFactu;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;PROCEDURE P_HistoRecapFactu(pMois IN NUMBER, pAnnee IN NUMBER) IS                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;vErr INTEGER :=0;                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    INSERT INTO T_FDSL_HISTO_RECAP_FACTURE (                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                                            FAI,                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                            DSP,                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                            TECHNO,                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                            MOIS,                                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                            ANNEE,                                                                                                                                                                                                                                                                                                             &lt;br/&gt;                                            LIBELLE,                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                                            TYPE_FACTU,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                            DATE_CALC_FACTU,                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                                            MODE_FACTU,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                            TERME_FACTU,                                                                                                                                                                                                                                                                                                       &lt;br/&gt;                                            FREQUENCE_FACTU,                                                                                                                                                                                                                                                                                                   &lt;br/&gt;                                            STATUT,                                                                                                                                                                                                                                                                                                            &lt;br/&gt;                                            MONTANT,                                                                                                                                                                                                                                                                                                           &lt;br/&gt;                                            USER_CREATION,                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                                            DATE_CREATION,                                                                                                                                                                                                                                                                                                     &lt;br/&gt;                                            USER_MODIF,                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                            DATE_MODIF                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                     )                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;    SELECT                                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          FAI,                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;          DSP,                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;          TECHNO,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          MOIS,                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;          ANNEE,                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;          LIBELLE,                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          TYPE_FACTU,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          DATE_CALC_FACTU,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          MODE_FACTU,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          TERME_FACTU,                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;          FREQUENCE_FACTU,                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;          STATUT,                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;          MONTANT,                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;          USER_CREATION,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;          DATE_CREATION,                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;          USER_MODIF,                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;          DATE_MODIF                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;    FROM T_FDSL_RECAP_FACTURE                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;    WHERE                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;         MOIS = pMois                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;     AND ANNEE = pAnnee                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    ;                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      vErr:=1;                                                                                                                                                                                                                                                                                                                                                 &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  IF vErr = 0 THEN                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;    COMMIT;                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;  ELSE                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;    ROLLBACK;                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;    RAISE_APPLICATION_ERROR(-20056,&apos;Erreur lors de l&apos;&apos;historisation de la table T_FDSL_RECAP_FACTURE&apos;);                                                                                                                                                                                                                                                        &lt;br/&gt;  END IF;                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;END P_HistoRecapFactu;                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;PROCEDURE P_ArchiServiceSF(pMois IN NUMBER,pAnnee IN NUMBER) IS                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  -- Archivage T_FDSL_SERVICE_SF vers T_FDSL_HISTO_SERVICE_SF                                                                                                                                                                                                                                                                                                  &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    P_HistoServiceSF(pMois,pAnnee);                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      RAISE_APPLICATION_ERROR(-20041,&apos;Problème lors de l&apos;&apos;archivage de la table T_FDSL_SERVICE_SF&apos;||SQLERRM);                                                                                                                                                                                                                                                  &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  -- Vidage T_FDSL_SERVICE_SF                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    EXECUTE IMMEDIATE &apos;TRUNCATE TABLE T_FDSL_SERVICE_SF&apos;;                                                                                                                                                                                                                                                                                                      &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      RAISE_APPLICATION_ERROR(-20042,&apos;Problème lors de la réinitialisation de la table T_FDSL_SERVICE_SF&apos;||SQLERRM);                                                                                                                                                                                                                                           &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;END P_ArchiServiceSF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;PROCEDURE P_ArchiComptaFactu(pMois IN NUMBER,pAnnee IN NUMBER) IS                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  -- Archivage T_FDSL_COMPTA_FACTU vers T_FDSL_HISTO_COMPTA_FACTU                                                                                                                                                                                                                                                                                              &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    P_HistoComptaFactu(pMois,pAnnee);                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      RAISE_APPLICATION_ERROR(-20141,&apos;Problème lors de l&apos;&apos;archivage de la table T_FDSL_COMPTA_FACTU&apos;||SQLERRM);                                                                                                                                                                                                                                                &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  -- Vidage T_FDSL_COMPTA_FACTU                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    EXECUTE IMMEDIATE &apos;TRUNCATE TABLE T_FDSL_COMPTA_FACTURE&apos;;                                                                                                                                                                                                                                                                                                  &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      RAISE_APPLICATION_ERROR(-20142,&apos;Problème lors de la réinitialisation de la table T_FDSL_COMPTA_FACTU&apos;||SQLERRM);                                                                                                                                                                                                                                         &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;END P_ArchiComptaFactu;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;PROCEDURE P_ArchiDetailRecap(pMois IN NUMBER,pAnnee IN NUMBER) IS                                                                                                                                                                                                                                                                                              &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  -- Archivage T_FDSL_DETAIL_FACTURE vers T_FDSL_HISTO_DETAIL_FACTURE                                                                                                                                                                                                                                                                                          &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    P_HistoDetailFactu(pMois,pAnnee);                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      RAISE_APPLICATION_ERROR(-20051,&apos;Problème lors de l&apos;&apos;archivage de la table T_FDSL_DETAIL_FACTURE&apos;||SQLERRM);                                                                                                                                                                                                                                              &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  -- Archivage T_FDSL_RECAP_FACTURE vers T_FDSL_HISTO_RECAP_FACTURE                                                                                                                                                                                                                                                                                            &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    P_HistoRecapFactu(pMois,pAnnee);                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      RAISE_APPLICATION_ERROR(-20052,&apos;Problème lors de l&apos;&apos;archivage de la table T_FDSL_RECAP_FACTURE&apos;||SQLERRM);                                                                                                                                                                                                                                               &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  -- Vidage T_FDSL_DETAIL_FACTURE                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    EXECUTE IMMEDIATE &apos;TRUNCATE TABLE T_FDSL_DETAIL_FACTURE&apos;;                                                                                                                                                                                                                                                                                                  &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      RAISE_APPLICATION_ERROR(-20053,&apos;Problème lors de la réinitialisation de la table T_FDSL_DETAIL_FACTURE&apos;||SQLERRM);                                                                                                                                                                                                                                       &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  -- Vidage T_FDSL_RECAP_FACTURE                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    EXECUTE IMMEDIATE &apos;TRUNCATE TABLE T_FDSL_RECAP_FACTURE&apos;;                                                                                                                                                                                                                                                                                                   &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      RAISE_APPLICATION_ERROR(-20054,&apos;Problème lors de la réinitialisation de la table T_FDSL_RECAP_FACTURE&apos;||SQLERRM);                                                                                                                                                                                                                                        &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;END P_ArchiDetailRecap;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;PROCEDURE P_UpdateDetailMail IS                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  v_mail_dest VARCHAR2(4000);                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;  v_mail_cc VARCHAR2(4000);                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    SELECT TRANSLATE(WMSYS.WM_CONCAT(ADRESSE),&apos;,&apos;,&apos;;&apos;)                                                                                                                                                                                                                                                                                                         &lt;br/&gt;    INTO v_mail_dest                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;    FROM T_FDSL_MAIL                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;    WHERE APPLICATION=&apos;FACTU_SF&apos;                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;      AND TYPE_ACTION=&apos;CUSTOMER&apos;                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;      AND POSITION=&apos;DEST&apos;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;    ;                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN NO_DATA_FOUND THEN                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;      v_mail_dest := NULL;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      RAISE_APPLICATION_ERROR(-20021,&apos;Problème lors de la récupération mails destinataire ADV&apos;||SQLERRM);                                                                                                                                                                                                                                                      &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    SELECT TRANSLATE(WMSYS.WM_CONCAT(ADRESSE),&apos;,&apos;,&apos;;&apos;)                                                                                                                                                                                                                                                                                                         &lt;br/&gt;    INTO v_mail_cc                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;    FROM T_FDSL_MAIL                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;    WHERE APPLICATION=&apos;FACTU_SF&apos;                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;      AND TYPE_ACTION=&apos;CUSTOMER&apos;                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;      AND POSITION=&apos;CC&apos;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    ;                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN NO_DATA_FOUND THEN                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;      v_mail_cc := NULL;                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      RAISE_APPLICATION_ERROR(-20022,&apos;Problème lors de la récupération mails CC ADV&apos;||SQLERRM);                                                                                                                                                                                                                                                                &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  IF v_mail_dest IS NOT NULL THEN                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;    v_mail_dest := &apos;;&apos;||v_mail_dest;                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;  END IF;                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    UPDATE T_FDSL_DETAIL_FACTURE                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;    SET MAIL_DEST = MAIL_DEST||v_mail_dest,                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;        MAIL_CC = DECODE(MAIL_CC,NULL,v_mail_cc,MAIL_CC||DECODE(v_mail_cc,NULL,NULL,&apos;;&apos;||v_mail_cc))                                                                                                                                                                                                                                                           &lt;br/&gt;    WHERE                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;         MAIL_DEST IS NOT NULL;                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      RAISE_APPLICATION_ERROR(-20023,&apos;Problème lors de la mise à jour des mails&apos;||SQLERRM);                                                                                                                                                                                                                                                                    &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;END P_UpdateDetailMail;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;PROCEDURE P_InsertFactureSF(pDateCalcFactu IN DATE) IS                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  -- Insertion des nouvelles données fraîche issues de SalesForce                                                                                                                                                                                                                                                                                              &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    P_InsertServiceSF(pDateCalcFactu);                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      RAISE_APPLICATION_ERROR(-20000,&apos;Problème lors du chargement de la table T_FDSL_SERVICE_SF &apos;||SQLERRM);                                                                                                                                                                                                                                                   &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  -- Insertion des données dans la table des détails de facturation, c&apos;est là le plus gros du traitement par les tests et calculs effectués                                                                                                                                                                                                                    &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    P_InsertDetailFactu(pDateCalcFactu);                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      RAISE_APPLICATION_ERROR(-20010,&apos;Problème lors du chargement de la table T_FDSL_DETAIL_FACTURE &apos;||SQLERRM);                                                                                                                                                                                                                                               &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  -- Mise à jour des mails destinataires et CC avec les données présentes dans la table T_FDSL_MAIL                                                                                                                                                                                                                                                            &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    P_UpdateDetailMail;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      RAISE_APPLICATION_ERROR(-20020,&apos;Problème lors de la mise à jour des mails ADV &apos;||SQLERRM);                                                                                                                                                                                                                                                               &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  -- Insertion dans la table de récapitulatif T_FDSL_RECAP_FACTURE                                                                                                                                                                                                                                                                                             &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    P_InsertRecapFactu;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      RAISE_APPLICATION_ERROR(-20030,&apos;Problème lors du chargement de la table T_FDSL_RECAP_FACTURE &apos;||SQLERRM);                                                                                                                                                                                                                                                &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;END P_InsertFactureSF;                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;PROCEDURE P_ArchiFactureSF(pMois IN NUMBER, pAnnee IN NUMBER) IS                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  -- Archivage des données sources issues de Salesforce                                                                                                                                                                                                                                                                                                        &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    P_ArchiServiceSF(pMois,pAnnee);                                                                                                                                                                                                                                                                                                                            &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      RAISE_APPLICATION_ERROR(-20040,&apos;Problème l&apos;&apos;archivage de la table T_FDSL_SERVICE_SF &apos;||SQLERRM);                                                                                                                                                                                                                                                         &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;  -- Archivage des tables de facturation                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    P_ArchiDetailRecap(pMois,pAnnee);                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      RAISE_APPLICATION_ERROR(-20050,&apos;Problème lors de l&apos;&apos;archivage des tables T_FDSL_DETAIL_FACTURE et T_FDSL_RECAP_FACTURE &apos;||SQLERRM);                                                                                                                                                                                                                      &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt; BEGIN                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;    P_ArchiComptaFactu(pMois,pAnnee);                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      RAISE_APPLICATION_ERROR(-20051,&apos;Problème lors de l&apos;&apos;archivage des tables T_FDSL_COMPTA_FACTURE&apos;||SQLERRM);                                                                                                                                                                                                                                               &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;END P_ArchiFactureSF;                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;PROCEDURE P_UpdateMailDetailNewLigne( listIdService varchar2) IS                                                                                                                                                                                                                                                                                               &lt;br/&gt; v_mail_dest VARCHAR2(4000);                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;  v_mail_cc VARCHAR2(4000);                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;BEGIN                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;    SELECT TRANSLATE(WMSYS.WM_CONCAT(ADRESSE),&apos;,&apos;,&apos;;&apos;)                                                                                                                                                                                                                                                                                                         &lt;br/&gt;    INTO v_mail_dest                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;    FROM T_FDSL_MAIL                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;    WHERE APPLICATION=&apos;FACTU_SF&apos;                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;      AND TYPE_ACTION=&apos;CUSTOMER&apos;                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;      AND POSITION=&apos;DEST&apos;                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;    ;                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN NO_DATA_FOUND THEN                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;      v_mail_dest := NULL;                                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      RAISE_APPLICATION_ERROR(-20021,&apos;Problème lors de la récupération mails destinataire ADV&apos;||SQLERRM);                                                                                                                                                                                                                                                      &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;   IF v_mail_dest IS NOT NULL THEN                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;    v_mail_dest := &apos;;&apos;||v_mail_dest;                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;  END IF;                                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    SELECT TRANSLATE(WMSYS.WM_CONCAT(ADRESSE),&apos;,&apos;,&apos;;&apos;)                                                                                                                                                                                                                                                                                                         &lt;br/&gt;    INTO v_mail_cc                                                                                                                                                                                                                                                                                                                                             &lt;br/&gt;    FROM T_FDSL_MAIL                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;    WHERE APPLICATION=&apos;FACTU_SF&apos;                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;      AND TYPE_ACTION=&apos;CUSTOMER&apos;                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;      AND POSITION=&apos;CC&apos;                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;    ;                                                                                                                                                                                                                                                                                                                                                          &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN NO_DATA_FOUND THEN                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;      v_mail_cc := NULL;                                                                                                                                                                                                                                                                                                                                       &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      RAISE_APPLICATION_ERROR(-20022,&apos;Problème lors de la récupération mails CC ADV&apos;||SQLERRM);                                                                                                                                                                                                                                                                &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  BEGIN                                                                                                                                                                                                                                                                                                                                                        &lt;br/&gt;      update                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;      t_fdsl_detail_facture                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;      set (mail_dest, mail_cc)=                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;        (select                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;        distinct mails_dest_d_tail_factu__c||v_mail_dest,                                                                                                                                                                                                                                                                                                      &lt;br/&gt;        DECODE(MAILS_COPIES_D_TAIL_FACTU__C,NULL,v_mail_cc,MAILS_COPIES_D_TAIL_FACTU__C||DECODE(v_mail_cc,NULL,NULL,&apos;;&apos;||v_mail_cc))                                                                                                                                                                                                                           &lt;br/&gt;        from                                                                                                                                                                                                                                                                                                                                                   &lt;br/&gt;        t_fdsl_service_sf                                                                                                                                                                                                                                                                                                                                      &lt;br/&gt;        where                                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;        ID_SERVICE__C=ID_SERVICE)                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;            where                                                                                                                                                                                                                                                                                                                                              &lt;br/&gt;            mail_dest is null                                                                                                                                                                                                                                                                                                                                  &lt;br/&gt;            and                                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;            ID_SERVICE in (listIdService);                                                                                                                                                                                                                                                                                                                     &lt;br/&gt;  EXCEPTION                                                                                                                                                                                                                                                                                                                                                    &lt;br/&gt;    WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           &lt;br/&gt;      RAISE_APPLICATION_ERROR(-20070,&apos;Problème lors de la mise à jour du mail CC et Destinataire pour ID service &apos;||listIdService||&apos; : &apos;||SQLERRM);                                                                                                                                                                                                            &lt;br/&gt;                                                                                                                                                                                                                                                                                                                                                               &lt;br/&gt;  END;                                                                                                                                                                                                                                                                                                                                                         &lt;br/&gt;END P_UpdateMailDetailNewLigne;                                                                                                                                                                                                                                                                                                                                &lt;br/&gt;&lt;br/&gt;PROCEDURE P_MAJ_MONTANT &lt;br/&gt;( P_ID_FDSL_DETAIL_FACTURE IN Number&lt;br/&gt;, P_CONSOMMATION IN Number  &lt;br/&gt;, P_TARIF_FORFAIT IN Number  &lt;br/&gt;, P_SEUIL IN Number  &lt;br/&gt;, P_TARIF_DEPASS IN Number&lt;br/&gt;) IS &lt;br/&gt;&lt;br/&gt;BEGIN&lt;br/&gt;--insert into tab1 values(P_ID_FDSL_DETAIL_FACTURE,P_CONSOMMATION,P_TARIF_FORFAIT,P_SEUIL,P_TARIF_DEPASS,sysdate);&lt;br/&gt;&lt;br/&gt;IF nvl(P_CONSOMMATION,0) != 0 Then&lt;br/&gt;&lt;br/&gt;UPDATE AXIONEUSER_FACTU.T_FDSL_DETAIL_FACTURE&lt;br/&gt;SET MONTANT = nvl(P_TARIF_FORFAIT,0) +((P_CONSOMMATION - P_SEUIL)* (P_TARIF_DEPASS))&lt;br/&gt;WHERE id_fdsl_detail_facture=P_ID_FDSL_DETAIL_FACTURE;&lt;br/&gt;&lt;br/&gt;END IF;&lt;br/&gt; &lt;br/&gt;Commit;&lt;br/&gt;END P_MAJ_MONTANT;&lt;br/&gt;&lt;br/&gt;END PCK_FACTU_PRO;&lt;br/&gt;/</source>
</body>
</PackageOracle>