<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.StoredProcedureOraclev10g" name="PROC_CREATION_ABONNEMENT_SDSL" id="A1212B57-9D7A-2F90-802D-F597E19E9A75" directorySegmentName="seg_0">
<sourceConnName>DEV57_AXIONEUSER_FACTU</sourceConnName>
<sourceObjSchema>AXIONEUSER_FACTU</sourceObjSchema>
<sourceObjName>PROC_CREATION_ABONNEMENT_SDSL</sourceObjName>
<createdBy>R.WATH</createdBy>
<createdTime>2012-12-04 10:06:38 UTC</createdTime>
<generatorID>Généré par l&apos;utilisateur</generatorID>
<ownerDesignName>ST-SYS-SIB-BD_FCTPRO-000009-8 MCD-FACTUPRO V4.5.0</ownerDesignName>
<owner>4FCC3A6A-181E-A36A-613B-7868309493E2</owner>
<source>CREATE OR REPLACE PROCEDURE                    AXIONEUSER_FACTU.PROC_CREATION_ABONNEMENT_SDSL (DATE_MOIS in date, LIGNE_SERVICE in varchar  ) AS&lt;br/&gt;BEGIN&lt;br/&gt;&lt;br/&gt;begin&lt;br/&gt;INSERT INTO&lt;br/&gt;T_FDSL_FACTURATION (DATE_FACTURATION&lt;br/&gt;, id_fdsl_offres&lt;br/&gt;,TYPE_CHARGE&lt;br/&gt;,IDENTITE&lt;br/&gt;,ID_SERVICE2&lt;br/&gt;,VIA&lt;br/&gt;,TYPE_TECHNO&lt;br/&gt;,TYPE_DEGROUPAGE&lt;br/&gt;,DATE_MES&lt;br/&gt;,DATE_RESIL&lt;br/&gt;,NOM_DSP&lt;br/&gt;,NRA&lt;br/&gt;,PROFIL&lt;br/&gt;,CODE_CHARGE&lt;br/&gt;,MONTANT_HT&lt;br/&gt;,ID_SERVICE&lt;br/&gt;,ETAT_SERVICE&lt;br/&gt;,NOM_FAI, DATE_CMDE, PLOT,&lt;br/&gt;ADRESSE, RIVOLI&lt;br/&gt;, CODE_INSEE&lt;br/&gt;, CODE_POSTAL&lt;br/&gt;, COMMUNE&lt;br/&gt;,NUM_VOIE&lt;br/&gt;,VIA_GTR)&lt;br/&gt;&lt;br/&gt;(select distinct&lt;br/&gt;DATE_MOIS date_facturation,&lt;br/&gt;offres.id_fdsl_offres,&lt;br/&gt;&apos;ABO&apos;,&lt;br/&gt;t2.NOM_PRENOM_OU_RAISON_SOCIALE IDENTITE,&lt;br/&gt;t1.ID_SERVICE2,&lt;br/&gt;CASE WHEN ID_SERVICE like &apos;VIA%&apos;&lt;br/&gt;then&lt;br/&gt;ID_SERVICE&lt;br/&gt;else NULL&lt;br/&gt;end&lt;br/&gt;VIA,&lt;br/&gt;t1.nom_service type_techno,&lt;br/&gt;&apos;TOTAL&apos;,&lt;br/&gt;date_MES date_MES,&lt;br/&gt;NULL date_resil,&lt;br/&gt;/*date_resil date_resil,*/&lt;br/&gt;nom_dsp,&lt;br/&gt;t10.CODE_SITE NRA,&lt;br/&gt;t16.NOM_PRODUIT_COMMERCIAL PROFIL,&lt;br/&gt;offres.ref_produit CODE_CHARGE,&lt;br/&gt;offres.tarif MONTANT_HT,&lt;br/&gt;t1.id_service,&lt;br/&gt;--&apos;ACTIF&apos; etat_service,&lt;br/&gt;/*t1.etat_service,*/&lt;br/&gt;&apos;ACCES&apos; etat_service,&lt;br/&gt;nom_fai, t6.date_cmde, t6.port,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,28)+1, instr(t6.ligne,&apos;;&apos;,1,29)-instr(t6.ligne,&apos;;&apos;,1,28)-1) as ADRESSE,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,29)+1, instr(t6.ligne,&apos;;&apos;,1,30)-instr(t6.ligne,&apos;;&apos;,1,29)-1) as RIVOLI,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,37)+1, instr(t6.ligne,&apos;;&apos;,1,38)-instr(t6.ligne,&apos;;&apos;,1,37)-1) as CODE_INSEE,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,38)+1, instr(t6.ligne,&apos;;&apos;,1,39)-instr(t6.ligne,&apos;;&apos;,1,38)-1) as CODE_POSTAL,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,39)+1, instr(t6.ligne,&apos;;&apos;,1,40)-instr(t6.ligne,&apos;;&apos;,1,39)-1) as COMMUNE,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,30)+1, instr(t6.ligne,&apos;;&apos;,1,31)-instr(t6.ligne,&apos;;&apos;,1,30)-1) as NUM_VOIE,&lt;br/&gt;t6.IDEXTERNESAV as VIA_GTR&lt;br/&gt;from s_com_service_axione t1&lt;br/&gt;inner join s_com_utilisateur t2 on t1.id_utilisateur=t2.id&lt;br/&gt;left join s_com_produit t3 on t1.id_produit=t3.id&lt;br/&gt;left join s_com_site_utilisateur t4 on t2.id=t4.id_utilisateur&lt;br/&gt;left join s_com_adresse_ft t5 on t4.id= t5.id_site&lt;br/&gt;--left join s_com_facturation t6 on t6.id_service_axione=t1.id&lt;br/&gt;left join S_TEMP_FOP_FACTU_SDSL t6 on t1.commande_initiale=t6.idcommande&lt;br/&gt;left join s_com_fai t7 on t1.id_fai=t7.id&lt;br/&gt;left join s_com_cpe t8 on t2.id=t8.id_site&lt;br/&gt;left join s_com_contrat_fai t9 on t9.id_fai=t7.id&lt;br/&gt;left join v_com_site_raccordement t10 on t10.id=t4.id_site_racco&lt;br/&gt;left join s_com_dsp t11 on t11.id=t1.id_dsp&lt;br/&gt;left join s_com_ligne_produit t12 on t12.id=t3.id_ligne_produit&lt;br/&gt;left join s_com_ligne_service t13 on t13.id=t12.id_ligne_service&lt;br/&gt;left outer join s_com_tech_produit t16 on t16.id=t3.id_produit&lt;br/&gt;inner join (select * from T_FDSL_OFFRES&lt;br/&gt;          -- where Date_Debut&lt;=Date_Mois&lt;br/&gt;          --and (NVL(date_fin,trunc(add_months(sysdate,0)))&gt;=DATE_MOIS)&lt;br/&gt;		  )  offres&lt;br/&gt;          on trim(offres.ref_produit)=trim(t3.ref_produit)&lt;br/&gt;          and trim(offres.zone_densite)=NVL(t10.zone_densite,&apos;DENSE&apos;)&lt;br/&gt;          and t6.date_cmde &gt;= offres.Date_Debut&lt;br/&gt;          and t6.date_cmde &lt; NVL(offres.date_fin,trunc(add_months(sysdate,0)))&lt;br/&gt;          and t11.id= offres.id_fdsl_dsp and t6.nbpaires=offres.id_fdsl_paire&lt;br/&gt;where nom_ligne_service=LIGNE_SERVICE and&lt;br/&gt;(date_resil is null or add_months(trunc(date_resil,&apos;MONTH&apos;),0)&gt;=trunc(DATE_MOIS,&apos;MONTH&apos;))&lt;br/&gt;and t1.etat_service in (&apos;ACTIF&apos;,&apos;RESILIE&apos;) and t1.id_service  not in&lt;br/&gt;(select id_service from S_COM_SERVICE_AXIONE service where ETAT_SERVICE in (&apos;INVALIDE&apos;))&lt;br/&gt;and trunc(date_MES,&apos;MONTH&apos;)&lt;=(add_months(DATE_MOIS,-2))&lt;br/&gt;and&lt;br/&gt; (&lt;br/&gt; (t1.ID_SERVICE=ID_SERVICE and t1.ID_SERVICE like &apos;VIA%&apos;)&lt;br/&gt; or t1.ID_SERVICE not like &apos;VIA%&apos;)&lt;br/&gt;and nom_fai = &apos;NEUF CEGETEL&apos;&lt;br/&gt;and t6.typecr=&apos;OK&apos;&lt;br/&gt;--order by IDENTITE, id_service,NDI,offres.ref_produit&lt;br/&gt;);&lt;br/&gt;exception when others then null;&lt;br/&gt;end;&lt;br/&gt;&lt;br/&gt;&lt;br/&gt;begin&lt;br/&gt;INSERT INTO&lt;br/&gt;t_FDSL_FACTURATION (DATE_FACTURATION&lt;br/&gt;, id_fdsl_offres&lt;br/&gt;,TYPE_CHARGE&lt;br/&gt;,IDENTITE&lt;br/&gt;,ID_SERVICE2&lt;br/&gt;,VIA&lt;br/&gt;,TYPE_TECHNO&lt;br/&gt;,TYPE_DEGROUPAGE&lt;br/&gt;,DATE_MES&lt;br/&gt;,DATE_RESIL&lt;br/&gt;,NOM_DSP&lt;br/&gt;,NRA&lt;br/&gt;,PROFIL&lt;br/&gt;,CODE_CHARGE&lt;br/&gt;,MONTANT_HT&lt;br/&gt;,ID_SERVICE&lt;br/&gt;,ETAT_SERVICE&lt;br/&gt;,NOM_FAI&lt;br/&gt;,ID_FDSL_OFFRES_OLD&lt;br/&gt;, code_charge_old)&lt;br/&gt;(&lt;br/&gt;select distinct&lt;br/&gt;DATE_MOIS date_facturation,&lt;br/&gt;service_changement_produit.id_fdsl_offres,&lt;br/&gt;&apos;ABO&apos;,&lt;br/&gt;service_changement_produit.IDENTITE,&lt;br/&gt;service_changement_produit.ID_SERVICE2,&lt;br/&gt;CASE WHEN service_changement_produit.ID_SERVICE like &apos;VIA%&apos;&lt;br/&gt;then&lt;br/&gt;service_changement_produit.ID_SERVICE&lt;br/&gt;else NULL&lt;br/&gt;end,&lt;br/&gt;service_changement_produit.nom_service type_techno,&lt;br/&gt;&apos;TOTAL&apos;,&lt;br/&gt;service_invalide.date_MES date_souscription,&lt;br/&gt;service_changement_produit.date_MES date_changement,&lt;br/&gt;service_changement_produit.nom_dsp,&lt;br/&gt;service_changement_produit.CODE_SITE NRA,&lt;br/&gt;service_changement_produit.NOM_PRODUIT_COMMERCIAL PROFIL,&lt;br/&gt;service_changement_produit.ref_produit CODE_CHARGE,&lt;br/&gt;CASE WHEN service_changement_produit.tarif &gt;= service_invalide.tarif&lt;br/&gt;then service_changement_produit.tarif&lt;br/&gt;      WHEN service_changement_produit.tarif&lt;service_invalide.tarif and trunc(service_changement_produit.date_mes,&apos;MONTH&apos;)&gt;=(add_months(DATE_MOIS,-3))&lt;br/&gt;then service_INVALIDE.tarif&lt;br/&gt;      WHEN service_changement_produit.tarif&lt;service_invalide.tarif and trunc(service_changement_produit.date_mes,&apos;MONTH&apos;)&lt;(add_months(DATE_MOIS,-3))&lt;br/&gt;then service_changement_produit.tarif&lt;br/&gt;ELSE&lt;br/&gt;service_changement_produit.tarif&lt;br/&gt;end montant_ht,&lt;br/&gt;service_changement_produit.ID_SERVICE,&lt;br/&gt;--&apos;ACTIF&apos; etat_service,&lt;br/&gt;&apos;ACCES&apos; etat_service,&lt;br/&gt;/*service_changement_produit.etat_service,*/&lt;br/&gt;service_changement_produit.nom_fai,&lt;br/&gt;service_invalide.id_fdsl_offres_old,&lt;br/&gt;service_invalide.ref_produit_old&lt;br/&gt;from&lt;br/&gt;(&lt;br/&gt;select distinct&lt;br/&gt;offres.id_fdsl_offres,&lt;br/&gt;offres.tarif,&lt;br/&gt;t2.NOM_PRENOM_OU_RAISON_SOCIALE IDENTITE,&lt;br/&gt;t1.ID_SERVICE2,&lt;br/&gt;CASE WHEN ID_SERVICE like &apos;VIA%&apos;&lt;br/&gt;then&lt;br/&gt;ID_SERVICE&lt;br/&gt;else NULL&lt;br/&gt;end&lt;br/&gt;VIA,&lt;br/&gt;t1.nom_service ,&lt;br/&gt;t16.type_degroupage,&lt;br/&gt;t16.NOM_PRODUIT_COMMERCIAL PROFIL,&lt;br/&gt;offres.ref_produit CODE_CHARGE,&lt;br/&gt;date_MES date_changement_service,&lt;br/&gt;date_MES,&lt;br/&gt;t11.nom_dsp, t10.CODE_SITE, t16.NOM_PRODUIT_COMMERCIAL,&lt;br/&gt;T1.ID_SERVICE,T1.etat_service,nom_fai, t3.ref_produit, t3.id_ligne_produit,nom_ligne_produit&lt;br/&gt;from s_com_service_axione t1&lt;br/&gt;inner join s_com_utilisateur t2 on t1.id_utilisateur=t2.id&lt;br/&gt;left join s_com_produit t3 on t1.id_produit=t3.id&lt;br/&gt;left join s_com_site_utilisateur t4 on t2.id=t4.id_utilisateur&lt;br/&gt;left join s_com_adresse_ft t5 on t4.id= t5.id_site&lt;br/&gt;--left join s_com_facturation t6 on t6.id_service_axione=t1.id&lt;br/&gt;left join S_TEMP_FOP_FACTU_SDSL t6 on t1.commande_initiale=t6.idcommande&lt;br/&gt;left join s_com_fai t7 on t1.id_fai=t7.id&lt;br/&gt;left join s_com_cpe t8 on t2.id=t8.id_site&lt;br/&gt;left join s_com_contrat_fai t9 on t9.id_fai=t7.id&lt;br/&gt;left join v_com_site_raccordement t10 on t10.id=t4.id_site_racco&lt;br/&gt;left join s_com_dsp t11 on t11.id=t1.id_dsp&lt;br/&gt;left join s_com_ligne_produit t12 on t12.id=t3.id_ligne_produit&lt;br/&gt;left join s_com_ligne_service t13 on t13.id=t12.id_ligne_service&lt;br/&gt;Left Outer Join S_Com_Tech_Produit T16 On T16.Id=T3.Id_Produit&lt;br/&gt;inner Join (Select * From T_Fdsl_Offres&lt;br/&gt;			--Where Date_Debut&lt;=Date_Mois&lt;br/&gt;          --and (NVL(date_fin,trunc(add_months(sysdate+1,0)))&gt;DATE_MOIS)&lt;br/&gt;		  )  offres&lt;br/&gt;          on trim(offres.ref_produit)=trim(t3.ref_produit) and trim(offres.zone_densite)=NVL(t10.zone_densite,&apos;DENSE&apos;)&lt;br/&gt;where nom_ligne_service=&apos;LIGNE SDSL&apos;&lt;br/&gt;and (date_resil is null or add_months(trunc(date_resil,&apos;MONTH&apos;),0)&gt;=trunc(DATE_MOIS,&apos;MONTH&apos;))&lt;br/&gt;and t1.etat_service in (&apos;ACTIF&apos;,&apos;RESILIE&apos;)&lt;br/&gt;and t1.id_service in (select id_service from s_com_SERVICE_AXIONE service&lt;br/&gt;where ETAT_SERVICE in (&apos;INVALIDE&apos;))&lt;br/&gt;order by NOM_PRENOM_OU_RAISON_SOCIALE, id_service) service_changement_produit,&lt;br/&gt;(select offres.ref_produit ref_produit_old,&lt;br/&gt;offres.id_fdsl_offres id_fdsl_offres_old,&lt;br/&gt; offres.tarif,&lt;br/&gt; id_service,&lt;br/&gt; nom_service,etat_service,&lt;br/&gt; nom_produit,&lt;br/&gt; t3.id_ligne_produit,&lt;br/&gt;&lt;br/&gt;NOM_PRENOM_OU_RAISON_SOCIALE,NUM_VOIE,CODE_POSTAL,COMMUNE,&lt;br/&gt;NOM_VOIE,nature,caracteristique_commande,t2.id id_utilisateur_site,&lt;br/&gt;t2.id id_utilisateur_abonne,date_MES,--date_mise_en_facturation,&lt;br/&gt;date_resil,nom_fai,t8.num_serie,nom_dsp,t3.ref_produit,nom_ligne_produit,&lt;br/&gt;origine_resiliation,nom_ligne_service&lt;br/&gt;from s_com_service_axione t1&lt;br/&gt;inner join s_com_utilisateur t2 on t1.id_utilisateur=t2.id&lt;br/&gt;left join s_com_produit t3 on t1.id_produit=t3.id&lt;br/&gt;left join s_com_site_utilisateur t4 on t2.id=t4.id_utilisateur&lt;br/&gt;left join s_com_adresse_ft t5 on t4.id= t5.id_site&lt;br/&gt;--left join s_com_facturation t6 on t6.id_service_axione=t1.id&lt;br/&gt;left join S_TEMP_FOP_FACTU_SDSL t6 on t1.commande_initiale=t6.idcommande&lt;br/&gt;left join s_com_fai t7 on t1.id_fai=t7.id&lt;br/&gt;left join s_com_cpe t8 on t2.id=t8.id_site&lt;br/&gt;left join s_com_contrat_fai t9 on t9.id_fai=t7.id&lt;br/&gt;left join v_com_site_raccordement t10 on t10.id=t4.id_site_racco&lt;br/&gt;left join s_com_dsp t11 on t11.id=t1.id_dsp&lt;br/&gt;left join s_com_ligne_produit t12 on t12.id=t3.id_ligne_produit&lt;br/&gt;left join s_com_ligne_service t13 on t13.id=t12.id_ligne_service&lt;br/&gt;left  join (select * from T_FDSL_OFFRES&lt;br/&gt;          )  offres on trim(offres.ref_produit)=trim(t3.ref_produit)&lt;br/&gt;          and trim(offres.zone_densite)=NVL(t10.zone_densite,&apos;DENSE&apos;)&lt;br/&gt;          and t6.date_cmde &gt;= offres.Date_Debut&lt;br/&gt;          and t6.date_cmde &lt; NVL(offres.date_fin,trunc(add_months(sysdate,0)))&lt;br/&gt;          and t11.id= offres.id_fdsl_dsp and t6.nbpaires=offres.id_fdsl_paire&lt;br/&gt;where nom_ligne_service=LIGNE_SERVICE and date_resil is null&lt;br/&gt;--and&lt;br/&gt;--offres.date_debut&lt;=t1.DATE_MES&lt;br/&gt;and (NVL(offres.date_fin,trunc(add_months(sysdate,0)))&gt;t1.DATE_MES)&lt;br/&gt;and etat_service in (&apos;INVALIDE&apos;) and date_mes in (select max(date_mes) from s_com_service_axione serv where etat_service in (&apos;INVALIDE&apos;) and serv.id_service=t1.id_service)&lt;br/&gt;order by NOM_PRENOM_OU_RAISON_SOCIALE, id_service) service_invalide&lt;br/&gt;where service_invalide.id_service=service_changement_produit.id_service&lt;br/&gt;--and service_invalide.date_MES!=service_changement_produit.date_MES&lt;br/&gt;--and service_invalide.ref_produit!=service_changement_produit.ref_produit&lt;br/&gt;&lt;br/&gt;and  service_invalide.id_ligne_produit=service_changement_produit.id_ligne_produit&lt;br/&gt;and&lt;br/&gt; (&lt;br/&gt; (service_changement_produit.ID_SERVICE=service_changement_produit.ID_SERVICE&lt;br/&gt; and service_changement_produit.ID_SERVICE like &apos;VIA%&apos;)&lt;br/&gt; or service_changement_produit.ID_SERVICE not like &apos;VIA%&apos;)&lt;br/&gt;&lt;br/&gt;--and id_fdsl_offres!=id_fdsl_offres_old&lt;br/&gt;and (trunc(service_changement_produit.date_MES,&apos;MONTH&apos;)&lt;(add_months(DATE_MOIS,-1))&lt;br/&gt;or (service_changement_produit.date_MES is NULL and trunc(service_invalide.date_MES,&apos;MONTH&apos;)&lt;(add_months(DATE_MOIS,0)))&lt;br/&gt;)&lt;br/&gt;--order by IDENTITE, service_changement_produit.id_service&lt;br/&gt;);&lt;br/&gt;exception when others then null;&lt;br/&gt;end;&lt;br/&gt;&lt;br/&gt;END PROC_CREATION_ABONNEMENT_SDSL;</source>
<body>CREATE OR REPLACE PROCEDURE                    AXIONEUSER_FACTU.PROC_CREATION_ABONNEMENT_SDSL (DATE_MOIS in date, LIGNE_SERVICE in varchar  ) AS&lt;br/&gt;BEGIN&lt;br/&gt;&lt;br/&gt;begin&lt;br/&gt;INSERT INTO&lt;br/&gt;T_FDSL_FACTURATION (DATE_FACTURATION&lt;br/&gt;, id_fdsl_offres&lt;br/&gt;,TYPE_CHARGE&lt;br/&gt;,IDENTITE&lt;br/&gt;,ID_SERVICE2&lt;br/&gt;,VIA&lt;br/&gt;,TYPE_TECHNO&lt;br/&gt;,TYPE_DEGROUPAGE&lt;br/&gt;,DATE_MES&lt;br/&gt;,DATE_RESIL&lt;br/&gt;,NOM_DSP&lt;br/&gt;,NRA&lt;br/&gt;,PROFIL&lt;br/&gt;,CODE_CHARGE&lt;br/&gt;,MONTANT_HT&lt;br/&gt;,ID_SERVICE&lt;br/&gt;,ETAT_SERVICE&lt;br/&gt;,NOM_FAI, DATE_CMDE, PLOT,&lt;br/&gt;ADRESSE, RIVOLI&lt;br/&gt;, CODE_INSEE&lt;br/&gt;, CODE_POSTAL&lt;br/&gt;, COMMUNE&lt;br/&gt;,NUM_VOIE&lt;br/&gt;,VIA_GTR)&lt;br/&gt;&lt;br/&gt;(select distinct&lt;br/&gt;DATE_MOIS date_facturation,&lt;br/&gt;offres.id_fdsl_offres,&lt;br/&gt;&apos;ABO&apos;,&lt;br/&gt;t2.NOM_PRENOM_OU_RAISON_SOCIALE IDENTITE,&lt;br/&gt;t1.ID_SERVICE2,&lt;br/&gt;CASE WHEN ID_SERVICE like &apos;VIA%&apos;&lt;br/&gt;then&lt;br/&gt;ID_SERVICE&lt;br/&gt;else NULL&lt;br/&gt;end&lt;br/&gt;VIA,&lt;br/&gt;t1.nom_service type_techno,&lt;br/&gt;&apos;TOTAL&apos;,&lt;br/&gt;date_MES date_MES,&lt;br/&gt;NULL date_resil,&lt;br/&gt;/*date_resil date_resil,*/&lt;br/&gt;nom_dsp,&lt;br/&gt;t10.CODE_SITE NRA,&lt;br/&gt;t16.NOM_PRODUIT_COMMERCIAL PROFIL,&lt;br/&gt;offres.ref_produit CODE_CHARGE,&lt;br/&gt;offres.tarif MONTANT_HT,&lt;br/&gt;t1.id_service,&lt;br/&gt;--&apos;ACTIF&apos; etat_service,&lt;br/&gt;/*t1.etat_service,*/&lt;br/&gt;&apos;ACCES&apos; etat_service,&lt;br/&gt;nom_fai, t6.date_cmde, t6.port,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,28)+1, instr(t6.ligne,&apos;;&apos;,1,29)-instr(t6.ligne,&apos;;&apos;,1,28)-1) as ADRESSE,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,29)+1, instr(t6.ligne,&apos;;&apos;,1,30)-instr(t6.ligne,&apos;;&apos;,1,29)-1) as RIVOLI,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,37)+1, instr(t6.ligne,&apos;;&apos;,1,38)-instr(t6.ligne,&apos;;&apos;,1,37)-1) as CODE_INSEE,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,38)+1, instr(t6.ligne,&apos;;&apos;,1,39)-instr(t6.ligne,&apos;;&apos;,1,38)-1) as CODE_POSTAL,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,39)+1, instr(t6.ligne,&apos;;&apos;,1,40)-instr(t6.ligne,&apos;;&apos;,1,39)-1) as COMMUNE,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,30)+1, instr(t6.ligne,&apos;;&apos;,1,31)-instr(t6.ligne,&apos;;&apos;,1,30)-1) as NUM_VOIE,&lt;br/&gt;t6.IDEXTERNESAV as VIA_GTR&lt;br/&gt;from s_com_service_axione t1&lt;br/&gt;inner join s_com_utilisateur t2 on t1.id_utilisateur=t2.id&lt;br/&gt;left join s_com_produit t3 on t1.id_produit=t3.id&lt;br/&gt;left join s_com_site_utilisateur t4 on t2.id=t4.id_utilisateur&lt;br/&gt;left join s_com_adresse_ft t5 on t4.id= t5.id_site&lt;br/&gt;--left join s_com_facturation t6 on t6.id_service_axione=t1.id&lt;br/&gt;left join S_TEMP_FOP_FACTU_SDSL t6 on t1.commande_initiale=t6.idcommande&lt;br/&gt;left join s_com_fai t7 on t1.id_fai=t7.id&lt;br/&gt;left join s_com_cpe t8 on t2.id=t8.id_site&lt;br/&gt;left join s_com_contrat_fai t9 on t9.id_fai=t7.id&lt;br/&gt;left join v_com_site_raccordement t10 on t10.id=t4.id_site_racco&lt;br/&gt;left join s_com_dsp t11 on t11.id=t1.id_dsp&lt;br/&gt;left join s_com_ligne_produit t12 on t12.id=t3.id_ligne_produit&lt;br/&gt;left join s_com_ligne_service t13 on t13.id=t12.id_ligne_service&lt;br/&gt;left outer join s_com_tech_produit t16 on t16.id=t3.id_produit&lt;br/&gt;inner join (select * from T_FDSL_OFFRES&lt;br/&gt;          -- where Date_Debut&lt;=Date_Mois&lt;br/&gt;          --and (NVL(date_fin,trunc(add_months(sysdate,0)))&gt;=DATE_MOIS)&lt;br/&gt;		  )  offres&lt;br/&gt;          on trim(offres.ref_produit)=trim(t3.ref_produit)&lt;br/&gt;          and trim(offres.zone_densite)=NVL(t10.zone_densite,&apos;DENSE&apos;)&lt;br/&gt;          and t6.date_cmde &gt;= offres.Date_Debut&lt;br/&gt;          and t6.date_cmde &lt; NVL(offres.date_fin,trunc(add_months(sysdate,0)))&lt;br/&gt;          and t11.id= offres.id_fdsl_dsp and t6.nbpaires=offres.id_fdsl_paire&lt;br/&gt;where nom_ligne_service=LIGNE_SERVICE and&lt;br/&gt;(date_resil is null or add_months(trunc(date_resil,&apos;MONTH&apos;),0)&gt;=trunc(DATE_MOIS,&apos;MONTH&apos;))&lt;br/&gt;and t1.etat_service in (&apos;ACTIF&apos;,&apos;RESILIE&apos;) and t1.id_service  not in&lt;br/&gt;(select id_service from S_COM_SERVICE_AXIONE service where ETAT_SERVICE in (&apos;INVALIDE&apos;))&lt;br/&gt;and trunc(date_MES,&apos;MONTH&apos;)&lt;=(add_months(DATE_MOIS,-2))&lt;br/&gt;and&lt;br/&gt; (&lt;br/&gt; (t1.ID_SERVICE=ID_SERVICE and t1.ID_SERVICE like &apos;VIA%&apos;)&lt;br/&gt; or t1.ID_SERVICE not like &apos;VIA%&apos;)&lt;br/&gt;and nom_fai = &apos;NEUF CEGETEL&apos;&lt;br/&gt;and t6.typecr=&apos;OK&apos;&lt;br/&gt;--order by IDENTITE, id_service,NDI,offres.ref_produit&lt;br/&gt;);&lt;br/&gt;exception when others then null;&lt;br/&gt;end;&lt;br/&gt;&lt;br/&gt;&lt;br/&gt;begin&lt;br/&gt;INSERT INTO&lt;br/&gt;t_FDSL_FACTURATION (DATE_FACTURATION&lt;br/&gt;, id_fdsl_offres&lt;br/&gt;,TYPE_CHARGE&lt;br/&gt;,IDENTITE&lt;br/&gt;,ID_SERVICE2&lt;br/&gt;,VIA&lt;br/&gt;,TYPE_TECHNO&lt;br/&gt;,TYPE_DEGROUPAGE&lt;br/&gt;,DATE_MES&lt;br/&gt;,DATE_RESIL&lt;br/&gt;,NOM_DSP&lt;br/&gt;,NRA&lt;br/&gt;,PROFIL&lt;br/&gt;,CODE_CHARGE&lt;br/&gt;,MONTANT_HT&lt;br/&gt;,ID_SERVICE&lt;br/&gt;,ETAT_SERVICE&lt;br/&gt;,NOM_FAI&lt;br/&gt;,ID_FDSL_OFFRES_OLD&lt;br/&gt;, code_charge_old)&lt;br/&gt;(&lt;br/&gt;select distinct&lt;br/&gt;DATE_MOIS date_facturation,&lt;br/&gt;service_changement_produit.id_fdsl_offres,&lt;br/&gt;&apos;ABO&apos;,&lt;br/&gt;service_changement_produit.IDENTITE,&lt;br/&gt;service_changement_produit.ID_SERVICE2,&lt;br/&gt;CASE WHEN service_changement_produit.ID_SERVICE like &apos;VIA%&apos;&lt;br/&gt;then&lt;br/&gt;service_changement_produit.ID_SERVICE&lt;br/&gt;else NULL&lt;br/&gt;end,&lt;br/&gt;service_changement_produit.nom_service type_techno,&lt;br/&gt;&apos;TOTAL&apos;,&lt;br/&gt;service_invalide.date_MES date_souscription,&lt;br/&gt;service_changement_produit.date_MES date_changement,&lt;br/&gt;service_changement_produit.nom_dsp,&lt;br/&gt;service_changement_produit.CODE_SITE NRA,&lt;br/&gt;service_changement_produit.NOM_PRODUIT_COMMERCIAL PROFIL,&lt;br/&gt;service_changement_produit.ref_produit CODE_CHARGE,&lt;br/&gt;CASE WHEN service_changement_produit.tarif &gt;= service_invalide.tarif&lt;br/&gt;then service_changement_produit.tarif&lt;br/&gt;      WHEN service_changement_produit.tarif&lt;service_invalide.tarif and trunc(service_changement_produit.date_mes,&apos;MONTH&apos;)&gt;=(add_months(DATE_MOIS,-3))&lt;br/&gt;then service_INVALIDE.tarif&lt;br/&gt;      WHEN service_changement_produit.tarif&lt;service_invalide.tarif and trunc(service_changement_produit.date_mes,&apos;MONTH&apos;)&lt;(add_months(DATE_MOIS,-3))&lt;br/&gt;then service_changement_produit.tarif&lt;br/&gt;ELSE&lt;br/&gt;service_changement_produit.tarif&lt;br/&gt;end montant_ht,&lt;br/&gt;service_changement_produit.ID_SERVICE,&lt;br/&gt;--&apos;ACTIF&apos; etat_service,&lt;br/&gt;&apos;ACCES&apos; etat_service,&lt;br/&gt;/*service_changement_produit.etat_service,*/&lt;br/&gt;service_changement_produit.nom_fai,&lt;br/&gt;service_invalide.id_fdsl_offres_old,&lt;br/&gt;service_invalide.ref_produit_old&lt;br/&gt;from&lt;br/&gt;(&lt;br/&gt;select distinct&lt;br/&gt;offres.id_fdsl_offres,&lt;br/&gt;offres.tarif,&lt;br/&gt;t2.NOM_PRENOM_OU_RAISON_SOCIALE IDENTITE,&lt;br/&gt;t1.ID_SERVICE2,&lt;br/&gt;CASE WHEN ID_SERVICE like &apos;VIA%&apos;&lt;br/&gt;then&lt;br/&gt;ID_SERVICE&lt;br/&gt;else NULL&lt;br/&gt;end&lt;br/&gt;VIA,&lt;br/&gt;t1.nom_service ,&lt;br/&gt;t16.type_degroupage,&lt;br/&gt;t16.NOM_PRODUIT_COMMERCIAL PROFIL,&lt;br/&gt;offres.ref_produit CODE_CHARGE,&lt;br/&gt;date_MES date_changement_service,&lt;br/&gt;date_MES,&lt;br/&gt;t11.nom_dsp, t10.CODE_SITE, t16.NOM_PRODUIT_COMMERCIAL,&lt;br/&gt;T1.ID_SERVICE,T1.etat_service,nom_fai, t3.ref_produit, t3.id_ligne_produit,nom_ligne_produit&lt;br/&gt;from s_com_service_axione t1&lt;br/&gt;inner join s_com_utilisateur t2 on t1.id_utilisateur=t2.id&lt;br/&gt;left join s_com_produit t3 on t1.id_produit=t3.id&lt;br/&gt;left join s_com_site_utilisateur t4 on t2.id=t4.id_utilisateur&lt;br/&gt;left join s_com_adresse_ft t5 on t4.id= t5.id_site&lt;br/&gt;--left join s_com_facturation t6 on t6.id_service_axione=t1.id&lt;br/&gt;left join S_TEMP_FOP_FACTU_SDSL t6 on t1.commande_initiale=t6.idcommande&lt;br/&gt;left join s_com_fai t7 on t1.id_fai=t7.id&lt;br/&gt;left join s_com_cpe t8 on t2.id=t8.id_site&lt;br/&gt;left join s_com_contrat_fai t9 on t9.id_fai=t7.id&lt;br/&gt;left join v_com_site_raccordement t10 on t10.id=t4.id_site_racco&lt;br/&gt;left join s_com_dsp t11 on t11.id=t1.id_dsp&lt;br/&gt;left join s_com_ligne_produit t12 on t12.id=t3.id_ligne_produit&lt;br/&gt;left join s_com_ligne_service t13 on t13.id=t12.id_ligne_service&lt;br/&gt;Left Outer Join S_Com_Tech_Produit T16 On T16.Id=T3.Id_Produit&lt;br/&gt;inner Join (Select * From T_Fdsl_Offres&lt;br/&gt;			--Where Date_Debut&lt;=Date_Mois&lt;br/&gt;          --and (NVL(date_fin,trunc(add_months(sysdate+1,0)))&gt;DATE_MOIS)&lt;br/&gt;		  )  offres&lt;br/&gt;          on trim(offres.ref_produit)=trim(t3.ref_produit) and trim(offres.zone_densite)=NVL(t10.zone_densite,&apos;DENSE&apos;)&lt;br/&gt;where nom_ligne_service=&apos;LIGNE SDSL&apos;&lt;br/&gt;and (date_resil is null or add_months(trunc(date_resil,&apos;MONTH&apos;),0)&gt;=trunc(DATE_MOIS,&apos;MONTH&apos;))&lt;br/&gt;and t1.etat_service in (&apos;ACTIF&apos;,&apos;RESILIE&apos;)&lt;br/&gt;and t1.id_service in (select id_service from s_com_SERVICE_AXIONE service&lt;br/&gt;where ETAT_SERVICE in (&apos;INVALIDE&apos;))&lt;br/&gt;order by NOM_PRENOM_OU_RAISON_SOCIALE, id_service) service_changement_produit,&lt;br/&gt;(select offres.ref_produit ref_produit_old,&lt;br/&gt;offres.id_fdsl_offres id_fdsl_offres_old,&lt;br/&gt; offres.tarif,&lt;br/&gt; id_service,&lt;br/&gt; nom_service,etat_service,&lt;br/&gt; nom_produit,&lt;br/&gt; t3.id_ligne_produit,&lt;br/&gt;&lt;br/&gt;NOM_PRENOM_OU_RAISON_SOCIALE,NUM_VOIE,CODE_POSTAL,COMMUNE,&lt;br/&gt;NOM_VOIE,nature,caracteristique_commande,t2.id id_utilisateur_site,&lt;br/&gt;t2.id id_utilisateur_abonne,date_MES,--date_mise_en_facturation,&lt;br/&gt;date_resil,nom_fai,t8.num_serie,nom_dsp,t3.ref_produit,nom_ligne_produit,&lt;br/&gt;origine_resiliation,nom_ligne_service&lt;br/&gt;from s_com_service_axione t1&lt;br/&gt;inner join s_com_utilisateur t2 on t1.id_utilisateur=t2.id&lt;br/&gt;left join s_com_produit t3 on t1.id_produit=t3.id&lt;br/&gt;left join s_com_site_utilisateur t4 on t2.id=t4.id_utilisateur&lt;br/&gt;left join s_com_adresse_ft t5 on t4.id= t5.id_site&lt;br/&gt;--left join s_com_facturation t6 on t6.id_service_axione=t1.id&lt;br/&gt;left join S_TEMP_FOP_FACTU_SDSL t6 on t1.commande_initiale=t6.idcommande&lt;br/&gt;left join s_com_fai t7 on t1.id_fai=t7.id&lt;br/&gt;left join s_com_cpe t8 on t2.id=t8.id_site&lt;br/&gt;left join s_com_contrat_fai t9 on t9.id_fai=t7.id&lt;br/&gt;left join v_com_site_raccordement t10 on t10.id=t4.id_site_racco&lt;br/&gt;left join s_com_dsp t11 on t11.id=t1.id_dsp&lt;br/&gt;left join s_com_ligne_produit t12 on t12.id=t3.id_ligne_produit&lt;br/&gt;left join s_com_ligne_service t13 on t13.id=t12.id_ligne_service&lt;br/&gt;left  join (select * from T_FDSL_OFFRES&lt;br/&gt;          )  offres on trim(offres.ref_produit)=trim(t3.ref_produit)&lt;br/&gt;          and trim(offres.zone_densite)=NVL(t10.zone_densite,&apos;DENSE&apos;)&lt;br/&gt;          and t6.date_cmde &gt;= offres.Date_Debut&lt;br/&gt;          and t6.date_cmde &lt; NVL(offres.date_fin,trunc(add_months(sysdate,0)))&lt;br/&gt;          and t11.id= offres.id_fdsl_dsp and t6.nbpaires=offres.id_fdsl_paire&lt;br/&gt;where nom_ligne_service=LIGNE_SERVICE and date_resil is null&lt;br/&gt;--and&lt;br/&gt;--offres.date_debut&lt;=t1.DATE_MES&lt;br/&gt;and (NVL(offres.date_fin,trunc(add_months(sysdate,0)))&gt;t1.DATE_MES)&lt;br/&gt;and etat_service in (&apos;INVALIDE&apos;) and date_mes in (select max(date_mes) from s_com_service_axione serv where etat_service in (&apos;INVALIDE&apos;) and serv.id_service=t1.id_service)&lt;br/&gt;order by NOM_PRENOM_OU_RAISON_SOCIALE, id_service) service_invalide&lt;br/&gt;where service_invalide.id_service=service_changement_produit.id_service&lt;br/&gt;--and service_invalide.date_MES!=service_changement_produit.date_MES&lt;br/&gt;--and service_invalide.ref_produit!=service_changement_produit.ref_produit&lt;br/&gt;&lt;br/&gt;and  service_invalide.id_ligne_produit=service_changement_produit.id_ligne_produit&lt;br/&gt;and&lt;br/&gt; (&lt;br/&gt; (service_changement_produit.ID_SERVICE=service_changement_produit.ID_SERVICE&lt;br/&gt; and service_changement_produit.ID_SERVICE like &apos;VIA%&apos;)&lt;br/&gt; or service_changement_produit.ID_SERVICE not like &apos;VIA%&apos;)&lt;br/&gt;&lt;br/&gt;--and id_fdsl_offres!=id_fdsl_offres_old&lt;br/&gt;and (trunc(service_changement_produit.date_MES,&apos;MONTH&apos;)&lt;(add_months(DATE_MOIS,-1))&lt;br/&gt;or (service_changement_produit.date_MES is NULL and trunc(service_invalide.date_MES,&apos;MONTH&apos;)&lt;(add_months(DATE_MOIS,0)))&lt;br/&gt;)&lt;br/&gt;--order by IDENTITE, service_changement_produit.id_service&lt;br/&gt;);&lt;br/&gt;exception when others then null;&lt;br/&gt;end;&lt;br/&gt;&lt;br/&gt;END PROC_CREATION_ABONNEMENT_SDSL;</body>
</StoredProcedureOraclev10g>