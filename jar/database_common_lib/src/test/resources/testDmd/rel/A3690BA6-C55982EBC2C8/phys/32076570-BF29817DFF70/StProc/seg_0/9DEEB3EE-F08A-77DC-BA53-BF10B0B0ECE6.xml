<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.StoredProcedureOraclev10g" name="PROC_CREATION_FAS_SDSL" id="9DEEB3EE-F08A-77DC-BA53-BF10B0B0ECE6" directorySegmentName="seg_0">
<sourceConnName>DEV57_AXIONEUSER_FACTU</sourceConnName>
<sourceObjSchema>AXIONEUSER_FACTU</sourceObjSchema>
<sourceObjName>PROC_CREATION_FAS_SDSL</sourceObjName>
<createdBy>R.WATH</createdBy>
<createdTime>2012-12-04 10:06:38 UTC</createdTime>
<generatorID>Généré par l&apos;utilisateur</generatorID>
<ownerDesignName>ST-SYS-SIB-BD_FCTPRO-000009-8 MCD-FACTUPRO V4.5.0</ownerDesignName>
<owner>4FCC3A6A-181E-A36A-613B-7868309493E2</owner>
<source>CREATE OR REPLACE PROCEDURE                    AXIONEUSER_FACTU.PROC_CREATION_FAS_SDSL (DATE_MOIS in date, LIGNE_SERVICE in varchar  ) AS&lt;br/&gt;BEGIN&lt;br/&gt;  begin&lt;br/&gt;INSERT INTO&lt;br/&gt;t_FDSL_FACTURATION (DATE_FACTURATION&lt;br/&gt;, id_fdsl_offres&lt;br/&gt;,TYPE_CHARGE&lt;br/&gt;,IDENTITE&lt;br/&gt;,ID_SERVICE2&lt;br/&gt;,VIA&lt;br/&gt;,TYPE_TECHNO&lt;br/&gt;,TYPE_DEGROUPAGE&lt;br/&gt;,DATE_MES&lt;br/&gt;,DATE_RESIL&lt;br/&gt;,NOM_DSP&lt;br/&gt;,NRA&lt;br/&gt;,PROFIL&lt;br/&gt;,CODE_CHARGE&lt;br/&gt;,MONTANT_HT&lt;br/&gt;,ID_SERVICE&lt;br/&gt;,ETAT_SERVICE&lt;br/&gt;,NOM_FAI&lt;br/&gt;,DATE_CMDE, PLOT,&lt;br/&gt;ADRESSE&lt;br/&gt;, RIVOLI&lt;br/&gt;, CODE_INSEE&lt;br/&gt;, CODE_POSTAL&lt;br/&gt;, COMMUNE&lt;br/&gt;,NUM_VOIE&lt;br/&gt;,VIA_GTR)&lt;br/&gt;(select distinct&lt;br/&gt;DATE_MOIS date_facturation,&lt;br/&gt;offres.id_fdsl_offres,&lt;br/&gt;&apos;FAS&apos;,&lt;br/&gt;t2.NOM_PRENOM_OU_RAISON_SOCIALE IDENTITE,&lt;br/&gt;t1.ID_SERVICE2,&lt;br/&gt;CASE WHEN t1.ID_SERVICE like &apos;VIA%&apos;&lt;br/&gt;then&lt;br/&gt;t1.ID_SERVICE&lt;br/&gt;else NULL&lt;br/&gt;end,&lt;br/&gt;t1.nom_service type_techno,&lt;br/&gt;&apos;TOTAL&apos;,&lt;br/&gt;date_MES date_MES,&lt;br/&gt;date_resil date_resil,&lt;br/&gt;nom_dsp,&lt;br/&gt;t10.CODE_SITE NRA,&lt;br/&gt;t16.NOM_PRODUIT_COMMERCIAL PROFIL,&lt;br/&gt;offres.ref_produit CODE_CHARGE,&lt;br/&gt;offres.tarif MONTANT_HT,&lt;br/&gt;t1.ID_SERVICE,&lt;br/&gt;--t1.etat_service,&lt;br/&gt;&apos;ACCES&apos;,&lt;br/&gt;nom_fai,&lt;br/&gt;t6.date_cmde, t6.port,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,28)+1, instr(t6.ligne,&apos;;&apos;,1,29)-instr(t6.ligne,&apos;;&apos;,1,28)-1) as ADRESSE,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,29)+1, instr(t6.ligne,&apos;;&apos;,1,30)-instr(t6.ligne,&apos;;&apos;,1,29)-1) as RIVOLI,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,37)+1, instr(t6.ligne,&apos;;&apos;,1,38)-instr(t6.ligne,&apos;;&apos;,1,37)-1) as CODE_INSEE,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,38)+1, instr(t6.ligne,&apos;;&apos;,1,39)-instr(t6.ligne,&apos;;&apos;,1,38)-1) as CODE_POSTAL,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,39)+1, instr(t6.ligne,&apos;;&apos;,1,40)-instr(t6.ligne,&apos;;&apos;,1,39)-1) as COMMUNE,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,30)+1, instr(t6.ligne,&apos;;&apos;,1,31)-instr(t6.ligne,&apos;;&apos;,1,30)-1) as NUM_VOIE,&lt;br/&gt;t6.IDEXTERNESAV as VIA_GTR&lt;br/&gt;from s_com_service_axione t1&lt;br/&gt;inner join s_com_utilisateur t2 on t1.id_utilisateur=t2.id&lt;br/&gt;left join s_com_produit t3 on t1.id_produit=t3.id&lt;br/&gt;left join s_com_site_utilisateur t4 on t2.id=t4.id_utilisateur&lt;br/&gt;left join s_com_adresse_ft t5 on t4.id= t5.id_site&lt;br/&gt;--left join s_com_facturation t6 on t6.id_service_axione=t1.id&lt;br/&gt;left join S_TEMP_FOP_FACTU_SDSL t6 on t1.commande_initiale=t6.idcommande&lt;br/&gt;left join s_com_fai t7 on t1.id_fai=t7.id&lt;br/&gt;left join s_com_cpe t8 on t2.id=t8.id_site&lt;br/&gt;left join s_com_contrat_fai t9 on t9.id_fai=t7.id&lt;br/&gt;left join v_com_site_raccordement t10 on t10.id=t4.id_site_racco&lt;br/&gt;left join s_com_dsp t11 on t11.id=t1.id_dsp&lt;br/&gt;left join s_com_ligne_produit t12 on t12.id=t3.id_ligne_produit&lt;br/&gt;left join s_com_ligne_service t13 on t13.id=t12.id_ligne_service&lt;br/&gt;left outer join s_com_tech_produit t16 on t16.id=t3.id_produit&lt;br/&gt;inner join (&lt;br/&gt;          select distinct zone_densite, id_ligne_produit,id_fdsl_offres,offres_fas.ref_produit,offres_fas.tarif, correspondance.code_axione_fas,&lt;br/&gt;          correspondance.code_axione_paire, correspondance.id_fdsl_paire, id_fdsl_dsp,&lt;br/&gt;          OFFRES_FAS.date_debut, OFFRES_FAS.date_fin&lt;br/&gt;          from T_FDSL_OFFRES OFFRES_FAS, t_fdsl_correspondance correspondance&lt;br/&gt;          where&lt;br/&gt;          OFFRES_FAS.ref_produit=correspondance.code_axione_fas&lt;br/&gt;          )  offres&lt;br/&gt;          on offres.code_axione_paire=t3.ref_produit and trim(offres.zone_densite)=NVL(t10.zone_densite,&apos;DENSE&apos;)&lt;br/&gt;		  and t6.date_cmde &gt;= offres.Date_Debut&lt;br/&gt;          and t6.date_cmde &lt; NVL(offres.date_fin,trunc(add_months(sysdate,0)))&lt;br/&gt;          and t11.id= offres.id_fdsl_dsp and t6.nbpaires=offres.id_fdsl_paire&lt;br/&gt;left join s_com_ligne_produit t21 on t21.id=offres.id_ligne_produit&lt;br/&gt;where nom_ligne_service=LIGNE_SERVICE and date_resil is  null&lt;br/&gt;and etat_service in(&apos;ACTIF&apos;)&lt;br/&gt;and trunc(date_MES,&apos;MONTH&apos;)&lt;=(add_months(DATE_MOIS,-1))&lt;br/&gt;and trunc(date_MES,&apos;MONTH&apos;)&gt;(add_months(DATE_MOIS,-2))&lt;br/&gt;and t3.ref_produit like &apos;%ABO%&apos;&lt;br/&gt;and nom_fai = &apos;NEUF CEGETEL&apos; and t6.typecr=&apos;OK&apos;&lt;br/&gt;/*and&lt;br/&gt; (&lt;br/&gt; (t1.ID_SERVICE=VIA_ACCES and t1.ID_SERVICE like &apos;VIA%&apos;)&lt;br/&gt; or t1.ID_SERVICE not like &apos;VIA%&apos;&lt;br/&gt; )*/&lt;br/&gt;union&lt;br/&gt;select distinct&lt;br/&gt;DATE_MOIS date_facturation,&lt;br/&gt;offres.id_fdsl_offres,&lt;br/&gt;&apos;FAS&apos;,&lt;br/&gt;t2.NOM_PRENOM_OU_RAISON_SOCIALE IDENTITE,&lt;br/&gt;t1.ID_SERVICE2,&lt;br/&gt;CASE WHEN t1.ID_SERVICE like &apos;VIA%&apos;&lt;br/&gt;then&lt;br/&gt;t1.ID_SERVICE&lt;br/&gt;else NULL&lt;br/&gt;end,&lt;br/&gt;t1.nom_service type_techno,&lt;br/&gt;&apos;TOTAL&apos;,&lt;br/&gt;date_MES date_MES,&lt;br/&gt;date_resil date_resil,&lt;br/&gt;nom_dsp,&lt;br/&gt;t10.CODE_SITE NRA,&lt;br/&gt;t16.NOM_PRODUIT_COMMERCIAL PROFIL,&lt;br/&gt;offres.ref_produit CODE_CHARGE,&lt;br/&gt;offres.tarif MONTANT_HT,&lt;br/&gt;t1.ID_SERVICE,&lt;br/&gt;--t1.etat_service,&lt;br/&gt;&apos;ACCES&apos;,&lt;br/&gt;nom_fai,&lt;br/&gt;t6.date_cmde, t6.port,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,28)+1, instr(t6.ligne,&apos;;&apos;,1,29)-instr(t6.ligne,&apos;;&apos;,1,28)-1) as ADRESSE,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,29)+1, instr(t6.ligne,&apos;;&apos;,1,30)-instr(t6.ligne,&apos;;&apos;,1,29)-1) as RIVOLI,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,37)+1, instr(t6.ligne,&apos;;&apos;,1,38)-instr(t6.ligne,&apos;;&apos;,1,37)-1) as CODE_INSEE,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,38)+1, instr(t6.ligne,&apos;;&apos;,1,39)-instr(t6.ligne,&apos;;&apos;,1,38)-1) as CODE_POSTAL,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,39)+1, instr(t6.ligne,&apos;;&apos;,1,40)-instr(t6.ligne,&apos;;&apos;,1,39)-1) as COMMUNE,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,30)+1, instr(t6.ligne,&apos;;&apos;,1,31)-instr(t6.ligne,&apos;;&apos;,1,30)-1) as NUM_VOIE,&lt;br/&gt;t6.IDEXTERNESAV as VIA_GTR&lt;br/&gt;from s_com_service_axione t1&lt;br/&gt;inner join s_com_utilisateur t2 on t1.id_utilisateur=t2.id&lt;br/&gt;left join s_com_produit t3 on t1.id_produit=t3.id&lt;br/&gt;left join s_com_site_utilisateur t4 on t2.id=t4.id_utilisateur&lt;br/&gt;left join s_com_adresse_ft t5 on t4.id= t5.id_site&lt;br/&gt;--left join s_com_facturation t6 on t6.id_service_axione=t1.id&lt;br/&gt;left join S_TEMP_FOP_FACTU_SDSL t6 on t1.commande_initiale=t6.idcommande&lt;br/&gt;left join s_com_fai t7 on t1.id_fai=t7.id&lt;br/&gt;left join s_com_cpe t8 on t2.id=t8.id_site&lt;br/&gt;left join s_com_contrat_fai t9 on t9.id_fai=t7.id&lt;br/&gt;left join v_com_site_raccordement t10 on t10.id=t4.id_site_racco&lt;br/&gt;left join s_com_dsp t11 on t11.id=t1.id_dsp&lt;br/&gt;left join s_com_ligne_produit t12 on t12.id=t3.id_ligne_produit&lt;br/&gt;left join s_com_ligne_service t13 on t13.id=t12.id_ligne_service&lt;br/&gt;left outer join s_com_tech_produit t16 on t16.id=t3.id_produit&lt;br/&gt;inner join (&lt;br/&gt;          select distinct zone_densite, id_ligne_produit,id_fdsl_offres, offres_fas_1.ref_produit,&lt;br/&gt;          offres_fas_1.tarif, correspondance.code_axione_fas, correspondance.code_axione_debit,&lt;br/&gt;          correspondance.id_fdsl_paire, id_fdsl_dsp, OFFRES_FAS_1.date_debut, OFFRES_FAS_1.date_fin&lt;br/&gt;          from T_FDSL_OFFRES OFFRES_FAS_1, t_fdsl_correspondance correspondance&lt;br/&gt;          where OFFRES_FAS_1.ref_produit=correspondance.code_axione_fas&lt;br/&gt;          )  offres&lt;br/&gt;          on offres.code_axione_debit=t3.ref_produit and trim(offres.zone_densite)=NVL(t10.zone_densite,&apos;DENSE&apos;)&lt;br/&gt;		  and t6.date_cmde &gt;= offres.Date_Debut&lt;br/&gt;          and t6.date_cmde &lt; NVL(offres.date_fin,trunc(add_months(sysdate,0)))&lt;br/&gt;          and t11.id= offres.id_fdsl_dsp and t6.nbpaires=offres.id_fdsl_paire&lt;br/&gt;left join s_com_ligne_produit t21 on t21.id=offres.id_ligne_produit&lt;br/&gt;where nom_ligne_service=&apos;LIGNE SDSL&apos; and date_resil is  null&lt;br/&gt;and t1.etat_service in(&apos;ACTIF&apos;)&lt;br/&gt;and trunc(t1.date_MES,&apos;MONTH&apos;)&lt;=(add_months(DATE_MOIS,-1))&lt;br/&gt;and trunc(t1.date_MES,&apos;MONTH&apos;)&gt;(add_months(DATE_MOIS,-2))&lt;br/&gt;and t3.ref_produit like &apos;%PKN%&apos;&lt;br/&gt;/*and&lt;br/&gt; (&lt;br/&gt; (t1.ID_SERVICE=VIA_ACCES and t1.ID_SERVICE like &apos;VIA%&apos;)&lt;br/&gt; or t1.ID_SERVICE not like &apos;VIA%&apos;&lt;br/&gt; )*/&lt;br/&gt;and t1.id_service not in (select distinct&lt;br/&gt;t1.id_service&lt;br/&gt;from s_com_service_axione t1&lt;br/&gt;inner join s_com_utilisateur t2 on t1.id_utilisateur=t2.id&lt;br/&gt;left join s_com_produit t3 on t1.id_produit=t3.id&lt;br/&gt;left join s_com_ligne_produit t12 on t12.id=t3.id_ligne_produit&lt;br/&gt;left join s_com_ligne_service t13 on t13.id=t12.id_ligne_service&lt;br/&gt;where nom_ligne_service=&apos;LIGNE SDSL&apos; and date_resil is  null&lt;br/&gt;and etat_service in(&apos;ACTIF&apos;)&lt;br/&gt;and trunc(date_MES,&apos;MONTH&apos;)&lt;=(add_months(DATE_MOIS,-1))&lt;br/&gt;and trunc(date_MES,&apos;MONTH&apos;)&gt;(add_months(DATE_MOIS,-2))&lt;br/&gt;and ref_produit like &apos;%ABO%&apos;)&lt;br/&gt;and nom_fai = &apos;NEUF CEGETEL&apos; and t6.typecr=&apos;OK&apos;&lt;br/&gt;/*and&lt;br/&gt;(&lt;br/&gt; (t1.ID_SERVICE=VIA_ACCES and t1.ID_SERVICE like &apos;VIA%&apos;)&lt;br/&gt; or t1.ID_SERVICE not like &apos;VIA%&apos;)*/&lt;br/&gt;);&lt;br/&gt;exception when others then null;&lt;br/&gt;end;&lt;br/&gt;END PROC_CREATION_FAS_SDSL;</source>
<body>CREATE OR REPLACE PROCEDURE                    AXIONEUSER_FACTU.PROC_CREATION_FAS_SDSL (DATE_MOIS in date, LIGNE_SERVICE in varchar  ) AS&lt;br/&gt;BEGIN&lt;br/&gt;  begin&lt;br/&gt;INSERT INTO&lt;br/&gt;t_FDSL_FACTURATION (DATE_FACTURATION&lt;br/&gt;, id_fdsl_offres&lt;br/&gt;,TYPE_CHARGE&lt;br/&gt;,IDENTITE&lt;br/&gt;,ID_SERVICE2&lt;br/&gt;,VIA&lt;br/&gt;,TYPE_TECHNO&lt;br/&gt;,TYPE_DEGROUPAGE&lt;br/&gt;,DATE_MES&lt;br/&gt;,DATE_RESIL&lt;br/&gt;,NOM_DSP&lt;br/&gt;,NRA&lt;br/&gt;,PROFIL&lt;br/&gt;,CODE_CHARGE&lt;br/&gt;,MONTANT_HT&lt;br/&gt;,ID_SERVICE&lt;br/&gt;,ETAT_SERVICE&lt;br/&gt;,NOM_FAI&lt;br/&gt;,DATE_CMDE, PLOT,&lt;br/&gt;ADRESSE&lt;br/&gt;, RIVOLI&lt;br/&gt;, CODE_INSEE&lt;br/&gt;, CODE_POSTAL&lt;br/&gt;, COMMUNE&lt;br/&gt;,NUM_VOIE&lt;br/&gt;,VIA_GTR)&lt;br/&gt;(select distinct&lt;br/&gt;DATE_MOIS date_facturation,&lt;br/&gt;offres.id_fdsl_offres,&lt;br/&gt;&apos;FAS&apos;,&lt;br/&gt;t2.NOM_PRENOM_OU_RAISON_SOCIALE IDENTITE,&lt;br/&gt;t1.ID_SERVICE2,&lt;br/&gt;CASE WHEN t1.ID_SERVICE like &apos;VIA%&apos;&lt;br/&gt;then&lt;br/&gt;t1.ID_SERVICE&lt;br/&gt;else NULL&lt;br/&gt;end,&lt;br/&gt;t1.nom_service type_techno,&lt;br/&gt;&apos;TOTAL&apos;,&lt;br/&gt;date_MES date_MES,&lt;br/&gt;date_resil date_resil,&lt;br/&gt;nom_dsp,&lt;br/&gt;t10.CODE_SITE NRA,&lt;br/&gt;t16.NOM_PRODUIT_COMMERCIAL PROFIL,&lt;br/&gt;offres.ref_produit CODE_CHARGE,&lt;br/&gt;offres.tarif MONTANT_HT,&lt;br/&gt;t1.ID_SERVICE,&lt;br/&gt;--t1.etat_service,&lt;br/&gt;&apos;ACCES&apos;,&lt;br/&gt;nom_fai,&lt;br/&gt;t6.date_cmde, t6.port,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,28)+1, instr(t6.ligne,&apos;;&apos;,1,29)-instr(t6.ligne,&apos;;&apos;,1,28)-1) as ADRESSE,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,29)+1, instr(t6.ligne,&apos;;&apos;,1,30)-instr(t6.ligne,&apos;;&apos;,1,29)-1) as RIVOLI,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,37)+1, instr(t6.ligne,&apos;;&apos;,1,38)-instr(t6.ligne,&apos;;&apos;,1,37)-1) as CODE_INSEE,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,38)+1, instr(t6.ligne,&apos;;&apos;,1,39)-instr(t6.ligne,&apos;;&apos;,1,38)-1) as CODE_POSTAL,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,39)+1, instr(t6.ligne,&apos;;&apos;,1,40)-instr(t6.ligne,&apos;;&apos;,1,39)-1) as COMMUNE,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,30)+1, instr(t6.ligne,&apos;;&apos;,1,31)-instr(t6.ligne,&apos;;&apos;,1,30)-1) as NUM_VOIE,&lt;br/&gt;t6.IDEXTERNESAV as VIA_GTR&lt;br/&gt;from s_com_service_axione t1&lt;br/&gt;inner join s_com_utilisateur t2 on t1.id_utilisateur=t2.id&lt;br/&gt;left join s_com_produit t3 on t1.id_produit=t3.id&lt;br/&gt;left join s_com_site_utilisateur t4 on t2.id=t4.id_utilisateur&lt;br/&gt;left join s_com_adresse_ft t5 on t4.id= t5.id_site&lt;br/&gt;--left join s_com_facturation t6 on t6.id_service_axione=t1.id&lt;br/&gt;left join S_TEMP_FOP_FACTU_SDSL t6 on t1.commande_initiale=t6.idcommande&lt;br/&gt;left join s_com_fai t7 on t1.id_fai=t7.id&lt;br/&gt;left join s_com_cpe t8 on t2.id=t8.id_site&lt;br/&gt;left join s_com_contrat_fai t9 on t9.id_fai=t7.id&lt;br/&gt;left join v_com_site_raccordement t10 on t10.id=t4.id_site_racco&lt;br/&gt;left join s_com_dsp t11 on t11.id=t1.id_dsp&lt;br/&gt;left join s_com_ligne_produit t12 on t12.id=t3.id_ligne_produit&lt;br/&gt;left join s_com_ligne_service t13 on t13.id=t12.id_ligne_service&lt;br/&gt;left outer join s_com_tech_produit t16 on t16.id=t3.id_produit&lt;br/&gt;inner join (&lt;br/&gt;          select distinct zone_densite, id_ligne_produit,id_fdsl_offres,offres_fas.ref_produit,offres_fas.tarif, correspondance.code_axione_fas,&lt;br/&gt;          correspondance.code_axione_paire, correspondance.id_fdsl_paire, id_fdsl_dsp,&lt;br/&gt;          OFFRES_FAS.date_debut, OFFRES_FAS.date_fin&lt;br/&gt;          from T_FDSL_OFFRES OFFRES_FAS, t_fdsl_correspondance correspondance&lt;br/&gt;          where&lt;br/&gt;          OFFRES_FAS.ref_produit=correspondance.code_axione_fas&lt;br/&gt;          )  offres&lt;br/&gt;          on offres.code_axione_paire=t3.ref_produit and trim(offres.zone_densite)=NVL(t10.zone_densite,&apos;DENSE&apos;)&lt;br/&gt;		  and t6.date_cmde &gt;= offres.Date_Debut&lt;br/&gt;          and t6.date_cmde &lt; NVL(offres.date_fin,trunc(add_months(sysdate,0)))&lt;br/&gt;          and t11.id= offres.id_fdsl_dsp and t6.nbpaires=offres.id_fdsl_paire&lt;br/&gt;left join s_com_ligne_produit t21 on t21.id=offres.id_ligne_produit&lt;br/&gt;where nom_ligne_service=LIGNE_SERVICE and date_resil is  null&lt;br/&gt;and etat_service in(&apos;ACTIF&apos;)&lt;br/&gt;and trunc(date_MES,&apos;MONTH&apos;)&lt;=(add_months(DATE_MOIS,-1))&lt;br/&gt;and trunc(date_MES,&apos;MONTH&apos;)&gt;(add_months(DATE_MOIS,-2))&lt;br/&gt;and t3.ref_produit like &apos;%ABO%&apos;&lt;br/&gt;and nom_fai = &apos;NEUF CEGETEL&apos; and t6.typecr=&apos;OK&apos;&lt;br/&gt;/*and&lt;br/&gt; (&lt;br/&gt; (t1.ID_SERVICE=VIA_ACCES and t1.ID_SERVICE like &apos;VIA%&apos;)&lt;br/&gt; or t1.ID_SERVICE not like &apos;VIA%&apos;&lt;br/&gt; )*/&lt;br/&gt;union&lt;br/&gt;select distinct&lt;br/&gt;DATE_MOIS date_facturation,&lt;br/&gt;offres.id_fdsl_offres,&lt;br/&gt;&apos;FAS&apos;,&lt;br/&gt;t2.NOM_PRENOM_OU_RAISON_SOCIALE IDENTITE,&lt;br/&gt;t1.ID_SERVICE2,&lt;br/&gt;CASE WHEN t1.ID_SERVICE like &apos;VIA%&apos;&lt;br/&gt;then&lt;br/&gt;t1.ID_SERVICE&lt;br/&gt;else NULL&lt;br/&gt;end,&lt;br/&gt;t1.nom_service type_techno,&lt;br/&gt;&apos;TOTAL&apos;,&lt;br/&gt;date_MES date_MES,&lt;br/&gt;date_resil date_resil,&lt;br/&gt;nom_dsp,&lt;br/&gt;t10.CODE_SITE NRA,&lt;br/&gt;t16.NOM_PRODUIT_COMMERCIAL PROFIL,&lt;br/&gt;offres.ref_produit CODE_CHARGE,&lt;br/&gt;offres.tarif MONTANT_HT,&lt;br/&gt;t1.ID_SERVICE,&lt;br/&gt;--t1.etat_service,&lt;br/&gt;&apos;ACCES&apos;,&lt;br/&gt;nom_fai,&lt;br/&gt;t6.date_cmde, t6.port,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,28)+1, instr(t6.ligne,&apos;;&apos;,1,29)-instr(t6.ligne,&apos;;&apos;,1,28)-1) as ADRESSE,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,29)+1, instr(t6.ligne,&apos;;&apos;,1,30)-instr(t6.ligne,&apos;;&apos;,1,29)-1) as RIVOLI,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,37)+1, instr(t6.ligne,&apos;;&apos;,1,38)-instr(t6.ligne,&apos;;&apos;,1,37)-1) as CODE_INSEE,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,38)+1, instr(t6.ligne,&apos;;&apos;,1,39)-instr(t6.ligne,&apos;;&apos;,1,38)-1) as CODE_POSTAL,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,39)+1, instr(t6.ligne,&apos;;&apos;,1,40)-instr(t6.ligne,&apos;;&apos;,1,39)-1) as COMMUNE,&lt;br/&gt;substr(t6.ligne,instr(t6.ligne,&apos;;&apos;,1,30)+1, instr(t6.ligne,&apos;;&apos;,1,31)-instr(t6.ligne,&apos;;&apos;,1,30)-1) as NUM_VOIE,&lt;br/&gt;t6.IDEXTERNESAV as VIA_GTR&lt;br/&gt;from s_com_service_axione t1&lt;br/&gt;inner join s_com_utilisateur t2 on t1.id_utilisateur=t2.id&lt;br/&gt;left join s_com_produit t3 on t1.id_produit=t3.id&lt;br/&gt;left join s_com_site_utilisateur t4 on t2.id=t4.id_utilisateur&lt;br/&gt;left join s_com_adresse_ft t5 on t4.id= t5.id_site&lt;br/&gt;--left join s_com_facturation t6 on t6.id_service_axione=t1.id&lt;br/&gt;left join S_TEMP_FOP_FACTU_SDSL t6 on t1.commande_initiale=t6.idcommande&lt;br/&gt;left join s_com_fai t7 on t1.id_fai=t7.id&lt;br/&gt;left join s_com_cpe t8 on t2.id=t8.id_site&lt;br/&gt;left join s_com_contrat_fai t9 on t9.id_fai=t7.id&lt;br/&gt;left join v_com_site_raccordement t10 on t10.id=t4.id_site_racco&lt;br/&gt;left join s_com_dsp t11 on t11.id=t1.id_dsp&lt;br/&gt;left join s_com_ligne_produit t12 on t12.id=t3.id_ligne_produit&lt;br/&gt;left join s_com_ligne_service t13 on t13.id=t12.id_ligne_service&lt;br/&gt;left outer join s_com_tech_produit t16 on t16.id=t3.id_produit&lt;br/&gt;inner join (&lt;br/&gt;          select distinct zone_densite, id_ligne_produit,id_fdsl_offres, offres_fas_1.ref_produit,&lt;br/&gt;          offres_fas_1.tarif, correspondance.code_axione_fas, correspondance.code_axione_debit,&lt;br/&gt;          correspondance.id_fdsl_paire, id_fdsl_dsp, OFFRES_FAS_1.date_debut, OFFRES_FAS_1.date_fin&lt;br/&gt;          from T_FDSL_OFFRES OFFRES_FAS_1, t_fdsl_correspondance correspondance&lt;br/&gt;          where OFFRES_FAS_1.ref_produit=correspondance.code_axione_fas&lt;br/&gt;          )  offres&lt;br/&gt;          on offres.code_axione_debit=t3.ref_produit and trim(offres.zone_densite)=NVL(t10.zone_densite,&apos;DENSE&apos;)&lt;br/&gt;		  and t6.date_cmde &gt;= offres.Date_Debut&lt;br/&gt;          and t6.date_cmde &lt; NVL(offres.date_fin,trunc(add_months(sysdate,0)))&lt;br/&gt;          and t11.id= offres.id_fdsl_dsp and t6.nbpaires=offres.id_fdsl_paire&lt;br/&gt;left join s_com_ligne_produit t21 on t21.id=offres.id_ligne_produit&lt;br/&gt;where nom_ligne_service=&apos;LIGNE SDSL&apos; and date_resil is  null&lt;br/&gt;and t1.etat_service in(&apos;ACTIF&apos;)&lt;br/&gt;and trunc(t1.date_MES,&apos;MONTH&apos;)&lt;=(add_months(DATE_MOIS,-1))&lt;br/&gt;and trunc(t1.date_MES,&apos;MONTH&apos;)&gt;(add_months(DATE_MOIS,-2))&lt;br/&gt;and t3.ref_produit like &apos;%PKN%&apos;&lt;br/&gt;/*and&lt;br/&gt; (&lt;br/&gt; (t1.ID_SERVICE=VIA_ACCES and t1.ID_SERVICE like &apos;VIA%&apos;)&lt;br/&gt; or t1.ID_SERVICE not like &apos;VIA%&apos;&lt;br/&gt; )*/&lt;br/&gt;and t1.id_service not in (select distinct&lt;br/&gt;t1.id_service&lt;br/&gt;from s_com_service_axione t1&lt;br/&gt;inner join s_com_utilisateur t2 on t1.id_utilisateur=t2.id&lt;br/&gt;left join s_com_produit t3 on t1.id_produit=t3.id&lt;br/&gt;left join s_com_ligne_produit t12 on t12.id=t3.id_ligne_produit&lt;br/&gt;left join s_com_ligne_service t13 on t13.id=t12.id_ligne_service&lt;br/&gt;where nom_ligne_service=&apos;LIGNE SDSL&apos; and date_resil is  null&lt;br/&gt;and etat_service in(&apos;ACTIF&apos;)&lt;br/&gt;and trunc(date_MES,&apos;MONTH&apos;)&lt;=(add_months(DATE_MOIS,-1))&lt;br/&gt;and trunc(date_MES,&apos;MONTH&apos;)&gt;(add_months(DATE_MOIS,-2))&lt;br/&gt;and ref_produit like &apos;%ABO%&apos;)&lt;br/&gt;and nom_fai = &apos;NEUF CEGETEL&apos; and t6.typecr=&apos;OK&apos;&lt;br/&gt;/*and&lt;br/&gt;(&lt;br/&gt; (t1.ID_SERVICE=VIA_ACCES and t1.ID_SERVICE like &apos;VIA%&apos;)&lt;br/&gt; or t1.ID_SERVICE not like &apos;VIA%&apos;)*/&lt;br/&gt;);&lt;br/&gt;exception when others then null;&lt;br/&gt;end;&lt;br/&gt;END PROC_CREATION_FAS_SDSL;</body>
</StoredProcedureOraclev10g>